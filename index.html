<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Application mobile de collecte de donn√©es g√©ographiques pour le dimensionnement des sites SENELEC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SENELEC Map">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dy='.3em'>S</text></svg>">
    <title>Dimensionnement SENELEC - Collecte de Donn√©es</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Times New Roman', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .partners-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .partners-logos img {
            height: 60px;
            width: auto;
            background: white;
            padding: 8px 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .section h2 {
            color: #667eea;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        select[multiple] {
            padding: 8px;
            min-height: 100px;
            background: white;
        }
        
        select[multiple] option {
            padding: 8px 5px;
            line-height: 1.5;
        }
        
        select[multiple] option:checked {
            background: linear-gradient(#667eea, #667eea);
            background-color: #667eea !important;
            color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #map {
            height: 400px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        
        #canvas-container {
            position: relative;
        }
        
        video {
            width: 100%;
            max-height: 300px;
            border-radius: 5px;
            margin-bottom: 15px;
            background: #000;
            display: none;
        }
        
        video.active {
            display: block;
        }
        
        canvas {
            width: 100%;
            max-height: 300px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            display: none;
        }
        
        canvas.active {
            display: block;
        }
        
        .coords-display {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .coords-display strong {
            color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .button-group button {
            flex: 1;
            min-width: 150px;
        }
        
        .success {
            background: #10b981;
        }
        
        .success:hover {
            background: #059669;
        }
        
        .danger {
            background: #ef4444;
        }
        
        .danger:hover {
            background: #dc2626;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #0c2340;
            border-left: 4px solid #3b82f6;
        }
        
        .hidden {
            display: none;
        }

        /* CSS Mobile et Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                box-shadow: none;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .partners-logos {
                gap: 20px;
            }

            .partners-logos img {
                height: 50px;
            }

            .content {
                padding: 15px;
            }

            .section {
                gap: 12px;
            }

            #map {
                height: 300px;
            }

            video, canvas {
                max-height: 250px;
            }

            button {
                padding: 12px 16px;
                font-size: 13px;
            }

            .button-group button {
                min-width: 120px;
            }

            label {
                font-size: 12px;
            }

            input, select, textarea {
                padding: 8px;
                font-size: 13px;
            }

            select[multiple] {
                min-height: 80px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 12px;
            }

            #map {
                height: 250px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
                min-width: unset;
            }

            .data-item {
                grid-template-columns: 1fr;
            }
        }

        /* Styles pour l'install PWA */
        #install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #install-prompt.hidden {
            display: none;
        }

        #install-prompt > div {
            flex: 1;
        }

        #install-prompt button {
            background: white;
            color: #667eea;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            margin: 0;
            flex-shrink: 0;
        }

        #install-prompt button:hover {
            background: #f0f0f0;
        }

        /* Optimisation Leaflet pour mobile */
        .leaflet-container {
            font-size: 12px;
        }

        .leaflet-control {
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        .leaflet-control-zoom {
            border: none;
        }

        .leaflet-control-zoom a {
            background-color: #667eea;
            color: white;
            border: none;
        }

        .leaflet-control-zoom a:hover {
            background-color: #764ba2;
        }

        .leaflet-popup-content {
            font-size: 13px;
        }

        /* Safe area pour encoche */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                padding-top: max(10px, env(safe-area-inset-top));
            }
        }
        
        .data-summary {
            background: #f9fafb;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #e5e7eb;
            margin-top: 20px;
        }
        
        .data-summary h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .data-item {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 600;
            color: #667eea;
        }
        
        .data-value {
            color: #333;
            word-break: break-word;
        }
        
        footer {
            background: #f3f4f6;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Calendrier styles */
        .calendar-section {
            padding: 30px;
            background: #f9fafb;
            border-top: 2px solid #667eea;
            margin-top: 20px;
        }
        
        .calendar-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .calendar-day {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 6px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .calendar-day.current {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245,158,11,0.05) 0%, rgba(245,158,11,0.02) 100%);
        }
        
        .calendar-day.upcoming {
            border-left-color: #10b981;
            background: linear-gradient(135deg, rgba(16,185,129,0.05) 0%, rgba(16,185,129,0.02) 100%);
        }
        
        .calendar-day-header {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .calendar-day.current .calendar-day-header {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        }
        
        .calendar-day.upcoming .calendar-day-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .calendar-day-badge {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 10px;
        }
        
        .calendar-day-content {
            padding: 15px;
        }
        
        .department-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .sites-list {
            list-style: none;
        }
        
        .sites-list li {
            padding: 8px 0 8px 25px;
            color: #333;
            font-size: 14px;
            position: relative;
        }
        
        .sites-list li:before {
            content: "üìç";
            position: absolute;
            left: 0;
        }
        
        .sites-count {
            background: #e5e7eb;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            margin-top: 12px;
            font-size: 14px;
        }
    </style>

</head>
<body>
    <div id="alert-container" style="position: fixed; top: 10px; right: 10px; z-index: 1000; max-width: 300px;"></div>
    <div id="install-prompt" class="hidden">
        <div>
            <strong>üì≤ Installer l'application SENELEC</strong>
            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">Acc√©dez √† vos cartes hors ligne</p>
        </div>
        <button onclick="installPWA()">Installer</button>
        <button onclick="dismissInstall()" style="background: rgba(255,255,255,0.2); color: white;">√ó</button>
    </div>
    <div class="container">
        <div class="header">
            <h1>‚ö° Dimensionnement SENELEC</h1>
            <p>Collecte de Donn√©es - Localisation et Documentation</p>
            <div class="partners-logos">
                <img src="senelec_logo.svg" alt="SENELEC" style="height: 60px;">
                <img src="sonaged_logo.svg" alt="SONAGED" style="height: 60px;">
            </div>
        </div>
        
        <!-- LISTE DES SITES PAR D√âPARTEMENT -->
        <div style="padding: 30px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-top: 3px solid #667eea;">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px; font-size: 24px;">
                üìç Sites Concern√©s par D√©partement
            </h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- Ziguinchor -->
                <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 6px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                        D√©partement de Ziguinchor (5 sites)
                    </h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Agence principal de Ziguinchor
                        </li>
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Bureau Commercial de Ziguinchor
                        </li>
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Centre de distribution de Ziguinchor
                        </li>
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Parc de carburant
                        </li>
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>La sous station Kankourang
                        </li>
                    </ul>
                </div>

                <!-- Bignona -->
                <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 6px solid #10b981;">
                    <h3 style="color: #10b981; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #10b981; padding-bottom: 10px;">
                        D√©partement de Bignona (4 sites)
                    </h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Nouveau site √† l'entr√©e de Bignona
                        </li>
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Bureau commercial Thionck-Essyl
                        </li>
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Bureau commercial Djioulou
                        </li>
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Bureau commercial Kafountine
                        </li>
                    </ul>
                </div>

                <!-- Oussouye -->
                <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 6px solid #f59e0b;">
                    <h3 style="color: #f59e0b; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #f59e0b; padding-bottom: 10px;">
                        D√©partement d'Oussouye (2 sites)
                    </h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>Bureau commercial d'Oussouye
                        </li>
                        <li style="padding: 8px 0 8px 25px; color: #333; font-size: 14px; position: relative;">
                            <span style="position: absolute; left: 0;">üìç</span>District Principal Cap Skiring
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- FORMULAIRE DE SAISIE -->
            <div class="section">
                <h2>üìù Informations du Site</h2>
                
                <div id="alert-container"></div>
                
                <div class="form-group">
                    <label for="region">R√©gion</label>
                    <select id="region" required>
                        <option value="R√©gion de Ziguinchor">R√©gion de Ziguinchor</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="departement">D√©partement</label>
                    <select id="departement" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="Ziguinchor">Ziguinchor</option>
                        <option value="Bignona">Bignona</option>
                        <option value="Oussouye">Oussouye</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="commune">Commune</label>
                    <select id="commune" required>
                        <option value="">-- S√©lectionner une commune --</option>
                        <option value="Ziguinchor">Ziguinchor</option>
                        <option value="Bignona">Bignona</option>
                        <option value="Oussoye">Oussoye</option>
                        <option value="Djimbering">Djimbering</option>
                        <option value="Diouloulou">Diouloulou</option>
                        <option value="Kafountine">Kafountine</option>
                        <option value="Thionck-Essil">Thionck-Essil</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="typeActivite">Type d'Activit√©</label>
                    <select id="typeActivite" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="Lev√© des dechets vert">Lev√© des dechets vert</option>
                        <option value="Desherbage">Desherbage</option>
                        <option value="Mecanisation">Mecanisation</option>
                        <option value="Collecte">Collecte</option>
                        <option value="Balayage">Balayage</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="siteConcerne">Site Concern√©</label>
                    <select id="siteConcerne" required>
                        <option value="">-- S√©lectionner un site --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="adresse">Adresse</label>
                    <input type="text" id="adresse" placeholder="Adresse d√©taill√©e" required>
                </div>
                
                <div class="form-group">
                    <label for="superficie">Superficie (ha)</label>
                    <input type="number" id="superficie" placeholder="ex: 2.81" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="besoinPersonnel">Besoin en Personnel</label>
                    <input type="number" id="besoinPersonnel" placeholder="Nombre de personnes" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="dispositifDeploy">Dispositif D√©ploy√© (S√©lectionner plusieurs)</label>
                    <select id="dispositifDeploy" required multiple size="4">
                        <option value="Pelle Chargeur">Pelle Chargeur</option>
                        <option value="Camion BTP">Camion BTP</option>
                        <option value="Polybene">Polybene</option>
                        <option value="Benne tasseuse">Benne tasseuse</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">üí° Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs choix</small>
                </div>
                
                <div class="form-group">
                    <label for="nombreRotation">Nombre de Rotation</label>
                    <input type="number" id="nombreRotation" placeholder="Nombre de rotations" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="infrastructureGestion">Infrastructure de Gestion de Dechets</label>
                    <select id="infrastructureGestion" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="PRN">PRN</option>
                        <option value="PP">PP</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="frequenceCollecte">Fr√©quence de Collecte</label>
                    <select id="frequenceCollecte" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="F1">F1</option>
                        <option value="F2">F2</option>
                        <option value="F3">F3</option>
                        <option value="F4">F4</option>
                        <option value="F5">F5</option>
                        <option value="F6">F6</option>
                        <option value="F7">F7</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bacs240">Bacs 240L</label>
                    <input type="number" id="bacs240" placeholder="Nombre de bacs" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="caissePolybene">Caisse Polybene</label>
                    <input type="number" id="caissePolybene" placeholder="Nombre de caisses" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="bacs660">Bacs 660L</label>
                    <input type="number" id="bacs660" placeholder="Nombre de bacs" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="accessibilite">Accessibilit√©</label>
                    <select id="accessibilite" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="Facile">Facile</option>
                        <option value="Difficile">Difficile</option>
                        <option value="Route non goudronn√©e">Route non goudronn√©e</option>
                        <option value="Route goudronn√©e">Route goudronn√©e</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="observation">Observations</label>
                    <textarea id="observation" placeholder="Notes suppl√©mentaires" rows="3"></textarea>
                </div>
                
                <button class="success" onclick="sauvegarderDonnees()">üíæ Sauvegarder Donn√©es</button>
                
                <div style="margin-top: 15px; background: #f0f9ff; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 12px; font-size: 14px;">üì• Exporter les Donn√©es</h3>
                    <button class="success" onclick="exporterExcel(true)" style="background: #10b981; width: 100%;">üìä Excel (avec image)</button>
                    <button style="margin-top: 10px; width: 100%; background: #8b5cf6;" onclick="imprimerDonnees()">üñ®Ô∏è Imprimer</button>
                </div>
            </div>
            
            <!-- LOCALISATION & IMAGES -->
            <div class="section">
                <h2>üìç Localisation et Images</h2>
                
                <div class="coords-display" id="coords-display">
                    <strong>Coordonn√©es actuelles:</strong><br>
                    Latitude: <span id="lat">--</span><br>
                    Longitude: <span id="lon">--</span><br>
                    Pr√©cision: <span id="accuracy">--</span> m
                </div>
                
                <button onclick="obtenirLocalisationGPS()">üì° Obtenir Position GPS</button>
                
                <h3 style="color: #667eea; margin-top: 20px;">üìç Localisation du Site (UTM)</h3>
                
                <div class="form-group">
                    <label for="coordonneeX">Coordonn√©es X (Easting)</label>
                    <input type="text" id="coordonneeX" placeholder="Entrez la coordonn√©e X (UTM)" required>
                </div>
                
                <div class="form-group">
                    <label for="coordonneeY">Coordonn√©es Y (Northing)</label>
                    <input type="text" id="coordonneeY" placeholder="Entrez la coordonn√©e Y (UTM)" required>
                </div>
                
                <div id="map"></div>
                
                <h3 style="color: #667eea; margin-top: 20px;">üì∑ Capture d'Image</h3>
                
                <div class="button-group">
                    <button onclick="demarrerCamera()">üìπ D√©marrer Cam√©ra</button>
                    <button class="danger" onclick="arreterCamera()">‚èπÔ∏è Arr√™ter</button>
                </div>
                
                <video id="video"></video>
                <canvas id="canvas"></canvas>
                
                <button onclick="capturerPhoto()">üì∏ Capturer Photo</button>
                
                <div id="image-preview" class="hidden">
                    <img id="preview-img" src="" alt="Aper√ßu" style="width: 100%; border-radius: 5px; margin: 10px 0;">
                    <button class="danger" onclick="effacerPhoto()">üóëÔ∏è Effacer Photo</button>
                </div>
            </div>
        </div>
        
        <!-- R√âSUM√â DES DONN√âES -->
        <div style="padding: 30px;">
            <div class="data-summary" id="summary" style="display: none;">
                <h3>üìã R√©sum√© des Donn√©es Collect√©es</h3>
                <div id="summary-content"></div>
                <button class="success" onclick="exporterExcel(true)" style="background: #10b981; width: 100%; margin-bottom: 10px;">üìä Excel (avec image)</button>
                <button class="success" onclick="exporterJSON()" style="background: #3b82f6; width: 100%; margin-bottom: 10px;">üì• Exporter JSON</button>
                <button style="width: 100%;" onclick="imprimerDonnees()">üñ®Ô∏è Imprimer</button>
            </div>
        </div>
        
        <!-- Calendrier des Activit√©s -->
        <div class="calendar-section">
            <h2>üìÖ Calendrier des Activit√©s (12-15 F√©vrier 2026)</h2>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        
        <footer>
            <p>¬© 2026 Dimensionnement SENELEC - Collecte de Donn√©es | R√©gion de Ziguinchor | Derni√®re mise √† jour: <span id="date-update"></span></p>
        </footer>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <script>
        // ============ PWA & Service Worker Enregistrement ============
        let deferredPrompt;
        let swRegistration = null;

        // Enregistrer le Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    swRegistration = registration;
                    console.log('‚úÖ Service Worker enregistr√©:', registration);
                    
                    // V√©rifier les mises √† jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'activated') {
                                showAlert('info', '‚úÖ Nouvelle version disponible! Rechargez la page.');
                            }
                        });
                    });
                    
                    // Polling pour les mises √† jour
                    setInterval(() => {
                        registration.update();
                    }, 60000);
                }).catch(error => {
                    console.warn('‚ùå Erreur SW:', error);
                });
            });
        }

        // Gestion de l'install prompt PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Afficher le bouton d'installation
            document.getElementById('install-prompt').classList.remove('hidden');
        });

        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ Application install√©e!');
            document.getElementById('install-prompt').classList.add('hidden');
            showAlert('success', 'üì± Application install√©e avec succ√®s!');
            deferredPrompt = null;
        });

        // Fonction d'installation PWA
        function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((outcome) => {
                if (outcome.outcome === 'accepted') {
                    console.log('‚úÖ Installation accept√©e');
                } else {
                    console.log('‚ùå Installation refus√©e');
                }
                deferredPrompt = null;
            });
        }

        // Masquer l'avis d'installation
        function dismissInstall() {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // D√©tection de la connectivit√©
        window.addEventListener('online', () => {
            showAlert('success', 'üåê Connect√© √† internet');
        });

        window.addEventListener('offline', () => {
            showAlert('info', 'üìµ Mode hors ligne activ√© - Les donn√©es seront synchronis√©es');
        });

        // Si d√©j√† install√©e ou accessible en standalone
        if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // ============ Variables et Donn√©es ============
        let map;
        let userLocationMarker;
        let videoStream;
        
        // Base de donn√©es des sites par d√©partement
        const sitesParDepartement = {
            'Ziguinchor': [
                'Agence principal de Ziguinchor',
                'Bureau Commercial de Ziguinchor',
                'Centre de distribution de Ziguinchor',
                'Parc de carburant',
                'La sous station Kankourang'
            ],
            'Bignona': [
                'Nouveau site √† l\'entr√©e de Bignona',
                'Bureau commercial Thionck-Essyl',
                'Bureau commercial Djioulou',
                'Bureau commercial Kafountine'
            ],
            'Oussouye': [
                'Bureau commercial d\'Oussouye',
                'District Principal Cap Skiring'
            ]
        };
        let donnees = {
            region: '',
            departement: '',
            commune: '',
            typeActivite: '',
            siteConcerne: '',
            adresse: '',
            superficie: '',
            besoinPersonnel: '',
            dispositifDeploy: '',
            nombreRotation: '',
            infrastructureGestion: '',
            frequenceCollecte: '',
            bacs240: '',
            caissePolybene: '',
            bacs660: '',
            accessibilite: '',
            observation: '',
            latitude: null,
            longitude: null,
            precision: null,
            coordonneeX: '',
            coordonneeY: '',
            photo: null,
            dateCollecte: new Date().toISOString()
        };
        
        // Initialiser la carte avec optimisations
        function initMap() {
            map = L.map('map').setView([13.1939, -15.5277], 13); // Coordonn√©es Ziguinchor
            
            // Ajouter les tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                crossOrigin: true,
                className: 'leaflet-tiles-offline'
            }).addTo(map);
            
            // Ajouter un marqueur de d√©part
            L.marker([13.1939, -15.5277], {
                title: 'Ziguinchor (Si√®ge SENELEC)'
            }).addTo(map).bindPopup('<b>Ziguinchor</b><br>Si√®ge SENELEC');
            
            // Optimisation pour mobile
            if (window.innerWidth < 768) {
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
            }
        }

        // Informations sur le cache
        function afficherInfoCache() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const percentUsed = (estimate.usage / estimate.quota) * 100;
                    console.log(`Cache utilis√©: ${(estimate.usage / 1024 / 1024).toFixed(2)} MB / ${(estimate.quota / 1024 / 1024).toFixed(2)} MB (${percentUsed.toFixed(1)}%)`);
                });
            }
        }

        // Nettoyer le cache
        function nettoyerCache() {
            if (swRegistration) {
                swRegistration.active.postMessage({ type: 'CLEAR_CACHE' });
                showAlert('success', 'üóëÔ∏è Cache en cours de nettoyage...');
            }
        }
        
        // Mettre √† jour les sites disponibles - afficher tous les sites de tous les d√©partements
        function mettreAJourSites() {
            const siteConcerneSelect = document.getElementById('siteConcerne');
            
            // R√©initialiser le select
            siteConcerneSelect.innerHTML = '<option value="">-- S√©lectionner un site --</option>';
            
            // Ajouter tous les sites de tous les d√©partements avec leurs labels
            for (const [departement, sites] of Object.entries(sitesParDepartement)) {
                // Cr√©er un groupe optgroup pour chaque d√©partement
                const optgroup = document.createElement('optgroup');
                optgroup.label = `üìç ${departement}`;
                
                sites.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site;
                    option.textContent = `  üìç ${site}`;
                    optgroup.appendChild(option);
                });
                
                siteConcerneSelect.appendChild(optgroup);
            }
        }
        
        // G√©olocalisation GPS
        // G√©olocalisation am√©lior√©e avec conversion UTM
        let watchPositionId = null;

        function obtenirLocalisationGPS() {
            showAlert('info', 'üì° Recherche de la position avec haute pr√©cision...');
            
            if (!navigator.geolocation) {
                showAlert('error', '‚ùå La g√©olocalisation n\'est pas support√©e par votre navigateur');
                return;
            }
            
            // Options pour haute pr√©cision
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            // Utiliser watchPosition pour suivi continu
            watchPositionId = navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    const altitude = position.coords.altitude ? Math.round(position.coords.altitude) : 'N/A';
                    const heading = position.coords.heading ? Math.round(position.coords.heading) : 'N/A';
                    const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) : '0'; // m/s to km/h
                    
                    donnees.latitude = lat;
                    donnees.longitude = lon;
                    donnees.precision = accuracy;
                    
                    // Afficher les coordonn√©es
                    document.getElementById('lat').textContent = lat.toFixed(6);
                    document.getElementById('lon').textContent = lon.toFixed(6);
                    document.getElementById('accuracy').textContent = accuracy;
                    
                    // Convertir en UTM
                    const utm = latLonToUTM(lat, lon);
                    document.getElementById('coordonneeX').value = utm.easting.toFixed(2);
                    document.getElementById('coordonneeY').value = utm.northing.toFixed(2);
                    donnees.coordonneeX = utm.easting.toFixed(2);
                    donnees.coordonneeY = utm.northing.toFixed(2);
                    
                    // Centrer la carte et ajouter un marqueur
                    map.setView([lat, lon], 17);
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    
                    const popupContent = `<b>üìç Position actuelle</b><br>
                    Lat: ${lat.toFixed(6)}<br>
                    Lon: ${lon.toFixed(6)}<br>
                    Pr√©cision: ¬±${accuracy}m<br>
                    Altitude: ${altitude}m<br>
                    Vitesse: ${speed} km/h<br>
                    Cap: ${heading}¬∞`;
                    
                    userLocationMarker = L.circleMarker([lat, lon], {
                        radius: 8,
                        fillColor: '#667eea',
                        color: '#764ba2',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8,
                        title: 'Votre position'
                    }).addTo(map).bindPopup(popupContent);
                    
                    showAlert('success', `‚úÖ Position obtenue! Pr√©cision: ¬±${accuracy}m`);
                },
                function(error) {
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Acc√®s √† la g√©olocalisation refus√©. V√©rifiez les permissions!';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Position indisponible. Assurez-vous d\'avoir une connexion GPS.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'D√©lai d√©pass√© pour obtenir la position.';
                            break;
                    }
                    showAlert('error', '‚ùå Erreur GPS: ' + errorMsg);
                },
                options
            );
        }

        // Fonction de conversion Lat/Lon en UTM
        function latLonToUTM(lat, lon) {
            // R√©f√©rence: WGS84
            const k0 = 0.9996;
            const E = 0.00669438;
            const E2 = E / (1 - E);
            const N0 = 0;
            const E0 = 500000;
            
            const zone = Math.floor((lon + 180) / 6) + 1;
            const lon0 = (zone - 1) * 6 - 180 + 3;
            
            const N = Math.cos(lat * Math.PI / 180);
            const T = Math.tan(lat * Math.PI / 180);
            const C = E2 * N * N;
            const A = (lon - lon0) * Math.PI / 180 * N;
            
            const M = 111132.92 * lat - 16216.94 * Math.sin(2 * lat * Math.PI / 180) + 
                      17.21 * Math.sin(4 * lat * Math.PI / 180) - 
                      0.094 * Math.sin(6 * lat * Math.PI / 180);
            
            const easting = E0 + k0 * 6378137 * (A + (A * A * A / 6) * (1 - T * T + C) + 
                            (A * A * A * A * A / 120) * (5 - 18 * T * T + T * T * T * T + 72 * C - 58 * E2));
            
            const northing = N0 + k0 * (M + 6378137 * (T * (A * A / 2) + (T * (A * A * A * A / 24)) * 
                            (5 - T * T + 9 * C + 4 * C * C) + 
                            (T * (A * A * A * A * A * A / 720)) * (61 - 58 * T * T + T * T * T * T + 600 * C - 330 * E2)));
            
            return {
                easting: easting,
                northing: northing,
                zone: zone
            };
        }

        // Arr√™ter le suivi GPS
        function arreterLocalisationGPS() {
            if (watchPositionId !== null) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
                showAlert('info', '‚èπÔ∏è Suivi GPS arr√™t√©');
            }
        }
        
        // Cam√©ra
        function demarrerCamera() {
            const video = document.getElementById('video');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.classList.add('active');
                    showAlert('success', '‚úÖ Cam√©ra activ√©e');
                })
                .catch(err => {
                    showAlert('error', '‚ùå Erreur cam√©ra: ' + err.message);
                });
        }
        
        function arreterCamera() {
            const video = document.getElementById('video');
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                video.classList.remove('active');
                videoStream = null;
            }
        }
        
        function capturerPhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!videoStream) {
                showAlert('error', '‚ùå Veuillez d√©marrer la cam√©ra d\'abord');
                return;
            }
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            canvas.classList.add('active');
            
            const imageData = canvas.toDataURL('image/jpeg');
            donnees.photo = imageData;
            
            document.getElementById('preview-img').src = imageData;
            document.getElementById('image-preview').classList.remove('hidden');
            
            showAlert('success', '‚úÖ Photo captur√©e');
        }
        
        function effacerPhoto() {
            document.getElementById('canvas').classList.remove('active');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('preview-img').src = '';
            donnees.photo = null;
        }
        
        // Formulaire
        function sauvegarderDonnees() {
            donnees.region = document.getElementById('region').value;
            donnees.departement = document.getElementById('departement').value;
            donnees.commune = document.getElementById('commune').value;
            donnees.typeActivite = document.getElementById('typeActivite').value;
            donnees.siteConcerne = document.getElementById('siteConcerne').value;
            donnees.adresse = document.getElementById('adresse').value;
            donnees.superficie = document.getElementById('superficie').value;
            donnees.besoinPersonnel = document.getElementById('besoinPersonnel').value;
            // R√©cup√©rer tous les dispositifs s√©lectionn√©s
            const dispositifSelect = document.getElementById('dispositifDeploy');
            const selectedDisposition = Array.from(dispositifSelect.selectedOptions).map(option => option.value);
            donnees.dispositifDeploy = selectedDisposition.length > 0 ? selectedDisposition : [];
            donnees.nombreRotation = document.getElementById('nombreRotation').value;
            donnees.infrastructureGestion = document.getElementById('infrastructureGestion').value;
            donnees.frequenceCollecte = document.getElementById('frequenceCollecte').value;
            donnees.bacs240 = document.getElementById('bacs240').value;
            donnees.caissePolybene = document.getElementById('caissePolybene').value;
            donnees.bacs660 = document.getElementById('bacs660').value;
            donnees.accessibilite = document.getElementById('accessibilite').value;
            donnees.observation = document.getElementById('observation').value;
            donnees.coordonneeX = document.getElementById('coordonneeX').value;
            donnees.coordonneeY = document.getElementById('coordonneeY').value;
            
            showAlert('success', '‚úÖ Donn√©es sauvegard√©es avec succ√®s!');
            affichageResume();
        }
        
        function affichageResume() {
            const summary = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            let html = `
                <div class="data-item">
                    <div class="data-label">R√©gion:</div>
                    <div class="data-value">${donnees.region}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">D√©partement:</div>
                    <div class="data-value">${donnees.departement}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Commune:</div>
                    <div class="data-value">${donnees.commune}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Type d'Activit√©:</div>
                    <div class="data-value">${donnees.typeActivite}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Site Concern√©:</div>
                    <div class="data-value">${donnees.siteConcerne}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Adresse:</div>
                    <div class="data-value">${donnees.adresse}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Superficie:</div>
                    <div class="data-value">${donnees.superficie} ha</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Besoin en Personnel:</div>
                    <div class="data-value">${donnees.besoinPersonnel}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Dispositif D√©ploy√©:</div>
                    <div class="data-value">${Array.isArray(donnees.dispositifDeploy) ? donnees.dispositifDeploy.join(', ') : donnees.dispositifDeploy}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Nombre de Rotation:</div>
                    <div class="data-value">${donnees.nombreRotation}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Infrastructure de Gestion:</div>
                    <div class="data-value">${donnees.infrastructureGestion}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Fr√©quence de Collecte:</div>
                    <div class="data-value">${donnees.frequenceCollecte}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Bacs 240L:</div>
                    <div class="data-value">${donnees.bacs240}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Caisse Polybene:</div>
                    <div class="data-value">${donnees.caissePolybene}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Bacs 660L:</div>
                    <div class="data-value">${donnees.bacs660}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Accessibilit√©:</div>
                    <div class="data-value">${donnees.accessibilite}</div>
                </div>
            `;
            
            if (donnees.latitude) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Latitude:</div>
                        <div class="data-value">${donnees.latitude.toFixed(6)}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Longitude:</div>
                        <div class="data-value">${donnees.longitude.toFixed(6)}</div>
                    </div>
                `;
            }
            
            if (donnees.coordonneeX || donnees.coordonneeY) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Coordonn√©es X (UTM):</div>
                        <div class="data-value">${donnees.coordonneeX}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Coordonn√©es Y (UTM):</div>
                        <div class="data-value">${donnees.coordonneeY}</div>
                    </div>
                `;
            }
            
            if (donnees.observation) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Observations:</div>
                        <div class="data-value">${donnees.observation}</div>
                    </div>
                `;
            }
            
            if (donnees.photo) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Photo Captur√©e:</div>
                        <div class="data-value">‚úÖ Oui</div>
                    </div>
                `;
            }
            
            summaryContent.innerHTML = html;
            summary.style.display = 'block';
        }
        
        function exporterExcel(avecImage = true) {
            const ExcelJS = window.ExcelJS;
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Collecte de Donn√©es');
            
            // D√©finir les largeurs de colonnes
            worksheet.columns = [
                { width: 40 },
                { width: 50 }
            ];
            
            let rowCount = 1;
            
            // Titre principal
            const titleRow = worksheet.getRow(rowCount);
            titleRow.values = ['DIMENSIONNEMENT SENELEC - COLLECTE DE DONN√âES'];
            titleRow.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 14 };
            titleRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            titleRow.alignment = { horizontal: 'center', vertical: 'center' };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Informations du Site
            const sectionRow1 = worksheet.getRow(rowCount);
            sectionRow1.values = ['INFORMATIONS DU SITE'];
            sectionRow1.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow1.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            // Donn√©es du site
            const siteData = [
                ['R√©gion', donnees.region || 'R√©gion de Ziguinchor'],
                ['D√©partement', donnees.departement],
                ['Commune', donnees.commune],
                ['Type d\'Activit√©', donnees.typeActivite],
                ['Site Concern√©', donnees.siteConcerne],
                ['Adresse', donnees.adresse],
                ['Superficie (ha)', donnees.superficie],
                ['Besoin en Personnel', donnees.besoinPersonnel],
                ['Dispositif D√©ploy√©', Array.isArray(donnees.dispositifDeploy) ? donnees.dispositifDeploy.join(', ') : donnees.dispositifDeploy],
                ['Nombre de Rotation', donnees.nombreRotation],
                ['Infrastructure de Gestion', donnees.infrastructureGestion],
                ['Fr√©quence de Collecte', donnees.frequenceCollecte],
                ['Bacs 240L', donnees.bacs240],
                ['Caisse Polybene', donnees.caissePolybene],
                ['Bacs 660L', donnees.bacs660],
                ['Accessibilit√©', donnees.accessibilite],
                ['Observations', donnees.observation]
            ];
            
            siteData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Localisation GPS
            const sectionRow2 = worksheet.getRow(rowCount);
            sectionRow2.values = ['LOCALISATION GPS'];
            sectionRow2.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow2.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const gpsData = [
                ['Latitude', donnees.latitude ? donnees.latitude.toFixed(6) : '--'],
                ['Longitude', donnees.longitude ? donnees.longitude.toFixed(6) : '--'],
                ['Pr√©cision (m)', donnees.precision || '--']
            ];
            
            gpsData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Localisation UTM
            const sectionRow3 = worksheet.getRow(rowCount);
            sectionRow3.values = ['LOCALISATION DU SITE (UTM)'];
            sectionRow3.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow3.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF69B4' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const utmData = [
                ['Coordonn√©es X (Easting)', donnees.coordonneeX],
                ['Coordonn√©es Y (Northing)', donnees.coordonneeY]
            ];
            
            utmData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Photo
            if (donnees.photo) {
                const sectionRow4 = worksheet.getRow(rowCount);
                sectionRow4.values = ['PHOTO CAPTUR√âE'];
                sectionRow4.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
                sectionRow4.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF10B981' } };
                worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
                rowCount++;
                
                // Convertir le canvas/data URL en image et l'ajouter
                const imageBase64 = donnees.photo.split('data:image/jpeg;base64,')[1] || donnees.photo;
                const imageId = workbook.addImage({
                    base64: imageBase64,
                    extension: 'jpeg'
                });
                
                // Ajouter l'image √† la feuille
                worksheet.addImage(imageId, {
                    tl: { col: 0, row: rowCount - 1 },
                    ext: { width: 400, height: 400 }
                });
                
                rowCount += 15;
            }
            
            // Section: Informations de collecte
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            const sectionRow5 = worksheet.getRow(rowCount);
            sectionRow5.values = ['INFORMATIONS DE COLLECTE'];
            sectionRow5.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow5.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const collecteData = [
                ['Date de Collecte', new Date(donnees.dateCollecte).toLocaleString('fr-FR')],
                ['Photo Captur√©e', donnees.photo ? 'Oui' : 'Non']
            ];
            
            collecteData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            // G√©n√©rer et t√©l√©charger le fichier
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `SENELEC_Collecte_${new Date().getTime()}.xlsx`;
                link.click();
                URL.revokeObjectURL(url);
                showAlert('success', '‚úÖ Fichier Excel export√© avec succ√®s!');
            });
        }
        
        function exporterJSON() {
            const dataStr = JSON.stringify(donnees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `collecte_donnees_${new Date().getTime()}.json`;
            link.click();
        }
        
        function imprimerDonnees() {
            window.print();
        }
        
        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 4000);
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            afficherInfoCache();
            document.getElementById('date-update').textContent = new Date().toLocaleDateString('fr-FR');
            afficherCalendrier();
            mettreAJourSites();
            
            // V√©rifier le statut PWA
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                console.log('‚úÖ Ex√©cution en mode PWA');
                showAlert('success', 'üì± Application PWA charg√©e!');
            }
        });
        
        // Calendrier des activit√©s
        function afficherCalendrier() {
            const activites = [
                {
                    date: '12 F√©vrier 2026',
                    type: 'current',
                    departement: 'Ziguinchor',
                    sites: [
                        'Agence principal de Ziguinchor',
                        'Bureau Commercial de Ziguinchor',
                        'Centre de distribution de Ziguinchor',
                        'Parc de carburant',
                        'La sous station Kankourang'
                    ]
                },
                {
                    date: '13-14 F√©vrier 2026',
                    type: 'upcoming',
                    departement: 'Bignona',
                    sites: [
                        'Nouveau site √† l\'entr√©e de Bignona',
                        'Bureau commercial Thionck-Essil',
                        'Bureau commercial Diouloulou',
                        'Bureau commercial Kafountine'
                    ]
                },
                {
                    date: '15 F√©vrier 2026',
                    type: 'upcoming',
                    departement: 'Oussouye',
                    sites: [
                        'Bureau commercial d\'Oussouye',
                        'District Principal Cap Skiring'
                    ]
                }
            ];
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            activites.forEach(activite => {
                const dayCard = document.createElement('div');
                dayCard.className = `calendar-day ${activite.type}`;
                
                let typeBadge = '';
                if (activite.type === 'current') {
                    typeBadge = '<span class="calendar-day-badge">üî¥ EN COURS</span>';
                } else {
                    typeBadge = '<span class="calendar-day-badge">üü¢ √Ä VENIR</span>';
                }
                
                dayCard.innerHTML = `
                    <div class="calendar-day-header">
                        üìÖ ${activite.date}
                        ${typeBadge}
                    </div>
                    <div class="calendar-day-content">
                        <div class="department-name">D√©partement: ${activite.departement}</div>
                        <ul class="sites-list">
                            ${activite.sites.map(site => `<li>${site}</li>`).join('')}
                        </ul>
                        <div class="sites-count">${activite.sites.length} site${activite.sites.length > 1 ? 's' : ''}</div>
                    </div>
                `;
                
                calendarGrid.appendChild(dayCard);
            });
        }
    </script>

</body>
</html>
