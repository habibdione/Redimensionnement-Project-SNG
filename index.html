<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Application mobile de collecte de donn√©es g√©ographiques pour le dimensionnement des sites SONAGED">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SONAGED Map">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dy='.3em'>S</text></svg>">
    <title>Dimensionnement SONAGED - Collecte de Donn√©es</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c27 50%, #6db038 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .header > * {
            position: relative;
            z-index: 1;
        }
        
        .header-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .header-logo-container img {
            height: 100px;
            width: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
            animation: float 3s ease-in-out infinite;
        }
        
        .sonaged-logo {
            height: 120px;
            width: 120px;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.3)) drop-shadow(0 2px 4px rgba(45, 80, 22, 0.5));
            animation: float 3s ease-in-out infinite, spin 6s ease-in-out infinite;
        }
        
        @keyframes spin {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(2deg); }
            75% { transform: rotate(-2deg); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 15px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .header-features {
            font-size: 12px;
            opacity: 0.88;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-features span {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        /* ===== ANIMATIONS FLUIDES ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Animations des sections */
        .section {
            animation: fadeIn 0.6s ease-out;
        }
        
        .form-group {
            animation: fadeIn 0.5s ease-out;
        }
        
        .galerie-container {
            animation: slideInRight 0.7s ease-out;
        }
        
        /* Animations des boutons */
        button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Animation des inputs */
        input, select, textarea {
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(109, 176, 56, 0.1) !important;
        }
        
        /* Animation des cartes galerie */
        .galerie-item {
            animation: fadeIn 0.5s ease-out;
        }
        
        .galerie-item img {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .galerie-item:hover img {
            transform: scale(1.08);
        }
        
        /* Animation du modal */
        .galerie-modal {
            animation: fadeIn 0.3s ease-out;
        }
        
        .galerie-modal-content {
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Animation des alertes */
        .alert {
            animation: slideInRight 0.4s ease-out;
        }
        
        /* Animation des marqueurs carte */
        .leaflet-marker-icon {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Animation smooth scroll */
        html {
            scroll-behavior: smooth;
        }
        
        /* Animation du compteur d'images */
        .galerie-counter {
            animation: fadeIn 0.5s ease-out 0.2s both;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Animation du bouton de t√©l√©chargement */
        .telecharger-btn {
            animation: fadeIn 0.5s ease-out 0.3s both;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .telecharger-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 24px rgba(109, 176, 56, 0.4);
            background-color: #5aa332 !important;
        }
        
        /* Animation des infos photo */
        .galerie-info {
            animation: slideInLeft 0.5s ease-out 0.2s both;
        }
        
        .galerie-detail-item {
            animation: fadeIn 0.4s ease-out;
            transition: all 0.3s ease;
            padding: 10px;
            border-left: 3px solid transparent;
        }
        
        .galerie-detail-item:hover {
            border-left-color: #6db038;
            background-color: rgba(109, 176, 56, 0.1);
            transform: translateX(5px);
        }
        
        /* Animation des boutons de navigation */
        .galerie-nav-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .galerie-nav-button:hover {
            transform: scale(1.15) translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .galerie-nav-button:active {
            transform: scale(0.95);
        }
        
        /* Animation de l'en-t√™te */
        .header {
            animation: slideInDown 0.7s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Animation du logo */
        .header-logo-container img {
            animation: fadeIn 0.8s ease-out, float 3s ease-in-out 0.8s infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Animation des cartes de stats */
        .stats-card {
            animation: scaleIn 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
        }
        
        /* Animation des titres */
        h1, h2, h3 {
            transition: all 0.3s ease;
        }
        
        h2:hover {
            color: #6db038;
            text-shadow: 0 4px 8px rgba(109, 176, 56, 0.3);
        }
        
        /* D√©sactiver les animations sur les m√©dias r√©duits */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .section h2 {
            color: #2d5016;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 3px solid #6db038;
            padding-bottom: 12px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #2d5016;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select, textarea {
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        select[multiple] {
            padding: 10px;
            min-height: 120px;
            background: white;
            border-color: #d0d0d0;
        }
        
        select[multiple] option {
            padding: 10px 5px;
            line-height: 1.6;
        }
        
        /* ===== ANIMATIONS DE FORMULAIRE ===== */
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            background: linear-gradient(135deg, #ffffff 0%, #f0f8e6 100%);
            border-color: #6db038 !important;
            box-shadow: 0 0 0 4px rgba(109, 176, 56, 0.1) !important;
            transform: translateY(-1px);
        }
        
        /* Animation de la vid√©o */
        video, canvas {
            transition: all 0.4s ease;
        }
        
        video:not([style*="display: none"]),
        canvas:not([style*="display: none"]) {
            animation: slideInLeft 0.5s ease-out;
        }
        
        /* Animation de la carte */
        #map, #collecte-map {
            transition: all 0.5s ease;
            animation: fadeIn 0.6s ease-out;
        }
        
        /* Animation du preview image */
        #image-preview {
            animation: fadeIn 0.4s ease-out;
        }
        
        #preview-img {
            animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* ===== ANIMATIONS DES ALERTES ET MESSAGES ===== */
        .alert-box {
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.3s ease;
        }
        
        .alert-box:hover {
            transform: translateX(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        /* Animation du r√©sum√© */
        #resume-section {
            animation: fadeIn 0.5s ease-out;
        }
        
        .data-summary {
            animation: fadeIn 0.6s ease-out;
        }
        
        .data-item {
            animation: slideInLeft 0.4s ease-out;
            transition: all 0.3s ease;
        }
        
        .data-item:hover {
            transform: translateX(4px);
        }
        
        /* ===== ANIMATIONS DES STATISTIQUES ===== */
        .galerie-stat-item {
            animation: scaleIn 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .galerie-stat-item:hover {
            transform: scale(1.05);
        }
        
        .galerie-stat-number {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* ===== ANIMATIONS DES BOUTONS ===== */
        .success, .danger, .info {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .success:hover, .danger:hover, .info:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .success:active, .danger:active, .info:active {
            transform: translateY(-1px);
        }
        
        /* Effet de ripple au clic */
        .success::after, .danger::after, .info::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .success:active::after, .danger:active::after, .info:active::after {
            width: 300px;
            height: 300px;
        }
        
        /* ===== ANIMATIONS SP√âCIALES ===== */
        /* Animation de chargement */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        /* Animation de succ√®s */
        @keyframes checkmark {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        
        /* Animation de l'en-t√™te */
        .header {
            animation: slideInDown 0.7s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Animation du conteneur principal */
        .container {
            animation: fadeIn 0.8s ease-out;
        }
        
        /* Animation des cartes de stats */
        .stats-card {
            animation: scaleIn 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
        }
        
        /* Animation du logo au chargement */
        .header-logo-container img {
            animation: fadeIn 0.8s ease-out, float 3s ease-in-out 0.8s infinite;
        }
        
        /* Animation des titres */
        h1, h2, h3 {
            transition: all 0.3s ease;
        }
        
        h2:hover {
            color: #6db038;
            text-shadow: 0 4px 8px rgba(109, 176, 56, 0.3);
        }
        
        /* Animation des liens */
        a {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        a:hover {
            color: #6db038;
        }
        
        /* Animation des ic√¥nes */
        .icon {
            transition: all 0.3s ease;
        }
        
        .icon:hover {
            transform: rotate(10deg) scale(1.1);
        }
        
        /* Animation smooth pour les transitions */
        * {
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* D√©sactiver les animations sur les m√©dias r√©duits */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        select[multiple] option:checked {
            background: linear-gradient(#6db038, #6db038);
            background-color: #6db038 !important;
            color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6db038;
            background: white;
            box-shadow: 0 0 0 3px rgba(109, 176, 56, 0.1);
        }
        
        button {
            padding: 13px 24px;
            background: linear-gradient(135deg, #6db038 0%, #4a7c27 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(109, 176, 56, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(109, 176, 56, 0.4);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        button.danger:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }
        
        .success {
            background: linear-gradient(135deg, #6db038 0%, #4a7c27 100%) !important;
        }
        
        #map {
            height: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        video {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        video.active {
            display: block;
        }
        
        canvas {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            display: none;
        }
        
        canvas.active {
            display: block;
        }
        
        .coords-display {
            background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%);
            padding: 18px;
            border-radius: 10px;
            border-left: 5px solid #6db038;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(109, 176, 56, 0.1);
        }
        
        .coords-display strong {
            color: #2d5016;
            font-weight: 700;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .button-group button {
            flex: 1;
            min-width: 160px;
        }
        
        .danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
        }
        
        .danger:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4) !important;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #0c2340;
            border-left: 4px solid #3b82f6;
        }
        
        .hidden {
            display: none;
        }

        /* CSS Mobile et Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                box-shadow: none;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .partners-logos {
                gap: 20px;
            }

            .partners-logos img {
                height: 50px;
            }

            .content {
                padding: 15px;
            }

            .section {
                gap: 12px;
            }

            #map {
                height: 300px;
            }

            video, canvas {
                max-height: 250px;
            }

            button {
                padding: 12px 16px;
                font-size: 13px;
            }

            .button-group button {
                min-width: 120px;
            }

            label {
                font-size: 12px;
            }

            input, select, textarea {
                padding: 8px;
                font-size: 13px;
            }

            select[multiple] {
                min-height: 80px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 12px;
            }

            #map {
                height: 250px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
                min-width: unset;
            }

            .data-item {
                grid-template-columns: 1fr;
            }
        }

        /* Styles pour l'install PWA */
        #install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #install-prompt.hidden {
            display: none;
        }

        #install-prompt > div {
            flex: 1;
        }

        #install-prompt button {
            background: white;
            color: #667eea;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            margin: 0;
            flex-shrink: 0;
        }

        #install-prompt button:hover {
            background: #f0f0f0;
        }

        /* Optimisation Leaflet pour mobile */
        .leaflet-container {
            font-size: 12px;
        }

        .leaflet-control {
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        .leaflet-control-zoom {
            border: none;
        }

        .leaflet-control-zoom a {
            background-color: #667eea;
            color: white;
            border: none;
        }

        .leaflet-control-zoom a:hover {
            background-color: #764ba2;
        }

        .leaflet-popup-content {
            font-size: 13px;
        }

        /* Safe area pour encoche */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                padding-top: max(10px, env(safe-area-inset-top));
            }
        }
        
        .data-summary {
            background: #f9fafb;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #e5e7eb;
            margin-top: 20px;
        }
        
        .data-summary h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .data-item {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 600;
            color: #667eea;
        }
        
        .data-value {
            color: #333;
            word-break: break-word;
        }
        
        footer {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c27 50%, #5ba837 100%);
            padding: 40px 20px;
            text-align: center;
            color: white;
            font-size: 13px;
            border-top: 4px solid #6db038;
            position: relative;
            overflow: hidden;
        }
        
        footer::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        footer::after {
            content: '';
            position: absolute;
            bottom: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        footer > * {
            position: relative;
            z-index: 1;
        }
        
        footer p {
            margin: 8px 0;
            opacity: 0.95;
            letter-spacing: 0.3px;
        }
        
        footer strong {
            font-weight: 700;
            display: block;
            margin-bottom: 3px;
            color: #a4d65e;
        }

        /* ===== STYLES GALERIE ===== */
        .galerie-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .galerie-header {
            background: linear-gradient(135deg, #2d5016 0%, #5ba837 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .galerie-header h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .galerie-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .galerie-stats {
            display: flex;
            justify-content: space-around;
            padding: 12px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
        }

        .galerie-stat-item {
            text-align: center;
        }

        .galerie-stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #2d5016;
        }

        .galerie-stat-label {
            color: #666;
            font-size: 11px;
        }

        .galerie-scroll {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            align-content: start;
        }

        .galerie-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease-out;
        }

        .galerie-item:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 12px 28px rgba(45, 80, 22, 0.25);
            border-color: #6db038;
        }

        .galerie-item-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .galerie-item-info {
            padding: 12px;
            font-size: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .galerie-item-commune {
            font-weight: bold;
            color: #2d5016;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .galerie-item-detail {
            color: #666;
            margin-bottom: 3px;
            font-size: 11px;
            flex: 1;
        }

        .galerie-item-detail strong {
            color: #5ba837;
        }

        @media (max-width: 600px) {
            .galerie-scroll {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 10px;
            }
        }

        /* Modal pour images */
        .galerie-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .galerie-modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 95%;
            max-width: 700px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-height: 85vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .galerie-modal-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .galerie-modal-info {
            padding: 15px;
            background: white;
        }

        .galerie-modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            background: rgba(0,0,0,0.3);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            border: none;
            z-index: 2002;
        }

        .galerie-modal-close:hover {
            background: rgba(0,0,0,0.6);
        }

        .galerie-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.4);
            color: white;
            border: none;
            font-size: 30px;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2002;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .galerie-nav-button:hover {
            background: rgba(0,0,0,0.8);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .galerie-nav-button:active {
            transform: translateY(-50%) scale(0.95);
        }

        .galerie-nav-prev {
            left: 10px;
        }

        .galerie-nav-next {
            right: 10px;
        }

        .galerie-modal-counter {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 2002;
        }
    </style>

</head>
<body>
    <div id="alert-container" style="position: fixed; top: 10px; right: 10px; z-index: 1000; max-width: 300px;"></div>
    <div id="install-prompt" class="hidden">
        <div>
            <strong>üì≤ Installer l'application SONAGED</strong>
            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">Acc√©dez √† vos cartes hors ligne</p>
        </div>
        <button onclick="installPWA()">Installer</button>
        <button onclick="dismissInstall()" style="background: rgba(255,255,255,0.2); color: white;">√ó</button>
    </div>
    <div class="container">
        <div class="header">
            <div class="header-logo-container">
                <!-- Logo SONAGED Image Externe -->
                <img class="sonaged-logo" src="./src/assets/logo-sonaged.jpg" alt="SONAGED Logo">
                <!-- 
                    üìç LOGO CHARG√â DEPUIS: ./src/assets/logo-sonaged.jpg
                -->
                
                <div>
                    <h1 style="color: #2d5016; font-size: 36px; font-weight: 800; margin-bottom: 8px;">SONAGED</h1>
                    <p style="font-size: 16px; opacity: 0.95; color: #5ba837; font-weight: 600; letter-spacing: 0.5px;">Dimensionnement & Collecte de Donn√©es</p>
                    <p style="font-size: 13px; opacity: 0.85; margin-top: 5px; color: white;">Gestion intelligente des ressources</p>
                </div>
            </div>
            <div class="header-features">
                <span>üì± Mobile PWA</span>
                <span>üó∫Ô∏è G√©olocalisation</span>
                <span>üì∑ Photographie</span>
                <span>üíæ Donn√©es Locales</span>
                <span>üóÑÔ∏è PostgreSQL</span>
                <span>üåê Mode Hors-Ligne</span>
            </div>
        </div>
        
        <div class="content">
            <!-- FORMULAIRE DE SAISIE -->
            <form id="collecte-form" onsubmit="return false;" novalidate>
            <div class="section">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <span style="background: linear-gradient(135deg, #2d5016 0%, #5ba837 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">1</span>
                    <h2 style="margin: 0;">üìù Informations du Site</h2>
                </div>
                
                <div id="alert-container" style="margin-bottom: 15px;"></div>
                
                <div class="form-group">
                    <label for="region">üó∫Ô∏è R√©gion <span style="color: red;">*</span></label>
                    <select id="region" required onchange="mettreAJourDepartements(); validerChamp('region');">
                        <option value="">-- S√©lectionner une r√©gion --</option>
                    </select>
                    <small class="error-msg" id="error-region" style="color: red; display: none;">‚ö†Ô∏è R√©gion obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="departement">üìç D√©partement <span style="color: red;">*</span></label>
                    <select id="departement" required onchange="mettreAJourCommunes(); validerChamp('departement');">
                        <option value="">-- S√©lectionner un d√©partement --</option>
                    </select>
                    <small class="error-msg" id="error-departement" style="color: red; display: none;">‚ö†Ô∏è D√©partement obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="commune">üèòÔ∏è Commune <span style="color: red;">*</span></label>
                    <select id="commune" required onchange="validerChamp('commune');">
                        <option value="">-- S√©lectionner une commune --</option>
                    </select>
                    <small class="error-msg" id="error-commune" style="color: red; display: none;">‚ö†Ô∏è Commune obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="typeActivite">Type d'Activit√© (S√©lectionner plusieurs)</label>
                    <select id="typeActivite" required multiple size="5">
                        <option value="Lev√© des dechets vert">Lev√© des dechets vert</option>
                        <option value="Desherbage">Desherbage</option>
                        <option value="Mecanisation">Mecanisation</option>
                        <option value="Collecte">Collecte</option>
                        <option value="Balayage">Balayage</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">üí° Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs choix</small>
                </div>
                
                <div class="form-group">
                    <label for="partenaire">Partenaire <span style="color: red;">*</span></label>
                    <input type="text" id="partenaire" placeholder="Ex: SONAGED, ONG, etc." required onchange="validerChamp('partenaire');">
                    <small class="error-msg" id="error-partenaire" style="color: red; display: none;">‚ö†Ô∏è Partenaire obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="adresse">Sites Concern√©s <span style="color: red;">*</span></label>
                    <input type="text" id="adresse" placeholder="Sites concern√©s" required onchange="validerChamp('adresse');">
                    <small class="error-msg" id="error-adresse" style="color: red; display: none;">‚ö†Ô∏è Sites Concern√©s obligatoires</small>
                </div>
                
                <div class="form-group">
                    <label for="superficie">Superficie (ha) <span style="color: red;">*</span></label>
                    <input type="number" id="superficie" placeholder="ex: 2.81" step="0.01" required onchange="validerChamp('superficie');">
                    <small class="error-msg" id="error-superficie" style="color: red; display: none;">‚ö†Ô∏è Superficie obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="besoinPersonnel">Besoin en Personnel <span style="color: red;">*</span></label>
                    <input type="number" id="besoinPersonnel" placeholder="Nombre de personnes" step="1" required onchange="validerChamp('besoinPersonnel');">
                    <small class="error-msg" id="error-besoinPersonnel" style="color: red; display: none;">‚ö†Ô∏è Personnel obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="dispositifDeploy">Dispositif D√©ploy√© (S√©lectionner plusieurs)</label>
                    <select id="dispositifDeploy" required multiple size="4">
                        <option value="Pelle Chargeur">Pelle Chargeur</option>
                        <option value="Camion BTP">Camion BTP</option>
                        <option value="Polybene">Polybene</option>
                        <option value="Benne tasseuse">Benne tasseuse</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">üí° Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs choix</small>
                </div>
                
                <div class="form-group">
                    <label for="nombreRotation">Nombre de Rotation</label>
                    <input type="number" id="nombreRotation" placeholder="Nombre de rotations" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="infrastructureGestion">Infrastructure de Gestion de Dechets</label>
                    <select id="infrastructureGestion" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="PRN">PRN</option>
                        <option value="PP">PP</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="frequenceCollecte">Fr√©quence de Collecte</label>
                    <select id="frequenceCollecte" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="F1">F1</option>
                        <option value="F2">F2</option>
                        <option value="F3">F3</option>
                        <option value="F4">F4</option>
                        <option value="F5">F5</option>
                        <option value="F6">F6</option>
                        <option value="F7">F7</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bacs240">Bacs 240L</label>
                    <input type="number" id="bacs240" placeholder="Nombre de bacs" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="caissePolybene">Caisse Polybene</label>
                    <input type="number" id="caissePolybene" placeholder="Nombre de caisses" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="bacs660">Bacs 660L</label>
                    <input type="number" id="bacs660" placeholder="Nombre de bacs" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="accessibilite">Accessibilit√©</label>
                    <select id="accessibilite" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="Facile">Facile</option>
                        <option value="Difficile">Difficile</option>
                        <option value="Route non goudronn√©e">Route non goudronn√©e</option>
                        <option value="Route goudronn√©e">Route goudronn√©e</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="observation">Observations</label>
                    <textarea id="observation" placeholder="Notes suppl√©mentaires" rows="3"></textarea>
                </div>
                
                <!-- R√âSUM√â DES DONN√âES AVANT SAUVEGARDE -->
                <div id="resume-section" style="display: none; background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%); padding: 25px; border-radius: 12px; border-left: 6px solid #6db038; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(109, 176, 56, 0.15);">
                    <h3 style="color: #2d5016; margin-bottom: 18px; font-size: 20px; font-weight: 700;">üìã R√©sum√© des Donn√©es</h3>
                    <div id="resume-contenu" style="font-size: 14px; line-height: 2; color: #333;"></div>
                </div>
            </div>
            </form>
            
            <!-- LOCALISATION & IMAGES -->
            <div class="section">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <span style="background: linear-gradient(135deg, #2d5016 0%, #5ba837 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">2</span>
                    <h2 style="margin: 0;">üìç Localisation et Images</h2>
                </div>
                
                <div class="coords-display" id="coords-display">
                    <strong>üìç Coordonn√©es actuelles:</strong><br>
                    Latitude: <span id="lat">--</span><br>
                    Longitude: <span id="lon">--</span><br>
                    Pr√©cision: <span id="accuracy">--</span> m<br>
                    <small style="margin-top: 10px; display: block; opacity: 0.8;">UTM - Easting: <span id="utm-easting">--</span> | Northing: <span id="utm-northing">--</span></small>
                </div>
                
                <!-- Champs cach√©s pour coordonn√©es UTM -->
                <input type="hidden" id="coordonneeX" value="">
                <input type="hidden" id="coordonneeY" value="">
                
                <button onclick="obtenirLocalisationGPS()" style="width: 100%;">üì° Obtenir Position GPS & Ajouter Marqueur</button>
                
                <div id="map"></div>
                
                <h3 style="color: #667eea; margin-top: 20px;">üì∑ Capture d'Image</h3>
                
                <div class="button-group">
                    <button onclick="demarrerCamera()" style="flex: 1;">üìπ D√©marrer Cam√©ra</button>
                    <button class="danger" onclick="arreterCamera()" style="flex: 1;">‚èπÔ∏è Arr√™ter</button>
                </div>
                
                <video id="video" style="width: 100%; border-radius: 8px; background: #000; margin: 15px 0; display: none;" playsinline></video>
                <canvas id="canvas" style="width: 100%; border-radius: 8px; margin: 15px 0; display: none;"></canvas>
                
                <button onclick="capturerPhoto()" style="width: 100%;">üì∏ Capturer Photo</button>
                
                <div id="image-preview" class="hidden">
                    <div id="photo-info" style="background: #f0f8e6; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #6db038; font-size: 12px; color: #2d5016;">
                        <strong>üìå Nom du fichier:</strong> <span id="photo-filename">photo_site.jpg</span>
                    </div>
                    <img id="preview-img" src="" alt="Aper√ßu" style="width: 100%; border-radius: 8px; margin: 10px 0; max-height: 300px;">
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <button onclick="telechargerPhoto()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">‚¨áÔ∏è T√©l√©charger l'Image</button>
                        <button class="danger" onclick="effacerPhoto()" style="width: 100%; margin-top: 0;">üóëÔ∏è Effacer Photo</button>
                    </div>
                </div>
                
                <!-- CARTE DU S√âN√âGAL AVEC POINTS COLLECT√âS -->
                <div style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <span style="background: linear-gradient(135deg, #2d5016 0%, #5ba837 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">3</span>
                        <h2 style="margin: 0;">üó∫Ô∏è Localisation des Collectes</h2>
                    </div>
                    <div id="collecte-map" style="width: 100%; height: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border: 2px solid #e5e7eb;"></div>
                    <div style="margin-top: 10px; padding: 12px; background: #f0f8e6; border-left: 4px solid #6db038; border-radius: 4px; font-size: 12px; color: #333;">
                        <strong>‚ÑπÔ∏è L√©gende:</strong> Les marqueurs üìç indiquent les sites collect√©s. 
                        Vous pouvez zoomer/d√©zoomer et cliquer sur les marqueurs pour voir les d√©tails.
                    </div>
                </div>
            </div>
            
            <!-- GALERIE PHOTOS COLLECT√âES -->
            <div class="galerie-container">
                <div class="galerie-header">
                    <h3>üì∏ Galerie des Collectes</h3>
                    <p>Visualisez les sites photographi√©s</p>
                </div>
                
                <div class="galerie-stats">
                    <div class="galerie-stat-item">
                        <div class="galerie-stat-number">8</div>
                        <div class="galerie-stat-label">Collectes</div>
                    </div>
                    <div class="galerie-stat-item">
                        <div class="galerie-stat-number">1</div>
                        <div class="galerie-stat-label">R√©gions</div>
                    </div>
                    <div class="galerie-stat-item">
                        <div class="galerie-stat-number">8</div>
                        <div class="galerie-stat-label">Images</div>
                    </div>
                </div>
                
                <div class="galerie-scroll">
                    <div class="galerie-item" onclick="openGalerieModal(0)">
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T18-16-04/images/photo_12_1.jpg" alt="Oussouye">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">üìç Oussouye</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> Bureau commercial</div>
                        </div>
                    </div>

                    <div class="galerie-item" onclick="openGalerieModal(1)">
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T18-16-04/images/photo_11_2.jpg" alt="Diemb√©ring">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">üìç Diemb√©ring</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> District Cap-Skirring</div>
                        </div>
                    </div>

                    <div class="galerie-item" onclick="openGalerieModal(2)">
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T18-16-04/images/photo_10_3.jpg" alt="Ziguinchor">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">üìç Ziguinchor</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> Bureau commercial</div>
                        </div>
                    </div>

                    <div class="galerie-item" onclick="openGalerieModal(3)">
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T18-16-04/images/photo_9_4.jpg" alt="Niaguis">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">üìç Niaguis</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> Centrale √©lectrique</div>
                        </div>
                    </div>

                    <div class="galerie-item" onclick="openGalerieModal(4)">
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T18-16-04/images/photo_8_5.jpg" alt="Ziguinchor">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">üìç Ziguinchor</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> Chambre de passage</div>
                        </div>
                    </div>

                    <div class="galerie-item" onclick="openGalerieModal(5)">
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T18-16-04/images/photo_7_6.jpg" alt="Ziguinchor">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">üìç Ziguinchor</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> Agence principale</div>
                        </div>
                    </div>

                    <div class="galerie-item" onclick="openGalerieModal(6)">
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T18-16-04/images/photo_6_7.jpg" alt="Ziguinchor">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">üìç Ziguinchor</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> Sous station Kankourang</div>
                        </div>
                    </div>

                    <div class="galerie-item" onclick="openGalerieModal(7)">
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T18-16-04/images/photo_5_8.jpg" alt="Ziguinchor">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">üìç Ziguinchor</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> Parc √† carburant</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- R√âSUM√â DES DONN√âES -->
        <div style="padding: 30px;">
            <div class="data-summary" id="summary" style="display: none;">
                <h3>üìã R√©sum√© des Donn√©es Collect√©es</h3>
                <div id="summary-content"></div>
            </div>
        </div>
        
        <footer>
            <p style="margin-bottom: 10px; font-weight: 700; font-size: 14px;">¬© 2026 SONAGED - Syst√®me de Dimensionnement & Gestion de Donn√©es</p>
            <p style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;"><strong>üó∫Ô∏è Application G√©ographique Progressive</strong> | Derni√®re mise √† jour: <span id="date-update"></span></p>
            <p style="font-size: 12px; opacity: 0.85; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 10px;">üë®‚Äçüíª <strong>Habib DIONE</strong> | üè¢ Charg√© SIG Ziguinchor</p>
        </footer>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <script>
        // ============ CONFIGURATION DYNAMIQUE DE L'URL DU SERVEUR ============
        let API_BASE_URL = 'http://localhost:3001'; // Par d√©faut
        
        // D√©tecter l'URL dynamiquement selon le contexte
        function detecterURLServeur() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            console.log('%cüåê INITIALISATION API', 'background: #2d5016; color: white; padding: 10px; font-weight: bold; border-radius: 5px;');
            console.log('Contexte d√©tect√©:', {
                hostname: hostname,
                protocol: protocol,
                href: window.location.href
            });
            
            // Si c'est GitHub Pages (habibdione.github.io)
            if (hostname.includes('github.io')) {
                API_BASE_URL = 'https://4mkdbs2k-3001.euw.devtunnels.ms';
                console.log('%c‚úÖ Mode GitHub Pages', 'color: #4CAF50; font-weight: bold;');
                console.log('Serveur: ' + API_BASE_URL);
            }
            // Si c'est le dev tunnel
            else if (hostname.includes('devtunnels.ms')) {
                API_BASE_URL = 'https://' + hostname.replace('-8000', '-3001').replace('-8080', '-3001');
                console.log('%c‚úÖ Mode Dev Tunnel', 'color: #4CAF50; font-weight: bold;');
                console.log('Serveur: ' + API_BASE_URL);
            }
            // Si c'est localhost
            else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                API_BASE_URL = 'http://localhost:3001';
                console.log('%c‚úÖ Mode D√©veloppement Local', 'color: #4CAF50; font-weight: bold;');
                console.log('Serveur: ' + API_BASE_URL);
            }
            // Autre cas (production)
            else {
                API_BASE_URL = protocol + '//' + hostname + ':3001';
                console.log('%c‚úÖ Mode Production', 'color: #4CAF50; font-weight: bold;');
                console.log('Serveur: ' + API_BASE_URL);
            }
            
            console.log('%cüîó API_BASE_URL', 'background: #2196F3; color: white; padding: 8px; font-weight: bold; border-radius: 3px;');
            console.log(API_BASE_URL);
            
            // Afficher aussi dans la page
            console.log('%c‚úÖ Configuration API compl√©t√©e', 'background: #8BC34A; color: white; padding: 10px; font-weight: bold; border-radius: 5px;');
            
            return API_BASE_URL;
        }
        
        // Initialiser l'URL du serveur au chargement
        detecterURLServeur();
        
        // ============ DONN√âES G√âOGRAPHIQUES DU S√âN√âGAL (PRIORITAIRE) ============
        const SENEGAL_REGIONS = {
            regions: [
                {
                    id: 'dakar',
                    nom: 'üèõÔ∏è Dakar',
                    code: 'DK',
                    departements: [
                        {
                            id: 'dakar-dept',
                            nom: 'Dakar',
                            communes: ['Dakar', 'Gu√©diawaye', 'Pikine', 'Rufisque', 'Keur Massar']
                        }
                    ]
                },
                {
                    id: 'thies',
                    nom: 'üèòÔ∏è Thi√®s',
                    code: 'TH',
                    departements: [
                        { id: 'thies-dept', nom: 'Thi√®s', communes: ['Thi√®s', 'Popenguine', 'Sindia'] },
                        { id: 'mbour-dept', nom: 'Mbour', communes: ['Mbour', 'Nianing', 'Joal-Fadiouth', 'Malicounda', 'Ngaparou', 'Toubab Dialao'] },
                        { id: 'tivaouane-dept', nom: 'Tivaouane', communes: ['Tivaouane', 'Mekh√©', 'M√©rinag√®ne', 'Gningue'] }
                    ]
                },
                {
                    id: 'saint-louis',
                    nom: 'üëë Saint-Louis',
                    code: 'SL',
                    departements: [
                        { id: 'saint-louis-dept', nom: 'Saint-Louis', communes: ['Saint-Louis', 'Guet N Dar', 'Sor'] },
                        { id: 'dagana-dept', nom: 'Dagana', communes: ['Dagana', 'Ronchamp', 'Diama'] },
                        { id: 'podor-dept', nom: 'Podor', communes: ['Podor', 'Tandilao', 'Madina'] }
                    ]
                },
                {
                    id: 'diourbel',
                    nom: 'üåæ Diourbel',
                    code: 'DB',
                    departements: [
                        { id: 'diourbel-dept', nom: 'Diourbel', communes: ['Diourbel', 'Gueule Tap√©e', 'Touba', 'Gueule Ndar'] },
                        { id: 'bambey-dept', nom: 'Bambey', communes: ['Bambey', 'Ngoye'] },
                        { id: 'mbacke-dept', nom: 'Mback√©', communes: ['Mback√©', 'Darou Mouhty', 'Lamina', 'Keur Modou'] }
                    ]
                },
                {
                    id: 'tambacounda',
                    nom: 'üê™ Tambacounda',
                    code: 'TC',
                    departements: [
                        { id: 'tambacounda-dept', nom: 'Tambacounda', communes: ['Tambacounda', 'Sinthiou Lemba', 'Guel Malick', 'Banda R√©'] },
                        { id: 'bakel-dept', nom: 'Bakel', communes: ['Bakel', 'Kanel'] },
                        { id: 'goudiry-dept', nom: 'Goudiry', communes: ['Goudiry', 'Kidira'] },
                        { id: 'koumpentoum-dept', nom: 'Koumpentoum', communes: ['Koumpentoum', 'Gueumane'] },
                        { id: 'kidira-dept', nom: 'Kidira', communes: ['Kidira', 'Gabu'] }
                    ]
                },
                {
                    id: 'ziguinchor',
                    nom: 'üå¥ Ziguinchor',
                    code: 'ZG',
                    departements: [
                        { id: 'ziguinchor-dept', nom: 'Ziguinchor', communes: ['Ziguinchor', 'Ad√©ane', 'Niaguis', 'Niassia', 'Boutoupa Camara Kounda'] },
                        { id: 'bignona-dept', nom: 'Bignona', communes: ['Bignona', 'Thionck-Essyl', 'Kafountine', 'Diouloulou', 'Balingore', 'Coubalan', 'Di√©goune', 'Djibidione', 'Djinaki', 'Karthiack', 'Kataba 1', 'Mangagoulack', 'Mlomp', 'Niamone', 'Oulampane', 'Quonck', 'Sindian', 'Suelle', 'Tenghory'] },
                        { id: 'oussouye-dept', nom: 'Oussouye', communes: ['Oussouye', 'Diemb√©ring', 'Mlomp'] }
                    ]
                },
                {
                    id: 'kaolack',
                    nom: 'üé™ Kaolack',
                    code: 'KL',
                    departements: [
                        { id: 'kaolack-dept', nom: 'Kaolack', communes: ['Kaolack', 'Lamin Sine', 'Ndi√©di√©me', 'Gankette Soul√©'] },
                        { id: 'nioro-dept', nom: 'Nioro du Rip', communes: ['Nioro du Rip', 'Kolia'] },
                        { id: 'guinguineo-dept', nom: 'Guinguin√©o', communes: ['Guinguin√©o', 'Taiba Niass√®ne', 'Ndengler'] }
                    ]
                },
                {
                    id: 'fatick',
                    nom: 'üèûÔ∏è Fatick',
                    code: 'FT',
                    departements: [
                        { id: 'fatick-dept', nom: 'Fatick', communes: ['Fatick', 'Keur Samba Gueye', 'Missirah', 'Passe'] },
                        { id: 'foundiougne-dept', nom: 'Foundiougne', communes: ['Foundiougne', 'Missirah Wad√®ne'] },
                        { id: 'gossas-dept', nom: 'Gossas', communes: ['Gossas', 'Rip', 'Sarelle'] }
                    ]
                },
                {
                    id: 'kaffrine',
                    nom: 'üåæ Kaffrine',
                    code: 'KF',
                    departements: [
                        { id: 'kaffrine-dept', nom: 'Kaffrine', communes: ['Kaffrine', 'Sinth√©', 'Sar√© Yerma'] },
                        { id: 'birkelane-dept', nom: 'Birkelane', communes: ['Birkelane', 'Ndiob√®ne'] },
                        { id: 'malem-hodar-dept', nom: 'Malem Hodar', communes: ['Malem Hodar', 'Maka Kol√©'] },
                        { id: 'koungheul-dept', nom: 'Koungheul', communes: ['Koungheul', 'Guelel Yerguel'] }
                    ]
                },
                {
                    id: 'matam',
                    nom: 'üèúÔ∏è Matam',
                    code: 'MT',
                    departements: [
                        { id: 'matam-dept', nom: 'Matam', communes: ['Matam', 'Kassan', 'Orb√©'] },
                        { id: 'kanel-dept', nom: 'Kanel', communes: ['Kanel', 'Ouro Alfa'] },
                        { id: 'ranerou-dept', nom: 'Ran√©rou', communes: ['Ran√©rou', 'S√©libaby'] }
                    ]
                },
                {
                    id: 'kedougou',
                    nom: 'üå≤ K√©dougou',
                    code: 'KD',
                    departements: [
                        { id: 'kedougou-dept', nom: 'K√©dougou', communes: ['K√©dougou', 'Mampatim'] },
                        { id: 'salemata-dept', nom: 'Salemata', communes: ['Salemata', 'Mako'] },
                        { id: 'saraya-dept', nom: 'Saraya', communes: ['Saraya', 'Misira'] }
                    ]
                },
                {
                    id: 'kolda',
                    nom: 'üéã Kolda',
                    code: 'KO',
                    departements: [
                        { id: 'kolda-dept', nom: 'Kolda', communes: ['Kolda', 'Sibassor', 'M√©dina El Hadj'] },
                        { id: 'velingara-dept', nom: 'V√©lingara', communes: ['V√©lingara', 'Gaoual'] },
                        { id: 'medina-yoro-foulah-dept', nom: 'M√©dina Yoro Foulah', communes: ['M√©dina Yoro Foulah', 'Dialacoto'] }
                    ]
                },
                {
                    id: 'sedhiou',
                    nom: 'üå≥ S√©dhiou',
                    code: 'SD',
                    departements: [
                        { id: 'sedhiou-dept', nom: 'S√©dhiou', communes: ['S√©dhiou', 'Kabrousse'] },
                        { id: 'bounkiling-dept', nom: 'Bounkiling', communes: ['Bounkiling', 'Linkering'] },
                        { id: 'goudomp-dept', nom: 'Goudomp', communes: ['Goudomp', 'Yarol'] }
                    ]
                },
                {
                    id: 'louga',
                    nom: 'üê† Louga',
                    code: 'LG',
                    departements: [
                        { id: 'louga-dept', nom: 'Louga', communes: ['Louga', 'Gueoul'] },
                        { id: 'kebemer-dept', nom: 'K√©b√©mer', communes: ['K√©b√©mer', 'Tataguine'] },
                        { id: 'linguere-dept', nom: 'Lingu√®re', communes: ['Lingu√®re', 'Dodji'] }
                    ]
                }
            ],
            
            getRegions: function() {
                return this.regions;
            },
            
            getDepartements: function(regionId) {
                const region = this.regions.find(r => r.id === regionId);
                return region ? region.departements : [];
            },
            
            getCommunes: function(regionId, departementId) {
                const region = this.regions.find(r => r.id === regionId);
                if (!region) return [];
                const dept = region.departements.find(d => d.id === departementId);
                return dept ? dept.communes : [];
            }
        };

        // ============ FONCTIONS G√âOGRAPHIQUES ============
        function initialiserSelectsGeographiques() {
            console.log('‚úÖ Initialiser les selects g√©ographiques');
            const regionSelect = document.getElementById('region');
            if (!regionSelect) {
                console.error('‚ùå Element region select non trouv√©');
                return;
            }
            
            regionSelect.innerHTML = '<option value="">-- S√©lectionner une r√©gion --</option>';
            
            SENEGAL_REGIONS.getRegions().forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = region.nom;
                regionSelect.appendChild(option);
            });
            
            console.log(`‚úÖ ${SENEGAL_REGIONS.getRegions().length} r√©gions charg√©es`);
        }
        
        function mettreAJourDepartements() {
            console.log('üîÑ MISE √Ä JOUR DES D√âPARTEMENTS');
            const regionSelect = document.getElementById('region');
            const departementSelect = document.getElementById('departement');
            const communeSelect = document.getElementById('commune');
            
            const regionId = regionSelect.value;
            console.log(`   R√©gion s√©lectionn√©e: "${regionId}"`);
            
            // R√©initialiser les autres selects
            departementSelect.innerHTML = '<option value="">-- S√©lectionner un d√©partement --</option>';
            communeSelect.innerHTML = '<option value="">-- S√©lectionner une commune --</option>';
            
            if (!regionId) {
                console.warn('   ‚ö†Ô∏è Aucune r√©gion s√©lectionn√©e');
                return;
            }
            
            // R√©cup√©rer et remplir les d√©partements
            const departements = SENEGAL_REGIONS.getDepartements(regionId);
            console.log(`   ‚úÖ ${departements.length} d√©partements trouv√©s`);
            
            departements.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.nom;
                departementSelect.appendChild(option);
            });
        }
        
        function mettreAJourCommunes() {
            console.log('üîÑ MISE √Ä JOUR DES COMMUNES');
            const regionSelect = document.getElementById('region');
            const departementSelect = document.getElementById('departement');
            const communeSelect = document.getElementById('commune');
            
            const regionId = regionSelect.value;
            const departementId = departementSelect.value;
            
            console.log(`   R√©gion: "${regionId}", D√©partement: "${departementId}"`);
            
            // R√©initialiser le select des communes
            communeSelect.innerHTML = '<option value="">-- S√©lectionner une commune --</option>';
            
            if (!regionId || !departementId) {
                console.warn('   ‚ö†Ô∏è R√©gion ou d√©partement manquant');
                return;
            }
            
            // R√©cup√©rer et remplir les communes
            const communes = SENEGAL_REGIONS.getCommunes(regionId, departementId);
            console.log(`   ‚úÖ ${communes.length} communes trouv√©es`);
            
            communes.forEach(commune => {
                const option = document.createElement('option');
                option.value = commune;
                option.textContent = commune;
                communeSelect.appendChild(option);
            });
        }

        // ============ PWA & Service Worker Enregistrement ============
        let deferredPrompt;
        let swRegistration = null;

        // Enregistrer le Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    swRegistration = registration;
                    console.log('‚úÖ Service Worker enregistr√©:', registration);
                    
                    // V√©rifier les mises √† jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'activated') {
                                showAlert('info', '‚úÖ Nouvelle version disponible! Rechargez la page.');
                            }
                        });
                    });
                    
                    // Polling pour les mises √† jour
                    setInterval(() => {
                        registration.update();
                    }, 60000);
                }).catch(error => {
                    console.warn('‚ùå Erreur SW:', error);
                });
            });
        }

        // Gestion de l'install prompt PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Afficher le bouton d'installation
            document.getElementById('install-prompt').classList.remove('hidden');
        });

        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ Application install√©e!');
            document.getElementById('install-prompt').classList.add('hidden');
            showAlert('success', 'üì± Application install√©e avec succ√®s!');
            deferredPrompt = null;
        });

        // Fonction d'installation PWA
        function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((outcome) => {
                if (outcome.outcome === 'accepted') {
                    console.log('‚úÖ Installation accept√©e');
                } else {
                    console.log('‚ùå Installation refus√©e');
                }
                deferredPrompt = null;
            });
        }

        // Masquer l'avis d'installation
        function dismissInstall() {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // D√©tection de la connectivit√©
        window.addEventListener('online', () => {
            showAlert('success', 'üåê Connect√© √† internet');
        });

        window.addEventListener('offline', () => {
            showAlert('info', 'üìµ Mode hors ligne activ√© - Les donn√©es seront synchronis√©es');
        });

        // Si d√©j√† install√©e ou accessible en standalone
        if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // ============ Variables et Donn√©es ============
        let map;
        let userLocationMarker;
        let videoStream;
        
        let donnees = {
            partenaire: '',
            region: '',
            departement: '',
            commune: '',
            typeActivite: [],
            sites_concernes: '',
            superficie: '',
            besoinPersonnel: '',
            dispositifDeploy: '',
            nombreRotation: '',
            infrastructureGestion: '',
            frequenceCollecte: '',
            bacs240: '',
            caissePolybene: '',
            bacs660: '',
            accessibilite: '',
            observation: '',
            latitude: null,
            longitude: null,
            precision: null,
            coordonneeX: '',
            coordonneeY: '',
            photo: null,
            dateCollecte: new Date().toISOString()
        };
        
        // Initialiser la carte avec optimisations
        function initMap() {
            map = L.map('map').setView([13.1939, -15.5277], 13); // Coordonn√©es Ziguinchor
            
            // Ajouter les tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                crossOrigin: true,
                className: 'leaflet-tiles-offline'
            }).addTo(map);
            
            // Ajouter un marqueur de d√©part
            L.marker([13.1939, -15.5277], {
                title: 'Ziguinchor (Si√®ge SONAGED)'
            }).addTo(map).bindPopup('<b>Ziguinchor</b><br>Si√®ge SONAGED');
            
            // Optimisation pour mobile
            if (window.innerWidth < 768) {
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
            }
        }

        // Informations sur le cache
        function afficherInfoCache() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const percentUsed = (estimate.usage / estimate.quota) * 100;
                    console.log(`Cache utilis√©: ${(estimate.usage / 1024 / 1024).toFixed(2)} MB / ${(estimate.quota / 1024 / 1024).toFixed(2)} MB (${percentUsed.toFixed(1)}%)`);
                });
            }
        }

        // Nettoyer le cache
        function nettoyerCache() {
            if (swRegistration) {
                swRegistration.active.postMessage({ type: 'CLEAR_CACHE' });
                showAlert('success', 'üóëÔ∏è Cache en cours de nettoyage...');
            }
        }
        
        // Mettre √† jour les sites - fonction d√©sactiv√©e (le champ siteConcerne a √©t√© supprim√©)
        function mettreAJourSites() {
            // Cette fonction est conserv√©e pour compatibilit√© mais ne fait rien
            // Le champ siteConcerne a √©t√© supprim√© du formulaire
        }
        
        // G√©olocalisation GPS
        // G√©olocalisation am√©lior√©e avec conversion UTM
        let watchPositionId = null;

        function obtenirLocalisationGPS() {
            // V√©rification du protocole
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('error', '‚ö†Ô∏è La g√©olocalisation n√©cessite HTTPS. Veuillez utiliser une connexion s√©curis√©e ou localhost.');
                return;
            }
            
            if (!navigator.geolocation) {
                showAlert('error', '‚ùå La g√©olocalisation n\'est pas support√©e par votre navigateur');
                return;
            }
            
            showAlert('info', 'üì° Demande de permission pour acc√©der √† la localisation...');
            
            // Options pour haute pr√©cision
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,  // Augment√© √† 15 secondes
                maximumAge: 0
            };

            // Utiliser watchPosition pour suivi continu
            watchPositionId = navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    const altitude = position.coords.altitude ? Math.round(position.coords.altitude) : 'N/A';
                    const heading = position.coords.heading ? Math.round(position.coords.heading) : 'N/A';
                    const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) : '0'; // m/s to km/h
                    
                    donnees.latitude = lat;
                    donnees.longitude = lon;
                    donnees.precision = accuracy;
                    
                    // Afficher les coordonn√©es
                    document.getElementById('lat').textContent = lat.toFixed(6);
                    document.getElementById('lon').textContent = lon.toFixed(6);
                    document.getElementById('accuracy').textContent = accuracy;
                    
                    // Convertir en UTM
                    const utm = latLonToUTM(lat, lon);
                    document.getElementById('utm-easting').textContent = utm.easting.toFixed(2);
                    document.getElementById('utm-northing').textContent = utm.northing.toFixed(2);
                    document.getElementById('coordonneeX').value = utm.easting.toFixed(2);
                    document.getElementById('coordonneeY').value = utm.northing.toFixed(2);
                    donnees.coordonneeX = utm.easting.toFixed(2);
                    donnees.coordonneeY = utm.northing.toFixed(2);
                    
                    // Centrer la carte et ajouter un marqueur
                    map.setView([lat, lon], 17);
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    
                    const popupContent = `<b>üìç Votre Position</b><br>
                    <strong>Latitude:</strong> ${lat.toFixed(6)}¬∞<br>
                    <strong>Longitude:</strong> ${lon.toFixed(6)}¬∞<br>
                    <strong>Pr√©cision:</strong> ¬±${accuracy}m<br>
                    <strong>Altitude:</strong> ${altitude}m<br>
                    <strong>Vitesse:</strong> ${speed} km/h<br>
                    <strong>Orientation:</strong> ${heading}¬∞<br>
                    <strong>UTM Easting:</strong> ${utm.easting.toFixed(2)}<br>
                    <strong>UTM Northing:</strong> ${utm.northing.toFixed(2)}`;
                    
                    userLocationMarker = L.circleMarker([lat, lon], {
                        radius: 8,
                        fillColor: '#667eea',
                        color: '#764ba2',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8,
                        title: 'Votre position'
                    }).addTo(map).bindPopup(popupContent);
                    
                    showAlert('success', `‚úÖ Position obtenue! Pr√©cision: ¬±${accuracy}m`);
                },
                function(error) {
                    let errorMsg = '';
                    console.error('üî¥ Erreur g√©olocalisation code:', error.code, 'message:', error.message);
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Acc√®s √† la g√©olocalisation refus√©. ';
                            errorMsg += 'Veuillez v√©rifier les permissions de votre navigateur. ';
                            errorMsg += 'Allez dans Param√®tres > Permissions de site et autorisez l\'acc√®s √† votre localisation.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Position indisponible. Assurez-vous que le GPS est activ√© et que vous √™tes en ext√©rieur.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'D√©lai d√©pass√© (15s). Essayez dans un endroit avec meilleure r√©ception GPS.';
                            break;
                        default:
                            errorMsg = error.message || 'Erreur inconnue';
                    }
                    showAlert('error', '‚ùå Erreur GPS: ' + errorMsg);
                },
                options
            );
        }

        // Fonction de conversion Lat/Lon en UTM
        function latLonToUTM(lat, lon) {
            // R√©f√©rence: WGS84
            const k0 = 0.9996;
            const E = 0.00669438;
            const E2 = E / (1 - E);
            const N0 = 0;
            const E0 = 500000;
            
            const zone = Math.floor((lon + 180) / 6) + 1;
            const lon0 = (zone - 1) * 6 - 180 + 3;
            
            const N = Math.cos(lat * Math.PI / 180);
            const T = Math.tan(lat * Math.PI / 180);
            const C = E2 * N * N;
            const A = (lon - lon0) * Math.PI / 180 * N;
            
            const M = 111132.92 * lat - 16216.94 * Math.sin(2 * lat * Math.PI / 180) + 
                      17.21 * Math.sin(4 * lat * Math.PI / 180) - 
                      0.094 * Math.sin(6 * lat * Math.PI / 180);
            
            const easting = E0 + k0 * 6378137 * (A + (A * A * A / 6) * (1 - T * T + C) + 
                            (A * A * A * A * A / 120) * (5 - 18 * T * T + T * T * T * T + 72 * C - 58 * E2));
            
            const northing = N0 + k0 * (M + 6378137 * (T * (A * A / 2) + (T * (A * A * A * A / 24)) * 
                            (5 - T * T + 9 * C + 4 * C * C) + 
                            (T * (A * A * A * A * A * A / 720)) * (61 - 58 * T * T + T * T * T * T + 600 * C - 330 * E2)));
            
            return {
                easting: easting,
                northing: northing,
                zone: zone
            };
        }

        // Arr√™ter le suivi GPS
        function arreterLocalisationGPS() {
            if (watchPositionId !== null) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
                showAlert('info', '‚èπÔ∏è Suivi GPS arr√™t√©');
            }
        }
        
        // Cam√©ra - Version am√©lior√©e
        function demarrerCamera() {
            const video = document.getElementById('video');
            
            // V√©rifier les permissions HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('error', '‚ùå La cam√©ra n√©cessite HTTPS (ou localhost pour test)');
                return;
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('error', '‚ùå Votre navigateur ne supporte pas la cam√©ra\n\nüí° Essayez avec Chrome, Firefox ou Edge');
                return;
            }
            
            showAlert('info', 'üìπ Demande d\'acc√®s √† la cam√©ra...');
            
            // Essayer avec facingMode 'environment' d'abord (cam√©ra arri√®re)
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            })
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.play().catch(err => console.warn('Play warning:', err));
                    video.style.display = 'block';
                    showAlert('success', '‚úÖ Cam√©ra activ√©e avec succ√®s!');
                    console.log('üìπ Stream video actif');
                })
                .catch(err => {
                    console.error('‚ùå Erreur cam√©ra:', err);
                    
                    // Fallback: essayer sans facingMode
                    navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    })
                        .then(stream => {
                            videoStream = stream;
                            video.srcObject = stream;
                            video.play().catch(err => console.warn('Play warning:', err));
                            video.style.display = 'block';
                            showAlert('success', '‚úÖ Cam√©ra activ√©e!');
                        })
                        .catch(err2 => {
                            let message = '‚ùå Erreur cam√©ra: ';
                            if (err.name === 'NotAllowedError') {
                                message += 'Permission refus√©e. Acceptez l\'acc√®s √† la cam√©ra.';
                            } else if (err.name === 'NotFoundError') {
                                message += 'Aucune cam√©ra d√©tect√©e sur votre appareil.';
                            } else {
                                message += err.name + ': ' + err.message;
                            }
                            showAlert('error', message);
                            console.error('Erreur cam√©ra compl√®te:', err2);
                        });
                });
        }
        
        function arreterCamera() {
            const video = document.getElementById('video');
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
                videoStream = null;
                showAlert('info', '‚èπÔ∏è Cam√©ra arr√™t√©e');
            }
        }
        
        function capturerPhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!videoStream) {
                showAlert('error', '‚ùå Veuillez d√©marrer la cam√©ra d\'abord');
                return;
            }
            
            showAlert('info', 'üì∏ Compression de la photo...');
            
            // Cr√©er un canvas de taille r√©duite pour compresser
            const maxWidth = 800;
            const maxHeight = 600;
            
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            // Redimensionner si trop grand
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width = width * ratio;
                height = height * ratio;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, width, height);
            canvas.style.display = 'block';
            
            // Compresser en JPEG basse qualit√© (0.7 = 70%)
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            
            // V√©rifier la taille maximale (5MB = 5242880 bytes)
            const maxSize = 5242880;
            const dataSize = imageData.length;
            
            if (dataSize > maxSize) {
                showAlert('error', `‚ùå Photo trop grosse: ${(dataSize/1024/1024).toFixed(1)}MB (max 5MB)`);
                return;
            }
            
            donnees.photo = imageData;
            
            // üîë R√©cup√©rer le site et cr√©er le nom du fichier
            const siteElement = document.getElementById('adresse');
            const communeElement = document.getElementById('commune');
            const regionElement = document.getElementById('region');
            const departementElement = document.getElementById('departement');
            const activitesElement = document.getElementById('activites-group');
            
            let siteName = siteElement ? siteElement.value.trim() : 'site_inconnu';
            let communeName = communeElement ? communeElement.options[communeElement.selectedIndex]?.text : 'commune';
            let regionName = regionElement ? regionElement.options[regionElement.selectedIndex]?.text : 'region';
            let deptName = departementElement ? departementElement.options[departementElement.selectedIndex]?.text : 'dept';
            
            // R√©cup√©rer les activit√©s s√©lectionn√©es
            let activites = [];
            if (activitesElement) {
                const checkboxes = activitesElement.querySelectorAll('input[type="checkbox"]:checked');
                activites = Array.from(checkboxes).map(cb => cb.labels[0].textContent.trim());
            }
            
            // Nettoyer les noms (supprimer caract√®res sp√©ciaux)
            siteName = siteName.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 30);
            communeName = communeName.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 20);
            
            // Cr√©er le nom du fichier avec date
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            const filename = `photo_${communeName}_${siteName}_${dateStr}_${timeStr}.jpg`;
            
            // Stocker le filename pour le t√©l√©chargement
            window.currentPhotoFilename = filename;
            
            // üì∏ Cr√©er un nouvel objet photo pour la galerie
            const newPhoto = {
                id: galleriePhotos.length + 1,
                commune: communeName,
                partenaire: "SONAGED",
                site: siteName,
                dept: deptName,
                region: regionName,
                activites: activites.join(", "),
                superficie: document.getElementById('superficie')?.value || "0.00 ha",
                personnel: document.getElementById('personnel')?.value || "0",
                dispositifs: document.getElementById('dispositif')?.value || "N/A",
                frequence: document.getElementById('frequence')?.value || "F1",
                accessibilite: document.getElementById('accessibilite')?.value || "Facile",
                lat: "0.0000¬∞N",
                lng: "0.0000¬∞O",
                src: imageData // Photo en base64
            };
            
            // Ajouter la photo √† la galerie
            galleriePhotos.unshift(newPhoto); // Ajouter au d√©but
            
            // Ajouter l'√©l√©ment HTML √† la galerie
            const galerieScroll = document.querySelector('.galerie-scroll');
            if (galerieScroll) {
                const newItem = document.createElement('div');
                newItem.className = 'galerie-item';
                newItem.dataset.photoId = newPhoto.id; // Ajouter un data attribute pour identifier
                newItem.onclick = () => openGalerieModalByPhotoId(newPhoto.id); // Chercher par ID
                newItem.innerHTML = `
                    <img class="galerie-item-image" src="${imageData}" alt="${siteName}">
                    <div class="galerie-item-info">
                        <div class="galerie-item-detail"><strong>Partenaire:</strong> SONAGED</div>
                        <div class="galerie-item-commune">üìç ${communeName}</div>
                        <div class="galerie-item-detail"><strong>Site:</strong> ${siteName}</div>
                    </div>
                `;
                galerieScroll.insertBefore(newItem, galerieScroll.firstChild);
            }
            
            // Mettre √† jour les statistiques
            const statsNumber = document.querySelector('.galerie-stat-item .galerie-stat-number');
            if (statsNumber) {
                statsNumber.textContent = galleriePhotos.length;
            }
            
            // ‚úÖ AFFICHER LA PR√âVIEW (avec v√©rification compl√®te)
            const previewImg = document.getElementById('preview-img');
            if (previewImg) {
                previewImg.src = imageData;
                previewImg.style.display = 'block';
                previewImg.style.maxWidth = '100%';
                previewImg.style.height = 'auto';
                previewImg.style.borderRadius = '8px';
                previewImg.style.marginTop = '10px';
            }
            
            // Update filename display
            const filenameSpan = document.getElementById('photo-filename');
            if (filenameSpan) {
                filenameSpan.textContent = filename;
            }
            
            // Show the image preview container
            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) {
                imagePreview.classList.remove('hidden');
                imagePreview.style.display = 'block';
            }
            
            showAlert('success', `‚úÖ Photo captur√©e et ajout√©e √† la galerie (${(dataSize/1024).toFixed(0)}KB)`);
        }
        
        // üì• Fonction pour t√©l√©charger l'image (compatible mobile)
        function telechargerPhoto() {
            const imageData = donnees.photo;
            if (!imageData) {
                showAlert('error', '‚ùå Aucune photo √† t√©l√©charger');
                return;
            }
            
            const filename = window.currentPhotoFilename || 'photo.jpg';
            
            try {
                // Convertir data URL en Blob pour meilleure compatibilit√© mobile
                fetch(imageData)
                    .then(res => res.blob())
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        // Lib√©rer la m√©moire
                        URL.revokeObjectURL(url);
                        showAlert('success', `‚úÖ Image t√©l√©charg√©e: ${filename}`);
                    })
                    .catch(err => {
                        console.error('Erreur Blob:', err);
                        // Fallback: utiliser la m√©thode directe
                        const link = document.createElement('a');
                        link.href = imageData;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showAlert('success', `‚úÖ Image t√©l√©charg√©e: ${filename}`);
                    });
            } catch (error) {
                console.error('Erreur t√©l√©chargement:', error);
                showAlert('error', '‚ùå Erreur lors du t√©l√©chargement');
            }
        }
        
        function effacerPhoto() {
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            
            canvas.style.display = 'none';
            preview.classList.add('hidden');
            previewImg.src = '';
            donnees.photo = null;
            showAlert('info', 'üóëÔ∏è Photo supprim√©e');
        }
        
        // Formulaire
        function sauvegarderDonnees() {
            try {
                console.group('üìã COLLECTE DES DONN√âES - sauvegarderDonnees()');
                
                // üîç V√©rifier d'abord que les √©l√©ments existent
                console.log('1Ô∏è‚É£ R√©cup√©ration des √©l√©ments HTML par ID:');
                
                const partenaire_elem = document.getElementById('partenaire');
                const region_elem = document.getElementById('region');
                const departement_elem = document.getElementById('departement');
                const commune_elem = document.getElementById('commune');
                
                console.log(`   ‚úì partenaire: ${partenaire_elem ? '‚úÖ TROUV√â' : '‚ùå MANQUANT'}`);
                console.log(`   ‚úì region: ${region_elem ? '‚úÖ TROUV√â' : '‚ùå MANQUANT'}`);
                console.log(`   ‚úì departement: ${departement_elem ? '‚úÖ TROUV√â' : '‚ùå MANQUANT'}`);
                console.log(`   ‚úì commune: ${commune_elem ? '‚úÖ TROUV√â' : '‚ùå MANQUANT'}`);
                
                // R√©cup√©rer les valeurs avec d√©tails
                console.log('\n2Ô∏è‚É£ Lecture des valeurs:');
                
                donnees.partenaire = partenaire_elem ? partenaire_elem.value.trim() : '';
                donnees.region = region_elem ? region_elem.value.trim() : '';
                donnees.departement = departement_elem ? departement_elem.value.trim() : '';
                donnees.commune = commune_elem ? commune_elem.value.trim() : '';
                
                // AIDE POUR R√âGION - r√©cup√©rer aussi le texte affich√©
                let regionText = '';
                if (region_elem && region_elem.selectedIndex >= 0) {
                    regionText = region_elem.options[region_elem.selectedIndex].text;
                }
                
                // AIDE POUR D√âPARTEMENT - r√©cup√©rer aussi le texte affich√©
                let departementText = '';
                if (departement_elem && departement_elem.selectedIndex >= 0) {
                    departementText = departement_elem.options[departement_elem.selectedIndex].text;
                }
                
                // AIDE POUR COMMUNE - r√©cup√©rer aussi le texte affich√©
                let communeText = '';
                if (commune_elem && commune_elem.selectedIndex >= 0) {
                    communeText = commune_elem.options[commune_elem.selectedIndex].text;
                }
                
                console.log(`   partenaire = "${donnees.partenaire}"`);
                console.log(`   region = "${donnees.region}" | text="${regionText}"`);
                console.log(`   departement = "${donnees.departement}" | text="${departementText}"`);
                console.log(`   commune = "${donnees.commune}" | text="${communeText}"`);
                
                // R√©cup√©rer tous les types d'activit√© s√©lectionn√©s
                const typeActiviteSelect = document.getElementById('typeActivite');
                const selectedTypes = typeActiviteSelect ? Array.from(typeActiviteSelect.selectedOptions).map(option => option.value) : [];
                donnees.typeActivite = selectedTypes.length > 0 ? selectedTypes : [];
                
                donnees.sites_concernes = document.getElementById('adresse') ? document.getElementById('adresse').value : '';
                donnees.superficie = document.getElementById('superficie') ? document.getElementById('superficie').value : '';
                donnees.besoinPersonnel = document.getElementById('besoinPersonnel') ? document.getElementById('besoinPersonnel').value : '';
                
                // R√©cup√©rer tous les dispositifs s√©lectionn√©s
                const dispositifSelect = document.getElementById('dispositifDeploy');
                const selectedDisposition = dispositifSelect ? Array.from(dispositifSelect.selectedOptions).map(option => option.value) : [];
                donnees.dispositifDeploy = selectedDisposition.length > 0 ? selectedDisposition : [];
                
                donnees.nombreRotation = document.getElementById('nombreRotation') ? document.getElementById('nombreRotation').value : '';
                donnees.infrastructureGestion = document.getElementById('infrastructureGestion') ? document.getElementById('infrastructureGestion').value : '';
                donnees.frequenceCollecte = document.getElementById('frequenceCollecte') ? document.getElementById('frequenceCollecte').value : '';
                donnees.bacs240 = document.getElementById('bacs240') ? document.getElementById('bacs240').value : '';
                donnees.caissePolybene = document.getElementById('caissePolybene') ? document.getElementById('caissePolybene').value : '';
                donnees.bacs660 = document.getElementById('bacs660') ? document.getElementById('bacs660').value : '';
                donnees.accessibilite = document.getElementById('accessibilite') ? document.getElementById('accessibilite').value : '';
                donnees.observation = document.getElementById('observation') ? document.getElementById('observation').value : '';
                
                // R√©cup√©rer les coordonn√©es UTM si elles existent
                const coordXElem = document.getElementById('coordonneeX');
                const coordYElem = document.getElementById('coordonneeY');
                donnees.coordonneeX = coordXElem ? coordXElem.value : '';
                donnees.coordonneeY = coordYElem ? coordYElem.value : '';
                
                console.log('\n3Ô∏è‚É£ OBJET donnees FINAL:', donnees);
                
                // ‚ö†Ô∏è ALERTE SI DONN√âES VIDES
                if (!donnees.region) {
                    console.warn('‚ö†Ô∏è ALERTE: R√©gion est vide! V√©rifiez que vous avez s√©lectionn√© une r√©gion dans le dropdown.');
                }
                if (!donnees.departement) {
                    console.warn('‚ö†Ô∏è ALERTE: D√©partement est vide! V√©rifiez que vous avez s√©lectionn√© un d√©partement dans le dropdown.');
                }
                if (!donnees.commune) {
                    console.warn('‚ö†Ô∏è ALERTE: Commune est vide! V√©rifiez que vous avez s√©lectionn√© une commune dans le dropdown.');
                }
                
                console.groupEnd();
                
                showAlert('success', '‚úÖ Donn√©es collect√©es localement!');
            } catch (error) {
                console.error('‚ùå Erreur lors de la r√©cup√©ration des donn√©es:', error);
                console.error('Stack:', error.stack);
                showAlert('error', '‚ùå Erreur: ' + error.message);
            }
        }
        
        function affichageResume() {
            const summary = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            let html = `
                <div class="data-item">
                    <div class="data-label">Partenaire:</div>
                    <div class="data-value">${donnees.partenaire}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">R√©gion:</div>
                    <div class="data-value">${donnees.region}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">D√©partement:</div>
                    <div class="data-value">${donnees.departement}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Commune:</div>
                    <div class="data-value">${donnees.commune}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Type d'Activit√©:</div>
                    <div class="data-value">${Array.isArray(donnees.typeActivite) ? donnees.typeActivite.join(', ') : donnees.typeActivite}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Sites Concern√©s:</div>
                    <div class="data-value">${donnees.sites_concernes}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Superficie:</div>
                    <div class="data-value">${donnees.superficie} ha</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Besoin en Personnel:</div>
                    <div class="data-value">${donnees.besoinPersonnel}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Dispositif D√©ploy√©:</div>
                    <div class="data-value">${Array.isArray(donnees.dispositifDeploy) ? donnees.dispositifDeploy.join(', ') : donnees.dispositifDeploy}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Nombre de Rotation:</div>
                    <div class="data-value">${donnees.nombreRotation}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Infrastructure de Gestion:</div>
                    <div class="data-value">${donnees.infrastructureGestion}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Fr√©quence de Collecte:</div>
                    <div class="data-value">${donnees.frequenceCollecte}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Bacs 240L:</div>
                    <div class="data-value">${donnees.bacs240}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Caisse Polybene:</div>
                    <div class="data-value">${donnees.caissePolybene}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Bacs 660L:</div>
                    <div class="data-value">${donnees.bacs660}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Accessibilit√©:</div>
                    <div class="data-value">${donnees.accessibilite}</div>
                </div>
            `;
            
            if (donnees.latitude) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Latitude:</div>
                        <div class="data-value">${donnees.latitude.toFixed(6)}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Longitude:</div>
                        <div class="data-value">${donnees.longitude.toFixed(6)}</div>
                    </div>
                `;
            }
            
            if (donnees.coordonneeX || donnees.coordonneeY) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Coordonn√©es X (UTM):</div>
                        <div class="data-value">${donnees.coordonneeX}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Coordonn√©es Y (UTM):</div>
                        <div class="data-value">${donnees.coordonneeY}</div>
                    </div>
                `;
            }
            
            if (donnees.observation) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Observations:</div>
                        <div class="data-value">${donnees.observation}</div>
                    </div>
                `;
            }
            
            if (donnees.photo) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Photo Captur√©e:</div>
                        <div class="data-value">‚úÖ Oui</div>
                    </div>
                `;
            }
            
            summaryContent.innerHTML = html;
            summary.style.display = 'block';
        }
        
        function exporterExcel(avecImage = true) {
            const ExcelJS = window.ExcelJS;
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Collecte de Donn√©es');
            
            // D√©finir les largeurs de colonnes
            worksheet.columns = [
                { width: 40 },
                { width: 50 }
            ];
            
            let rowCount = 1;
            
            // Titre principal
            const titleRow = worksheet.getRow(rowCount);
            titleRow.values = ['DIMENSIONNEMENT SONAGED - COLLECTE DE DONN√âES'];
            titleRow.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 14 };
            titleRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            titleRow.alignment = { horizontal: 'center', vertical: 'center' };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Informations du Site
            const sectionRow1 = worksheet.getRow(rowCount);
            sectionRow1.values = ['INFORMATIONS DU SITE'];
            sectionRow1.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow1.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            // Donn√©es du site
            const siteData = [
                ['R√©gion', donnees.region || 'R√©gion de Ziguinchor'],
                ['D√©partement', donnees.departement],
                ['Commune', donnees.commune],
                ['Type d\'Activit√©', donnees.typeActivite],
                ['Sites Concern√©s', donnees.sites_concernes],
                ['Superficie (ha)', donnees.superficie],
                ['Besoin en Personnel', donnees.besoinPersonnel],
                ['Dispositif D√©ploy√©', Array.isArray(donnees.dispositifDeploy) ? donnees.dispositifDeploy.join(', ') : donnees.dispositifDeploy],
                ['Nombre de Rotation', donnees.nombreRotation],
                ['Infrastructure de Gestion', donnees.infrastructureGestion],
                ['Fr√©quence de Collecte', donnees.frequenceCollecte],
                ['Bacs 240L', donnees.bacs240],
                ['Caisse Polybene', donnees.caissePolybene],
                ['Bacs 660L', donnees.bacs660],
                ['Accessibilit√©', donnees.accessibilite],
                ['Observations', donnees.observation]
            ];
            
            siteData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Localisation GPS
            const sectionRow2 = worksheet.getRow(rowCount);
            sectionRow2.values = ['LOCALISATION GPS'];
            sectionRow2.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow2.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const gpsData = [
                ['Latitude', donnees.latitude ? donnees.latitude.toFixed(6) : '--'],
                ['Longitude', donnees.longitude ? donnees.longitude.toFixed(6) : '--'],
                ['Pr√©cision (m)', donnees.precision || '--']
            ];
            
            gpsData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Localisation UTM
            const sectionRow3 = worksheet.getRow(rowCount);
            sectionRow3.values = ['LOCALISATION DU SITE (UTM)'];
            sectionRow3.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow3.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF69B4' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const utmData = [
                ['Coordonn√©es X (Easting)', donnees.coordonneeX],
                ['Coordonn√©es Y (Northing)', donnees.coordonneeY]
            ];
            
            utmData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Photo
            if (donnees.photo) {
                const sectionRow4 = worksheet.getRow(rowCount);
                sectionRow4.values = ['PHOTO CAPTUR√âE'];
                sectionRow4.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
                sectionRow4.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF10B981' } };
                worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
                rowCount++;
                
                // Convertir le canvas/data URL en image et l'ajouter
                const imageBase64 = donnees.photo.split('data:image/jpeg;base64,')[1] || donnees.photo;
                const imageId = workbook.addImage({
                    base64: imageBase64,
                    extension: 'jpeg'
                });
                
                // Ajouter l'image √† la feuille
                worksheet.addImage(imageId, {
                    tl: { col: 0, row: rowCount - 1 },
                    ext: { width: 400, height: 400 }
                });
                
                rowCount += 15;
            }
            
            // Section: Informations de collecte
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            const sectionRow5 = worksheet.getRow(rowCount);
            sectionRow5.values = ['INFORMATIONS DE COLLECTE'];
            sectionRow5.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow5.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const collecteData = [
                ['Date de Collecte', new Date(donnees.dateCollecte).toLocaleString('fr-FR')],
                ['Photo Captur√©e', donnees.photo ? 'Oui' : 'Non']
            ];
            
            collecteData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            // G√©n√©rer et t√©l√©charger le fichier
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `SONAGED_Collecte_${new Date().getTime()}.xlsx`;
                link.click();
                URL.revokeObjectURL(url);
                showAlert('success', '‚úÖ Fichier Excel export√© avec succ√®s!');
            });
        }
        
        function exporterJSON() {
            const dataStr = JSON.stringify(donnees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `collecte_donnees_${new Date().getTime()}.json`;
            link.click();
        }
        
        function imprimerDonnees() {
            window.print();
        }
        
        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 4000);
        }
        
        // Afficher le r√©sum√© des donn√©es avant sauvegarde
        function afficherResume() {
            // R√©cup√©rer tous les champs du formulaire
            const region = document.getElementById('region').value;
            const regionLabel = document.getElementById('region').options[document.getElementById('region').selectedIndex]?.text;
            const departement = document.getElementById('departement').value;
            const departementLabel = document.getElementById('departement').options[document.getElementById('departement').selectedIndex]?.text;
            const commune = document.getElementById('commune').value;
            const typeActivite = Array.from(document.getElementById('typeActivite').selectedOptions).map(opt => opt.text).join(', ');
            const partenaire = document.getElementById('partenaire').value;
            const sites_concernes = document.getElementById('adresse').value;
            const superficie = document.getElementById('superficie').value;
            const besoinPersonnel = document.getElementById('besoinPersonnel').value;
            const dispositifDeploy = Array.from(document.getElementById('dispositifDeploy').selectedOptions).map(opt => opt.text).join(', ');
            const nombreRotation = document.getElementById('nombreRotation').value;
            const infrastructureGestion = document.getElementById('infrastructureGestion').value;
            const frequenceCollecte = document.getElementById('frequenceCollecte').value;
            const bacs240 = document.getElementById('bacs240').value;
            const caissePolybene = document.getElementById('caissePolybene').value;
            const bacs660 = document.getElementById('bacs660').value;
            const accessibilite = document.getElementById('accessibilite').value;
            const observation = document.getElementById('observation').value;
            const lat = document.getElementById('lat').textContent;
            const lon = document.getElementById('lon').textContent;
            const accuracy = document.getElementById('accuracy').textContent;
            const utmEasting = document.getElementById('utm-easting').textContent;
            const utmNorthing = document.getElementById('utm-northing').textContent;
            const photo = donnees.photo;
            
            if (!region || !departement || !commune) {
                alert('‚ùå Veuillez s√©lectionner la r√©gion, le d√©partement et la commune');
                return;
            }
            
            let resumeHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üìç LOCALISATION</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>R√©gion: <strong>${regionLabel || region}</strong></div>
                        <div>D√©partement: <strong>${departementLabel || departement}</strong></div>
                        <div>Commune: <strong>${commune}</strong></div>
                        <div>Sites Concern√©s: <strong>${adresse}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üìä INFORMATIONS PRINCIPALES</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Type d'Activit√©: <strong>${typeActivite || 'Non sp√©cifi√©'}</strong></div>
                        <div>Partenaire: <strong>${partenaire}</strong></div>
                        <div>Superficie: <strong>${superficie} ha</strong></div>
                        <div>Accessibilit√©: <strong>${accessibilite}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üë• RESSOURCES</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Besoin en Personnel: <strong>${besoinPersonnel} personne(s)</strong></div>
                        <div>Nombre de Rotations: <strong>${nombreRotation}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üõ†Ô∏è INFRASTRUCTURE & √âQUIPEMENTS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Dispositif D√©ploy√©: <strong>${dispositifDeploy || 'Non sp√©cifi√©'}</strong></div>
                        <div>Infrastructure de Gestion: <strong>${infrastructureGestion}</strong></div>
                        <div>Fr√©quence de Collecte: <strong>${frequenceCollecte}</strong></div>
                        <div>Bacs 240L: <strong>${bacs240}</strong></div>
                        <div>Caisse Polyb√®ne: <strong>${caissePolybene}</strong></div>
                        <div>Bacs 660L: <strong>${bacs660}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üó∫Ô∏è COORDONN√âES GPS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Latitude: <strong>${lat}</strong></div>
                        <div>Longitude: <strong>${lon}</strong></div>
                        <div>Pr√©cision: <strong>${accuracy}</strong></div>
                        <div style="font-size: 12px; margin-top: 8px; color: #666;">
                            UTM - Easting: <strong>${utmEasting}</strong> | Northing: <strong>${utmNorthing}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            if (observation) {
                resumeHTML += `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üìù OBSERVATIONS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>${observation}</div>
                    </div>
                </div>
                `;
            }
            
            if (photo) {
                resumeHTML += `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üì∑ PHOTO CAPTUR√âE</strong>
                    <div style="margin-top: 10px; text-align: center;">
                        <img src="${photo}" alt="Photo captur√©e" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 2px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    </div>
                </div>
                `;
            }
            
            resumeHTML += `
                <div style="background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%); padding: 15px; border-radius: 8px; text-align: center; font-size: 12px; color: #2d5016;">
                    <strong>‚úÖ V√©rifiez toutes les informations avant de sauvegarder</strong>
                </div>
            `;
            
            document.getElementById('resume-contenu').innerHTML = resumeHTML;
            document.getElementById('resume-section').style.display = 'block';
            
            // Scroller vers le r√©sum√©
            document.getElementById('resume-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ‚úÖ FONCTION DE VALIDATION POUR UN SEUL CHAMP
        function validerChamp(fieldId) {
            const champ = document.getElementById(fieldId);
            const errorElem = document.getElementById(`error-${fieldId}`);
            
            if (!champ || !errorElem) return true;
            
            const valeur = champ.value ? champ.value.toString().trim() : '';
            const estValide = valeur !== '' && valeur !== '0';
            
            if (!estValide) {
                errorElem.style.display = 'block';
                champ.style.borderColor = '#dc3545';
                champ.style.borderWidth = '2px';
            } else {
                errorElem.style.display = 'none';
                champ.style.borderColor = '';
                champ.style.borderWidth = '';
            }
            
            return estValide;
        }
        
        // ‚úÖ FONCTION DE VALIDATION COMPL√àTE DU FORMULAIRE
        function validerFormulaire() {
            console.log('üîç Validation du formulaire...');
            
            const champsObligatoires = [
                'region', 'departement', 'commune', 'typeActivite',
                'partenaire', 'sites_concernes', 'superficie', 'besoinPersonnel'
            ];
            
            let tousValides = true;
            const erreursMessages = [];
            
            champsObligatoires.forEach(fieldId => {
                const champ = document.getElementById(fieldId);
                if (!champ) return;
                
                let valeur = '';
                if (champ.type === 'select-multiple') {
                    valeur = Array.from(champ.selectedOptions).length > 0 ? 'ok' : '';
                } else {
                    valeur = champ.value ? champ.value.toString().trim() : '';
                }
                
                const estValide = valeur !== '' && valeur !== '0';
                
                if (!estValide) {
                    tousValides = false;
                    erreursMessages.push(`‚ùå ${champ.previousElementSibling?.textContent || fieldId}`);
                    validerChamp(fieldId);
                } else {
                    const errorElem = document.getElementById(`error-${fieldId}`);
                    if (errorElem) {
                        errorElem.style.display = 'none';
                        champ.style.borderColor = '';
                    }
                }
            });
            
            // V√©rifier GPS
            const lat = parseFloat(document.getElementById('lat')?.textContent || '');
            const lon = parseFloat(document.getElementById('lon')?.textContent || '');
            
            if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                tousValides = false;
                erreursMessages.push('‚ùå Coordonn√©es GPS obligatoires (cliquez sur "Obtenir Position GPS")');
            }
            
            // Afficher les erreurs
            if (!tousValides) {
                const message = '‚ö†Ô∏è ERREURS DE VALIDATION:\n\n' + erreursMessages.join('\n');
                console.error(message);
                showAlert('error', message);
            } else {
                console.log('‚úÖ Tous les champs sont valides!');
            }
            
            return tousValides;
        }
        
        // ‚úÖ FONCTION DE R√âINITIALISATION COMPL√àTE DES CHAMPS
        function reinitialiserFormulaire() {
            console.group('üßπ R√âINITIALISATION COMPL√àTE DU FORMULAIRE');
            
            // R√©initialiser le formulaire HTML
            const form = document.getElementById('collecte-form');
            if (form) {
                form.reset();
                console.log('  ‚úÖ Formulaire HTML r√©initialis√©');
            }
            
            // Masquer le r√©sum√©
            const resumeSection = document.getElementById('resume-section');
            if (resumeSection) {
                resumeSection.style.display = 'none';
                console.log('  ‚úÖ R√©sum√© masqu√©');
            }
            
            // R√©initialiser les coordonn√©es GPS
            document.getElementById('lat').textContent = '--';
            document.getElementById('lon').textContent = '--';
            document.getElementById('accuracy').textContent = '--';
            document.getElementById('utm-easting').textContent = '--';
            document.getElementById('utm-northing').textContent = '--';
            console.log('  ‚úÖ Coordonn√©es GPS r√©initialis√©es');
            
            // Masquer les images
            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) {
                imagePreview.classList.add('hidden');
                console.log('  ‚úÖ Aper√ßu image masqu√©');
            }
            
            const canvas = document.getElementById('canvas');
            if (canvas) {
                canvas.style.display = 'none';
                console.log('  ‚úÖ Canvas masqu√©');
            }
            
            // R√©initialiser l'objet global donnees
            donnees = {
                partenaire: '', region: '', departement: '', commune: '',
                typeActivite: [], sites_concernes: '', superficie: '',
                besoinPersonnel: '', dispositifDeploy: [], nombreRotation: '',
                infrastructureGestion: '', frequenceCollecte: '',
                bacs240: '', caissePolybene: '', bacs660: '',
                accessibilite: '', observation: '',
                latitude: null, longitude: null, precision: null,
                coordonneeX: '', coordonneeY: '', photo: null,
                dateCollecte: new Date().toISOString()
            };
            console.log('  ‚úÖ Objet donnees r√©initialis√©');
            
            // R√©initialiser la map
            if (typeof map !== 'undefined' && map !== null && typeof marker !== 'undefined' && marker !== null) {
                map.removeLayer(marker);
                marker = null;
                console.log('  ‚úÖ Marqueur supprim√© de la carte');
            }
            
            console.groupEnd();
            console.log('‚úÖ Formulaire, GPS et images compl√®tement vid√©s');
        }
        
        // ‚úÖ FONCTION QUI VALIDE PUIS SAUVEGARDE
        function validerEtSauvegarder() {
            if (validerFormulaire()) {
                sauvegarderDonneesBD();
            } else {
                console.log('‚õî Sauvegarde bloqu√©e: formulaire invalide');
            }
        }
        
        // Fonction pour sauvegarder en base de donn√©es
        function sauvegarderDonneesBD() {
            console.group('üî¥ COLLECTE DIRECTE DEPUIS LE FORMULAIRE HTML');
            
            // üî¥ COLLECTER DIRECTEMENT DES √âL√âMENTS HTML (pas de d√©pendance sur l'objet donnees)
            const partenaire = (document.getElementById('partenaire')?.value || '').trim();
            const region = (document.getElementById('region')?.value || '').trim();
            const departement = (document.getElementById('departement')?.value || '').trim();
            const commune = (document.getElementById('commune')?.value || '').trim();
            const sites_concernes = (document.getElementById('adresse')?.value || '').trim();
            const superficie = (document.getElementById('superficie')?.value || '').trim();
            const besoinPersonnel = (document.getElementById('besoinPersonnel')?.value || '').trim();
            const observation = (document.getElementById('observation')?.value || '').trim();
            
            // Collecte des √©l√©ments multi-select
            const typeActiviteSelect = document.getElementById('typeActivite');
            const typeActivite = typeActiviteSelect ? Array.from(typeActiviteSelect.selectedOptions).map(opt => opt.value) : [];
            
            const dispositifDeploySelect = document.getElementById('dispositifDeploy');
            const dispositifDeploy = dispositifDeploySelect ? Array.from(dispositifDeploySelect.selectedOptions).map(opt => opt.value) : [];
            
            // Collecte des champs optionnels
            const nombreRotation = (document.getElementById('nombreRotation')?.value || '').trim();
            const infrastructureGestion = (document.getElementById('infrastructureGestion')?.value || '').trim();
            const frequenceCollecte = (document.getElementById('frequenceCollecte')?.value || '').trim();
            const bacs240 = (document.getElementById('bacs240')?.value || '').trim();
            const caissePolybene = (document.getElementById('caissePolybene')?.value || '').trim();
            const bacs660 = (document.getElementById('bacs660')?.value || '').trim();
            const accessibilite = (document.getElementById('accessibilite')?.value || '').trim();
            
            // Collecte des GPS
            const latitude = parseFloat(document.getElementById('lat')?.textContent || donnees.latitude || '');
            const longitude = parseFloat(document.getElementById('lon')?.textContent || donnees.longitude || '');
            const precision = parseFloat(document.getElementById('accuracy')?.textContent || donnees.precision || '');
            const coordonneeX = (document.getElementById('utm-easting')?.textContent || donnees.coordonneeX || '').trim();
            const coordonneeY = (document.getElementById('utm-northing')?.textContent || donnees.coordonneeY || '').trim();
            
            // Photo depuis donnees globales
            const photo = donnees.photo || null;
            
            console.log('‚úÖ COLLECTE DIRECTE - R√©sultats:');
            console.log('  Partenaire:', partenaire);
            console.log('  R√©gion:', region);
            console.log('  D√©partement:', departement);
            console.log('  Commune:', commune);
            console.log('  Sites Concern√©s:', sites_concernes);
            console.log('  Superficie:', superficie);
            console.log('  Personnel:', besoinPersonnel);
            console.log('  Latitude:', latitude);
            console.log('  Longitude:', longitude);
            console.log('  Precision:', precision);
            
            console.groupEnd();
            
            // ‚úÖ VALIDATION STRICTE DES CHAMPS OBLIGATOIRES
            console.group('üî¥ VALIDATION STRUCTE');
            
            const champs_vides = [];
            
            if (!partenaire) champs_vides.push('Partenaire');
            if (!region) champs_vides.push('R√©gion');
            if (!departement) champs_vides.push('D√©partement');
            if (!commune) champs_vides.push('Commune');
            if (!sites_concernes) champs_vides.push('Sites Concern√©s');
            if (!superficie) champs_vides.push('Superficie');
            if (!besoinPersonnel) champs_vides.push('Besoin en Personnel');
            
            // Afficher les v√©rifications
            champs_vides.length === 0 && console.log('‚úÖ Tous les champs obligatoires sont remplis!');
            champs_vides.forEach(champ => console.error(`‚ùå ${champ} est VIDE`));
            
            console.groupEnd();
            
            // Si des champs obligatoires sont vides
            if (champs_vides.length > 0) {
                const message = `‚ùå ERREUR: Veuillez remplir les champs obligatoires manquants:\n\n${champs_vides.map(c => '‚Ä¢ ' + c).join('\n')}`;
                console.error(message);
                alert(message);
                showAlert('error', message);
                return;
            }
            
            // GPS obligatoire
            if (!latitude || !longitude || isNaN(latitude) || isNaN(longitude)) {
                showAlert('error', 'üìç Les coordonn√©es GPS sont obligatoires. Cliquez sur "üì° Obtenir Position GPS" d\'abord.');
                console.error('‚ùå GPS invalide - Latitude:', latitude, 'Longitude:', longitude);
                return;
            }
            
            // Afficher le r√©sum√© pour v√©rification
            afficherResume();
            
            // Demander confirmation
            if (!confirm('‚úÖ √ätes-vous s√ªr(e) de vouloir sauvegarder ces donn√©es en base de donn√©es ?')) {
                console.log('‚ÑπÔ∏è Sauvegarde annul√©e par l\'utilisateur');
                return;
            }
            
            console.log('üì§ Pr√™t √† envoyer les donn√©es au serveur');
            
            // Pr√©parer les donn√©es pour l'envoi (DIRECTEMENT depuis les variables locales)
            const dataToSend = {
                partenaire: partenaire,
                region: region,
                departement: departement,
                commune: commune,
                typeActivite: typeActivite.length > 0 ? typeActivite.join(',') : '',
                sites_concernes: sites_concernes,
                superficie: superficie,
                besoinPersonnel: besoinPersonnel,
                dispositifDeploy: dispositifDeploy.length > 0 ? dispositifDeploy.join(',') : '',
                nombreRotation: nombreRotation,
                infrastructureGestion: infrastructureGestion,
                frequenceCollecte: frequenceCollecte,
                bacs240: bacs240,
                caissePolybene: caissePolybene,
                bacs660: bacs660,
                accessibilite: accessibilite,
                observation: observation,
                latitude: latitude,
                longitude: longitude,
                precision: precision,
                coordonneeX: coordonneeX,
                coordonneeY: coordonneeY,
                photo: photo,
                dateCollecte: new Date().toISOString()
            };
            
            console.group('üü¢ DONN√âES √Ä ENVOYER AU SERVEUR');
            console.log('Partenaire:', dataToSend.partenaire);
            console.log('R√©gion:', dataToSend.region);
            console.log('D√©partement:', dataToSend.departement);
            console.log('Commune:', dataToSend.commune);
            console.log('Sites Concern√©s:', dataToSend.sites_concernes);
            console.log('Latitude:', dataToSend.latitude);
            console.log('Longitude:', dataToSend.longitude);
            console.log('Full dataToSend:', JSON.stringify(dataToSend, null, 2));
            console.groupEnd();
            
            showAlert('success', '‚è≥ Envoi des donn√©es au serveur... Veuillez patienter.');
            
            // V√©rifier la taille totale avant envoi
            const totalSize = JSON.stringify(dataToSend).length;
            console.log('üì¶ Taille totale √† envoyer:', (totalSize/1024/1024).toFixed(2), 'MB');
            
            if (totalSize > 25 * 1024 * 1024) {
                showAlert('error', `‚ùå Les donn√©es sont trop volumineuses: ${(totalSize/1024/1024).toFixed(1)}MB`);
                return;
            }
            
            console.log('üöÄ Envoi des donn√©es au serveur...');
            
            // Envoyer au serveur avec l'URL dynamique
            fetch(API_BASE_URL + '/api/collecte', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                console.log('üì° R√©ponse serveur:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Erreur serveur ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(result => {
                console.log('‚úÖ R√©ponse du serveur (SUCCESS):', result);
                console.log('üóÑÔ∏è Les donn√©es sont maintenant dans PostgreSQL');
                
                const serverURL = window.API_BASE_URL || 'serveur backend';
                const message = `
‚úÖ DONN√âES SAUVEGARD√âES DANS POSTGRESQL!

üÜî ID Collecte: ${result.data.id || 'N/A'}
üìÖ Date: ${new Date(result.data.dateCollecte).toLocaleString('fr-FR')}
üóÑÔ∏è Serveur: ${serverURL}
üìä Status: Pr√™t pour nouvelle saisie
                `.trim();
                
                showAlert('success', message);
                
                // Sauvegarder aussi localement
                sauvegarderEnLocal(dataToSend);
                
                // üßπ R√âINITIALISER COMPL√àTEMENT LE FORMULAIRE
                reinitialiserFormulaire();
                
                // Notification finale apr√®s 1 seconde
                setTimeout(() => {
                    showAlert('info', 'üßπ Formulaire vid√©. Pr√™t pour une nouvelle saisie!');
                }, 1000);
            })
            .catch(error => {
                console.error('‚ùå ERREUR SAUVEGARDE POSTGRESQL:', error);
                console.error('üìç Stack:', error.stack);
                console.error('üìä Type d\'erreur:', error.name);
                console.error('üíæ Donn√©es envoy√©es (size):', (JSON.stringify(dataToSend).length/1024/1024).toFixed(2), 'MB');
                
                // Message plus d√©taill√© bas√© sur le type d'erreur
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = `
‚ùå IMPOSSIBLE DE JOINDRE LE SERVEUR POSTGRESQL

V√©rifiez que:
1. Le serveur backend est lanc√©: npm start
2. PostgreSQL est en cours d'ex√©cution
3. L'URL est correcte: http://localhost:3001

Si le probl√®me persiste, consultez les logs du serveur.
                    `.trim();
                } else if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
                    errorMsg = `
‚ùå ERREUR DE R√âPONSE DU SERVEUR

Le serveur n'a pas retourn√© du JSON valide.
V√©rifiez les logs du serveur (npm start) pour plus de d√©tails.
                    `.trim();
                } else if (error.message.includes('HTTP 500')) {
                    errorMsg = `
‚ùå ERREUR SERVEUR (500)

Le serveur PostgreSQL a rencontr√© une erreur.
Consultez les logs du serveur pour les d√©tails complets.
                    `.trim();
                } else if (error.message.includes('HTTP')) {
                    errorMsg = error.message;
                }
                
                showAlert('error', errorMsg);
                
                // Sauvegarder quand m√™me en local en cas d'√©chec
                console.log('üíæ Sauvegarde locale de secours...');
                sauvegarderEnLocal(dataToSend);
                const serverURL = window.API_BASE_URL || 'http://localhost:3001';
                showAlert('info', `üíæ Donn√©es sauvegard√©es localement en attente.\n\nElle seront synchronis√©es avec PostgreSQL d√®s que le serveur ${serverURL} sera disponible.`);
            });
        }
        
        // Sauvegarder en localStorage en tant que secours
        function sauvegarderEnLocal(donnees) {
            try {
                // Cr√©er une copie sans la photo pour r√©duire la taille localStorage
                const donneesReduite = { ...donnees };
                if (donneesReduite.photo) {
                    donneesReduite.photo = '(photo supprim√©e du local storage)';
                }
                
                const collectes = JSON.parse(localStorage.getItem('collectes_donnees') || '[]');
                collectes.push({
                    ...donneesReduite,
                    saveDateLocal: new Date().toISOString(),
                    photoExists: !!donnees.photo
                });
                localStorage.setItem('collectes_donnees', JSON.stringify(collectes));
                console.log('‚úÖ Donn√©es sauvegard√©es en localStorage');
            } catch (e) {
                console.error('‚ùå Erreur localStorage:', e);
            }
        }
        
        // Fonction de diagnostic pour v√©rifier les permissions et connexion
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            afficherInfoCache();
            document.getElementById('date-update').textContent = new Date().toLocaleDateString('fr-FR');
            mettreAJourSites();
            
            // Initialiser les selects g√©ographiques
            initialiserSelectsGeographiques();
            
            // V√©rifier le statut PWA
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                console.log('‚úÖ Ex√©cution en mode PWA');
                showAlert('success', 'üì± Application PWA charg√©e!');
            }
        });
    </script>
    
    <!-- MODAL GALERIE POUR IMAGES EN PLEIN √âCRAN -->
    <div id="galerie-modal" class="galerie-modal">
        <div class="galerie-modal-content">
            <button class="galerie-modal-close" onclick="closeGalerieModal()">&times;</button>
            <button class="galerie-nav-button galerie-nav-prev" onclick="prevGalerieImage()">‚ùÆ</button>
            <button class="galerie-nav-button galerie-nav-next" onclick="nextGalerieImage()">‚ùØ</button>
            <img class="galerie-modal-image" id="galerie-modal-image" src="" alt="">
            <div class="galerie-modal-counter" id="galerie-modal-counter"></div>
            <div style="padding: 0 15px 10px 15px; display: flex; gap: 10px; flex-direction: column;">
                <button onclick="telechargerGaleriePhoto()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;">‚¨áÔ∏è Enregistrer l'Image</button>
                <button id="galerie-delete-btn" onclick="supprimerPhotoGalerie()" style="width: 100%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;">üóëÔ∏è Supprimer l'Image</button>
            </div>
            <div class="galerie-modal-info" id="galerie-modal-info"></div>
        </div>
    </div>
    
    <!-- FONCTIONS JAVASCRIPT POUR LA GALERIE PHOTOS -->
    <script>
        // Donn√©es compl√®tes des 8 photos collect√©es
        const galleriePhotos = [
            { 
                id: 12,
                commune: "Oussouye", 
                partenaire: "SENELEC", 
                site: "Bureau commercial Oussouye",
                dept: "Oussouye",
                region: "Ziguinchor",
                activites: "Desherbage, Collecte",
                superficie: "0.00 ha",
                personnel: "15",
                dispositifs: "Benne tasseuse",
                frequence: "F1",
                accessibilite: "Facile",
                lat: "12.4906¬∞N",
                lng: "16.5466¬∞O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_12_1.jpg" 
            },
            { 
                id: 11,
                commune: "Diemb√©ring", 
                partenaire: "SENELEC", 
                site: "District Cap-Skirring",
                dept: "Oussouye",
                region: "Ziguinchor",
                activites: "Desherbage, Collecte",
                superficie: "0.00 ha",
                personnel: "15",
                dispositifs: "Benne tasseuse",
                frequence: "F2",
                accessibilite: "Facile",
                lat: "12.3763¬∞N",
                lng: "16.7300¬∞O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_11_2.jpg" 
            },
            { 
                id: 10,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Bureau commercial de Boutoute",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Collecte",
                superficie: "0.00 ha",
                personnel: "0",
                dispositifs: "Benne tasseuse",
                frequence: "F2",
                accessibilite: "Facile",
                lat: "12.5694¬∞N",
                lng: "16.2776¬∞O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_10_3.jpg" 
            },
            { 
                id: 9,
                commune: "Niaguis", 
                partenaire: "SENELEC", 
                site: "Centrale √©lectrique de Boutoute",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Lev√© des dechets vert, Desherbage, Mecanisation, Collecte",
                superficie: "0.00 ha",
                personnel: "150",
                dispositifs: "Pelle Chargeur, Camion BTP, Benne tasseuse",
                frequence: "F2",
                accessibilite: "Facile",
                lat: "12.5871¬∞N",
                lng: "16.2667¬∞O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_9_4.jpg" 
            },
            { 
                id: 8,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Chambre de passage",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Collecte",
                superficie: "0.00 ha",
                personnel: "0",
                dispositifs: "Benne tasseuse",
                frequence: "F3",
                accessibilite: "Facile",
                lat: "12.5843¬∞N",
                lng: "16.2716¬∞O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_8_5.jpg" 
            },
            { 
                id: 7,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Agence principale",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Collecte",
                superficie: "0.00 ha",
                personnel: "0",
                dispositifs: "Benne tasseuse",
                frequence: "F3",
                accessibilite: "Facile",
                lat: "12.5841¬∞N",
                lng: "16.2716¬∞O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_7_6.jpg" 
            },
            { 
                id: 6,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Sous station Kankourang",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Desherbage, Collecte",
                superficie: "0.00 ha",
                personnel: "3",
                dispositifs: "Benne tasseuse",
                frequence: "F3",
                accessibilite: "Facile",
                lat: "12.5828¬∞N",
                lng: "16.2672¬∞O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_6_7.jpg" 
            },
            { 
                id: 5,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Parc √† carburant",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Lev√© des dechets vert, Desherbage",
                superficie: "0.01 ha",
                personnel: "30",
                dispositifs: "Pelle Chargeur, Camion BTP",
                frequence: "F1",
                accessibilite: "Facile",
                lat: "12.5868¬∞N",
                lng: "16.2649¬∞O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_5_8.jpg" 
            }
        ];
        
        let currentGalerieIndex = 0;
        
        // Fonction helper pour trouver et ouvrir une photo par son ID
        function openGalerieModalByPhotoId(photoId) {
            const index = galleriePhotos.findIndex(photo => photo.id === photoId);
            if (index !== -1) {
                openGalerieModal(index);
            }
        }
        
        function openGalerieModal(index) {
            currentGalerieIndex = index;
            const modal = document.getElementById('galerie-modal');
            const photo = galleriePhotos[currentGalerieIndex];
            
            document.getElementById('galerie-modal-image').src = photo.src;
            document.getElementById('galerie-modal-counter').textContent = `${currentGalerieIndex + 1} / ${galleriePhotos.length}`;
            document.getElementById('galerie-modal-info').innerHTML = `
                <div style="padding: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <h3 style="margin: 0; color: #2d5016; font-size: 16px;">üìç ${photo.commune}</h3>
                        <span style="background: #f0f8e6; color: #2d5016; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">üè∑Ô∏è ID: ${photo.id}</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px; color: #333; line-height: 1.6;">
                        <div>
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">üìå Site</strong>
                            <span>${photo.site}</span>
                        </div>
                        <div>
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">üè¢ Partenaire</strong>
                            <span>${photo.partenaire}</span>
                        </div>
                        <div>
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">üó∫Ô∏è R√©gion/D√©partement</strong>
                            <span>${photo.region} / ${photo.dept}</span>
                        </div>
                        <div>
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">üìç Localisation</strong>
                            <span>${photo.lat}, ${photo.lng}</span>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">üéØ Activit√©s</strong>
                            <span>${photo.activites}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">üìè Superficie</strong>
                            <span>${photo.superficie}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">üë• Personnel</strong>
                            <span>${photo.personnel} personnes</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">üöó Dispositifs</strong>
                            <span>${photo.dispositifs}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">üìÖ Fr√©quence</strong>
                            <span>${photo.frequence}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">üõ£Ô∏è Accessibilit√©</strong>
                            <span>${photo.accessibilite}</span>
                        </div>
                    </div>
                </div>
            `;
            modal.style.display = 'block';
        }
        
        function closeGalerieModal() {
            document.getElementById('galerie-modal').style.display = 'none';
        }
        
        // üóëÔ∏è Fonction pour supprimer une photo de la galerie
        function supprimerPhotoGalerie() {
            const photo = galleriePhotos[currentGalerieIndex];
            if (!photo) {
                showAlert('error', '‚ùå Aucune photo √† supprimer');
                return;
            }
            
            // Confirmation avant suppression
            if (!confirm(`‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer cette photo de ${photo.commune}?\n\nCette action est irr√©versible.`)) {
                return;
            }
            
            try {
                // 1. Supprimer du tableau galleriePhotos
                const indexInArray = galleriePhotos.findIndex(p => p.id === photo.id);
                if (indexInArray !== -1) {
                    galleriePhotos.splice(indexInArray, 1);
                }
                
                // 2. Retirer l'√©l√©ment HTML du DOM
                const galerieScroll = document.querySelector('.galerie-scroll');
                if (galerieScroll) {
                    const items = galerieScroll.querySelectorAll('[data-photo-id]');
                    items.forEach(item => {
                        if (item.dataset.photoId == photo.id) {
                            item.remove();
                        }
                    });
                }
                
                // 3. Retirer aussi par classe galerie-item si pas encore supprim√©
                const galerieItems = document.querySelectorAll('.galerie-item');
                for (let i = 0; i < galerieItems.length; i++) {
                    const text = galerieItems[i].textContent;
                    if (text.includes(photo.commune)) {
                        const itemSrc = galerieItems[i].querySelector('img')?.src;
                        if (itemSrc === photo.src || itemSrc?.includes(photo.site)) {
                            galerieItems[i].remove();
                            break;
                        }
                    }
                }
                
                // 4. Mettre √† jour le compteur
                const statsNumber = document.querySelector('.galerie-stat-item .galerie-stat-number');
                if (statsNumber) {
                    statsNumber.textContent = galleriePhotos.length;
                }
                
                // 5. Si des photos restent, afficher la suivante
                if (galleriePhotos.length > 0) {
                    currentGalerieIndex = Math.min(currentGalerieIndex, galleriePhotos.length - 1);
                    openGalerieModal(currentGalerieIndex);
                    showAlert('success', `‚úÖ Photo de ${photo.commune} supprim√©e! (${galleriePhotos.length} restante)`);
                } else {
                    // Sinon, fermer le modal
                    closeGalerieModal();
                    showAlert('info', `üóëÔ∏è Derni√®re photo supprim√©e! Galerie vide.`);
                }
            } catch (error) {
                console.error('Erreur suppression:', error);
                showAlert('error', '‚ùå Erreur lors de la suppression');
            }
        }
        
        // üì• Fonction pour t√©l√©charger une image de la galerie
        function telechargerGaleriePhoto() {
            const photo = galleriePhotos[currentGalerieIndex];
            if (!photo) {
                alert('‚ùå Aucune photo √† t√©l√©charger');
                return;
            }
            
            // Cr√©er le nom du fichier avec commune et site
            let comuneName = photo.commune.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 20);
            let siteName = photo.site.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 30);
            
            // Ajouter la date
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            
            const filename = `photo_${comuneName}_${siteName}_${dateStr}_${timeStr}.jpg`;
            
            // T√©l√©charger l'image
            const link = document.createElement('a');
            link.href = photo.src;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`‚úÖ Image t√©l√©charg√©e: ${filename}`);
        }
        
        function nextGalerieImage() {
            currentGalerieIndex = (currentGalerieIndex + 1) % galleriePhotos.length;
            openGalerieModal(currentGalerieIndex);
        }
        
        function prevGalerieImage() {
            currentGalerieIndex = (currentGalerieIndex - 1 + galleriePhotos.length) % galleriePhotos.length;
            openGalerieModal(currentGalerieIndex);
        }
        
        // Navigation au clavier
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('galerie-modal');
            if (modal && modal.style.display === 'block') {
                if (event.key === 'ArrowRight') nextGalerieImage();
                if (event.key === 'ArrowLeft') prevGalerieImage();
                if (event.key === 'Escape') closeGalerieModal();
            }
        });
        
        // Clic en dehors ferme le modal
        window.onclick = function(event) {
            const modal = document.getElementById('galerie-modal');
            if (event.target === modal) {
                closeGalerieModal();
            }
        }
    </script>
    
    <!-- FONCTIONS JAVASCRIPT POUR LA CARTE DES COLLECTES -->
    <script>
        // Donn√©es g√©ographiques des 8 collectes
        const collectesGPS = [
            { id: 12, commune: "Oussouye", partenaire: "SENELEC", site: "Bureau commercial Oussouye", lat: 12.49055100, lng: -16.54658500, photo: "./exports/export-2026-02-17T18-16-04/images/photo_12_1.jpg" },
            { id: 11, commune: "Diemb√©ring", partenaire: "SENELEC", site: "District Cap-Skirring", lat: 12.37629500, lng: -16.72996200, photo: "./exports/export-2026-02-17T18-16-04/images/photo_11_2.jpg" },
            { id: 10, commune: "Ziguinchor", partenaire: "SENELEC", site: "Bureau commercial de Boutoute", lat: 12.56943000, lng: -16.27761800, photo: "./exports/export-2026-02-17T18-16-04/images/photo_10_3.jpg" },
            { id: 9, commune: "Niaguis", partenaire: "SENELEC", site: "Centrale √©lectrique de Boutoute", lat: 12.58711600, lng: -16.26668500, photo: "./exports/export-2026-02-17T18-16-04/images/photo_9_4.jpg" },
            { id: 8, commune: "Ziguinchor", partenaire: "SENELEC", site: "Chambre de passage", lat: 12.58425300, lng: -16.27164800, photo: "./exports/export-2026-02-17T18-16-04/images/photo_8_5.jpg" },
            { id: 7, commune: "Ziguinchor", partenaire: "SENELEC", site: "Agence principale", lat: 12.58413100, lng: -16.27159400, photo: "./exports/export-2026-02-17T18-16-04/images/photo_7_6.jpg" },
            { id: 6, commune: "Ziguinchor", partenaire: "SENELEC", site: "Sous station Kankourang", lat: 12.58277100, lng: -16.26715500, photo: "./exports/export-2026-02-17T18-16-04/images/photo_6_7.jpg" },
            { id: 5, commune: "Ziguinchor", partenaire: "SENELEC", site: "Parc √† carburant", lat: 12.58679000, lng: -16.26486000, photo: "./exports/export-2026-02-17T18-16-04/images/photo_5_8.jpg" }
        ];
        
        // R√©gions du S√©n√©gal avec leurs coordonn√©es centrales et noms
        const senegalRegions = [
            { name: "Dakar", lat: 14.6928, lng: -17.0467 },
            { name: "Saint-Louis", lat: 16.0255, lng: -16.4861 },
            { name: "Tambacounda", lat: 13.7768, lng: -13.7707 },
            { name: "Kaolack", lat: 13.1609, lng: -15.0277 },
            { name: "Ziguinchor", lat: 13.1549, lng: -15.5828 },
            { name: "Louga", lat: 15.6167, lng: -15.6167 },
            { name: "Kolda", lat: 13.1662, lng: -14.9428 },
            { name: "Diourbel", lat: 14.6667, lng: -16.2500 },
            { name: "Thi√®s", lat: 14.7833, lng: -16.9333 },
            { name: "Gu√©diawaye", lat: 14.6833, lng: -17.45 },
            { name: "M√©guetane", lat: 14.5333, lng: -15.1333 }
        ];
        
        // Initialiser la carte une fois que le DOM est pr√™t
        function initializeCollecteMap() {
            const mapContainer = document.getElementById('collecte-map');
            if (!mapContainer) return;
            
            // Cr√©er la carte centr√©e sur Ziguinchor
            const collecteMap = L.map('collecte-map').setView([12.9, -16.0], 9);
            
            // Ajouter la couche de base OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                minZoom: 6
            }).addTo(collecteMap);
            
            // Ajouter les r√©gions comme √©tiquettes
            senegalRegions.forEach(region => {
                L.circleMarker([region.lat, region.lng], {
                    radius: 0,
                    fillOpacity: 0,
                    opacity: 0
                })
                .bindPopup(`<strong style="color: #667eea;">${region.name}</strong><br><small>R√©gion du S√©n√©gal</small>`)
                .addTo(collecteMap);
                
                // Ajouter l'√©tiquette du nom de r√©gion
                L.marker([region.lat, region.lng], {
                    icon: L.divIcon({
                        className: 'senegal-region-label',
                        html: `<div style="color: #999; font-size: 10px; font-weight: bold; text-align: center; width: 60px; background: rgba(255,255,255,0.7); padding: 2px; border-radius: 3px; white-space: nowrap;">${region.name}</div>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(collecteMap);
            });
            
            // Ajouter les marqueurs des collectes
            collectesGPS.forEach((collecte, idx) => {
                // Cr√©er une ic√¥ne personnalis√©e
                const customIcon = L.divIcon({
                    className: 'custom-collecte-marker',
                    html: `<div style="
                        background: linear-gradient(135deg, #6db038 0%, #5ba837 100%);
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 18px;
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    ">üìç</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                // Cr√©er le contenu du popup
                const popupContent = `
                    <div style="font-size: 12px;">
                        <strong style="color: #6db038; font-size: 13px;">üìå ${collecte.commune}</strong><br>
                        <small style="color: #666;">
                            <strong>Site:</strong> ${collecte.site}<br>
                            <strong>Partenaire:</strong> ${collecte.partenaire}<br>
                            <strong>Coordonn√©es:</strong> ${collecte.lat.toFixed(4)}, ${collecte.lng.toFixed(4)}<br>
                            <strong>ID:</strong> Collecte #${collecte.id}<br>
                            <a href="${collecte.photo}" target="_blank" style="color: #667eea; text-decoration: none;">üì∑ Voir Photo</a>
                        </small>
                    </div>
                `;
                
                // Ajouter le marqueur √† la carte
                const marker = L.marker([collecte.lat, collecte.lng], { icon: customIcon })
                    .bindPopup(popupContent)
                    .bindTooltip(`${collecte.commune}`, { permanent: false, direction: 'top' })
                    .addTo(collecteMap);
            });
            
            // Ajouter une l√©gende
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'info');
                div.style.background = 'white';
                div.style.padding = '10px';
                div.style.borderRadius = '5px';
                div.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';
                div.style.fontSize = '12px';
                div.innerHTML = `
                    <strong style="color: #333; display: block; margin-bottom: 8px;">üìä Statistiques</strong>
                    <div style="color: #666;">
                        <div><strong>üìç Sites:</strong> ${collectesGPS.length}</div>
                        <div><strong>üó∫Ô∏è R√©gion:</strong> Ziguinchor</div>
                        <div><strong>üè¢ Partenaire:</strong> SENELEC</div>
                        <div style="margin-top: 8px; color: #999; font-size: 11px;">
                            üí° Cliquez sur les marqueurs<br>pour voir les d√©tails
                        </div>
                    </div>
                `;
                return div;
            };
            legend.addTo(collecteMap);
        }
        
        // Initialiser la carte quand le document est compl√®tement charg√©
        window.addEventListener('load', function() {
            setTimeout(initializeCollecteMap, 500);
        });
    </script>
    
    

    <!-- Configuration d'environnement (doit √™tre avant api-client.js) -->
    <script src="config.js"></script>
    <!-- Client API pour communication avec PostgreSQL backend -->
    <script src="api-client.js"></script>

</body>
</html>

