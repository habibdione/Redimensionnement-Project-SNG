<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Application mobile de collecte de donn√©es g√©ographiques pour le dimensionnement des sites SONAGED">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SONAGED Map">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dy='.3em'>S</text></svg>">
    <title>Dimensionnement SONAGED - Collecte de Donn√©es</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c27 50%, #6db038 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .header > * {
            position: relative;
            z-index: 1;
        }
        
        .header-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .header-logo-container img {
            height: 100px;
            width: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 15px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .header-features {
            font-size: 12px;
            opacity: 0.88;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-features span {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .section h2 {
            color: #2d5016;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 3px solid #6db038;
            padding-bottom: 12px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #2d5016;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select, textarea {
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        select[multiple] {
            padding: 10px;
            min-height: 120px;
            background: white;
            border-color: #d0d0d0;
        }
        
        select[multiple] option {
            padding: 10px 5px;
            line-height: 1.6;
        }
        
        select[multiple] option:checked {
            background: linear-gradient(#6db038, #6db038);
            background-color: #6db038 !important;
            color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6db038;
            background: white;
            box-shadow: 0 0 0 3px rgba(109, 176, 56, 0.1);
        }
        
        button {
            padding: 13px 24px;
            background: linear-gradient(135deg, #6db038 0%, #4a7c27 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(109, 176, 56, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(109, 176, 56, 0.4);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        button.danger:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }
        
        .success {
            background: linear-gradient(135deg, #6db038 0%, #4a7c27 100%) !important;
        }
        
        #map {
            height: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        video {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        video.active {
            display: block;
        }
        
        canvas {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            display: none;
        }
        
        canvas.active {
            display: block;
        }
        
        .coords-display {
            background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%);
            padding: 18px;
            border-radius: 10px;
            border-left: 5px solid #6db038;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(109, 176, 56, 0.1);
        }
        
        .coords-display strong {
            color: #2d5016;
            font-weight: 700;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .button-group button {
            flex: 1;
            min-width: 160px;
        }
        
        .danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
        }
        
        .danger:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4) !important;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #0c2340;
            border-left: 4px solid #3b82f6;
        }
        
        .hidden {
            display: none;
        }

        /* CSS Mobile et Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                box-shadow: none;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .partners-logos {
                gap: 20px;
            }

            .partners-logos img {
                height: 50px;
            }

            .content {
                padding: 15px;
            }

            .section {
                gap: 12px;
            }

            #map {
                height: 300px;
            }

            video, canvas {
                max-height: 250px;
            }

            button {
                padding: 12px 16px;
                font-size: 13px;
            }

            .button-group button {
                min-width: 120px;
            }

            label {
                font-size: 12px;
            }

            input, select, textarea {
                padding: 8px;
                font-size: 13px;
            }

            select[multiple] {
                min-height: 80px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 12px;
            }

            #map {
                height: 250px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
                min-width: unset;
            }

            .data-item {
                grid-template-columns: 1fr;
            }
        }

        /* Styles pour l'install PWA */
        #install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #install-prompt.hidden {
            display: none;
        }

        #install-prompt > div {
            flex: 1;
        }

        #install-prompt button {
            background: white;
            color: #667eea;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            margin: 0;
            flex-shrink: 0;
        }

        #install-prompt button:hover {
            background: #f0f0f0;
        }

        /* Optimisation Leaflet pour mobile */
        .leaflet-container {
            font-size: 12px;
        }

        .leaflet-control {
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        .leaflet-control-zoom {
            border: none;
        }

        .leaflet-control-zoom a {
            background-color: #667eea;
            color: white;
            border: none;
        }

        .leaflet-control-zoom a:hover {
            background-color: #764ba2;
        }

        .leaflet-popup-content {
            font-size: 13px;
        }

        /* Safe area pour encoche */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                padding-top: max(10px, env(safe-area-inset-top));
            }
        }
        
        .data-summary {
            background: #f9fafb;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #e5e7eb;
            margin-top: 20px;
        }
        
        .data-summary h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .data-item {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 600;
            color: #667eea;
        }
        
        .data-value {
            color: #333;
            word-break: break-word;
        }
        
        footer {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
            font-size: 13px;
            border-top: 3px solid #6db038;
            position: relative;
        }
        
        footer p {
            margin: 8px 0;
            opacity: 0.95;
        }
        
        footer strong {
            font-weight: 700;
            color: #a4d65e;
        }
    </style>

</head>
<body>
    <div id="alert-container" style="position: fixed; top: 10px; right: 10px; z-index: 1000; max-width: 300px;"></div>
    <div id="install-prompt" class="hidden">
        <div>
            <strong>üì≤ Installer l'application SONAGED</strong>
            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">Acc√©dez √† vos cartes hors ligne</p>
        </div>
        <button onclick="installPWA()">Installer</button>
        <button onclick="dismissInstall()" style="background: rgba(255,255,255,0.2); color: white;">√ó</button>
    </div>
    <div class="container">
        <div class="header">
            <div class="header-logo-container">
                <img src="logo-sonaged.svg" alt="Logo SONAGED">
                <div>
                    <h1>DIMENSIONNEMENT SONAGED</h1>
                    <p style="font-size: 14px; opacity: 0.95;">Collecte & Gestion des Donn√©es G√©ographiques</p>
                </div>
            </div>
            <div class="header-features">
                <span>üì± Mobile</span>
                <span>üó∫Ô∏è GPS</span>
                <span>üì∑ Cam√©ra</span>
                <span>üíæ LocalStorage</span>
                <span>üóÑÔ∏è PostgreSQL</span>
                <span>üåê Offline</span>
            </div>
        </div>
        
        <div class="content">
            <!-- FORMULAIRE DE SAISIE -->
            <div class="section">
                <h2>üìù Informations du Site</h2>
                
                <div id="alert-container"></div>
                
                <div class="form-group">
                    <label for="region">üó∫Ô∏è R√©gion</label>
                    <select id="region" required onchange="mettreAJourDepartements()">
                        <option value="">-- S√©lectionner une r√©gion --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="departement">üìç D√©partement</label>
                    <select id="departement" required onchange="mettreAJourCommunes()">
                        <option value="">-- S√©lectionner un d√©partement --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="commune">üèòÔ∏è Commune</label>
                    <select id="commune" required>
                        <option value="">-- S√©lectionner une commune --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="typeActivite">Type d'Activit√© (S√©lectionner plusieurs)</label>
                    <select id="typeActivite" required multiple size="5">
                        <option value="Lev√© des dechets vert">Lev√© des dechets vert</option>
                        <option value="Desherbage">Desherbage</option>
                        <option value="Mecanisation">Mecanisation</option>
                        <option value="Collecte">Collecte</option>
                        <option value="Balayage">Balayage</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">üí° Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs choix</small>
                </div>
                
                <div class="form-group">
                    <label for="partenaire">Partenaire</label>
                    <input type="text" id="partenaire" placeholder="Ex: SONAGED, ONG, etc." required>
                </div>
                
                <div class="form-group">
                    <label for="adresse">Adresse</label>
                    <input type="text" id="adresse" placeholder="Adresse d√©taill√©e" required>
                </div>
                
                <div class="form-group">
                    <label for="superficie">Superficie (ha)</label>
                    <input type="number" id="superficie" placeholder="ex: 2.81" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="besoinPersonnel">Besoin en Personnel</label>
                    <input type="number" id="besoinPersonnel" placeholder="Nombre de personnes" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="dispositifDeploy">Dispositif D√©ploy√© (S√©lectionner plusieurs)</label>
                    <select id="dispositifDeploy" required multiple size="4">
                        <option value="Pelle Chargeur">Pelle Chargeur</option>
                        <option value="Camion BTP">Camion BTP</option>
                        <option value="Polybene">Polybene</option>
                        <option value="Benne tasseuse">Benne tasseuse</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">üí° Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs choix</small>
                </div>
                
                <div class="form-group">
                    <label for="nombreRotation">Nombre de Rotation</label>
                    <input type="number" id="nombreRotation" placeholder="Nombre de rotations" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="infrastructureGestion">Infrastructure de Gestion de Dechets</label>
                    <select id="infrastructureGestion" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="PRN">PRN</option>
                        <option value="PP">PP</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="frequenceCollecte">Fr√©quence de Collecte</label>
                    <select id="frequenceCollecte" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="F1">F1</option>
                        <option value="F2">F2</option>
                        <option value="F3">F3</option>
                        <option value="F4">F4</option>
                        <option value="F5">F5</option>
                        <option value="F6">F6</option>
                        <option value="F7">F7</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bacs240">Bacs 240L</label>
                    <input type="number" id="bacs240" placeholder="Nombre de bacs" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="caissePolybene">Caisse Polybene</label>
                    <input type="number" id="caissePolybene" placeholder="Nombre de caisses" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="bacs660">Bacs 660L</label>
                    <input type="number" id="bacs660" placeholder="Nombre de bacs" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="accessibilite">Accessibilit√©</label>
                    <select id="accessibilite" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="Facile">Facile</option>
                        <option value="Difficile">Difficile</option>
                        <option value="Route non goudronn√©e">Route non goudronn√©e</option>
                        <option value="Route goudronn√©e">Route goudronn√©e</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="observation">Observations</label>
                    <textarea id="observation" placeholder="Notes suppl√©mentaires" rows="3"></textarea>
                </div>
                
                <!-- R√âSUM√â DES DONN√âES AVANT SAUVEGARDE -->
                <div id="resume-section" style="display: none; background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%); padding: 25px; border-radius: 12px; border-left: 6px solid #6db038; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(109, 176, 56, 0.15);">
                    <h3 style="color: #2d5016; margin-bottom: 18px; font-size: 20px; font-weight: 700;">üìã R√©sum√© des Donn√©es</h3>
                    <div id="resume-contenu" style="font-size: 14px; line-height: 2; color: #333;"></div>
                </div>
                
                <button class="success" onclick="afficherResume()" style="width: 100%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); margin-top: 15px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">üëÅÔ∏è Voir le R√©sum√©</button>
                <button class="success" onclick="sauvegarderDonneesBD()" style="width: 100%; margin-top: 5px;">üíæ Sauvegarder les Donn√©es</button>
            </div>
            
            <!-- LOCALISATION & IMAGES -->
            <div class="section">
                <h2>üìç Localisation et Images</h2>
                
                <div class="coords-display" id="coords-display">
                    <strong>üìç Coordonn√©es actuelles:</strong><br>
                    Latitude: <span id="lat">--</span><br>
                    Longitude: <span id="lon">--</span><br>
                    Pr√©cision: <span id="accuracy">--</span> m<br>
                    <small style="margin-top: 10px; display: block; opacity: 0.8;">UTM - Easting: <span id="utm-easting">--</span> | Northing: <span id="utm-northing">--</span></small>
                </div>
                
                <!-- Champs cach√©s pour coordonn√©es UTM -->
                <input type="hidden" id="coordonneeX" value="">
                <input type="hidden" id="coordonneeY" value="">
                
                <button onclick="obtenirLocalisationGPS()" style="width: 100%;">üì° Obtenir Position GPS & Ajouter Marqueur</button>
                
                <div id="map"></div>
                
                <h3 style="color: #667eea; margin-top: 20px;">üì∑ Capture d'Image</h3>
                
                <div class="button-group">
                    <button onclick="demarrerCamera()" style="flex: 1;">üìπ D√©marrer Cam√©ra</button>
                    <button class="danger" onclick="arreterCamera()" style="flex: 1;">‚èπÔ∏è Arr√™ter</button>
                </div>
                
                <video id="video" style="width: 100%; border-radius: 8px; background: #000; margin: 15px 0; display: none;" playsinline></video>
                <canvas id="canvas" style="width: 100%; border-radius: 8px; margin: 15px 0; display: none;"></canvas>
                
                <button onclick="capturerPhoto()" style="width: 100%;">üì∏ Capturer Photo</button>
                
                <div id="image-preview" class="hidden">
                    <img id="preview-img" src="" alt="Aper√ßu" style="width: 100%; border-radius: 8px; margin: 10px 0; max-height: 300px;">
                    <button class="danger" onclick="effacerPhoto()" style="width: 100%; margin-top: 10px;">üóëÔ∏è Effacer Photo</button>
                </div>
            </div>
        </div>
        
        <!-- R√âSUM√â DES DONN√âES -->
        <div style="padding: 30px;">
            <div class="data-summary" id="summary" style="display: none;">
                <h3>üìã R√©sum√© des Donn√©es Collect√©es</h3>
                <div id="summary-content"></div>
                <button class="success" onclick="sauvegarderDonneesBD()" style="background: #10b981; width: 100%; margin-top: 15px;">üíæ Sauvegarder</button>
            </div>
        </div>
        
        <footer>
            <p style="margin-bottom: 10px; font-weight: 700; font-size: 14px;">¬© 2026 SONAGED - Syst√®me de Dimensionnement & Gestion de Donn√©es</p>
            <p style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;"><strong>üó∫Ô∏è Application G√©ographique Progressive</strong> | Derni√®re mise √† jour: <span id="date-update"></span></p>
            <p style="font-size: 12px; opacity: 0.85; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 10px;">üë®‚Äçüíª <strong>Habib DIONE</strong> | üè¢ Charg√© SIG Ziguinchor</p>
        </footer>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <script>
        // ============ DONN√âES G√âOGRAPHIQUES DU S√âN√âGAL (PRIORITAIRE) ============
        const SENEGAL_REGIONS = {
            regions: [
                {
                    id: 'dakar',
                    nom: 'üèõÔ∏è Dakar',
                    code: 'DK',
                    departements: [
                        {
                            id: 'dakar-dept',
                            nom: 'Dakar',
                            communes: ['Dakar', 'Gu√©diawaye', 'Pikine', 'Rufisque', 'Keur Massar']
                        }
                    ]
                },
                {
                    id: 'thies',
                    nom: 'üèòÔ∏è Thi√®s',
                    code: 'TH',
                    departements: [
                        { id: 'thies-dept', nom: 'Thi√®s', communes: ['Thi√®s', 'Popenguine', 'Sindia'] },
                        { id: 'mbour-dept', nom: 'Mbour', communes: ['Mbour', 'Nianing', 'Joal-Fadiouth', 'Malicounda', 'Ngaparou', 'Toubab Dialao'] },
                        { id: 'tivaouane-dept', nom: 'Tivaouane', communes: ['Tivaouane', 'Mekh√©', 'M√©rinag√®ne', 'Gningue'] }
                    ]
                },
                {
                    id: 'saint-louis',
                    nom: 'üëë Saint-Louis',
                    code: 'SL',
                    departements: [
                        { id: 'saint-louis-dept', nom: 'Saint-Louis', communes: ['Saint-Louis', 'Guet N Dar', 'Sor'] },
                        { id: 'dagana-dept', nom: 'Dagana', communes: ['Dagana', 'Ronchamp', 'Diama'] },
                        { id: 'podor-dept', nom: 'Podor', communes: ['Podor', 'Tandilao', 'Madina'] }
                    ]
                },
                {
                    id: 'diourbel',
                    nom: 'üåæ Diourbel',
                    code: 'DB',
                    departements: [
                        { id: 'diourbel-dept', nom: 'Diourbel', communes: ['Diourbel', 'Gueule Tap√©e', 'Touba', 'Gueule Ndar'] },
                        { id: 'bambey-dept', nom: 'Bambey', communes: ['Bambey', 'Ngoye'] },
                        { id: 'mbacke-dept', nom: 'Mback√©', communes: ['Mback√©', 'Darou Mouhty', 'Lamina', 'Keur Modou'] }
                    ]
                },
                {
                    id: 'tambacounda',
                    nom: 'üê™ Tambacounda',
                    code: 'TC',
                    departements: [
                        { id: 'tambacounda-dept', nom: 'Tambacounda', communes: ['Tambacounda', 'Sinthiou Lemba', 'Guel Malick', 'Banda R√©'] },
                        { id: 'bakel-dept', nom: 'Bakel', communes: ['Bakel', 'Kanel'] },
                        { id: 'goudiry-dept', nom: 'Goudiry', communes: ['Goudiry', 'Kidira'] },
                        { id: 'koumpentoum-dept', nom: 'Koumpentoum', communes: ['Koumpentoum', 'Gueumane'] },
                        { id: 'kidira-dept', nom: 'Kidira', communes: ['Kidira', 'Gabu'] }
                    ]
                },
                {
                    id: 'ziguinchor',
                    nom: 'üå¥ Ziguinchor',
                    code: 'ZG',
                    departements: [
                        { id: 'ziguinchor-dept', nom: 'Ziguinchor', communes: ['Ziguinchor', 'Ad√©ane', 'Niaguis', 'Niassia', 'Boutoupa Camara Kounda'] },
                        { id: 'bignona-dept', nom: 'Bignona', communes: ['Bignona', 'Thionck-Essyl', 'Kafountine', 'Diouloulou', 'Balingore', 'Coubalan', 'Di√©goune', 'Djibidione', 'Djinaki', 'Karthiack', 'Kataba 1', 'Mangagoulack', 'Mlomp', 'Niamone', 'Oulampane', 'Quonck', 'Sindian', 'Suelle', 'Tenghory'] },
                        { id: 'oussouye-dept', nom: 'Oussouye', communes: ['Oussouye', 'Diemb√©ring', 'Mlomp'] }
                    ]
                },
                {
                    id: 'kaolack',
                    nom: 'üé™ Kaolack',
                    code: 'KL',
                    departements: [
                        { id: 'kaolack-dept', nom: 'Kaolack', communes: ['Kaolack', 'Lamin Sine', 'Ndi√©di√©me', 'Gankette Soul√©'] },
                        { id: 'nioro-dept', nom: 'Nioro du Rip', communes: ['Nioro du Rip', 'Kolia'] },
                        { id: 'guinguineo-dept', nom: 'Guinguin√©o', communes: ['Guinguin√©o', 'Taiba Niass√®ne', 'Ndengler'] }
                    ]
                },
                {
                    id: 'fatick',
                    nom: 'üèûÔ∏è Fatick',
                    code: 'FT',
                    departements: [
                        { id: 'fatick-dept', nom: 'Fatick', communes: ['Fatick', 'Keur Samba Gueye', 'Missirah', 'Passe'] },
                        { id: 'foundiougne-dept', nom: 'Foundiougne', communes: ['Foundiougne', 'Missirah Wad√®ne'] },
                        { id: 'gossas-dept', nom: 'Gossas', communes: ['Gossas', 'Rip', 'Sarelle'] }
                    ]
                },
                {
                    id: 'kaffrine',
                    nom: 'üåæ Kaffrine',
                    code: 'KF',
                    departements: [
                        { id: 'kaffrine-dept', nom: 'Kaffrine', communes: ['Kaffrine', 'Sinth√©', 'Sar√© Yerma'] },
                        { id: 'birkelane-dept', nom: 'Birkelane', communes: ['Birkelane', 'Ndiob√®ne'] },
                        { id: 'malem-hodar-dept', nom: 'Malem Hodar', communes: ['Malem Hodar', 'Maka Kol√©'] },
                        { id: 'koungheul-dept', nom: 'Koungheul', communes: ['Koungheul', 'Guelel Yerguel'] }
                    ]
                },
                {
                    id: 'matam',
                    nom: 'üèúÔ∏è Matam',
                    code: 'MT',
                    departements: [
                        { id: 'matam-dept', nom: 'Matam', communes: ['Matam', 'Kassan', 'Orb√©'] },
                        { id: 'kanel-dept', nom: 'Kanel', communes: ['Kanel', 'Ouro Alfa'] },
                        { id: 'ranerou-dept', nom: 'Ran√©rou', communes: ['Ran√©rou', 'S√©libaby'] }
                    ]
                },
                {
                    id: 'kedougou',
                    nom: 'üå≤ K√©dougou',
                    code: 'KD',
                    departements: [
                        { id: 'kedougou-dept', nom: 'K√©dougou', communes: ['K√©dougou', 'Mampatim'] },
                        { id: 'salemata-dept', nom: 'Salemata', communes: ['Salemata', 'Mako'] },
                        { id: 'saraya-dept', nom: 'Saraya', communes: ['Saraya', 'Misira'] }
                    ]
                },
                {
                    id: 'kolda',
                    nom: 'üéã Kolda',
                    code: 'KO',
                    departements: [
                        { id: 'kolda-dept', nom: 'Kolda', communes: ['Kolda', 'Sibassor', 'M√©dina El Hadj'] },
                        { id: 'velingara-dept', nom: 'V√©lingara', communes: ['V√©lingara', 'Gaoual'] },
                        { id: 'medina-yoro-foulah-dept', nom: 'M√©dina Yoro Foulah', communes: ['M√©dina Yoro Foulah', 'Dialacoto'] }
                    ]
                },
                {
                    id: 'sedhiou',
                    nom: 'üå≥ S√©dhiou',
                    code: 'SD',
                    departements: [
                        { id: 'sedhiou-dept', nom: 'S√©dhiou', communes: ['S√©dhiou', 'Kabrousse'] },
                        { id: 'bounkiling-dept', nom: 'Bounkiling', communes: ['Bounkiling', 'Linkering'] },
                        { id: 'goudomp-dept', nom: 'Goudomp', communes: ['Goudomp', 'Yarol'] }
                    ]
                },
                {
                    id: 'louga',
                    nom: 'üê† Louga',
                    code: 'LG',
                    departements: [
                        { id: 'louga-dept', nom: 'Louga', communes: ['Louga', 'Gueoul'] },
                        { id: 'kebemer-dept', nom: 'K√©b√©mer', communes: ['K√©b√©mer', 'Tataguine'] },
                        { id: 'linguere-dept', nom: 'Lingu√®re', communes: ['Lingu√®re', 'Dodji'] }
                    ]
                }
            ],
            
            getRegions: function() {
                return this.regions;
            },
            
            getDepartements: function(regionId) {
                const region = this.regions.find(r => r.id === regionId);
                return region ? region.departements : [];
            },
            
            getCommunes: function(regionId, departementId) {
                const region = this.regions.find(r => r.id === regionId);
                if (!region) return [];
                const dept = region.departements.find(d => d.id === departementId);
                return dept ? dept.communes : [];
            }
        };

        // ============ FONCTIONS G√âOGRAPHIQUES ============
        function initialiserSelectsGeographiques() {
            console.log('‚úÖ Initialiser les selects g√©ographiques');
            const regionSelect = document.getElementById('region');
            if (!regionSelect) {
                console.error('‚ùå Element region select non trouv√©');
                return;
            }
            
            regionSelect.innerHTML = '<option value="">-- S√©lectionner une r√©gion --</option>';
            
            SENEGAL_REGIONS.getRegions().forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = region.nom;
                regionSelect.appendChild(option);
            });
            
            console.log(`‚úÖ ${SENEGAL_REGIONS.getRegions().length} r√©gions charg√©es`);
        }
        
        function mettreAJourDepartements() {
            console.log('üîÑ MISE √Ä JOUR DES D√âPARTEMENTS');
            const regionSelect = document.getElementById('region');
            const departementSelect = document.getElementById('departement');
            const communeSelect = document.getElementById('commune');
            
            const regionId = regionSelect.value;
            console.log(`   R√©gion s√©lectionn√©e: "${regionId}"`);
            
            // R√©initialiser les autres selects
            departementSelect.innerHTML = '<option value="">-- S√©lectionner un d√©partement --</option>';
            communeSelect.innerHTML = '<option value="">-- S√©lectionner une commune --</option>';
            
            if (!regionId) {
                console.warn('   ‚ö†Ô∏è Aucune r√©gion s√©lectionn√©e');
                return;
            }
            
            // R√©cup√©rer et remplir les d√©partements
            const departements = SENEGAL_REGIONS.getDepartements(regionId);
            console.log(`   ‚úÖ ${departements.length} d√©partements trouv√©s`);
            
            departements.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.nom;
                departementSelect.appendChild(option);
            });
        }
        
        function mettreAJourCommunes() {
            console.log('üîÑ MISE √Ä JOUR DES COMMUNES');
            const regionSelect = document.getElementById('region');
            const departementSelect = document.getElementById('departement');
            const communeSelect = document.getElementById('commune');
            
            const regionId = regionSelect.value;
            const departementId = departementSelect.value;
            
            console.log(`   R√©gion: "${regionId}", D√©partement: "${departementId}"`);
            
            // R√©initialiser le select des communes
            communeSelect.innerHTML = '<option value="">-- S√©lectionner une commune --</option>';
            
            if (!regionId || !departementId) {
                console.warn('   ‚ö†Ô∏è R√©gion ou d√©partement manquant');
                return;
            }
            
            // R√©cup√©rer et remplir les communes
            const communes = SENEGAL_REGIONS.getCommunes(regionId, departementId);
            console.log(`   ‚úÖ ${communes.length} communes trouv√©es`);
            
            communes.forEach(commune => {
                const option = document.createElement('option');
                option.value = commune;
                option.textContent = commune;
                communeSelect.appendChild(option);
            });
        }

        // ============ PWA & Service Worker Enregistrement ============
        let deferredPrompt;
        let swRegistration = null;

        // Enregistrer le Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    swRegistration = registration;
                    console.log('‚úÖ Service Worker enregistr√©:', registration);
                    
                    // V√©rifier les mises √† jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'activated') {
                                showAlert('info', '‚úÖ Nouvelle version disponible! Rechargez la page.');
                            }
                        });
                    });
                    
                    // Polling pour les mises √† jour
                    setInterval(() => {
                        registration.update();
                    }, 60000);
                }).catch(error => {
                    console.warn('‚ùå Erreur SW:', error);
                });
            });
        }

        // Gestion de l'install prompt PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Afficher le bouton d'installation
            document.getElementById('install-prompt').classList.remove('hidden');
        });

        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ Application install√©e!');
            document.getElementById('install-prompt').classList.add('hidden');
            showAlert('success', 'üì± Application install√©e avec succ√®s!');
            deferredPrompt = null;
        });

        // Fonction d'installation PWA
        function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((outcome) => {
                if (outcome.outcome === 'accepted') {
                    console.log('‚úÖ Installation accept√©e');
                } else {
                    console.log('‚ùå Installation refus√©e');
                }
                deferredPrompt = null;
            });
        }

        // Masquer l'avis d'installation
        function dismissInstall() {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // D√©tection de la connectivit√©
        window.addEventListener('online', () => {
            showAlert('success', 'üåê Connect√© √† internet');
        });

        window.addEventListener('offline', () => {
            showAlert('info', 'üìµ Mode hors ligne activ√© - Les donn√©es seront synchronis√©es');
        });

        // Si d√©j√† install√©e ou accessible en standalone
        if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // ============ Variables et Donn√©es ============
        let map;
        let userLocationMarker;
        let videoStream;
        
        let donnees = {
            partenaire: '',
            region: '',
            departement: '',
            commune: '',
            typeActivite: [],
            adresse: '',
            superficie: '',
            besoinPersonnel: '',
            dispositifDeploy: '',
            nombreRotation: '',
            infrastructureGestion: '',
            frequenceCollecte: '',
            bacs240: '',
            caissePolybene: '',
            bacs660: '',
            accessibilite: '',
            observation: '',
            latitude: null,
            longitude: null,
            precision: null,
            coordonneeX: '',
            coordonneeY: '',
            photo: null,
            dateCollecte: new Date().toISOString()
        };
        
        // Initialiser la carte avec optimisations
        function initMap() {
            map = L.map('map').setView([13.1939, -15.5277], 13); // Coordonn√©es Ziguinchor
            
            // Ajouter les tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                crossOrigin: true,
                className: 'leaflet-tiles-offline'
            }).addTo(map);
            
            // Ajouter un marqueur de d√©part
            L.marker([13.1939, -15.5277], {
                title: 'Ziguinchor (Si√®ge SONAGED)'
            }).addTo(map).bindPopup('<b>Ziguinchor</b><br>Si√®ge SONAGED');
            
            // Optimisation pour mobile
            if (window.innerWidth < 768) {
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
            }
        }

        // Informations sur le cache
        function afficherInfoCache() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const percentUsed = (estimate.usage / estimate.quota) * 100;
                    console.log(`Cache utilis√©: ${(estimate.usage / 1024 / 1024).toFixed(2)} MB / ${(estimate.quota / 1024 / 1024).toFixed(2)} MB (${percentUsed.toFixed(1)}%)`);
                });
            }
        }

        // Nettoyer le cache
        function nettoyerCache() {
            if (swRegistration) {
                swRegistration.active.postMessage({ type: 'CLEAR_CACHE' });
                showAlert('success', 'üóëÔ∏è Cache en cours de nettoyage...');
            }
        }
        
        // Mettre √† jour les sites - fonction d√©sactiv√©e (le champ siteConcerne a √©t√© supprim√©)
        function mettreAJourSites() {
            // Cette fonction est conserv√©e pour compatibilit√© mais ne fait rien
            // Le champ siteConcerne a √©t√© supprim√© du formulaire
        }
        
        // G√©olocalisation GPS
        // G√©olocalisation am√©lior√©e avec conversion UTM
        let watchPositionId = null;

        function obtenirLocalisationGPS() {
            // V√©rification du protocole
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('error', '‚ö†Ô∏è La g√©olocalisation n√©cessite HTTPS. Veuillez utiliser une connexion s√©curis√©e ou localhost.');
                return;
            }
            
            if (!navigator.geolocation) {
                showAlert('error', '‚ùå La g√©olocalisation n\'est pas support√©e par votre navigateur');
                return;
            }
            
            showAlert('info', 'üì° Demande de permission pour acc√©der √† la localisation...');
            
            // Options pour haute pr√©cision
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,  // Augment√© √† 15 secondes
                maximumAge: 0
            };

            // Utiliser watchPosition pour suivi continu
            watchPositionId = navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    const altitude = position.coords.altitude ? Math.round(position.coords.altitude) : 'N/A';
                    const heading = position.coords.heading ? Math.round(position.coords.heading) : 'N/A';
                    const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) : '0'; // m/s to km/h
                    
                    donnees.latitude = lat;
                    donnees.longitude = lon;
                    donnees.precision = accuracy;
                    
                    // Afficher les coordonn√©es
                    document.getElementById('lat').textContent = lat.toFixed(6);
                    document.getElementById('lon').textContent = lon.toFixed(6);
                    document.getElementById('accuracy').textContent = accuracy;
                    
                    // Convertir en UTM
                    const utm = latLonToUTM(lat, lon);
                    document.getElementById('utm-easting').textContent = utm.easting.toFixed(2);
                    document.getElementById('utm-northing').textContent = utm.northing.toFixed(2);
                    document.getElementById('coordonneeX').value = utm.easting.toFixed(2);
                    document.getElementById('coordonneeY').value = utm.northing.toFixed(2);
                    donnees.coordonneeX = utm.easting.toFixed(2);
                    donnees.coordonneeY = utm.northing.toFixed(2);
                    
                    // Centrer la carte et ajouter un marqueur
                    map.setView([lat, lon], 17);
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    
                    const popupContent = `<b>üìç Votre Position</b><br>
                    <strong>Latitude:</strong> ${lat.toFixed(6)}¬∞<br>
                    <strong>Longitude:</strong> ${lon.toFixed(6)}¬∞<br>
                    <strong>Pr√©cision:</strong> ¬±${accuracy}m<br>
                    <strong>Altitude:</strong> ${altitude}m<br>
                    <strong>Vitesse:</strong> ${speed} km/h<br>
                    <strong>Orientation:</strong> ${heading}¬∞<br>
                    <strong>UTM Easting:</strong> ${utm.easting.toFixed(2)}<br>
                    <strong>UTM Northing:</strong> ${utm.northing.toFixed(2)}`;
                    
                    userLocationMarker = L.circleMarker([lat, lon], {
                        radius: 8,
                        fillColor: '#667eea',
                        color: '#764ba2',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8,
                        title: 'Votre position'
                    }).addTo(map).bindPopup(popupContent);
                    
                    showAlert('success', `‚úÖ Position obtenue! Pr√©cision: ¬±${accuracy}m`);
                },
                function(error) {
                    let errorMsg = '';
                    console.error('üî¥ Erreur g√©olocalisation code:', error.code, 'message:', error.message);
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Acc√®s √† la g√©olocalisation refus√©. ';
                            errorMsg += 'Veuillez v√©rifier les permissions de votre navigateur. ';
                            errorMsg += 'Allez dans Param√®tres > Permissions de site et autorisez l\'acc√®s √† votre localisation.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Position indisponible. Assurez-vous que le GPS est activ√© et que vous √™tes en ext√©rieur.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'D√©lai d√©pass√© (15s). Essayez dans un endroit avec meilleure r√©ception GPS.';
                            break;
                        default:
                            errorMsg = error.message || 'Erreur inconnue';
                    }
                    showAlert('error', '‚ùå Erreur GPS: ' + errorMsg);
                },
                options
            );
        }

        // Fonction de conversion Lat/Lon en UTM
        function latLonToUTM(lat, lon) {
            // R√©f√©rence: WGS84
            const k0 = 0.9996;
            const E = 0.00669438;
            const E2 = E / (1 - E);
            const N0 = 0;
            const E0 = 500000;
            
            const zone = Math.floor((lon + 180) / 6) + 1;
            const lon0 = (zone - 1) * 6 - 180 + 3;
            
            const N = Math.cos(lat * Math.PI / 180);
            const T = Math.tan(lat * Math.PI / 180);
            const C = E2 * N * N;
            const A = (lon - lon0) * Math.PI / 180 * N;
            
            const M = 111132.92 * lat - 16216.94 * Math.sin(2 * lat * Math.PI / 180) + 
                      17.21 * Math.sin(4 * lat * Math.PI / 180) - 
                      0.094 * Math.sin(6 * lat * Math.PI / 180);
            
            const easting = E0 + k0 * 6378137 * (A + (A * A * A / 6) * (1 - T * T + C) + 
                            (A * A * A * A * A / 120) * (5 - 18 * T * T + T * T * T * T + 72 * C - 58 * E2));
            
            const northing = N0 + k0 * (M + 6378137 * (T * (A * A / 2) + (T * (A * A * A * A / 24)) * 
                            (5 - T * T + 9 * C + 4 * C * C) + 
                            (T * (A * A * A * A * A * A / 720)) * (61 - 58 * T * T + T * T * T * T + 600 * C - 330 * E2)));
            
            return {
                easting: easting,
                northing: northing,
                zone: zone
            };
        }

        // Arr√™ter le suivi GPS
        function arreterLocalisationGPS() {
            if (watchPositionId !== null) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
                showAlert('info', '‚èπÔ∏è Suivi GPS arr√™t√©');
            }
        }
        
        // Cam√©ra - Version am√©lior√©e
        function demarrerCamera() {
            const video = document.getElementById('video');
            
            // V√©rifier les permissions HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('error', '‚ùå La cam√©ra n√©cessite HTTPS (ou localhost pour test)');
                return;
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('error', '‚ùå Votre navigateur ne supporte pas la cam√©ra\n\nüí° Essayez avec Chrome, Firefox ou Edge');
                return;
            }
            
            showAlert('info', 'üìπ Demande d\'acc√®s √† la cam√©ra...');
            
            // Essayer avec facingMode 'environment' d'abord (cam√©ra arri√®re)
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            })
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.play().catch(err => console.warn('Play warning:', err));
                    video.style.display = 'block';
                    showAlert('success', '‚úÖ Cam√©ra activ√©e avec succ√®s!');
                    console.log('üìπ Stream video actif');
                })
                .catch(err => {
                    console.error('‚ùå Erreur cam√©ra:', err);
                    
                    // Fallback: essayer sans facingMode
                    navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    })
                        .then(stream => {
                            videoStream = stream;
                            video.srcObject = stream;
                            video.play().catch(err => console.warn('Play warning:', err));
                            video.style.display = 'block';
                            showAlert('success', '‚úÖ Cam√©ra activ√©e!');
                        })
                        .catch(err2 => {
                            let message = '‚ùå Erreur cam√©ra: ';
                            if (err.name === 'NotAllowedError') {
                                message += 'Permission refus√©e. Acceptez l\'acc√®s √† la cam√©ra.';
                            } else if (err.name === 'NotFoundError') {
                                message += 'Aucune cam√©ra d√©tect√©e sur votre appareil.';
                            } else {
                                message += err.name + ': ' + err.message;
                            }
                            showAlert('error', message);
                            console.error('Erreur cam√©ra compl√®te:', err2);
                        });
                });
        }
        
        function arreterCamera() {
            const video = document.getElementById('video');
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
                videoStream = null;
                showAlert('info', '‚èπÔ∏è Cam√©ra arr√™t√©e');
            }
        }
        
        function capturerPhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!videoStream) {
                showAlert('error', '‚ùå Veuillez d√©marrer la cam√©ra d\'abord');
                return;
            }
            
            showAlert('info', 'üì∏ Compression de la photo...');
            
            // Cr√©er un canvas de taille r√©duite pour compresser
            const maxWidth = 800;
            const maxHeight = 600;
            
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            // Redimensionner si trop grand
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width = width * ratio;
                height = height * ratio;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, width, height);
            canvas.style.display = 'block';
            
            // Compresser en JPEG basse qualit√© (0.7 = 70%)
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            
            // V√©rifier la taille maximale (5MB = 5242880 bytes)
            const maxSize = 5242880;
            const dataSize = imageData.length;
            
            if (dataSize > maxSize) {
                showAlert('error', `‚ùå Photo trop grosse: ${(dataSize/1024/1024).toFixed(1)}MB (max 5MB)`);
                return;
            }
            
            donnees.photo = imageData;
            
            document.getElementById('preview-img').src = imageData;
            document.getElementById('image-preview').classList.remove('hidden');
            
            showAlert('success', `‚úÖ Photo captur√©e (${(dataSize/1024).toFixed(0)}KB)`);
        }
        
        function effacerPhoto() {
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            
            canvas.style.display = 'none';
            preview.classList.add('hidden');
            previewImg.src = '';
            donnees.photo = null;
            showAlert('info', 'üóëÔ∏è Photo supprim√©e');
        }
        
        // Formulaire
        function sauvegarderDonnees() {
            try {
                console.group('üìã COLLECTE DES DONN√âES - sauvegarderDonnees()');
                
                // üîç V√©rifier d'abord que les √©l√©ments existent
                console.log('1Ô∏è‚É£ R√©cup√©ration des √©l√©ments HTML par ID:');
                
                const partenaire_elem = document.getElementById('partenaire');
                const region_elem = document.getElementById('region');
                const departement_elem = document.getElementById('departement');
                const commune_elem = document.getElementById('commune');
                
                console.log(`   ‚úì partenaire: ${partenaire_elem ? '‚úÖ TROUV√â' : '‚ùå MANQUANT'}`);
                console.log(`   ‚úì region: ${region_elem ? '‚úÖ TROUV√â' : '‚ùå MANQUANT'}`);
                console.log(`   ‚úì departement: ${departement_elem ? '‚úÖ TROUV√â' : '‚ùå MANQUANT'}`);
                console.log(`   ‚úì commune: ${commune_elem ? '‚úÖ TROUV√â' : '‚ùå MANQUANT'}`);
                
                // R√©cup√©rer les valeurs avec d√©tails
                console.log('\n2Ô∏è‚É£ Lecture des valeurs:');
                
                donnees.partenaire = partenaire_elem ? partenaire_elem.value.trim() : '';
                donnees.region = region_elem ? region_elem.value.trim() : '';
                donnees.departement = departement_elem ? departement_elem.value.trim() : '';
                donnees.commune = commune_elem ? commune_elem.value.trim() : '';
                
                // AIDE POUR R√âGION - r√©cup√©rer aussi le texte affich√©
                let regionText = '';
                if (region_elem && region_elem.selectedIndex >= 0) {
                    regionText = region_elem.options[region_elem.selectedIndex].text;
                }
                
                // AIDE POUR D√âPARTEMENT - r√©cup√©rer aussi le texte affich√©
                let departementText = '';
                if (departement_elem && departement_elem.selectedIndex >= 0) {
                    departementText = departement_elem.options[departement_elem.selectedIndex].text;
                }
                
                // AIDE POUR COMMUNE - r√©cup√©rer aussi le texte affich√©
                let communeText = '';
                if (commune_elem && commune_elem.selectedIndex >= 0) {
                    communeText = commune_elem.options[commune_elem.selectedIndex].text;
                }
                
                console.log(`   partenaire = "${donnees.partenaire}"`);
                console.log(`   region = "${donnees.region}" | text="${regionText}"`);
                console.log(`   departement = "${donnees.departement}" | text="${departementText}"`);
                console.log(`   commune = "${donnees.commune}" | text="${communeText}"`);
                
                // R√©cup√©rer tous les types d'activit√© s√©lectionn√©s
                const typeActiviteSelect = document.getElementById('typeActivite');
                const selectedTypes = typeActiviteSelect ? Array.from(typeActiviteSelect.selectedOptions).map(option => option.value) : [];
                donnees.typeActivite = selectedTypes.length > 0 ? selectedTypes : [];
                
                donnees.adresse = document.getElementById('adresse') ? document.getElementById('adresse').value : '';
                donnees.superficie = document.getElementById('superficie') ? document.getElementById('superficie').value : '';
                donnees.besoinPersonnel = document.getElementById('besoinPersonnel') ? document.getElementById('besoinPersonnel').value : '';
                
                // R√©cup√©rer tous les dispositifs s√©lectionn√©s
                const dispositifSelect = document.getElementById('dispositifDeploy');
                const selectedDisposition = dispositifSelect ? Array.from(dispositifSelect.selectedOptions).map(option => option.value) : [];
                donnees.dispositifDeploy = selectedDisposition.length > 0 ? selectedDisposition : [];
                
                donnees.nombreRotation = document.getElementById('nombreRotation') ? document.getElementById('nombreRotation').value : '';
                donnees.infrastructureGestion = document.getElementById('infrastructureGestion') ? document.getElementById('infrastructureGestion').value : '';
                donnees.frequenceCollecte = document.getElementById('frequenceCollecte') ? document.getElementById('frequenceCollecte').value : '';
                donnees.bacs240 = document.getElementById('bacs240') ? document.getElementById('bacs240').value : '';
                donnees.caissePolybene = document.getElementById('caissePolybene') ? document.getElementById('caissePolybene').value : '';
                donnees.bacs660 = document.getElementById('bacs660') ? document.getElementById('bacs660').value : '';
                donnees.accessibilite = document.getElementById('accessibilite') ? document.getElementById('accessibilite').value : '';
                donnees.observation = document.getElementById('observation') ? document.getElementById('observation').value : '';
                
                // R√©cup√©rer les coordonn√©es UTM si elles existent
                const coordXElem = document.getElementById('coordonneeX');
                const coordYElem = document.getElementById('coordonneeY');
                donnees.coordonneeX = coordXElem ? coordXElem.value : '';
                donnees.coordonneeY = coordYElem ? coordYElem.value : '';
                
                console.log('\n3Ô∏è‚É£ OBJET donnees FINAL:', donnees);
                
                // ‚ö†Ô∏è ALERTE SI DONN√âES VIDES
                if (!donnees.region) {
                    console.warn('‚ö†Ô∏è ALERTE: R√©gion est vide! V√©rifiez que vous avez s√©lectionn√© une r√©gion dans le dropdown.');
                }
                if (!donnees.departement) {
                    console.warn('‚ö†Ô∏è ALERTE: D√©partement est vide! V√©rifiez que vous avez s√©lectionn√© un d√©partement dans le dropdown.');
                }
                if (!donnees.commune) {
                    console.warn('‚ö†Ô∏è ALERTE: Commune est vide! V√©rifiez que vous avez s√©lectionn√© une commune dans le dropdown.');
                }
                
                console.groupEnd();
                
                showAlert('success', '‚úÖ Donn√©es collect√©es localement!');
            } catch (error) {
                console.error('‚ùå Erreur lors de la r√©cup√©ration des donn√©es:', error);
                console.error('Stack:', error.stack);
                showAlert('error', '‚ùå Erreur: ' + error.message);
            }
        }
        
        function affichageResume() {
            const summary = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            let html = `
                <div class="data-item">
                    <div class="data-label">Partenaire:</div>
                    <div class="data-value">${donnees.partenaire}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">R√©gion:</div>
                    <div class="data-value">${donnees.region}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">D√©partement:</div>
                    <div class="data-value">${donnees.departement}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Commune:</div>
                    <div class="data-value">${donnees.commune}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Type d'Activit√©:</div>
                    <div class="data-value">${Array.isArray(donnees.typeActivite) ? donnees.typeActivite.join(', ') : donnees.typeActivite}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Adresse:</div>
                    <div class="data-value">${donnees.adresse}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Superficie:</div>
                    <div class="data-value">${donnees.superficie} ha</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Besoin en Personnel:</div>
                    <div class="data-value">${donnees.besoinPersonnel}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Dispositif D√©ploy√©:</div>
                    <div class="data-value">${Array.isArray(donnees.dispositifDeploy) ? donnees.dispositifDeploy.join(', ') : donnees.dispositifDeploy}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Nombre de Rotation:</div>
                    <div class="data-value">${donnees.nombreRotation}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Infrastructure de Gestion:</div>
                    <div class="data-value">${donnees.infrastructureGestion}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Fr√©quence de Collecte:</div>
                    <div class="data-value">${donnees.frequenceCollecte}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Bacs 240L:</div>
                    <div class="data-value">${donnees.bacs240}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Caisse Polybene:</div>
                    <div class="data-value">${donnees.caissePolybene}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Bacs 660L:</div>
                    <div class="data-value">${donnees.bacs660}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Accessibilit√©:</div>
                    <div class="data-value">${donnees.accessibilite}</div>
                </div>
            `;
            
            if (donnees.latitude) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Latitude:</div>
                        <div class="data-value">${donnees.latitude.toFixed(6)}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Longitude:</div>
                        <div class="data-value">${donnees.longitude.toFixed(6)}</div>
                    </div>
                `;
            }
            
            if (donnees.coordonneeX || donnees.coordonneeY) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Coordonn√©es X (UTM):</div>
                        <div class="data-value">${donnees.coordonneeX}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Coordonn√©es Y (UTM):</div>
                        <div class="data-value">${donnees.coordonneeY}</div>
                    </div>
                `;
            }
            
            if (donnees.observation) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Observations:</div>
                        <div class="data-value">${donnees.observation}</div>
                    </div>
                `;
            }
            
            if (donnees.photo) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Photo Captur√©e:</div>
                        <div class="data-value">‚úÖ Oui</div>
                    </div>
                `;
            }
            
            summaryContent.innerHTML = html;
            summary.style.display = 'block';
        }
        
        function exporterExcel(avecImage = true) {
            const ExcelJS = window.ExcelJS;
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Collecte de Donn√©es');
            
            // D√©finir les largeurs de colonnes
            worksheet.columns = [
                { width: 40 },
                { width: 50 }
            ];
            
            let rowCount = 1;
            
            // Titre principal
            const titleRow = worksheet.getRow(rowCount);
            titleRow.values = ['DIMENSIONNEMENT SONAGED - COLLECTE DE DONN√âES'];
            titleRow.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 14 };
            titleRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            titleRow.alignment = { horizontal: 'center', vertical: 'center' };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Informations du Site
            const sectionRow1 = worksheet.getRow(rowCount);
            sectionRow1.values = ['INFORMATIONS DU SITE'];
            sectionRow1.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow1.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            // Donn√©es du site
            const siteData = [
                ['R√©gion', donnees.region || 'R√©gion de Ziguinchor'],
                ['D√©partement', donnees.departement],
                ['Commune', donnees.commune],
                ['Type d\'Activit√©', donnees.typeActivite],
                ['Adresse', donnees.adresse],
                ['Superficie (ha)', donnees.superficie],
                ['Besoin en Personnel', donnees.besoinPersonnel],
                ['Dispositif D√©ploy√©', Array.isArray(donnees.dispositifDeploy) ? donnees.dispositifDeploy.join(', ') : donnees.dispositifDeploy],
                ['Nombre de Rotation', donnees.nombreRotation],
                ['Infrastructure de Gestion', donnees.infrastructureGestion],
                ['Fr√©quence de Collecte', donnees.frequenceCollecte],
                ['Bacs 240L', donnees.bacs240],
                ['Caisse Polybene', donnees.caissePolybene],
                ['Bacs 660L', donnees.bacs660],
                ['Accessibilit√©', donnees.accessibilite],
                ['Observations', donnees.observation]
            ];
            
            siteData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Localisation GPS
            const sectionRow2 = worksheet.getRow(rowCount);
            sectionRow2.values = ['LOCALISATION GPS'];
            sectionRow2.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow2.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const gpsData = [
                ['Latitude', donnees.latitude ? donnees.latitude.toFixed(6) : '--'],
                ['Longitude', donnees.longitude ? donnees.longitude.toFixed(6) : '--'],
                ['Pr√©cision (m)', donnees.precision || '--']
            ];
            
            gpsData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Localisation UTM
            const sectionRow3 = worksheet.getRow(rowCount);
            sectionRow3.values = ['LOCALISATION DU SITE (UTM)'];
            sectionRow3.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow3.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF69B4' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const utmData = [
                ['Coordonn√©es X (Easting)', donnees.coordonneeX],
                ['Coordonn√©es Y (Northing)', donnees.coordonneeY]
            ];
            
            utmData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Photo
            if (donnees.photo) {
                const sectionRow4 = worksheet.getRow(rowCount);
                sectionRow4.values = ['PHOTO CAPTUR√âE'];
                sectionRow4.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
                sectionRow4.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF10B981' } };
                worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
                rowCount++;
                
                // Convertir le canvas/data URL en image et l'ajouter
                const imageBase64 = donnees.photo.split('data:image/jpeg;base64,')[1] || donnees.photo;
                const imageId = workbook.addImage({
                    base64: imageBase64,
                    extension: 'jpeg'
                });
                
                // Ajouter l'image √† la feuille
                worksheet.addImage(imageId, {
                    tl: { col: 0, row: rowCount - 1 },
                    ext: { width: 400, height: 400 }
                });
                
                rowCount += 15;
            }
            
            // Section: Informations de collecte
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            const sectionRow5 = worksheet.getRow(rowCount);
            sectionRow5.values = ['INFORMATIONS DE COLLECTE'];
            sectionRow5.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow5.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const collecteData = [
                ['Date de Collecte', new Date(donnees.dateCollecte).toLocaleString('fr-FR')],
                ['Photo Captur√©e', donnees.photo ? 'Oui' : 'Non']
            ];
            
            collecteData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            // G√©n√©rer et t√©l√©charger le fichier
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `SONAGED_Collecte_${new Date().getTime()}.xlsx`;
                link.click();
                URL.revokeObjectURL(url);
                showAlert('success', '‚úÖ Fichier Excel export√© avec succ√®s!');
            });
        }
        
        function exporterJSON() {
            const dataStr = JSON.stringify(donnees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `collecte_donnees_${new Date().getTime()}.json`;
            link.click();
        }
        
        function imprimerDonnees() {
            window.print();
        }
        
        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 4000);
        }
        
        // Afficher le r√©sum√© des donn√©es avant sauvegarde
        function afficherResume() {
            // R√©cup√©rer tous les champs du formulaire
            const region = document.getElementById('region').value;
            const regionLabel = document.getElementById('region').options[document.getElementById('region').selectedIndex]?.text;
            const departement = document.getElementById('departement').value;
            const departementLabel = document.getElementById('departement').options[document.getElementById('departement').selectedIndex]?.text;
            const commune = document.getElementById('commune').value;
            const typeActivite = Array.from(document.getElementById('typeActivite').selectedOptions).map(opt => opt.text).join(', ');
            const partenaire = document.getElementById('partenaire').value;
            const adresse = document.getElementById('adresse').value;
            const superficie = document.getElementById('superficie').value;
            const besoinPersonnel = document.getElementById('besoinPersonnel').value;
            const dispositifDeploy = Array.from(document.getElementById('dispositifDeploy').selectedOptions).map(opt => opt.text).join(', ');
            const nombreRotation = document.getElementById('nombreRotation').value;
            const infrastructureGestion = document.getElementById('infrastructureGestion').value;
            const frequenceCollecte = document.getElementById('frequenceCollecte').value;
            const bacs240 = document.getElementById('bacs240').value;
            const caissePolybene = document.getElementById('caissePolybene').value;
            const bacs660 = document.getElementById('bacs660').value;
            const accessibilite = document.getElementById('accessibilite').value;
            const observation = document.getElementById('observation').value;
            const lat = document.getElementById('lat').textContent;
            const lon = document.getElementById('lon').textContent;
            const accuracy = document.getElementById('accuracy').textContent;
            const utmEasting = document.getElementById('utm-easting').textContent;
            const utmNorthing = document.getElementById('utm-northing').textContent;
            const photo = donnees.photo;
            
            if (!region || !departement || !commune) {
                alert('‚ùå Veuillez s√©lectionner la r√©gion, le d√©partement et la commune');
                return;
            }
            
            let resumeHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üìç LOCALISATION</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>R√©gion: <strong>${regionLabel || region}</strong></div>
                        <div>D√©partement: <strong>${departementLabel || departement}</strong></div>
                        <div>Commune: <strong>${commune}</strong></div>
                        <div>Adresse: <strong>${adresse}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üìä INFORMATIONS PRINCIPALES</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Type d'Activit√©: <strong>${typeActivite || 'Non sp√©cifi√©'}</strong></div>
                        <div>Partenaire: <strong>${partenaire}</strong></div>
                        <div>Superficie: <strong>${superficie} ha</strong></div>
                        <div>Accessibilit√©: <strong>${accessibilite}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üë• RESSOURCES</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Besoin en Personnel: <strong>${besoinPersonnel} personne(s)</strong></div>
                        <div>Nombre de Rotations: <strong>${nombreRotation}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üõ†Ô∏è INFRASTRUCTURE & √âQUIPEMENTS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Dispositif D√©ploy√©: <strong>${dispositifDeploy || 'Non sp√©cifi√©'}</strong></div>
                        <div>Infrastructure de Gestion: <strong>${infrastructureGestion}</strong></div>
                        <div>Fr√©quence de Collecte: <strong>${frequenceCollecte}</strong></div>
                        <div>Bacs 240L: <strong>${bacs240}</strong></div>
                        <div>Caisse Polyb√®ne: <strong>${caissePolybene}</strong></div>
                        <div>Bacs 660L: <strong>${bacs660}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üó∫Ô∏è COORDONN√âES GPS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Latitude: <strong>${lat}</strong></div>
                        <div>Longitude: <strong>${lon}</strong></div>
                        <div>Pr√©cision: <strong>${accuracy}</strong></div>
                        <div style="font-size: 12px; margin-top: 8px; color: #666;">
                            UTM - Easting: <strong>${utmEasting}</strong> | Northing: <strong>${utmNorthing}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            if (observation) {
                resumeHTML += `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üìù OBSERVATIONS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>${observation}</div>
                    </div>
                </div>
                `;
            }
            
            if (photo) {
                resumeHTML += `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">üì∑ PHOTO CAPTUR√âE</strong>
                    <div style="margin-top: 10px; text-align: center;">
                        <img src="${photo}" alt="Photo captur√©e" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 2px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    </div>
                </div>
                `;
            }
            
            resumeHTML += `
                <div style="background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%); padding: 15px; border-radius: 8px; text-align: center; font-size: 12px; color: #2d5016;">
                    <strong>‚úÖ V√©rifiez toutes les informations avant de sauvegarder</strong>
                </div>
            `;
            
            document.getElementById('resume-contenu').innerHTML = resumeHTML;
            document.getElementById('resume-section').style.display = 'block';
            
            // Scroller vers le r√©sum√©
            document.getElementById('resume-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Fonction pour sauvegarder en base de donn√©es
        function sauvegarderDonneesBD() {
            console.group('üî¥ COLLECTE DIRECTE DEPUIS LE FORMULAIRE HTML');
            
            // üî¥ COLLECTER DIRECTEMENT DES √âL√âMENTS HTML (pas de d√©pendance sur l'objet donnees)
            const partenaire = (document.getElementById('partenaire')?.value || '').trim();
            const region = (document.getElementById('region')?.value || '').trim();
            const departement = (document.getElementById('departement')?.value || '').trim();
            const commune = (document.getElementById('commune')?.value || '').trim();
            const adresse = (document.getElementById('adresse')?.value || '').trim();
            const superficie = (document.getElementById('superficie')?.value || '').trim();
            const besoinPersonnel = (document.getElementById('besoinPersonnel')?.value || '').trim();
            const observation = (document.getElementById('observation')?.value || '').trim();
            
            // Collecte des √©l√©ments multi-select
            const typeActiviteSelect = document.getElementById('typeActivite');
            const typeActivite = typeActiviteSelect ? Array.from(typeActiviteSelect.selectedOptions).map(opt => opt.value) : [];
            
            const dispositifDeploySelect = document.getElementById('dispositifDeploy');
            const dispositifDeploy = dispositifDeploySelect ? Array.from(dispositifDeploySelect.selectedOptions).map(opt => opt.value) : [];
            
            // Collecte des champs optionnels
            const nombreRotation = (document.getElementById('nombreRotation')?.value || '').trim();
            const infrastructureGestion = (document.getElementById('infrastructureGestion')?.value || '').trim();
            const frequenceCollecte = (document.getElementById('frequenceCollecte')?.value || '').trim();
            const bacs240 = (document.getElementById('bacs240')?.value || '').trim();
            const caissePolybene = (document.getElementById('caissePolybene')?.value || '').trim();
            const bacs660 = (document.getElementById('bacs660')?.value || '').trim();
            const accessibilite = (document.getElementById('accessibilite')?.value || '').trim();
            
            // Collecte des GPS
            const latitude = parseFloat(document.getElementById('lat')?.textContent || donnees.latitude || '');
            const longitude = parseFloat(document.getElementById('lon')?.textContent || donnees.longitude || '');
            const precision = parseFloat(document.getElementById('accuracy')?.textContent || donnees.precision || '');
            const coordonneeX = (document.getElementById('utm-easting')?.textContent || donnees.coordonneeX || '').trim();
            const coordonneeY = (document.getElementById('utm-northing')?.textContent || donnees.coordonneeY || '').trim();
            
            // Photo depuis donnees globales
            const photo = donnees.photo || null;
            
            console.log('‚úÖ COLLECTE DIRECTE - R√©sultats:');
            console.log('  Partenaire:', partenaire);
            console.log('  R√©gion:', region);
            console.log('  D√©partement:', departement);
            console.log('  Commune:', commune);
            console.log('  Adresse:', adresse);
            console.log('  Superficie:', superficie);
            console.log('  Personnel:', besoinPersonnel);
            console.log('  Latitude:', latitude);
            console.log('  Longitude:', longitude);
            console.log('  Precision:', precision);
            
            console.groupEnd();
            
            // ‚úÖ VALIDATION STRICTE DES CHAMPS OBLIGATOIRES
            console.group('üî¥ VALIDATION STRUCTE');
            
            const champs_vides = [];
            
            if (!partenaire) champs_vides.push('Partenaire');
            if (!region) champs_vides.push('R√©gion');
            if (!departement) champs_vides.push('D√©partement');
            if (!commune) champs_vides.push('Commune');
            if (!adresse) champs_vides.push('Adresse');
            if (!superficie) champs_vides.push('Superficie');
            if (!besoinPersonnel) champs_vides.push('Besoin en Personnel');
            
            // Afficher les v√©rifications
            champs_vides.length === 0 && console.log('‚úÖ Tous les champs obligatoires sont remplis!');
            champs_vides.forEach(champ => console.error(`‚ùå ${champ} est VIDE`));
            
            console.groupEnd();
            
            // Si des champs obligatoires sont vides
            if (champs_vides.length > 0) {
                const message = `‚ùå ERREUR: Veuillez remplir les champs obligatoires manquants:\n\n${champs_vides.map(c => '‚Ä¢ ' + c).join('\n')}`;
                console.error(message);
                alert(message);
                showAlert('error', message);
                return;
            }
            
            // GPS obligatoire
            if (!latitude || !longitude || isNaN(latitude) || isNaN(longitude)) {
                showAlert('error', 'üìç Les coordonn√©es GPS sont obligatoires. Cliquez sur "üì° Obtenir Position GPS" d\'abord.');
                console.error('‚ùå GPS invalide - Latitude:', latitude, 'Longitude:', longitude);
                return;
            }
            
            // Afficher le r√©sum√© pour v√©rification
            afficherResume();
            
            // Demander confirmation
            if (!confirm('‚úÖ √ätes-vous s√ªr(e) de vouloir sauvegarder ces donn√©es en base de donn√©es ?')) {
                console.log('‚ÑπÔ∏è Sauvegarde annul√©e par l\'utilisateur');
                return;
            }
            
            console.log('üì§ Pr√™t √† envoyer les donn√©es au serveur');
            
            // Pr√©parer les donn√©es pour l'envoi (DIRECTEMENT depuis les variables locales)
            const dataToSend = {
                partenaire: partenaire,
                region: region,
                departement: departement,
                commune: commune,
                typeActivite: typeActivite.length > 0 ? typeActivite.join(',') : '',
                adresse: adresse,
                superficie: superficie,
                besoinPersonnel: besoinPersonnel,
                dispositifDeploy: dispositifDeploy.length > 0 ? dispositifDeploy.join(',') : '',
                nombreRotation: nombreRotation,
                infrastructureGestion: infrastructureGestion,
                frequenceCollecte: frequenceCollecte,
                bacs240: bacs240,
                caissePolybene: caissePolybene,
                bacs660: bacs660,
                accessibilite: accessibilite,
                observation: observation,
                latitude: latitude,
                longitude: longitude,
                precision: precision,
                coordonneeX: coordonneeX,
                coordonneeY: coordonneeY,
                photo: photo,
                dateCollecte: new Date().toISOString()
            };
            
            console.group('üü¢ DONN√âES √Ä ENVOYER AU SERVEUR');
            console.log('Partenaire:', dataToSend.partenaire);
            console.log('R√©gion:', dataToSend.region);
            console.log('D√©partement:', dataToSend.departement);
            console.log('Commune:', dataToSend.commune);
            console.log('Adresse:', dataToSend.adresse);
            console.log('Latitude:', dataToSend.latitude);
            console.log('Longitude:', dataToSend.longitude);
            console.log('Full dataToSend:', JSON.stringify(dataToSend, null, 2));
            console.groupEnd();
            
            showAlert('success', '‚è≥ Envoi des donn√©es au serveur... Veuillez patienter.');
            
            // V√©rifier la taille totale avant envoi
            const totalSize = JSON.stringify(dataToSend).length;
            console.log('üì¶ Taille totale √† envoyer:', (totalSize/1024/1024).toFixed(2), 'MB');
            
            if (totalSize > 25 * 1024 * 1024) {
                showAlert('error', `‚ùå Les donn√©es sont trop volumineuses: ${(totalSize/1024/1024).toFixed(1)}MB`);
                return;
            }
            
            console.log('üöÄ Envoi des donn√©es au serveur...');
            
            // Envoyer au serveur
            fetch('http://localhost:3001/api/collecte', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                console.log('üì° R√©ponse serveur:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Erreur serveur ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(result => {
                console.log('‚úÖ R√©ponse du serveur (SUCCESS):', result);
                showAlert('success', '‚úÖ Donn√©es sauvegard√©es avec succ√®s dans la base de donn√©es!');
                
                // Sauvegarder aussi localement
                sauvegarderEnLocal(dataToSend);
                
                // R√©initialiser le formulaire apr√®s 2 secondes
                setTimeout(() => {
                    document.getElementById('donnees-form').reset();
                    document.getElementById('resume-section').style.display = 'none';
                    donnees = {
                        partenaire: '', region: '', departement: '', commune: '',
                        typeActivite: [], adresse: '', superficie: '',
                        besoinPersonnel: '', dispositifDeploy: [], nombreRotation: '',
                        infrastructureGestion: '', frequenceCollecte: '',
                        bacs240: '', caissePolybene: '', bacs660: '',
                        accessibilite: '', observation: '',
                        latitude: null, longitude: null, precision: null,
                        coordonneeX: '', coordonneeY: '', photo: null,
                        dateCollecte: new Date().toISOString()
                    };
                    console.log('‚úÖ Formulaire r√©initialis√©');
                }, 2000);
            })
            .then(response => {
                // ‚úÖ V√©rifier le Content-Type avant de parser
                const contentType = response.headers.get('content-type');
                console.log(`   üìã Content-Type: ${contentType}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('‚ùå R√©ponse non-JSON re√ßue:', contentType);
                    return response.text().then(text => {
                        console.error('üìÑ Texte re√ßu:', text.substring(0, 200));
                        throw new Error(`R√©ponse invalide (${contentType || 'unknown'}): ${text.substring(0, 100)}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || data.message || 'Erreur serveur');
                }

                console.log('‚úÖ Donn√©es sauvegard√©es avec succ√®s!');
                console.log('   ID:', data.data.id);
                console.log('   Date:', data.data.dateCollecte);
                showAlert('success', '‚úÖ Donn√©es envoy√©es avec succ√®s!');
                
                // Vider le formulaire
                document.getElementById('collecte-form').reset();
                previewImg.style.display = 'none';
                console.log('üìã Formulaire r√©initialis√©');
            })
            .catch(error => {
                console.error('‚ùå Erreur compl√®te:', error);
                console.error('üìç Stack:', error.stack);
                console.error('üìä Type d\'erreur:', error.name);
                console.error('üíæ Donn√©es envoy√©es (size):', (JSON.stringify(dataToSend).length/1024/1024).toFixed(2), 'MB');
                
                // Message plus d√©taill√© bas√© sur le type d'erreur
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = 'Le serveur n\'est pas accessible. V√©rifiez que: 1) Le serveur est lanc√© (npm start) 2) L\'URL est correcte (http://localhost:3001) 3) Votre connexion Internet';
                } else if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
                    errorMsg = 'Erreur de format de r√©ponse. Le serveur a peut-√™tre retourn√© du HTML au lieu du JSON. V√©rifiez la console du serveur.';
                } else if (error.message.includes('Ressource') || error.message.toString().includes('Ressource')) {
                    errorMsg = 'La ressource n\'est pas accessible. Cela peut indiquer un probl√®me avec la transmission des donn√©es (taille trop grande ou timeout r√©seau).';
                } else if (error.message.includes('HTTP 500')) {
                    errorMsg = 'Erreur serveur (500). V√©rifiez la console du serveur pour plus de d√©tails.';
                } else if (error.message.includes('HTTP')) {
                    errorMsg = error.message;
                } else if (error.message.includes('R√©ponse invalide')) {
                    errorMsg = error.message;
                }
                
                showAlert('error', `‚ö†Ô∏è Erreur: ${errorMsg}`);
                
                // Sauvegarder quand m√™me en local en cas d'√©chec
                console.log('üíæ Sauvegarde locale de secours...');
                sauvegarderEnLocal(dataToSend);
                showAlert('info', 'üíæ Donn√©es sauvegard√©es localement. Elles seront synchronis√©es quand le serveur sera disponible.');
            });
        }
        
        // Sauvegarder en localStorage en tant que secours
        function sauvegarderEnLocal(donnees) {
            try {
                // Cr√©er une copie sans la photo pour r√©duire la taille localStorage
                const donneesReduite = { ...donnees };
                if (donneesReduite.photo) {
                    donneesReduite.photo = '(photo supprim√©e du local storage)';
                }
                
                const collectes = JSON.parse(localStorage.getItem('collectes_donnees') || '[]');
                collectes.push({
                    ...donneesReduite,
                    saveDateLocal: new Date().toISOString(),
                    photoExists: !!donnees.photo
                });
                localStorage.setItem('collectes_donnees', JSON.stringify(collectes));
                console.log('‚úÖ Donn√©es sauvegard√©es en localStorage');
            } catch (e) {
                console.error('‚ùå Erreur localStorage:', e);
            }
        }
        
        // Fonction de diagnostic pour v√©rifier les permissions et connexion
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            afficherInfoCache();
            document.getElementById('date-update').textContent = new Date().toLocaleDateString('fr-FR');
            mettreAJourSites();
            
            // Initialiser les selects g√©ographiques
            initialiserSelectsGeographiques();
            
            // V√©rifier le statut PWA
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                console.log('‚úÖ Ex√©cution en mode PWA');
                showAlert('success', 'üì± Application PWA charg√©e!');
            }
        });
    </script>
    
    <!-- Configuration d'environnement (doit √™tre avant api-client.js) -->
    <script src="config.js"></script>
    <!-- Client API pour communication avec PostgreSQL backend -->
    <script src="api-client.js"></script>

</body>
</html>

