<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Application mobile de collecte de données géographiques pour le dimensionnement des sites SONAGED">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SONAGED Map">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dy='.3em'>S</text></svg>">
    <title>Dimensionnement SONAGED - Collecte de Données</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c27 50%, #6db038 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .header > * {
            position: relative;
            z-index: 1;
        }
        
        .header-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .header-logo-container img {
            height: 100px;
            width: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
            animation: float 3s ease-in-out infinite;
        }
        
        .sonaged-logo {
            height: 120px;
            width: 120px;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.3)) drop-shadow(0 2px 4px rgba(45, 80, 22, 0.5));
            animation: float 3s ease-in-out infinite, spin 6s ease-in-out infinite;
        }
        
        @keyframes spin {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(2deg); }
            75% { transform: rotate(-2deg); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 15px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .header-features {
            font-size: 12px;
            opacity: 0.88;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-features span {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        /* ===== ANIMATIONS FLUIDES ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Animations des sections */
        .section {
            animation: fadeIn 0.6s ease-out;
        }
        
        .form-group {
            animation: fadeIn 0.5s ease-out;
        }
        
        .galerie-container {
            animation: slideInRight 0.7s ease-out;
        }
        
        /* Animations des boutons */
        button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Animation des inputs */
        input, select, textarea {
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(109, 176, 56, 0.1) !important;
        }
        
        /* Animation des cartes galerie */
        .galerie-item {
            animation: fadeIn 0.5s ease-out;
        }
        
        .galerie-item img {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .galerie-item:hover img {
            transform: scale(1.08);
        }
        
        /* Animation du modal */
        .galerie-modal {
            animation: fadeIn 0.3s ease-out;
        }
        
        .galerie-modal-content {
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Animation des alertes */
        .alert {
            animation: slideInRight 0.4s ease-out;
        }
        
        /* Animation des marqueurs carte */
        .leaflet-marker-icon {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Animation smooth scroll */
        html {
            scroll-behavior: smooth;
        }
        
        /* Animation du compteur d'images */
        .galerie-counter {
            animation: fadeIn 0.5s ease-out 0.2s both;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Animation du bouton de téléchargement */
        .telecharger-btn {
            animation: fadeIn 0.5s ease-out 0.3s both;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .telecharger-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 24px rgba(109, 176, 56, 0.4);
            background-color: #5aa332 !important;
        }
        
        /* Animation des infos photo */
        .galerie-info {
            animation: slideInLeft 0.5s ease-out 0.2s both;
        }
        
        .galerie-detail-item {
            animation: fadeIn 0.4s ease-out;
            transition: all 0.3s ease;
            padding: 10px;
            border-left: 3px solid transparent;
        }
        
        .galerie-detail-item:hover {
            border-left-color: #6db038;
            background-color: rgba(109, 176, 56, 0.1);
            transform: translateX(5px);
        }
        
        /* Animation des boutons de navigation */
        .galerie-nav-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .galerie-nav-button:hover {
            transform: scale(1.15) translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .galerie-nav-button:active {
            transform: scale(0.95);
        }
        
        /* Animation de l'en-tête */
        .header {
            animation: slideInDown 0.7s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Animation du logo */
        .header-logo-container img {
            animation: fadeIn 0.8s ease-out, float 3s ease-in-out 0.8s infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Animation des cartes de stats */
        .stats-card {
            animation: scaleIn 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
        }
        
        /* Animation des titres */
        h1, h2, h3 {
            transition: all 0.3s ease;
        }
        
        h2:hover {
            color: #6db038;
            text-shadow: 0 4px 8px rgba(109, 176, 56, 0.3);
        }
        
        /* Désactiver les animations sur les médias réduits */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .section h2 {
            color: #2d5016;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 3px solid #6db038;
            padding-bottom: 12px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #2d5016;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select, textarea {
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        select[multiple] {
            padding: 10px;
            min-height: 120px;
            background: white;
            border-color: #d0d0d0;
        }
        
        select[multiple] option {
            padding: 10px 5px;
            line-height: 1.6;
        }
        
        /* ===== ANIMATIONS DE FORMULAIRE ===== */
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            background: linear-gradient(135deg, #ffffff 0%, #f0f8e6 100%);
            border-color: #6db038 !important;
            box-shadow: 0 0 0 4px rgba(109, 176, 56, 0.1) !important;
            transform: translateY(-1px);
        }
        
        /* Animation de la vidéo */
        video, canvas {
            transition: all 0.4s ease;
        }
        
        video:not([style*="display: none"]),
        canvas:not([style*="display: none"]) {
            animation: slideInLeft 0.5s ease-out;
        }
        
        /* Animation de la carte */
        #map, #collecte-map {
            transition: all 0.5s ease;
            animation: fadeIn 0.6s ease-out;
        }
        
        /* Animation du preview image */
        #image-preview {
            animation: fadeIn 0.4s ease-out;
        }
        
        #preview-img {
            animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* ===== ANIMATIONS DES ALERTES ET MESSAGES ===== */
        .alert-box {
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.3s ease;
        }
        
        .alert-box:hover {
            transform: translateX(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        /* Animation du résumé */
        #resume-section {
            animation: fadeIn 0.5s ease-out;
        }
        
        .data-summary {
            animation: fadeIn 0.6s ease-out;
        }
        
        .data-item {
            animation: slideInLeft 0.4s ease-out;
            transition: all 0.3s ease;
        }
        
        .data-item:hover {
            transform: translateX(4px);
        }
        
        /* ===== ANIMATIONS DES STATISTIQUES ===== */
        .galerie-stat-item {
            animation: scaleIn 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .galerie-stat-item:hover {
            transform: scale(1.05);
        }
        
        .galerie-stat-number {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* ===== ANIMATIONS DES BOUTONS ===== */
        .success, .danger, .info {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .success:hover, .danger:hover, .info:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .success:active, .danger:active, .info:active {
            transform: translateY(-1px);
        }
        
        /* Effet de ripple au clic */
        .success::after, .danger::after, .info::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .success:active::after, .danger:active::after, .info:active::after {
            width: 300px;
            height: 300px;
        }
        
        /* ===== ANIMATIONS SPÉCIALES ===== */
        /* Animation de chargement */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        /* Animation de succès */
        @keyframes checkmark {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        
        /* Animation de l'en-tête */
        .header {
            animation: slideInDown 0.7s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Animation du conteneur principal */
        .container {
            animation: fadeIn 0.8s ease-out;
        }
        
        /* Animation des cartes de stats */
        .stats-card {
            animation: scaleIn 0.5s ease-out;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
        }
        
        /* Animation du logo au chargement */
        .header-logo-container img {
            animation: fadeIn 0.8s ease-out, float 3s ease-in-out 0.8s infinite;
        }
        
        /* Animation des titres */
        h1, h2, h3 {
            transition: all 0.3s ease;
        }
        
        h2:hover {
            color: #6db038;
            text-shadow: 0 4px 8px rgba(109, 176, 56, 0.3);
        }
        
        /* Animation des liens */
        a {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        a:hover {
            color: #6db038;
        }
        
        /* Animation des icônes */
        .icon {
            transition: all 0.3s ease;
        }
        
        .icon:hover {
            transform: rotate(10deg) scale(1.1);
        }
        
        /* Animation smooth pour les transitions */
        * {
            transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* S'assurer que tous les boutons sont cliquables sur mobile */
        button {
            pointer-events: auto !important;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Désactiver les animations sur les médias réduits */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        select[multiple] option:checked {
            background: linear-gradient(#6db038, #6db038);
            background-color: #6db038 !important;
            color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6db038;
            background: white;
            box-shadow: 0 0 0 3px rgba(109, 176, 56, 0.1);
        }
        
        button {
            padding: 13px 24px;
            background: linear-gradient(135deg, #6db038 0%, #4a7c27 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(109, 176, 56, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(109, 176, 56, 0.4);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        button.danger:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }
        
        .success {
            background: linear-gradient(135deg, #6db038 0%, #4a7c27 100%) !important;
            pointer-events: auto !important;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        #map {
            height: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        video {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        video.active {
            display: block;
        }
        
        canvas {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            display: none;
        }
        
        canvas.active {
            display: block;
        }
        
        .coords-display {
            background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%);
            padding: 18px;
            border-radius: 10px;
            border-left: 5px solid #6db038;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(109, 176, 56, 0.1);
        }
        
        .coords-display strong {
            color: #2d5016;
            font-weight: 700;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .button-group button {
            flex: 1;
            min-width: 160px;
        }
        
        .danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
        }
        
        .danger:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4) !important;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #0c2340;
            border-left: 4px solid #3b82f6;
        }
        
        .hidden {
            display: none;
        }

        /* ===== STYLES RESPONSIVE DES IMAGES ===== */
        /* Styles généraux pour toutes les images */
        img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Images dans les conteneurs flex/grid */
        div img {
            max-width: 100%;
            height: auto;
        }

        /* Force l'adaptation des images avec style inline */
        img[style*="width: 100%"] {
            max-width: 100%;
            height: auto !important;
        }

        img[style*="height"] {
            height: auto !important;
            aspect-ratio: auto;
        }

        /* Images actualités et galeries spécifies */
        img[style*="height: 140px"],
        img[style*="height: 180px"],
        img[style*="height: 120px"],
        img[style*="height: 100px"],
        img[style*="height: 150px"] {
            height: auto !important;
            object-fit: cover;
            object-position: center;
        }

        /* Galeries et conteneurs d'images */
        .galerie-item-image {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 0.9;
            object-fit: cover;
            object-position: center;
            background: #f0f0f0;
        }

        .galerie-modal-image {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
            object-position: center;
            display: block;
        }

        /* Conteneurs d'actualités avec images */
        div[style*="grid-template-columns: 1fr 1fr"] {
            gap: 15px;
        }

        div[style*="grid-template-columns: 1fr 1fr"] img {
            max-width: 100%;
            height: auto;
            aspect-ratio: 1.4 / 1;
            object-fit: cover;
            object-position: center;
        }

        /* Conteneurs d'acteurs (3 colonnes) */
        div[style*="grid-template-columns: 1fr 1fr 1fr"] img {
            max-width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            object-position: center;
        }

        /* Conteneurs à 4 colonnes */
        div[style*="grid-template-columns: repeat(4, 1fr)"] img {
            max-width: 100%;
            height: auto;
            aspect-ratio: 1 / 0.85;
            object-fit: cover;
            object-position: center;
        }

        /* Images de préview */
        #preview-img {
            max-width: 100%;
            height: auto;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px 0;
            object-fit: contain;
            object-position: center;
        }

        /* Vidéos et canvas adaptation */
        video {
            width: 100%;
            height: auto;
            max-height: 250px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            object-fit: cover;
        }

        canvas {
            width: 100%;
            height: auto;
            max-height: 250px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            display: none;
        }

        /* CSS Mobile et Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                box-shadow: none;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .partners-logos {
                gap: 20px;
            }

            .partners-logos img {
                height: 50px;
            }

            .content {
                padding: 15px;
            }

            .section {
                gap: 12px;
            }

            #map, #collecte-map {
                height: 300px;
            }

            video, canvas {
                max-height: 250px;
            }

            button {
                padding: 12px 16px;
                font-size: 13px;
            }

            .button-group button {
                min-width: 120px;
            }

            label {
                font-size: 12px;
            }

            input, select, textarea {
                padding: 8px;
                font-size: 13px;
            }

            select[multiple] {
                min-height: 80px;
            }

            /* RESPONSIVE IMAGES - Tablet */
            .galerie-item-image {
                aspect-ratio: 1 / 0.9 !important;
                height: auto !important;
                max-height: 130px !important;
            }

            div[style*="grid-template-columns: 1fr 1fr"] img[style*="height: 140px"],
            div[style*="grid-template-columns: 1fr 1fr"] img[style*="height: 180px"] {
                height: auto !important;
                max-height: 120px !important;
                aspect-ratio: 1.4 / 1 !important;
            }

            div[style*="grid-template-columns: 1fr 1fr 1fr"] img[style*="height: 100px"] {
                height: auto !important;
                max-height: 90px !important;
                aspect-ratio: 1 / 1 !important;
            }

            div[style*="grid-template-columns: repeat(4, 1fr)"] img {
                height: auto !important;
                max-height: 120px !important;
                aspect-ratio: 1 / 0.85 !important;
            }

            /* Force toutes les images à s'adapter */
            img[style*="height: 140px"],
            img[style*="height: 180px"],
            img[style*="height: 100px"],
            img[style*="height: 120px"] {
                height: auto !important;
                max-height: 120px !important;
            }

            #preview-img {
                max-height: 200px !important;
            }

            video:not(.active) {
                max-height: 200px !important;
            }

            canvas:not(.active) {
                max-height: 200px !important;
            }

            /* RESPONSIVE LANDING PAGE - Mobile */
            #landing-section {
                padding: 30px 15px !important;
                gap: 25px !important;
            }

            /* Section HERO - passer à 1 colonne */
            #landing-section > div {
                display: flex !important;
                flex-direction: column !important;
                grid-template-columns: 1fr !important;
                gap: 20px !important;
                align-items: unset !important;
            }

            /* Texte de bienvenue */
            #landing-section > div > div:first-child {
                animation: slideInLeft 0.8s ease-out !important;
            }

            #landing-section h2 {
                font-size: 28px !important;
                margin-bottom: 15px !important;
            }

            #landing-section h2 + p {
                font-size: 14px !important;
            }

            #landing-section > div > div:first-child > p {
                font-size: 13px !important;
                margin-bottom: 12px !important;
            }

            /* Boutons d'action */
            #landing-section button {
                padding: 12px 20px !important;
                font-size: 14px !important;
                width: 100% !important;
            }

            /* Section actualité - passer à 1 colonne */
            #landing-section > div > div:last-child {
                animation: slideInRight 0.8s ease-out !important;
                width: 100% !important;
            }

            /* Header actualité */
            #landing-section > div > div:last-child > div:first-child {
                padding: 12px !important;
                border-radius: 6px !important;
            }

            #landing-section > div > div:last-child h3 {
                font-size: 14px !important;
                gap: 6px !important;
            }

            #landing-section > div > div:last-child h3 span {
                font-size: 16px !important;
            }

            #landing-section > div > div:last-child > div:last-child {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* Images actualité */
            #landing-section img {
                height: 120px !important;
            }

            #landing-section > div > div:last-child div > p {
                font-size: 11px !important;
                padding: 10px !important;
            }

            /* Galeries avec 4 colonnes - convertir en 2 colonnes */
            div[style*="grid-template-columns: repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
            }

            /* Features cards */
            #features-section,
            div[class*="feature-card"],
            div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }

            /* Réduire la hauteur des images dans les galeries */
            #landing-section > div[style*="background: linear-gradient"] div img,
            div[style*="grid-template-columns: repeat(4, 1fr)"] img {
                height: auto !important;
                max-height: 150px !important;
                aspect-ratio: 1 / 0.85 !important;
            }

            /* Images actualités */
            #landing-section img[style*="height: 140px"],
            #landing-section img[style*="height: 180px"],
            #landing-section img[style*="height: 100px"] {
                height: auto !important;
                max-height: 120px !important;
                aspect-ratio: 1.4 / 1 !important;
            }

            /* Conteneurs d'images */
            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 12px;
            }

            #map, #collecte-map {
                height: 250px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
                min-width: unset;
            }

            .data-item {
                grid-template-columns: 1fr;
            }
            
            /* ULTRA RESPONSIVE LANDING PAGE - Très petit écran */
            #landing-section {
                padding: 20px 12px !important;
                gap: 20px !important;
            }

            #landing-section h2 {
                font-size: 24px !important;
            }

            #landing-section > div > div:first-child > p {
                font-size: 12px !important;
                line-height: 1.5 !important;
            }

            /* Features grid */
            #features-section {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            /* Partenaires galerie */
            #landing-section > div > div > div {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* Galeries 4 colonnes → 1 colonne */
            div[style*="grid-template-columns: repeat(4, 1fr)"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* Images plus petites */
            #landing-section img {
                height: auto !important;
                max-height: 100px !important;
                aspect-ratio: 1.4 / 1 !important;
            }

            #landing-section img[style*="height: 140px"],
            #landing-section img[style*="height: 180px"],
            #landing-section img[style*="height: 100px"] {
                height: auto !important;
                max-height: 100px !important;
                aspect-ratio: 1.4 / 1 !important;
            }

            div[style*="grid-template-columns: repeat(4, 1fr)"] img {
                height: auto !important;
                max-height: 100px !important;
                aspect-ratio: 1 / 0.85 !important;
            }

            #preview-img {
                height: auto !important;
                max-height: 150px !important;
            }

            video, canvas {
                max-height: 200px !important;
            }
        }

        /* ===== OPTIMISATION CIRCUIT TRACKER POUR MOBILE ===== */
        /* Desktop - Circuit Map 500px */
        #circuit-map {
            width: 100% !important;
            height: 500px !important;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Styles pour les marqueurs du circuit */
        .leaflet-marker-icon {
            border-radius: 50%;
        }
        
        /* Polyline du circuit - gradient visuel */
        .leaflet-pane.leaflet-overlay-pane .leaflet-path {
            transition: stroke-width 0.2s ease;
        }

        /* Tablette - Circuit Map 350px */
        @media (max-width: 768px) {
            #circuit-map {
                height: 350px !important;
            }
            
            /* Modal circuit en 2 colonnes */
            #circuit-modal > div > div:nth-child(1) {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 15px !important;
            }
        }

        /* Petit mobile - Circuit Map 200px */
        @media (max-width: 480px) {
            #circuit-map {
                height: 200px !important;
            }
            
            /* Modal circuit en 1 colonne */
            #circuit-modal > div > div:nth-child(1) {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            /* Panel contrôle passe sous la carte */
            #circuit-modal > div > div:nth-child(2) {
                width: 100% !important;
                max-width: 100% !important;
            }
        }

        /* Responsive - Tablette (768px) */
        @media (max-width: 768px) {
            #circuit-modal > div {
                grid-template-columns: 1fr !important;
            }
            
            #circuits-list {
                max-height: 200px !important;
            }
        }
        
        /* Responsive - Small Mobile (480px) */
        @media (max-width: 480px) {
            #circuit-modal > div {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            #circuits-list {
                max-height: 150px !important;
            }
        }

        /* Écrans très courts en hauteur (paysage sur petit mobile) */
        @media (max-height: 600px) {
            #circuit-map {
                height: 150px !important;
            }
            
            #circuit-modal > div {
                min-height: auto !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
            }
        }

        /* ===== OPTIMISATION TAILLE BOUTONS MOBILE ===== */
        button {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        @media (max-width: 480px) {
            button {
                padding: 14px 18px !important;
                font-size: 14px !important;
                min-height: 48px !important;
            }
        }

        /* ===== OPTIMISATION INPUT MOBILE ===== */
        input, select, textarea {
            font-size: 16px; /* Évite auto-zoom iOS */
            min-height: 44px;
            padding: 10px 12px;
        }

        @media (max-width: 480px) {
            input, select, textarea {
                padding: 12px 14px !important;
                font-size: 16px !important;
            }
        }

        /* ===== GESTION ORIENTATION MOBILE ===== */
        @media (orientation: landscape) and (max-height: 500px) {
            .container {
                border-radius: 0;
                box-shadow: none;
            }

            .header {
                padding: 10px 15px;
            }

            .header h1 {
                font-size: 16px;
            }

            #map, #collecte-map, #circuit-map {
                height: 300px !important;
            }

            body {
                padding: 0;
            }
        }

        /* ===== RESPONSIVE MODAL CIRCUIT ===== */
        #circuit-modal > div {
            width: 95% !important;
            max-width: 100vw !important;
            margin: 30px auto !important;
            max-height: auto !important;
        }

        @media (max-width: 480px) {
            #circuit-modal > div {
                margin: 10px auto !important;
                border-radius: 8px !important;
            }
            
            #circuit-modal > div > div:first-child {
                padding: 12px 15px !important;
            }
        }

        /* ===== INDICATEUR QUALITÉ GPS - NOUVEAU ===== */
        .gps-quality {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .gps-quality.good {
            background: #6db038;
            color: white;
        }

        .gps-quality.medium {
            background: #ff9800;
            color: white;
        }

        .gps-quality.poor {
            background: #c92a2a;
            color: white;
        }

        /* ===== CIRCUIT MAP FULLSCREEN ===== */
        #circuit-map-fullscreen {
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            border: 0 !important;
            border-radius: 0 !important;
            z-index: 100;
        }

        /* ===== CIRCUIT MODAL FULLSCREEN ===== */
        #circuit-modal {
            background: rgba(0, 0, 0, 0.1) !important;
        }

        /* Boutons Flottants */
        #circuit-controls-float button,
        #btn-toggle-export {
            transition: all 0.2s ease;
            border: 2px solid white;
        }

        #circuit-controls-float button:hover,
        #btn-toggle-export:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25) !important;
        }

        #circuit-controls-float button:active,
        #btn-toggle-export:active {
            transform: scale(0.95);
        }

        /* Header Flottant */
        #circuit-header-float {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Info Flottant */
        #circuit-info-float {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== BUTTON STYLES ===== */
        #btn-demarrer-circuit,
        #btn-pause-circuit,
        #btn-ajouter-marker,
        #btn-terminer-circuit,
        #btn-toggle-export {
            transition: all 0.2s ease !important;
            touch-action: manipulation;
        }

        /* Responsive - Mobile Fullscreen */
        @media (max-width: 768px) {
            #circuit-controls-float {
                flex-direction: column !important;
            }

            #circuit-header-float {
                font-size: 14px;
                padding: 10px 15px !important;
            }

            #circuit-info-float {
                font-size: 10px;
                padding: 10px !important;
                bottom: 100px !important;
            }

            #btn-toggle-export {
                bottom: 70px !important;
            }

            #circuit-basemap-float {
                top: 70px !important;
            }
        }

        @media (max-width: 480px) {
            #circuit-controls-float button,
            #btn-toggle-export {
                width: 45px !important;
                height: 45px !important;
                font-size: 20px !important;
            }

            #circuit-header-float {
                font-size: 12px;
                max-width: calc(100% - 20px) !important;
            }

            #circuit-info-float {
                display: block !important;
            }

            #circuit-basemap-float {
                display: block !important;
            }
        }

        /* ===== DESKTOP - Interface standard ===== */
        @media (min-width: 769px) {
            #circuit-mobile-fullscreen {
                display: none !important;
            }

            #circuit-desktop-modal {
                display: block !important;
            }

            #circuit-map-fullscreen {
                display: none !important;
            }
        }

        /* ===== MOBILE - Interface fullscreen ===== */
        @media (max-width: 768px) {
            #circuit-mobile-fullscreen {
                display: flex !important;
                width: 100% !important;
                height: 100% !important;
            }

            #circuit-desktop-modal {
                display: none !important;
            }

            #circuit-map {
                display: none !important;
            }

            #circuit-map-fullscreen {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
            }

            /* Ajuster les boutons pour petit écran */
            #btn-demarrer-circuit,
            #btn-pause-circuit,
            #btn-ajouter-marker,
            #btn-terminer-circuit,
            #btn-toggle-export {
                width: 45px !important;
                height: 45px !important;
                font-size: 20px !important;
            }

            /* Réorganiser les boutons sur très petit écran */
            @media (max-width: 480px) {
                #btn-pause-circuit {
                    left: 60px !important;
                }

                #btn-ajouter-marker {
                    left: 110px !important;
                }

                #btn-terminer-circuit {
                    left: 160px !important;
                }

                #btn-toggle-export {
                    left: 210px !important;
                }

                #circuit-header-float {
                    font-size: 11px !important;
                    padding: 10px 12px !important;
                }

                #circuit-basemap-float {
                    padding: 8px 10px !important;
                    font-size: 10px !important;
                }

                #circuit-info-float {
                    font-size: 9px !important;
                    max-width: 150px !important;
                }
            }
        }

        /* ===== SUPPORT NOTCH & SAFE AREA ===== */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-top: max(15px, env(safe-area-inset-top));
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
        }

        video, canvas {
                max-height: 200px !important;
            }

        /* Desktop et écrans larges (1000px+) */
        @media (min-width: 1000px) {
            /* Optimiser les images pour les grands écrans */
            .galerie-item-image {
                aspect-ratio: 1 / 0.9 !important;
                height: auto !important;
                max-height: 160px !important;
            }

            div[style*="grid-template-columns: 1fr 1fr"] img[style*="height: 140px"],
            div[style*="grid-template-columns: 1fr 1fr"] img[style*="height: 180px"] {
                height: auto !important;
                max-height: 180px !important;
                aspect-ratio: 1.4 / 1 !important;
            }

            div[style*="grid-template-columns: 1fr 1fr 1fr"] img[style*="height: 100px"] {
                height: auto !important;
                max-height: 120px !important;
                aspect-ratio: 1 / 1 !important;
            }

            div[style*="grid-template-columns: repeat(4, 1fr)"] img {
                height: auto !important;
                max-height: 160px !important;
                aspect-ratio: 1 / 0.85 !important;
            }

            #preview-img {
                max-height: 350px !important;
            }

            video, canvas {
                max-height: 350px !important;
            }
        }

        /* Styles pour l'install PWA */
        #install-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #install-prompt.hidden {
            display: none;
        }

        #install-prompt > div {
            flex: 1;
        }

        #install-prompt button {
            background: white;
            color: #667eea;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            margin: 0;
            flex-shrink: 0;
        }

        #install-prompt button:hover {
            background: #f0f0f0;
        }

        /* Optimisation Leaflet pour mobile */
        .leaflet-container {
            font-size: 12px;
        }

        .leaflet-control {
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        .leaflet-control-zoom {
            border: none;
        }

        .leaflet-control-zoom a {
            background-color: #667eea;
            color: white;
            border: none;
        }

        .leaflet-control-zoom a:hover {
            background-color: #764ba2;
        }

        .leaflet-popup-content {
            font-size: 13px;
        }

        /* Safe area pour encoche */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                padding-top: max(10px, env(safe-area-inset-top));
            }
        }
        
        .data-summary {
            background: #f9fafb;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #e5e7eb;
            margin-top: 20px;
        }
        
        .data-summary h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .data-item {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 600;
            color: #667eea;
        }
        
        .data-value {
            color: #333;
            word-break: break-word;
        }
        
        footer {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c27 50%, #5ba837 100%);
            padding: 40px 20px;
            text-align: center;
            color: white;
            font-size: 13px;
            border-top: 4px solid #6db038;
            position: relative;
            overflow: hidden;
        }
        
        footer::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        footer::after {
            content: '';
            position: absolute;
            bottom: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        footer > * {
            position: relative;
            z-index: 1;
        }
        
        footer p {
            margin: 8px 0;
            opacity: 0.95;
            letter-spacing: 0.3px;
        }
        
        footer strong {
            font-weight: 700;
            display: block;
            margin-bottom: 3px;
            color: #a4d65e;
        }

        /* ===== STYLES GALERIE ===== */
        .galerie-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            max-height: 700px;  /* ✅ LIMITE HAUTEUR */
            height: auto;       /* ✅ S'adapte au contenu mais limité */
        }

        .galerie-header {
            background: linear-gradient(135deg, #2d5016 0%, #5ba837 100%);
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;  /* ✅ Ne pas compresser le header */
        }

        .galerie-header h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .galerie-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .galerie-stats {
            display: flex;
            justify-content: space-around;
            padding: 12px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
            flex-shrink: 0;  /* ✅ Ne pas compresser les stats */
            flex-wrap: wrap;
            gap: 8px;
        }

        .galerie-stat-item {
            text-align: center;
            flex: 1;
            min-width: 80px;
        }

        .galerie-stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #2d5016;
        }

        .galerie-stat-label {
            color: #666;
            font-size: 11px;
        }

        .galerie-scroll {
            flex: 1;                   /* ✅ Prend l'espace restant */
            padding: 20px;
            overflow-y: auto;          /* ✅ Scroll vertical si nécessaire */
            overflow-x: hidden;        /* ✅ Pas de scroll horizontal */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            align-content: start;
            min-height: 0;             /* ✅ Permet au flex de calculer la hauteur */
        }

        /* 🖐️ SMOOTHSCROLL - Barre de scroll stylisée */
        .galerie-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .galerie-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .galerie-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #6db038 0%, #5ba837 100%);
            border-radius: 10px;
        }

        .galerie-scroll::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5ba837 0%, #4a7c27 100%);
        }

        .galerie-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease-out;
        }

        .galerie-item:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 12px 28px rgba(45, 80, 22, 0.25);
            border-color: #6db038;
        }

        .galerie-item-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .galerie-item-info {
            padding: 12px;
            font-size: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .galerie-item-commune {
            font-weight: bold;
            color: #2d5016;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .galerie-item-detail {
            color: #666;
            margin-bottom: 3px;
            font-size: 11px;
            flex: 1;
        }

        .galerie-item-detail strong {
            color: #5ba837;
        }

        @media (max-width: 600px) {
            .galerie-container {
                max-height: 500px;  /* ✅ Hauteur réduite sur mobile */
            }

            .galerie-scroll {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 10px;
            }

            .galerie-item-image {
                height: 120px;  /* ✅ Images plus petites sur mobile */
            }

            .galerie-header {
                padding: 15px;  /* ✅ Padding réduit */
            }

            .galerie-stats {
                padding: 8px;
                font-size: 11px;
            }
        }

        /* Modal pour images */
        .galerie-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .galerie-modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 95%;
            max-width: 700px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-height: 85vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .galerie-modal-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .galerie-modal-info {
            padding: 15px;
            background: white;
        }

        .galerie-modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            background: rgba(0,0,0,0.3);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            border: none;
            z-index: 2002;
        }

        .galerie-modal-close:hover {
            background: rgba(0,0,0,0.6);
        }

        .galerie-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.4);
            color: white;
            border: none;
            font-size: 30px;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2002;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .galerie-nav-button:hover {
            background: rgba(0,0,0,0.8);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .cta-button-primary:hover {
            box-shadow: 0 6px 20px rgba(109, 176, 56, 0.5);
        }

        .galerie-nav-button:active {
            transform: translateY(-50%) scale(0.95);
        }

        .galerie-nav-prev {
            left: 10px;
        }

        .galerie-nav-next {
            right: 10px;
        }

        .galerie-modal-counter {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 2002;
        }
        
        /* ===== NAVIGATION MENUS ===== */
        #menu-navigation {
            display: flex !important;
            justify-content: center;
            gap: 0;
        }
        
        .menu-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .menu-btn:hover {
            background: linear-gradient(135deg, #4a7c27 0%, #6db038 100%) !important;
            transform: translateY(-2px);
        }
        
        .menu-btn.active {
            border-bottom-color: #a4d65e !important;
            background: linear-gradient(135deg, #4a7c27 0%, #5ba837 100%) !important;
        }
        
        .content {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            #menu-navigation {
                flex-direction: column;
            }
            
            .menu-btn {
                padding: 14px 20px !important;
                font-size: 14px !important;
            }
        }
        
        /* ===== STYLES POUR DIFFÉRENCIER LES VUES ===== */
        /* Cacher le header principal lors du formulaire */
        #collecte-section:not([style*="display: none"]) ~ .header,
        #formulaire-section:not([style*="display: none"]) ~ .header {
            display: none;
        }
        
        /* Header du formulaire simplifié */
        #collecte-section .form-header,
        #formulaire-section .form-header {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 0;
        }
        
        #collecte-section .form-header h1,
        #formulaire-section .form-header h1 {
            color: white;
            font-size: 24px;
            font-weight: 800;
            margin: 0;
        }
        
        /* ===== RÉDUIRE LES ESPACES ENTRE LES CHAMPS ===== */
        /* Réduire l'espacement avant Partenaire (après Commune/TypeActivite) */
        #collecte-section .form-group:has(#partenaire),
        #formulaire-section .form-group:has(#partenaire) {
            margin-top: -10px;
        }
        
        /* Réduire l'espacement avant Fréquence de Collecte (après Nombre de Rotation) */
        #collecte-section .form-group:has(#frequenceCollecte),
        #formulaire-section .form-group:has(#frequenceCollecte) {
            margin-top: -10px;
        }
        
        /* Fallback avec nth-child au cas où :has() n'est pas supporté */
        @supports not selector(:has(*)) {
            /* Réduire l'espacement des form-group après commune et nombreRotation */
            #collecte-section .form-group,
            #formulaire-section .form-group {
                gap: 4px;
            }
        }
        
        /* ===== STYLES CARTE LEAFLET - LANDING PAGE ===== */
        #dimensionnement-map {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border: 2px solid #e5e7eb;
            z-index: 1;
            background: #f0f8e6;
            position: relative;
        }
        
        @media (max-width: 768px) {
            #dimensionnement-map {
                height: 400px;
            }
        }
        
        @media (max-width: 480px) {
            #dimensionnement-map {
                height: 300px;
            }
        }
    </style>

    <!-- 🗺️ TURF.JS pour géométries & buffer -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <!-- 📝 SHPWRITE pour export Shapefile client-side -->
    <script src="https://cdn.jsdelivr.net/npm/shpwrite@0.3.2/dist/shpwrite.js"></script>

</head>
<body>
    <div id="alert-container" style="position: fixed; top: 10px; right: 10px; z-index: 1000; max-width: 300px;"></div>
    <div id="install-prompt" class="hidden">
        <div>
            <strong>📲 Installer l'application SONAGED</strong>
            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">Accédez à vos cartes hors ligne</p>
        </div>
        <button onclick="installPWA()">Installer</button>
        <button onclick="dismissInstall()" style="background: rgba(255,255,255,0.2); color: white;">×</button>
    </div>
    <div class="container">
        <div class="header">
            <div class="header-logo-container">
                <!-- Logo SONAGED Image Externe -->
                <img class="sonaged-logo" src="./src/assets/logo-sonaged.jpg" alt="SONAGED Logo">
                <!-- 
                    📍 LOGO CHARGÉ DEPUIS: ./src/assets/logo-sonaged.jpg
                -->
                
                <div>
                    <h1 style="color: #2d5016; font-size: 36px; font-weight: 800; margin-bottom: 8px;">SONAGED</h1>
                    <p style="font-size: 16px; opacity: 0.95; color: #5ba837; font-weight: 600; letter-spacing: 0.5px;">Dimensionnement & Collecte de Données</p>
                    <p style="font-size: 13px; opacity: 0.85; margin-top: 5px; color: white;">Gestion intelligente des ressources</p>
                </div>
            </div>
            <div class="header-features">
                <span>📱 Mobile PWA</span>
                <span>🗺️ Géolocalisation</span>
                <span>📷 Photographie</span>
                <span>💾 Données Locales</span>
                <span>🗄️ PostgreSQL</span>
                <span>🌐 Mode Hors-Ligne</span>
            </div>
        </div>
        
        <!-- 🧭 NAVIGATION BAR 3 MENUS -->
        <div id="menu-navigation" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%); padding: 0; border-bottom: 3px solid #6db038; display: flex; justify-content: center; gap: 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <button onclick="mostrarMenu('accueil')" id="btn-accueil" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%); color: white; border: none; padding: 18px 40px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s elastic(1, .5); display: flex; align-items: center; gap: 10px; border-bottom: 4px solid #6db038;" class="menu-btn active">
                <span style="font-size: 20px;">🏠</span> Accueil
            </button>
            <button onclick="mostrarMenu('actualite')" id="btn-actualite" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%); color: white; border: none; padding: 18px 40px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; border-bottom: 4px solid transparent;" class="menu-btn">
                <span style="font-size: 20px;">🔥</span> Actualité & Convention
            </button>
            <button onclick="mostrarMenu('collecte')" id="btn-collecte" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%); color: white; border: none; padding: 18px 40px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; border-bottom: 4px solid transparent;" class="menu-btn">
                <span style="font-size: 20px;">📊</span> Accéder à la Collecte
            </button>
        </div>
        
        <!-- 🏠 MENU 1: ACCUEIL -->
        <div id="accueil-section" class="content" style="display: flex; flex-direction: column; padding: 60px 40px; gap: 40px; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-top: 1px solid #e5e7eb;">
            
            <!-- HERO SECTION - PRÉSENTATION SIMPLE -->
            <div style="animation: slideInLeft 0.8s ease-out;">
                <h2 style="font-size: 48px; font-weight: 800; color: #2d5016; margin-bottom: 20px; line-height: 1.2;">
                    🌍 Bienvenue à l'application de Dimensionnement SONAGED
                </h2>
                <p style="font-size: 18px; color: #4a5568; margin-bottom: 20px; line-height: 1.7; font-weight: 600;">
                    <strong>Société Nationale de Gestion de Déchets</strong>
                </p>
                <p style="font-size: 15px; color: #718096; margin-bottom: 15px; line-height: 1.8;">
                    Application mobile intelligente pour la collecte de données géospatiales au niveau national au Sénégal permettant aux agents SONAGED de collecter des informations détaillées sur les sites d'infrastructures de gestion des déchets.
                </p>
                <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                    <button onclick="allerAuFormulaire()" class="cta-button-primary" style="background: linear-gradient(135deg, #6db038 0%, #4a7c27 100%); color: white; padding: 16px 40px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(109, 176, 56, 0.3); transition: all 0.3s; pointer-events: auto;">
                        📱 Accéder à la Collecte
                    </button>
                </div>
            </div>
            
            <!-- COVERAGE STATS - COUVERTURE NATIONALE -->
            <div style="background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%); padding: 50px; border-radius: 12px; color: white; text-align: center; animation: fadeIn 0.8s ease-out 0.4s backwards;">
                <h3 style="font-size: 32px; font-weight: 700; margin-bottom: 40px;">🌍 Couverture Nationale du Sénégal</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 40px;">
                    <div>
                        <div style="font-size: 56px; font-weight: 800; color: #6db038; margin-bottom: 8px;">14</div>
                        <p style="font-size: 16px; opacity: 0.95; font-weight: 600;">Régions Couverts</p>
                        <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Collecte complète</p>
                    </div>
                    <div>
                        <div style="font-size: 56px; font-weight: 800; color: #6db038; margin-bottom: 8px;">45+</div>
                        <p style="font-size: 16px; opacity: 0.95; font-weight: 600;">Départements</p>
                        <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Couverture étendue</p>
                    </div>
                    <div>
                        <div style="font-size: 56px; font-weight: 800; color: #6db038; margin-bottom: 8px;">500+</div>
                        <p style="font-size: 16px; opacity: 0.95; font-weight: 600;">Communes</p>
                        <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Données précises</p>
                    </div>
                </div>
            </div>
            
            <!-- 🗺️ DIMENSIONNEMENT MAP SECTION -->
            <div id="map-section" style="margin: 50px 0; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); animation: slideInDown 0.8s ease-out 0.2s backwards;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h2 style="font-size: 28px; font-weight: 800; color: #2d5016; margin: 0; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 32px;">🗺️</span> Réseau National SONAGED - Couverture Opérationnelle
                        </h2>
                        <p style="font-size: 13px; color: #718096; margin-top: 8px; margin-bottom: 0; font-weight: 500;">
                            Visualisez le maillage territorial : régions, départements, arrondissements, circuits collecte/balayage, et infrastructure mobilier urbain
                        </p>
                    </div>
                </div>
                
                <!-- Carte Leaflet -->
                <div id="dimensionnement-map" style="width: 100%; height: 600px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #e5e7eb; margin-bottom: 20px;"></div>
                
                <!-- Légende -->
                <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; font-size: 12px;">
                        <strong style="color: #2d5016; display: block; margin-bottom: 12px; font-size: 13px;">📍 Couches Administratives</strong>
                        <div style="margin-bottom: 10px;"><span style="display: inline-block; width: 20px; height: 20px; background: rgba(139, 69, 19, 0.4); border: 1px solid #8B4513; border-radius: 4px; margin-right: 8px; vertical-align: middle;"></span>Régions</div>
                        <div style="margin-bottom: 10px;"><span style="display: inline-block; width: 20px; height: 20px; background: rgba(199, 21, 133, 0.4); border: 1px solid #C71585; border-radius: 4px; margin-right: 8px; vertical-align: middle;"></span>Départements</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: rgba(173, 51, 151, 0.4); border: 1px solid #AD3397; border-radius: 4px; margin-right: 8px; vertical-align: middle;"></span>Arrondissements</div>
                    </div>
                    
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; font-size: 12px;">
                        <strong style="color: #2d5016; display: block; margin-bottom: 12px; font-size: 13px;">🚛 Circuits & Mobilier</strong>
                        <div style="margin-bottom: 10px;"><span style="display: inline-block; width: 20px; height: 4px; background: rgba(220, 20, 60, 0.6); border: 1px solid #DC143C; border-radius: 2px; margin-right: 8px; vertical-align: middle;"></span>Circuits Collecte</div>
                        <div style="margin-bottom: 10px;"><span style="display: inline-block; width: 20px; height: 4px; background: rgba(147, 51, 234, 0.6); border: 1px dashed #9333EA; border-radius: 2px; margin-right: 8px; vertical-align: middle;"></span>Circuits Balayage</div>
                        <div><span style="display: inline-block; width: 16px; height: 16px; background: rgba(34, 197, 94, 0.8); border: 2px solid #22C55E; border-radius: 50%; margin-right: 8px; vertical-align: middle;"></span>Mobilier Urbain</div>
                    </div>
                </div>
                
                <div style="background: #f0f8e6; padding: 15px; border-radius: 8px; border-left: 4px solid #6db038; margin-top: 20px;">
                    <p style="margin: 0; font-size: 12px; color: #2d5016;">
                        <strong>💡 Astuce :</strong> Utilisez les contrôles en haut à droite de la carte pour afficher/masquer les couches. Cliquez sur les éléments pour voir les détails.
                    </p>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                    <button onclick="allerAuFormulaire()" class="cta-button-primary" style="background: linear-gradient(135deg, #6db038 0%, #4a7c27 100%); color: white; padding: 16px 40px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(109, 176, 56, 0.3); transition: all 0.3s; pointer-events: auto;">
                        📱 Accéder à la Collecte
                    </button>
                </div>
            </div>
        </div>
        <!-- FIN SECTION ACCUEIL -->
        
        <!-- 🔥 MENU 2: ACTUALITÉ & CONVENTION -->
        <div id="actualite-section" class="content" style="display: none; padding: 40px; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); min-height: 100vh;">
            <div style="margin-top: 40px; padding: 40px; background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%); border-radius: 12px; border-left: 6px solid #6db038;">
                <h2 style="font-size: 32px; font-weight: 800; color: #2d5016; text-align: center; margin-bottom: 30px;">🤝 Nos Partenaires & Conventions</h2>
                
                <!-- 🔥 ACTUALITÉS CONVENTIONS -->
                <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #ff6b6b; margin-bottom: 30px; text-align: center;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #c92a2a; margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 24px;">🔥</span>
                        ACTUALITÉ CONVENTION
                        <span style="font-size: 24px;">🔥</span>
                    </h3>
                    <p style="margin-top: 8px; color: #6d4e0d; font-size: 12px; margin-bottom: 0;">Conventions en cours - Événements importants</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <!-- ⭐ IMAGE DIRECTEUR ET RESPONSABLE SIG - ACTUALITÉ -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 6px 16px rgba(0,0,0,0.15); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; border: 2px solid #6db038;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.15)';">
                        <div style="position: relative; overflow: hidden;">
                            <img src="./src/assets/Image Directeur et Responsable SIG.jpeg" alt="Directeur et Responsable SIG" style="width: 100%; height: 180px; object-fit: cover;">
                            <div style="position: absolute; top: 8px; right: 8px; background: #6db038; color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700;">🔥 ACTUALITÉ</div>
                        </div>
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Directeur & SIG</p>
                    </div>
                    
                    <!-- ⭐ IMAGE DG CONVENTION COJOJ - ACTUALITÉ -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 6px 16px rgba(0,0,0,0.15); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; border: 2px solid #6db038;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.15)';">
                        <div style="position: relative; overflow: hidden;">
                            <img src="./src/assets/Image du DG pour la Convention avec COJOJ.jpeg" alt="DG Convention COJOJ" style="width: 100%; height: 180px; object-fit: cover;">
                            <div style="position: absolute; top: 8px; right: 8px; background: #6db038; color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700;">🔥 ACTUALITÉ</div>
                        </div>
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">DG - Convention COJOJ</p>
                    </div>
                    
                    <!-- Convention SENELEC 1 -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Image Convention avec SENELEC.jpeg" alt="Convention SENELEC" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Convention SENELEC</p>
                    </div>
                    
                    <!-- Convention SENELEC 2 -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Image 2 Convention avec SENELEC.jpeg" alt="Convention SENELEC 2" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Convention SENELEC 2</p>
                    </div>
                    
                    <!-- Convention SENELEC 3 -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Image 3 Convention avec SENELEC.jpeg" alt="Convention SENELEC 3" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Convention SENELEC 3</p>
                    </div>
                    
                    <!-- Convention Mairie Ziguinchor -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Image Convention avec Mairie de ZIGUINCHIR.jpeg" alt="Mairie Ziguinchor" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Mairie Ziguinchor</p>
                    </div>
                    
                    <!-- Convention DAKAR DEM DIK -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Image Convention DAKAR DEM DIK.jpeg" alt="Convention Dakar Dem Dik" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Convention Dakar Dem Dik</p>
                    </div>
                    
                    <!-- Convention Mairie MLOMP -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Image Convention en Partenariat avec Le Maire de MLOMP.jpeg" alt="Mairie MLOMP" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Mairie MLOMP</p>
                    </div>
                    
                    <!-- Base Navale MLOMP -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Image en Partenanriat avec La Base Naval de MLOMP.jpeg" alt="Base Navale MLOMP" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Base Navale MLOMP</p>
                    </div>
                    
                    <!-- Camp Militaire BIGNOA -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Image en Partenariat avec le Camp Militaire de BIGNOA.jpeg" alt="Camp Militaire BIGNOA" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Camp Militaire BIGNOA</p>
                    </div>
                    
                    <!-- Délégué Régionale de Ziguinchor -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Délégué Régionale de Ziguinchor.jpeg" alt="Délégué Régionale de Ziguinchor" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Délégué Régionale Ziguinchor</p>
                    </div>
                    
                    <!-- Délégué Départemental de Ziguinchor -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Délegué Départemental de Ziguinchor .jpeg" alt="Délégué Départemental de Ziguinchor" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Délégué Départemental Ziguinchor</p>
                    </div>
                    
                    <!-- Chef de Projet Convention Ziguinchor -->
                    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';">
                        <img src="./src/assets/Chef de Projet Convention Ziguinchor.jpeg" alt="Chef de Projet Convention Ziguinchor" style="width: 100%; height: 180px; object-fit: cover;">
                        <p style="padding: 15px; text-align: center; font-weight: 600; color: #2d5016; font-size: 13px; margin: 0;">Chef de Projet Convention</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- FIN SECTION ACTUALITÉ & CONVENTION -->
        
        <!-- 📊 MENU 3: COLLECTE DE DONNÉES -->
        <div id="collecte-section" class="content" style="display: none;">
        
        <div class="form-header" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%); color: white; padding: 30px 30px; text-align: center; margin-bottom: 0;">
            <h1 style="color: white; font-size: 24px; font-weight: 800; margin: 0; display: flex; align-items: center; justify-content: center; gap: 12px;">
                � Accéder à la Collecte de Données
            </h1>
        </div>
        
        <div class="content">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <span style="background: linear-gradient(135deg, #2d5016 0%, #5ba837 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">1</span>
                    <h2 style="margin: 0;">📝 Informations du Site</h2>
                </div>
                
                <div id="alert-container" style="margin-bottom: 15px;"></div>
                
                <div class="form-group">
                    <label for="region">🗺️ Région <span style="color: red;">*</span></label>
                    <select id="region" required onchange="mettreAJourDepartements(); validerChamp('region');">
                        <option value="">-- Sélectionner une région --</option>
                    </select>
                    <small class="error-msg" id="error-region" style="color: red; display: none;">⚠️ Région obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="departement">📍 Département <span style="color: red;">*</span></label>
                    <select id="departement" required onchange="mettreAJourCommunes(); validerChamp('departement');">
                        <option value="">-- Sélectionner un département --</option>
                    </select>
                    <small class="error-msg" id="error-departement" style="color: red; display: none;">⚠️ Département obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="commune">🏘️ Commune <span style="color: red;">*</span></label>
                    <select id="commune" required onchange="validerChamp('commune');">
                        <option value="">-- Sélectionner une commune --</option>
                    </select>
                    <small class="error-msg" id="error-commune" style="color: red; display: none;">⚠️ Commune obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="typeActivite">Type d'Activité (Sélectionner plusieurs)</label>
                    <select id="typeActivite" required multiple size="5">
                        <option value="Levé des dechets vert">Levé des dechets vert</option>
                        <option value="Desherbage">Desherbage</option>
                        <option value="Mecanisation">Mecanisation</option>
                        <option value="Collecte">Collecte</option>
                        <option value="Balayage">Balayage</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">💡 Maintenez Ctrl (Cmd sur Mac) pour sélectionner plusieurs choix</small>
                </div>
                
                <div class="form-group" style="margin-top: -8px;">
                    <label for="partenaire">Partenaire <span style="color: red;">*</span></label>
                    <input type="text" id="partenaire" placeholder="Ex: SONAGED, ONG, etc." required onchange="validerChamp('partenaire');">
                    <small class="error-msg" id="error-partenaire" style="color: red; display: none;">⚠️ Partenaire obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="adresse">Sites Concernés <span style="color: red;">*</span></label>
                    <input type="text" id="adresse" placeholder="Sites concernés" required onchange="validerChamp('adresse');">
                    <small class="error-msg" id="error-adresse" style="color: red; display: none;">⚠️ Sites Concernés obligatoires</small>
                </div>
                
                <div class="form-group">
                    <label for="superficie">Superficie (m²) <span style="color: red;">*</span></label>
                    <div style="display: flex; gap: 8px; align-items: end;">
                        <div style="flex: 1;">
                            <input type="number" id="superficie" placeholder="ex: 28100" step="0.01" required onchange="validerChamp('superficie');">
                            <small class="error-msg" id="error-superficie" style="color: red; display: none;">⚠️ Superficie obligatoire</small>
                        </div>
                        <button type="button" onclick="calculerSuperficie()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: 600; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">📐 Calculer</button>
                    </div>
                    <small style="color: #6db038; margin-top: 8px; display: block; font-weight: 500;">🚶 <strong>Méthode GPS:</strong> Marchez autour du site, appuyez sur "Ajouter Point" pour enregistrer les coordonnées. Min 3 points.</small>
                </div>
                
                <div class="form-group">
                    <label for="besoinPersonnel">Besoin en Personnel <span style="color: red;">*</span></label>
                    <input type="number" id="besoinPersonnel" placeholder="Nombre de personnes" step="1" required onchange="validerChamp('besoinPersonnel');">
                    <small class="error-msg" id="error-besoinPersonnel" style="color: red; display: none;">⚠️ Personnel obligatoire</small>
                </div>
                
                <div class="form-group">
                    <label for="dispositifDeploy">Dispositif Déployé (Sélectionner plusieurs)</label>
                    <select id="dispositifDeploy" required multiple size="4">
                        <option value="Pelle Chargeur">Pelle Chargeur</option>
                        <option value="Camion BTP">Camion BTP</option>
                        <option value="Polybene">Polybene</option>
                        <option value="Benne tasseuse">Benne tasseuse</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">💡 Maintenez Ctrl (Cmd sur Mac) pour sélectionner plusieurs choix</small>
                </div>
                
                <div class="form-group">
                    <label for="nombreRotation">Nombre de Rotation</label>
                    <input type="number" id="nombreRotation" placeholder="Nombre de rotations" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="infrastructureGestion">Infrastructure de Gestion de Dechets</label>
                    <select id="infrastructureGestion" required>
                        <option value="">-- Sélectionner --</option>
                        <option value="PRN">PRN</option>
                        <option value="PP">PP</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-top: -8px;">
                    <label for="frequenceCollecte">Fréquence de Collecte</label>
                    <select id="frequenceCollecte" required>
                        <option value="">-- Sélectionner --</option>
                        <option value="F1">F1</option>
                        <option value="F2">F2</option>
                        <option value="F3">F3</option>
                        <option value="F4">F4</option>
                        <option value="F5">F5</option>
                        <option value="F6">F6</option>
                        <option value="F7">F7</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bacs240">Bacs 240L</label>
                    <input type="number" id="bacs240" placeholder="Nombre de bacs" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="caissePolybene">Caisse Polybene</label>
                    <input type="number" id="caissePolybene" placeholder="Nombre de caisses" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="bacs660">Bacs 660L</label>
                    <input type="number" id="bacs660" placeholder="Nombre de bacs" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="accessibilite">Accessibilité</label>
                    <select id="accessibilite" required>
                        <option value="">-- Sélectionner --</option>
                        <option value="Facile">Facile</option>
                        <option value="Difficile">Difficile</option>
                        <option value="Route non goudronnée">Route non goudronnée</option>
                        <option value="Route goudronnée">Route goudronnée</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="observation">Observations</label>
                    <textarea id="observation" placeholder="Notes supplémentaires" rows="3"></textarea>
                </div>
                
                <!-- RÉSUMÉ DES DONNÉES AVANT SAUVEGARDE -->
                <div id="resume-section" style="display: none; background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%); padding: 25px; border-radius: 12px; border-left: 6px solid #6db038; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(109, 176, 56, 0.15);">
                    <h3 style="color: #2d5016; margin-bottom: 18px; font-size: 20px; font-weight: 700;">📋 Résumé des Données</h3>
                    <div id="resume-contenu" style="font-size: 14px; line-height: 2; color: #333;"></div>
                </div>
            </div>
            </form>
            
            <!-- LOCALISATION & IMAGES -->
            <div class="section">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <span style="background: linear-gradient(135deg, #2d5016 0%, #5ba837 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">2</span>
                    <h2 style="margin: 0;">📍 Localisation et Images</h2>
                </div>
                
                <div class="coords-display" id="coords-display">
                    <strong>📍 Coordonnées actuelles:</strong><br>
                    Latitude: <span id="lat">--</span><br>
                    Longitude: <span id="lon">--</span><br>
                    Précision: <span id="accuracy">--</span> m<br>
                    <small style="margin-top: 10px; display: block; opacity: 0.8;">UTM - Easting: <span id="utm-easting">--</span> | Northing: <span id="utm-northing">--</span></small>
                </div>
                
                <!-- Champs cachés pour coordonnées UTM -->
                <input type="hidden" id="coordonneeX" value="">
                <input type="hidden" id="coordonneeY" value="">
                
                <!-- ⭐ BOUTON UNIQUE: CAPTURE PHOTO + GPS + MARQUEUR -->
                <button onclick="capturerPhotoAvecGPSEtMarqueur()" style="width: 100%; background: linear-gradient(135deg, #2d5016 0%, #6db038 100%); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 12px rgba(109, 176, 56, 0.3);" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 16px rgba(109, 176, 56, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(109, 176, 56, 0.3)'">
                    📸 Capturer Photo + GPS + Marqueur
                </button>
                
                <div id="map"></div>
                
                <div id="gps-camera-capture" style="display: none; margin-top: 20px; padding: 15px; background: #f0f8e6; border-radius: 8px; border-left: 4px solid #6db038;">
                    <h3 style="color: #2d5016; margin-top: 0;">🎬 Capture Géolocalisée</h3>
                    
                    <!-- Infos GPS en temps réel -->
                    <div class="coords-display" id="coords-display-live" style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px;">
                        <strong>📍 Position GPS:</strong><br>
                        Latitude: <span id="lat-live">⏳ En recherche...</span><br>
                        Longitude: <span id="lon-live">⏳ En recherche...</span><br>
                        Précision: <span id="accuracy-live">⏳ En recherche...</span> m
                    </div>
                    
                    <!-- Caméra et vidéo -->
                    <div class="button-group" style="margin-bottom: 10px;">
                        <button id="demarrer-camera-live" onclick="demarrerCameraLive()" style="flex: 1;">📹 Démarrer Caméra</button>
                        <button id="arreter-camera-live" class="danger" onclick="arreterCameraLive()" style="flex: 1; display: none;">⏹️ Arrêter Caméra</button>
                    </div>
                    
                    <video id="video-live" style="width: 100%; border-radius: 8px; background: #000; margin: 10px 0; display: none;" playsinline></video>
                    <canvas id="canvas-live" style="width: 100%; border-radius: 8px; margin: 10px 0; display: none;"></canvas>
                    
                    <!-- Bouton capture: activé seulement si caméra + GPS OK -->
                    <button id="capturer-avec-gps-btn" onclick="capturerPhotoGeoloc()" style="width: 100%; background: linear-gradient(135deg, #6db038 0%, #9acd32 100%); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; opacity: 0.5; cursor: not-allowed;" disabled>
                        ⏳ Préparez-vous... (Caméra + GPS)
                    </button>
                </div>
                
                <div id="image-preview" class="hidden">
                    <div id="photo-info" style="background: #f0f8e6; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #6db038; font-size: 12px; color: #2d5016;">
                        <strong>📌 Nom du fichier:</strong> <span id="photo-filename">photo_site.jpg</span>
                    </div>
                    <img id="preview-img" src="" alt="Aperçu" style="width: 100%; border-radius: 8px; margin: 10px 0; max-height: 300px;">
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <button onclick="telechargerPhoto()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">⬇️ Télécharger l'Image</button>
                        <button class="danger" onclick="effacerPhoto()" style="width: 100%; margin-top: 0;">🗑️ Effacer Photo</button>
                    </div>
                </div>
                
                <!-- CARTE DU SÉNÉGAL AVEC POINTS COLLECTÉS -->
                <div style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <span style="background: linear-gradient(135deg, #2d5016 0%, #5ba837 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">3</span>
                        <h2 style="margin: 0;">🗺️ Localisation des Collectes</h2>
                    </div>
                    <div id="collecte-map" style="width: 100%; height: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border: 2px solid #e5e7eb;"></div>
                    <div style="margin-top: 10px; padding: 12px; background: #f0f8e6; border-left: 4px solid #6db038; border-radius: 4px; font-size: 12px; color: #333;">
                        <strong>ℹ️ Légende:</strong> Les marqueurs 📍 indiquent les sites collectés. 
                        Vous pouvez zoomer/dézoomer et cliquer sur les marqueurs pour voir les détails.
                    </div>
                    
                    <!-- BOUTONS D'ACTION - VOIR RÉSUMÉ ET SAUVEGARDER -->
                    <div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); padding: 25px; border-radius: 12px; border-top: 3px solid #6db038; margin-top: 30px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                        <div style="display: flex; gap: 15px; flex-direction: column;">
                            <button id="btn-voir-resume" class="success" type="button" style="width: 100%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 14px; font-size: 16px; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s; border: none; color: white; cursor: pointer; pointer-events: auto !important; touch-action: manipulation; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;">👁️ Voir le Résumé</button>
                            <button id="btn-sauvegarder" class="success" type="button" style="width: 100%; background: linear-gradient(135deg, #6db038 0%, #5ba837 100%); padding: 14px; font-size: 16px; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 12px rgba(109, 176, 56, 0.3); transition: all 0.3s; border: none; color: white; cursor: pointer; pointer-events: auto !important; touch-action: manipulation; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;">💾 Sauvegarder les Données</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- BOUTON POUR VOIR LA GALERIE -->
            <div style="text-align: center; margin: 30px 0;">
                <button id="toggle-galerie-btn" onclick="toggleGalerie()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 40px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.3s;">📸 Voir la Galerie des Collectes</button>
            </div>
            
            <!-- GALERIE PHOTOS COLLECTÉES (CACHÉE PAR DÉFAUT) -->
            <div id="galerie-section" class="galerie-container" style="display: none;">
                <div class="galerie-header">
                    <h3>📸 Galerie des Collectes</h3>
                    <p>Visualisez les sites photographiés</p>
                </div>
                
                <div class="galerie-stats">
                    <div class="galerie-stat-item">
                        <div class="galerie-stat-number" id="galerie-count-collectes">8</div>
                        <div class="galerie-stat-label">Collectes</div>
                    </div>
                    <div class="galerie-stat-item">
                        <div class="galerie-stat-number" id="galerie-count-regions">1</div>
                        <div class="galerie-stat-label">Régions</div>
                    </div>
                    <div class="galerie-stat-item">
                        <div class="galerie-stat-number" id="galerie-count-images">8</div>
                        <div class="galerie-stat-label">Images</div>
                    </div>
                    <button onclick="chargerDernierExportEnGalerie()" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(45, 80, 22, 0.3); transition: all 0.3s; white-space: nowrap;">
                        🔄 Rafraîchir
                    </button>
                </div>
                
                <div class="galerie-scroll">
                    <!-- Les images seront chargées dynamiquement ici -->
                </div>
                        <img class="galerie-item-image" src="./exports/export-2026-02-17T20-06-21/images/photo_5_8.jpg" alt="Ziguinchor">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> SENELEC</div>
                            <div class="galerie-item-commune">📍 Ziguinchor</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> Parc à carburant</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RÉSUMÉ DES DONNÉES -->
        <div style="padding: 30px;">
            <div class="data-summary" id="summary" style="display: none;">
                <h3>📋 Résumé des Données Collectées</h3>
                <div id="summary-content"></div>
            </div>
        </div>
        
        </div>
        </div>
        
        <!-- 🗺️ MODAL TRACEUR DE CIRCUIT DE COLLECTE/BALAYAGE (caché par défaut) -->
        <div id="circuit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 10000; overflow: hidden;">
            <!-- VERSION MOBILE FULLSCREEN -->
            <div id="circuit-mobile-fullscreen" style="width: 100%; height: 100%; display: flex; flex-direction: column; position: relative;">
                <!-- Carte Fullscreen -->
                <div id="circuit-map-fullscreen" style="width: 100%; height: 100%; border-radius: 0; z-index: 1; position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div>
                
                <!-- En-tête Flottant -->
                <div id="circuit-header-float" style="position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 101; max-width: 600px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                        <div>
                            <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: #2d5016;">🗺️ <span id="circuit-type-label">Collecte</span></h2>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #666;"><span id="circuit-status-header">Prêt</span></p>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div style="text-align: right; font-size: 13px; color: #2d5016;">
                                <div><strong><span id="circuit-distance">0</span> km</strong></div>
                                <div style="color: #999;"><span id="circuit-time">00:00</span></div>
                            </div>
                            <button onclick="fermerModalCircuit()" style="background: #c92a2a; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; min-width: auto;">✕</button>
                        </div>
                    </div>
                </div>
                
                <!-- Bouton Démarrer -->
                <button id="btn-demarrer-circuit" onclick="demarrerTracking()" title="Démarrer le tracage" style="position: absolute; bottom: 20px; left: 20px; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #6db038 0%, #5ba837 100%); color: white; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(109, 176, 56, 0.4); transition: all 0.2s; z-index: 102;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">▶️</button>
                
                <!-- Bouton Pause -->
                <button id="btn-pause-circuit" onclick="pauseTracking()" title="Mettre en pause" style="position: absolute; bottom: 20px; left: 80px; width: 50px; height: 50px; border-radius: 50%; background: #667eea; color: white; border: none; cursor: pointer; font-size: 24px; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: all 0.2s; z-index: 102;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">⏸️</button>
                
                <!-- Bouton Repère/Marqueur -->
                <button id="btn-ajouter-marker" onclick="ajouterMarqueurCircuit()" title="Ajouter un repère" style="position: absolute; bottom: 20px; left: 140px; width: 50px; height: 50px; border-radius: 50%; background: #667eea; color: white; border: none; cursor: pointer; font-size: 24px; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: all 0.2s; z-index: 102;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">📌</button>
                
                <!-- Bouton Terminer -->
                <button id="btn-terminer-circuit" onclick="terminerTracking()" title="Terminer le circuit" style="position: absolute; bottom: 20px; left: 200px; width: 50px; height: 50px; border-radius: 50%; background: #c92a2a; color: white; border: none; cursor: pointer; font-size: 24px; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(201, 42, 42, 0.4); transition: all 0.2s; z-index: 102;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">✓</button>
                
                <!-- Panneau Basemap Flottant -->
                <div id="circuit-basemap-float" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 12px 15px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 101;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;"><input type="radio" name="basemap" value="osm" onchange="changerBasemap('osm')" checked> 🗺️</label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;"><input type="radio" name="basemap" value="satellite" onchange="changerBasemap('satellite')"> 🛰️</label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;"><input type="radio" name="basemap" value="topo" onchange="changerBasemap('topo')"> ⛰️</label>
                    </div>
                </div>
                
                <!-- Info Position Flottant (bas droit) -->
                <div id="circuit-info-float" style="position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.95); padding: 12px 15px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 101; font-size: 11px; color: #2d5016; max-width: 200px;">
                    <div><strong>Lat:</strong> <span id="circuit-lat">--</span></div>
                    <div><strong>Lon:</strong> <span id="circuit-lon">--</span></div>
                    <div style="margin-top: 6px;"><strong>Précision:</strong> <span id="circuit-accuracy" class="gps-quality good">-- m</span></div>
                    <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;"><strong>Points GPS:</strong> <span id="circuit-points">0</span></div>
                </div>
                
                <!-- Modal Export (caché par défaut) -->
                <div id="circuit-export-modal" style="display: none; position: absolute; bottom: 100px; left: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 102; max-width: 350px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: #2d5016;">💾 Export du Circuit</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #666; display: block; margin-bottom: 4px;">Nom du circuit</label>
                            <input type="text" id="circuit-name" placeholder="Circuit 1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px;">
                        </div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" id="circuit-buffer" checked>
                            <span>+ Buffer 200m (100m de chaque côté)</span>
                        </label>
                        <button onclick="exporterCircuitShapefile()" style="width: 100%; background: #6db038; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 12px;">📦 Shapefile</button>
                        <button onclick="exporterCircuitGeoJSON()" style="width: 100%; background: #667eea; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 12px;">📄 GeoJSON</button>
                    </div>
                </div>
                
                <!-- Bouton Export Flottant (coin gauche bas) -->
                <button id="btn-toggle-export" onclick="document.getElementById('circuit-export-modal').style.display = document.getElementById('circuit-export-modal').style.display === 'none' ? 'block' : 'none'" title="Export du circuit" style="position: absolute; bottom: 20px; left: 260px; width: 50px; height: 50px; border-radius: 50%; background: #2d5016; color: white; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(45, 80, 22, 0.4); transition: all 0.2s; z-index: 102;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">💾</button>
            </div>

            <!-- VERSION DESKTOP - Interface standard -->
            <div id="circuit-desktop-modal" style="background: white; margin: 15px auto; width: 95%; max-width: 1200px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; display: none;">
                
                <!-- En-tête Modal -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; font-size: 22px; font-weight: 700;">🗺️ Traceur de Circuit - <span id="circuit-type-label-desktop">Collecte</span></h2>
                        <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">Tracez votre itinéraire de collecte en temps réel</p>
                    </div>
                    <button onclick="fermerModalCircuit()" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border: 1px solid white; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;">✕ Fermer</button>
                </div>
                
                <!-- Contenu Modal -->
                <div style="display: grid; grid-template-columns: 280px 1fr 350px; gap: 15px; padding: 20px; min-height: 600px;">
                    
                    <!-- 📋 LISTE CIRCUITS (GAUCHE) -->
                    <div style="display: flex; flex-direction: column; gap: 10px; background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; overflow-y: auto;">
                        <h3 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 700; color: #2d5016; display: flex; align-items: center; gap: 8px;">
                            <span>📍 Circuits</span>
                            <span id="circuits-count" style="background: #6db038; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">0</span>
                        </h3>
                        <div id="circuits-list" style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="text-align: center; color: #999; padding: 20px 10px; font-size: 12px;">Aucun circuit sauvegardé</div>
                        </div>
                    </div>
                    
                    <!-- Carte -->
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Basemap Selector -->
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="radio" name="basemap" value="osm" onchange="changerBasemap('osm')" checked> 🗺️ OSM Standard</label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="radio" name="basemap" value="satellite" onchange="changerBasemap('satellite')"> 🛰️ Satellite</label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;"><input type="radio" name="basemap" value="topo" onchange="changerBasemap('topo')"> ⛰️ Relief</label>
                        </div>
                        
                        <!-- Carte -->
                        <div id="circuit-map" style="width: 100%; height: 500px; border-radius: 8px; border: 2px solid #e5e7eb; z-index: 100;"></div>
                        
                        <!-- Stats -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 12px; background: #f0f8e6; border-radius: 8px; border-left: 4px solid #6db038;">
                            <div>
                                <div style="font-size: 12px; color: #666;">Distance</div>
                                <div style="font-size: 18px; font-weight: 700; color: #2d5016;"><span id="circuit-distance-desktop">0</span> km</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">Durée</div>
                                <div style="font-size: 18px; font-weight: 700; color: #2d5016;"><span id="circuit-time-desktop">00:00</span></div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">Points GPS</div>
                                <div style="font-size: 18px; font-weight: 700; color: #2d5016;"><span id="circuit-points-desktop">0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panneau Contrôle -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        
                        <!-- Contrôles GPS -->
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: #2d5016;">📡 Contrôles</h3>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: space-around;">
                                <button id="btn-demarrer-circuit-desktop" onclick="demarrerTracking()" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #6db038 0%, #5ba837 100%); color: white; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 4px 12px rgba(109, 176, 56, 0.3);" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">▶️</button>
                                <button id="btn-pause-circuit-desktop" onclick="pauseTracking()" style="width: 50px; height: 50px; border-radius: 50%; background: #667eea; color: white; border: none; cursor: pointer; font-size: 24px; display: none; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">⏸️</button>
                                <button id="btn-ajouter-marker-desktop" onclick="ajouterMarqueurCircuit()" style="width: 50px; height: 50px; border-radius: 50%; background: #667eea; color: white; border: none; cursor: pointer; font-size: 24px; display: none; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">📌</button>
                                <button id="btn-terminer-circuit-desktop" onclick="terminerTracking()" style="width: 50px; height: 50px; border-radius: 50%; background: #c92a2a; color: white; border: none; cursor: pointer; font-size: 24px; display: none; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 4px 12px rgba(201, 42, 42, 0.3);" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">✓</button>
                            </div>
                        </div>
                        
                        <!-- Info Position -->
                        <div style="background: #f0f8e6; padding: 12px; border-radius: 8px; border-left: 4px solid #6db038; font-size: 12px; color: #2d5016;">
                            <div><strong>Lat:</strong> <span id="circuit-lat-desktop">--</span></div>
                            <div><strong>Lon:</strong> <span id="circuit-lon-desktop">--</span></div>
                            <div style="margin-top: 8px;"><strong>Précision:</strong> <span id="circuit-accuracy-desktop" class="gps-quality good">-- m</span></div>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #6db038;"><strong>Status:</strong> <span id="circuit-status-desktop" style="color: #c92a2a; font-weight: 600;">Arrêté</span></div>
                        </div>
                        
                        <!-- Zone Résumé -->
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107; font-size: 12px; color: #333;">
                            <strong style="display: block; margin-bottom: 8px;">ℹ️ Instructions</strong>
                            <ul style="margin: 0; padding-left: 18px;">
                                <li>Cliquez "Démarrage"</li>
                                <li>Le GPS enregistre</li>
                                <li>Terminez quand fini</li>
                            </ul>
                        </div>
                        
                        <!-- Export & Buffer -->
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: #2d5016;">💾 Export</h3>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div>
                                    <label style="font-size: 12px; font-weight: 600; color: #666; display: block; margin-bottom: 4px;">Nom du circuit</label>
                                    <input type="text" id="circuit-name" placeholder="Circuit 1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px;">
                                </div>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
                                    <input type="checkbox" id="circuit-buffer" checked>
                                    <span>+ Buffer 200m (100m de chaque côté)</span>
                                </label>
                                <div style="display: flex; gap: 8px; justify-content: center; margin-top: 8px;">
                                    <button onclick="exporterCircuitShapefile()" style="width: 50px; height: 50px; border-radius: 50%; background: #6db038; color: white; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 4px 12px rgba(109, 176, 56, 0.3);" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">📦</button>
                                    <button onclick="exporterCircuitGeoJSON()" style="width: 50px; height: 50px; border-radius: 50%; background: #667eea; color: white; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">📄</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HEADER AVEC BOUTON RETOUR À L'ACCUEIL -->
        <div style="padding: 15px 30px; background: linear-gradient(135deg, #2d5016 0%, #4a7c27 100%); display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #5ba837;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">📱</span>
                <span style="color: white; font-weight: 600;">Collecte de Données SONAGED</span>
            </div>
            <button onclick="retournerAuFormulaire()" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border: 1px solid white; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; pointer-events: auto;">← Retour Accueil</button>
        </div>
        
        <footer>
            <p style="margin-bottom: 10px; font-weight: 700; font-size: 14px;">© 2026 SONAGED - Système de Dimensionnement & Gestion de Données</p>
            <p style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;"><strong>🗺️ Application Géographique Progressive</strong> | Dernière mise à jour: <span id="date-update"></span></p>
            <p style="font-size: 12px; opacity: 0.85; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 10px;">👨‍💻 <strong>Habib DIONE</strong> | 🏢 Chargé SIG Ziguinchor</p>
        </footer>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <script>
        // ============ CONFIGURATION DYNAMIQUE DE L'URL DU SERVEUR ============
        let API_BASE_URL = 'http://localhost:3001'; // Par défaut
        
        // Détecter l'URL dynamiquement selon le contexte
        function detecterURLServeur() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            console.log('%c🌐 INITIALISATION API', 'background: #2d5016; color: white; padding: 10px; font-weight: bold; border-radius: 5px;');
            console.log('Contexte détecté:', {
                hostname: hostname,
                protocol: protocol,
                href: window.location.href
            });
            
            // Si c'est GitHub Pages (habibdione.github.io)
            if (hostname.includes('github.io')) {
                API_BASE_URL = 'https://4mkdbs2k-3001.euw.devtunnels.ms';
                console.log('%c✅ Mode GitHub Pages', 'color: #4CAF50; font-weight: bold;');
                console.log('Serveur: ' + API_BASE_URL);
            }
            // Si c'est le dev tunnel (NOUVEAU: même domaine racine)
            else if (hostname.includes('devtunnels.ms')) {
                // Utiliser le même domaine racine (le backend sert déjà le frontend)
                API_BASE_URL = protocol + '//' + hostname;
                console.log('%c✅ Mode Dev Tunnel - Même domaine', 'color: #4CAF50; font-weight: bold;');
                console.log('Frontend + Backend sur: ' + API_BASE_URL);
            }
            // Si c'est localhost
            else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                API_BASE_URL = 'http://localhost:3001';
                console.log('%c✅ Mode Développement Local', 'color: #4CAF50; font-weight: bold;');
                console.log('Serveur: ' + API_BASE_URL);
            }
            // Autre cas (production)
            else {
                API_BASE_URL = protocol + '//' + hostname;
                console.log('%c✅ Mode Production', 'color: #4CAF50; font-weight: bold;');
                console.log('Serveur: ' + API_BASE_URL);
            }
            
            console.log('%c🔗 API_BASE_URL', 'background: #2196F3; color: white; padding: 8px; font-weight: bold; border-radius: 3px;');
            console.log(API_BASE_URL);
            
            // Afficher aussi dans la page
            console.log('%c✅ Configuration API complétée', 'background: #8BC34A; color: white; padding: 10px; font-weight: bold; border-radius: 5px;');
            
            return API_BASE_URL;
        }
        
        // Initialiser l'URL du serveur au chargement
        detecterURLServeur();
        
        // ============ DONNÉES GÉOGRAPHIQUES DU SÉNÉGAL (PRIORITAIRE) ============
        const SENEGAL_REGIONS = {
            regions: [
                {
                    id: 'dakar',
                    nom: '🏛️ Dakar',
                    code: 'DK',
                    departements: [
                        {
                            id: 'dakar-dept',
                            nom: 'Dakar',
                            communes: ['Dakar', 'Guédiawaye', 'Pikine', 'Rufisque', 'Keur Massar']
                        }
                    ]
                },
                {
                    id: 'thies',
                    nom: '🏘️ Thiès',
                    code: 'TH',
                    departements: [
                        { id: 'thies-dept', nom: 'Thiès', communes: ['Thiès', 'Popenguine', 'Sindia'] },
                        { id: 'mbour-dept', nom: 'Mbour', communes: ['Mbour', 'Nianing', 'Joal-Fadiouth', 'Malicounda', 'Ngaparou', 'Toubab Dialao'] },
                        { id: 'tivaouane-dept', nom: 'Tivaouane', communes: ['Tivaouane', 'Mekhé', 'Mérinagène', 'Gningue'] }
                    ]
                },
                {
                    id: 'saint-louis',
                    nom: '👑 Saint-Louis',
                    code: 'SL',
                    departements: [
                        { id: 'saint-louis-dept', nom: 'Saint-Louis', communes: ['Saint-Louis', 'Guet N Dar', 'Sor'] },
                        { id: 'dagana-dept', nom: 'Dagana', communes: ['Dagana', 'Ronchamp', 'Diama'] },
                        { id: 'podor-dept', nom: 'Podor', communes: ['Podor', 'Tandilao', 'Madina'] }
                    ]
                },
                {
                    id: 'diourbel',
                    nom: '🌾 Diourbel',
                    code: 'DB',
                    departements: [
                        { id: 'diourbel-dept', nom: 'Diourbel', communes: ['Diourbel', 'Gueule Tapée', 'Touba', 'Gueule Ndar'] },
                        { id: 'bambey-dept', nom: 'Bambey', communes: ['Bambey', 'Ngoye'] },
                        { id: 'mbacke-dept', nom: 'Mbacké', communes: ['Mbacké', 'Darou Mouhty', 'Lamina', 'Keur Modou'] }
                    ]
                },
                {
                    id: 'tambacounda',
                    nom: '🐪 Tambacounda',
                    code: 'TC',
                    departements: [
                        { id: 'tambacounda-dept', nom: 'Tambacounda', communes: ['Tambacounda', 'Sinthiou Lemba', 'Guel Malick', 'Banda Ré'] },
                        { id: 'bakel-dept', nom: 'Bakel', communes: ['Bakel', 'Kanel'] },
                        { id: 'goudiry-dept', nom: 'Goudiry', communes: ['Goudiry', 'Kidira'] },
                        { id: 'koumpentoum-dept', nom: 'Koumpentoum', communes: ['Koumpentoum', 'Gueumane'] },
                        { id: 'kidira-dept', nom: 'Kidira', communes: ['Kidira', 'Gabu'] }
                    ]
                },
                {
                    id: 'ziguinchor',
                    nom: '🌴 Ziguinchor',
                    code: 'ZG',
                    departements: [
                        { id: 'ziguinchor-dept', nom: 'Ziguinchor', communes: ['Ziguinchor', 'Adéane', 'Niaguis', 'Niassia', 'Boutoupa Camara Kounda'] },
                        { id: 'bignona-dept', nom: 'Bignona', communes: ['Bignona', 'Thionck-Essyl', 'Kafountine', 'Diouloulou', 'Balingore', 'Coubalan', 'Diégoune', 'Djibidione', 'Djinaki', 'Karthiack', 'Kataba 1', 'Mangagoulack', 'Mlomp', 'Niamone', 'Oulampane', 'Quonck', 'Sindian', 'Suelle', 'Tenghory'] },
                        { id: 'oussouye-dept', nom: 'Oussouye', communes: ['Oussouye', 'Diembéring', 'Mlomp'] }
                    ]
                },
                {
                    id: 'kaolack',
                    nom: '🎪 Kaolack',
                    code: 'KL',
                    departements: [
                        { id: 'kaolack-dept', nom: 'Kaolack', communes: ['Kaolack', 'Lamin Sine', 'Ndiédiéme', 'Gankette Soulé'] },
                        { id: 'nioro-dept', nom: 'Nioro du Rip', communes: ['Nioro du Rip', 'Kolia'] },
                        { id: 'guinguineo-dept', nom: 'Guinguinéo', communes: ['Guinguinéo', 'Taiba Niassène', 'Ndengler'] }
                    ]
                },
                {
                    id: 'fatick',
                    nom: '🏞️ Fatick',
                    code: 'FT',
                    departements: [
                        { id: 'fatick-dept', nom: 'Fatick', communes: ['Fatick', 'Keur Samba Gueye', 'Missirah', 'Passe'] },
                        { id: 'foundiougne-dept', nom: 'Foundiougne', communes: ['Foundiougne', 'Missirah Wadène'] },
                        { id: 'gossas-dept', nom: 'Gossas', communes: ['Gossas', 'Rip', 'Sarelle'] }
                    ]
                },
                {
                    id: 'kaffrine',
                    nom: '🌾 Kaffrine',
                    code: 'KF',
                    departements: [
                        { id: 'kaffrine-dept', nom: 'Kaffrine', communes: ['Kaffrine', 'Sinthé', 'Saré Yerma'] },
                        { id: 'birkelane-dept', nom: 'Birkelane', communes: ['Birkelane', 'Ndiobène'] },
                        { id: 'malem-hodar-dept', nom: 'Malem Hodar', communes: ['Malem Hodar', 'Maka Kolé'] },
                        { id: 'koungheul-dept', nom: 'Koungheul', communes: ['Koungheul', 'Guelel Yerguel'] }
                    ]
                },
                {
                    id: 'matam',
                    nom: '🏜️ Matam',
                    code: 'MT',
                    departements: [
                        { id: 'matam-dept', nom: 'Matam', communes: ['Matam', 'Kassan', 'Orbé'] },
                        { id: 'kanel-dept', nom: 'Kanel', communes: ['Kanel', 'Ouro Alfa'] },
                        { id: 'ranerou-dept', nom: 'Ranérou', communes: ['Ranérou', 'Sélibaby'] }
                    ]
                },
                {
                    id: 'kedougou',
                    nom: '🌲 Kédougou',
                    code: 'KD',
                    departements: [
                        { id: 'kedougou-dept', nom: 'Kédougou', communes: ['Kédougou', 'Mampatim'] },
                        { id: 'salemata-dept', nom: 'Salemata', communes: ['Salemata', 'Mako'] },
                        { id: 'saraya-dept', nom: 'Saraya', communes: ['Saraya', 'Misira'] }
                    ]
                },
                {
                    id: 'kolda',
                    nom: '🎋 Kolda',
                    code: 'KO',
                    departements: [
                        { id: 'kolda-dept', nom: 'Kolda', communes: ['Kolda', 'Sibassor', 'Médina El Hadj'] },
                        { id: 'velingara-dept', nom: 'Vélingara', communes: ['Vélingara', 'Gaoual'] },
                        { id: 'medina-yoro-foulah-dept', nom: 'Médina Yoro Foulah', communes: ['Médina Yoro Foulah', 'Dialacoto'] }
                    ]
                },
                {
                    id: 'sedhiou',
                    nom: '🌳 Sédhiou',
                    code: 'SD',
                    departements: [
                        { id: 'sedhiou-dept', nom: 'Sédhiou', communes: ['Sédhiou', 'Kabrousse'] },
                        { id: 'bounkiling-dept', nom: 'Bounkiling', communes: ['Bounkiling', 'Linkering'] },
                        { id: 'goudomp-dept', nom: 'Goudomp', communes: ['Goudomp', 'Yarol'] }
                    ]
                },
                {
                    id: 'louga',
                    nom: '🐠 Louga',
                    code: 'LG',
                    departements: [
                        { id: 'louga-dept', nom: 'Louga', communes: ['Louga', 'Gueoul'] },
                        { id: 'kebemer-dept', nom: 'Kébémer', communes: ['Kébémer', 'Tataguine'] },
                        { id: 'linguere-dept', nom: 'Linguère', communes: ['Linguère', 'Dodji'] }
                    ]
                }
            ],
            
            getRegions: function() {
                return this.regions;
            },
            
            getDepartements: function(regionId) {
                const region = this.regions.find(r => r.id === regionId);
                return region ? region.departements : [];
            },
            
            getCommunes: function(regionId, departementId) {
                const region = this.regions.find(r => r.id === regionId);
                if (!region) return [];
                const dept = region.departements.find(d => d.id === departementId);
                return dept ? dept.communes : [];
            }
        };

        // ============ FONCTIONS GÉOGRAPHIQUES ============
        function initialiserSelectsGeographiques() {
            console.log('✅ Initialiser les selects géographiques');
            const regionSelect = document.getElementById('region');
            if (!regionSelect) {
                console.error('❌ Element region select non trouvé');
                return;
            }
            
            regionSelect.innerHTML = '<option value="">-- Sélectionner une région --</option>';
            
            SENEGAL_REGIONS.getRegions().forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = region.nom;
                regionSelect.appendChild(option);
            });
            
            console.log(`✅ ${SENEGAL_REGIONS.getRegions().length} régions chargées`);
        }
        
        function mettreAJourDepartements() {
            console.log('🔄 MISE À JOUR DES DÉPARTEMENTS');
            const regionSelect = document.getElementById('region');
            const departementSelect = document.getElementById('departement');
            const communeSelect = document.getElementById('commune');
            
            const regionId = regionSelect.value;
            console.log(`   Région sélectionnée: "${regionId}"`);
            
            // Réinitialiser les autres selects
            departementSelect.innerHTML = '<option value="">-- Sélectionner un département --</option>';
            communeSelect.innerHTML = '<option value="">-- Sélectionner une commune --</option>';
            
            if (!regionId) {
                console.warn('   ⚠️ Aucune région sélectionnée');
                return;
            }
            
            // Récupérer et remplir les départements
            const departements = SENEGAL_REGIONS.getDepartements(regionId);
            console.log(`   ✅ ${departements.length} départements trouvés`);
            
            departements.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.nom;
                departementSelect.appendChild(option);
            });
        }
        
        function mettreAJourCommunes() {
            console.log('🔄 MISE À JOUR DES COMMUNES');
            const regionSelect = document.getElementById('region');
            const departementSelect = document.getElementById('departement');
            const communeSelect = document.getElementById('commune');
            
            const regionId = regionSelect.value;
            const departementId = departementSelect.value;
            
            console.log(`   Région: "${regionId}", Département: "${departementId}"`);
            
            // Réinitialiser le select des communes
            communeSelect.innerHTML = '<option value="">-- Sélectionner une commune --</option>';
            
            if (!regionId || !departementId) {
                console.warn('   ⚠️ Région ou département manquant');
                return;
            }
            
            // Récupérer et remplir les communes
            const communes = SENEGAL_REGIONS.getCommunes(regionId, departementId);
            console.log(`   ✅ ${communes.length} communes trouvées`);
            
            communes.forEach(commune => {
                const option = document.createElement('option');
                option.value = commune;
                option.textContent = commune;
                communeSelect.appendChild(option);
            });
        }

        // ============ PWA & Service Worker Enregistrement ============
        let deferredPrompt;
        let swRegistration = null;

        // Enregistrer le Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    swRegistration = registration;
                    console.log('✅ Service Worker enregistré:', registration);
                    
                    // Vérifier les mises à jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'activated') {
                                showAlert('info', '✅ Nouvelle version disponible! Rechargez la page.');
                            }
                        });
                    });
                    
                    // Polling pour les mises à jour
                    setInterval(() => {
                        registration.update();
                    }, 60000);
                }).catch(error => {
                    console.warn('❌ Erreur SW:', error);
                });
            });
        }

        // Gestion de l'install prompt PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Afficher le bouton d'installation
            document.getElementById('install-prompt').classList.remove('hidden');
        });

        window.addEventListener('appinstalled', () => {
            console.log('✅ Application installée!');
            document.getElementById('install-prompt').classList.add('hidden');
            showAlert('success', '📱 Application installée avec succès!');
            deferredPrompt = null;
        });

        // Fonction d'installation PWA
        function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((outcome) => {
                if (outcome.outcome === 'accepted') {
                    console.log('✅ Installation acceptée');
                } else {
                    console.log('❌ Installation refusée');
                }
                deferredPrompt = null;
            });
        }

        // Masquer l'avis d'installation
        function dismissInstall() {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // Détection de la connectivité
        window.addEventListener('online', () => {
            showAlert('success', '🌐 Connecté à internet');
        });

        window.addEventListener('offline', () => {
            showAlert('info', '📵 Mode hors ligne activé - Les données seront synchronisées');
        });

        // Si déjà installée ou accessible en standalone
        if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
            document.getElementById('install-prompt').classList.add('hidden');
        }

        // ============ Variables et Données ============
        let map;
        let userLocationMarker;
        let videoStream;
        let collectesMarqueurs = []; // Stockage des marqueurs de collecte géolocalisés
        
        let donnees = {
            partenaire: '',
            region: '',
            departement: '',
            commune: '',
            typeActivite: [],
            sites_concernes: '',
            superficie: '',
            besoinPersonnel: '',
            dispositifDeploy: '',
            nombreRotation: '',
            infrastructureGestion: '',
            frequenceCollecte: '',
            bacs240: '',
            caissePolybene: '',
            bacs660: '',
            accessibilite: '',
            observation: '',
            latitude: null,
            longitude: null,
            precision: null,
            coordonneeX: '',
            coordonneeY: '',
            photo: null,
            dateCollecte: new Date().toISOString()
        };
        
        // Initialiser la carte avec optimisations
        let mapInitialized = false;
        
        function initMap() {
            if (mapInitialized) return; // Éviter re-initialisation
            
            const mapContainer = document.getElementById('map');
            if (!mapContainer) return;
            
            mapInitialized = true;
            map = L.map('map').setView([13.1939, -15.5277], 13); // Coordonnées Ziguinchor
            
            // Ajouter les tuiles OpenStreetMap avec optimisation
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
                minZoom: 6,
                crossOrigin: true,
                className: 'leaflet-tiles-offline',
                errorTileUrl: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="256" height="256"%3E%3Crect fill="%23f0f0f0" width="256" height="256"/%3E%3C/svg%3E'
            }).addTo(map);
            
            // Ajouter un marqueur de départ
            L.marker([13.1939, -15.5277], {
                title: 'Ziguinchor (Siège SONAGED)'
            }).addTo(map).bindPopup('<b>Ziguinchor</b><br>Siège SONAGED');
            
            // Optimisation pour mobile
            if (window.innerWidth < 768) {
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
            }
            
            console.log('✅ Carte de localisation initialisée');
        }

        // Informations sur le cache
        function afficherInfoCache() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const percentUsed = (estimate.usage / estimate.quota) * 100;
                    console.log(`Cache utilisé: ${(estimate.usage / 1024 / 1024).toFixed(2)} MB / ${(estimate.quota / 1024 / 1024).toFixed(2)} MB (${percentUsed.toFixed(1)}%)`);
                });
            }
        }

        // Nettoyer le cache
        function nettoyerCache() {
            if (swRegistration) {
                swRegistration.active.postMessage({ type: 'CLEAR_CACHE' });
                showAlert('success', '🗑️ Cache en cours de nettoyage...');
            }
        }
        
        // Mettre à jour les sites - fonction désactivée (le champ siteConcerne a été supprimé)
        function mettreAJourSites() {
            // Cette fonction est conservée pour compatibilité mais ne fait rien
            // Le champ siteConcerne a été supprimé du formulaire
        }
        
        // Géolocalisation GPS
        // Géolocalisation améliorée avec conversion UTM
        let watchPositionId = null;

        function obtenirLocalisationGPS() {
            // Initialiser la carte si ce n'est pas encore fait
            if (!mapInitialized) {
                initMap();
            }
            
            // Vérification du protocole
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('error', '⚠️ La géolocalisation nécessite HTTPS. Veuillez utiliser une connexion sécurisée ou localhost.');
                return;
            }
            
            if (!navigator.geolocation) {
                showAlert('error', '❌ La géolocalisation n\'est pas supportée par votre navigateur');
                return;
            }
            
            showAlert('info', '📡 Demande de permission pour accéder à la localisation...');
            
            // Options pour haute précision
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,  // Augmenté à 15 secondes
                maximumAge: 0
            };

            // Utiliser watchPosition pour suivi continu
            watchPositionId = navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    const altitude = position.coords.altitude ? Math.round(position.coords.altitude) : 'N/A';
                    const heading = position.coords.heading ? Math.round(position.coords.heading) : 'N/A';
                    const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) : '0'; // m/s to km/h
                    
                    donnees.latitude = lat;
                    donnees.longitude = lon;
                    donnees.precision = accuracy;
                    
                    // Afficher les coordonnées
                    document.getElementById('lat').textContent = lat.toFixed(6);
                    document.getElementById('lon').textContent = lon.toFixed(6);
                    document.getElementById('accuracy').textContent = accuracy;
                    
                    // Convertir en UTM
                    const utm = latLonToUTM(lat, lon);
                    document.getElementById('utm-easting').textContent = utm.easting.toFixed(2);
                    document.getElementById('utm-northing').textContent = utm.northing.toFixed(2);
                    document.getElementById('coordonneeX').value = utm.easting.toFixed(2);
                    document.getElementById('coordonneeY').value = utm.northing.toFixed(2);
                    donnees.coordonneeX = utm.easting.toFixed(2);
                    donnees.coordonneeY = utm.northing.toFixed(2);
                    
                    // Centrer la carte et ajouter un marqueur
                    map.setView([lat, lon], 17);
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    
                    const popupContent = `<b>📍 Votre Position</b><br>
                    <strong>Latitude:</strong> ${lat.toFixed(6)}°<br>
                    <strong>Longitude:</strong> ${lon.toFixed(6)}°<br>
                    <strong>Précision:</strong> ±${accuracy}m<br>
                    <strong>Altitude:</strong> ${altitude}m<br>
                    <strong>Vitesse:</strong> ${speed} km/h<br>
                    <strong>Orientation:</strong> ${heading}°<br>
                    <strong>UTM Easting:</strong> ${utm.easting.toFixed(2)}<br>
                    <strong>UTM Northing:</strong> ${utm.northing.toFixed(2)}`;
                    
                    userLocationMarker = L.circleMarker([lat, lon], {
                        radius: 8,
                        fillColor: '#667eea',
                        color: '#764ba2',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8,
                        title: 'Votre position'
                    }).addTo(map).bindPopup(popupContent);
                    
                    showAlert('success', `✅ Position obtenue! Précision: ±${accuracy}m`);
                },
                function(error) {
                    let errorMsg = '';
                    console.error('🔴 Erreur géolocalisation code:', error.code, 'message:', error.message);
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Accès à la géolocalisation refusé. ';
                            errorMsg += 'Veuillez vérifier les permissions de votre navigateur. ';
                            errorMsg += 'Allez dans Paramètres > Permissions de site et autorisez l\'accès à votre localisation.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Position indisponible. Assurez-vous que le GPS est activé et que vous êtes en extérieur.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Délai dépassé (15s). Essayez dans un endroit avec meilleure réception GPS.';
                            break;
                        default:
                            errorMsg = error.message || 'Erreur inconnue';
                    }
                    showAlert('error', '❌ Erreur GPS: ' + errorMsg);
                },
                options
            );
        }

        // Fonction de conversion Lat/Lon en UTM
        function latLonToUTM(lat, lon) {
            // Référence: WGS84
            const k0 = 0.9996;
            const E = 0.00669438;
            const E2 = E / (1 - E);
            const N0 = 0;
            const E0 = 500000;
            
            const zone = Math.floor((lon + 180) / 6) + 1;
            const lon0 = (zone - 1) * 6 - 180 + 3;
            
            const N = Math.cos(lat * Math.PI / 180);
            const T = Math.tan(lat * Math.PI / 180);
            const C = E2 * N * N;
            const A = (lon - lon0) * Math.PI / 180 * N;
            
            const M = 111132.92 * lat - 16216.94 * Math.sin(2 * lat * Math.PI / 180) + 
                      17.21 * Math.sin(4 * lat * Math.PI / 180) - 
                      0.094 * Math.sin(6 * lat * Math.PI / 180);
            
            const easting = E0 + k0 * 6378137 * (A + (A * A * A / 6) * (1 - T * T + C) + 
                            (A * A * A * A * A / 120) * (5 - 18 * T * T + T * T * T * T + 72 * C - 58 * E2));
            
            const northing = N0 + k0 * (M + 6378137 * (T * (A * A / 2) + (T * (A * A * A * A / 24)) * 
                            (5 - T * T + 9 * C + 4 * C * C) + 
                            (T * (A * A * A * A * A * A / 720)) * (61 - 58 * T * T + T * T * T * T + 600 * C - 330 * E2)));
            
            return {
                easting: easting,
                northing: northing,
                zone: zone
            };
        }

        // Arrêter le suivi GPS
        function arreterLocalisationGPS() {
            if (watchPositionId !== null) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
                showAlert('info', '⏹️ Suivi GPS arrêté');
            }
        }
        
        // ============================================================================
        // 🎯 CAPTURE PHOTO INTÉGRÉE: GPS + CAMÉRA + MARQUEUR EN UN SEUL BOUTON
        // ============================================================================
        
        let gpsLiveData = { lat: null, lon: null, accuracy: null };
        let cameraLiveReady = false;
        let videoStreamLive = null;
        let watchPositionIdLive = null;
        
        function capturerPhotoAvecGPSEtMarqueur() {
            const container = document.getElementById('gps-camera-capture');
            container.style.display = 'block';
            showAlert('info', '🎬 Initialisation capture géolocalisée...\n✅ Demande d\'accès GPS\n✅ Demande d\'accès Caméra');
            
            // Scroll vers le conteneur
            container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Initialiser la carte
            if (!mapInitialized) {
                initMap();
            }
            
            // Démarrer le suivi GPS en parallèle
            demarrerGPSLive();
            
            // Attendre un peu puis démarrer la caméra
            setTimeout(() => {
                demarrerCameraLive();
            }, 500);
        }
        
        function demarrerGPSLive() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('error', '⚠️ GPS nécessite HTTPS. Utilisez un DevTunnel ou localhost.');
                return;
            }
            
            if (!navigator.geolocation) {
                showAlert('error', '❌ Géolocalisation non supportée');
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };
            
            watchPositionIdLive = navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    
                    gpsLiveData = { lat, lon, accuracy };
                    donnees.latitude = lat;
                    donnees.longitude = lon;
                    donnees.precision = accuracy;
                    
                    // Afficher les coordonnées en temps réel
                    document.getElementById('lat-live').textContent = lat.toFixed(6) + '°N';
                    document.getElementById('lon-live').textContent = lon.toFixed(6) + '°O';
                    document.getElementById('accuracy-live').textContent = accuracy;
                    document.getElementById('coords-display-live').style.background = '#e8f5e9';
                    
                    // Activer le bouton capture si caméra aussi prête
                    activerBoutonCaptureGPS();
                },
                function(error) {
                    let msg = '❌ GPS: ';
                    switch(error.code) {
                        case 1: msg += 'Permission refusée. Activez le GPS.'; break;
                        case 2: msg += 'Position indisponible. Essayez dehors.'; break;
                        case 3: msg += 'Délai dépassé. Réessayez.'; break;
                        default: msg += error.message;
                    }
                    showAlert('error', msg);
                    document.getElementById('lat-live').textContent = '❌ Erreur';
                    document.getElementById('lon-live').textContent = '❌ Erreur';
                },
                options
            );
        }
        
        function demarrerCameraLive() {
            const video = document.getElementById('video-live');
            
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('error', '❌ Caméra nécessite HTTPS (ou localhost)');
                return;
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('error', '❌ Caméra non supportée');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            })
            .then(function(stream) {
                videoStreamLive = stream;
                video.srcObject = stream;
                video.style.display = 'block';
                video.onloadedmetadata = function() {
                    video.play();
                };
                cameraLiveReady = true;
                
                document.getElementById('demarrer-camera-live').style.display = 'none';
                document.getElementById('arreter-camera-live').style.display = 'block';
                
                showAlert('success', '✅ Caméra prête! Positionnez-vous bien.');
                activerBoutonCaptureGPS();
            })
            .catch(function(error) {
                console.error('Erreur caméra:', error);
                showAlert('error', '❌ Erreur caméra: ' + error.message);
            });
        }
        
        function arreterCameraLive() {
            if (videoStreamLive) {
                videoStreamLive.getTracks().forEach(track => track.stop());
                videoStreamLive = null;
            }
            
            const video = document.getElementById('video-live');
            video.style.display = 'none';
            cameraLiveReady = false;
            
            document.getElementById('demarrer-camera-live').style.display = 'block';
            document.getElementById('arreter-camera-live').style.display = 'none';
            
            desactiverBoutonCaptureGPS();
        }
        
        function activerBoutonCaptureGPS() {
            const btn = document.getElementById('capturer-avec-gps-btn');
            if (gpsLiveData.lat && cameraLiveReady) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.textContent = `✅ CAPTURER! (${gpsLiveData.accuracy}m précision)`;
                btn.style.background = 'linear-gradient(135deg, #6db038 0%, #4CAF50 100%)';
            }
        }
        
        function desactiverBoutonCaptureGPS() {
            const btn = document.getElementById('capturer-avec-gps-btn');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.textContent = '⏳ Préparez-vous... (Caméra + GPS)';
            btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
        
        function capturerPhotoGeoloc() {
            const video = document.getElementById('video-live');
            const canvas = document.getElementById('canvas-live');
            
            if (!videoStreamLive || !gpsLiveData.lat) {
                showAlert('error', '❌ Caméra et GPS doivent être prêts');
                return;
            }
            
            showAlert('info', '📸 Capture en cours + marqueur...');
            
            // Redimensionner et compresser
            const maxWidth = 800;
            const maxHeight = 600;
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, width, height);
            canvas.style.display = 'block';
            
            // Compresser en JPEG
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            
            // Vérifier la taille
            const maxSize = 5242880; // 5MB
            if (imageData.length > maxSize) {
                showAlert('error', '❌ Photo trop grosse (max 5MB)');
                return;
            }
            
            donnees.photo = imageData;
            
            // Créer nom du fichier
            const siteElement = document.getElementById('adresse');
            const communeElement = document.getElementById('commune');
            let siteName = siteElement ? siteElement.value.trim().replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 30) : 'site';
            let communeName = communeElement ? communeElement.options[communeElement.selectedIndex]?.text : 'commune';
            communeName = communeName.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 20);
            
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            const filename = `photo_${communeName}_${siteName}_${dateStr}_${timeStr}.jpg`;
            window.currentPhotoFilename = filename;
            
            // Récupérer autres infos du formulaire
            const regionElement = document.getElementById('region');
            const departementElement = document.getElementById('departement');
            const deptName = departementElement ? departementElement.options[departementElement.selectedIndex]?.text : 'dept';
            const regionName = regionElement ? regionElement.options[regionElement.selectedIndex]?.text : 'region';
            
            let activites = [];
            const activitesElement = document.getElementById('activites-group');
            if (activitesElement) {
                const checkboxes = activitesElement.querySelectorAll('input[type="checkbox"]:checked');
                activites = Array.from(checkboxes).map(cb => cb.labels?.[0]?.textContent?.trim() || '').filter(a => a);
            }
            
            // Convertir en UTM
            const utm = latLonToUTM(gpsLiveData.lat, gpsLiveData.lon);
            document.getElementById('coordonneeX').value = utm.easting.toFixed(2);
            document.getElementById('coordonneeY').value = utm.northing.toFixed(2);
            donnees.coordonneeX = utm.easting.toFixed(2);
            donnees.coordonneeY = utm.northing.toFixed(2);
            
            // Ajouter la photo à la galerie
            const newPhoto = {
                id: Date.now(),
                commune: communeName,
                partenaire: "SONAGED",
                site: siteName,
                dept: deptName,
                region: regionName,
                activites: activites.join(", "),
                superficie: document.getElementById('superficie')?.value || "0 m²",
                personnel: document.getElementById('personnel')?.value || "0",
                dispositifs: document.getElementById('dispositif')?.value || "N/A",
                frequence: document.getElementById('frequence')?.value || "F1",
                accessibilite: document.getElementById('accessibilite')?.value || "Facile",
                lat: gpsLiveData.lat.toFixed(6) + "°N",
                lng: gpsLiveData.lon.toFixed(6) + "°O",
                src: imageData,
                quality: 0.7,
                size: imageData.length,
                timestamp: now.toISOString(),
                gps: { lat: gpsLiveData.lat, lon: gpsLiveData.lon, accuracy: gpsLiveData.accuracy }
            };
            
            // Vérifier les doublons
            const existingIndex = galleriePhotos.findIndex(p => p.site === newPhoto.site && p.commune === newPhoto.commune);
            if (existingIndex !== -1 && galleriePhotos[existingIndex].quality < newPhoto.quality) {
                galleriePhotos[existingIndex] = newPhoto;
                showAlert('success', `♻️ Photo de ${communeName} remplacée (meilleure qualité)`);
            } else if (existingIndex === -1) {
                galleriePhotos.unshift(newPhoto);
                showAlert('success', `✅ Photo capturée! ${communeName} - ${siteName}`);
            } else {
                showAlert('info', `⏭️ Photo non ajoutée (qualité inférieure)`);
                return;
            }
            
            // 🎯 AJOUTER LE MARQUEUR SUR LA CARTE
            const popupContent = `<b>📍 ${siteName}</b><br>
                <strong>Commune:</strong> ${communeName}<br>
                <strong>Latitude:</strong> ${gpsLiveData.lat.toFixed(6)}°<br>
                <strong>Longitude:</strong> ${gpsLiveData.lon.toFixed(6)}°<br>
                <strong>Précision:</strong> ±${gpsLiveData.accuracy}m<br>
                <strong>Date:</strong> ${now.toLocaleString('fr-FR')}<br>
                <img src="${imageData}" style="width: 100%; border-radius: 6px; margin-top: 8px; max-width: 200px;">`;
            
            // Centrer et ajouter le marqueur
            map.setView([gpsLiveData.lat, gpsLiveData.lon], 17);
            const marker = L.marker([gpsLiveData.lat, gpsLiveData.lon], {
                title: siteName,
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map).bindPopup(popupContent);
            
            // Stocker le marqueur
            if (!collectesMarqueurs) collectesMarqueurs = [];
            collectesMarqueurs.push({
                marker: marker,
                data: {
                    site: siteName,
                    commune: communeName,
                    lat: gpsLiveData.lat,
                    lon: gpsLiveData.lon,
                    timestamp: now.toISOString()
                }
            });
            
            // Update affichage
            document.getElementById('lat').textContent = gpsLiveData.lat.toFixed(6);
            document.getElementById('lon').textContent = gpsLiveData.lon.toFixed(6);
            document.getElementById('accuracy').textContent = gpsLiveData.accuracy;
            document.getElementById('utm-easting').textContent = utm.easting.toFixed(2);
            document.getElementById('utm-northing').textContent = utm.northing.toFixed(2);
            
            // Arrêter le suivi
            if (watchPositionIdLive) {
                navigator.geolocation.clearWatch(watchPositionIdLive);
                watchPositionIdLive = null;
            }
        }
        
        // Caméra - Version améliorée
        function demarrerCamera() {
            const video = document.getElementById('video');
            
            // Vérifier les permissions HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('error', '❌ La caméra nécessite HTTPS (ou localhost pour test)');
                return;
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('error', '❌ Votre navigateur ne supporte pas la caméra\n\n💡 Essayez avec Chrome, Firefox ou Edge');
                return;
            }
            
            showAlert('info', '📹 Demande d\'accès à la caméra...');
            
            // Essayer avec facingMode 'environment' d'abord (caméra arrière)
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            })
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.play().catch(err => console.warn('Play warning:', err));
                    video.style.display = 'block';
                    document.getElementById('arreter-camera-btn').style.display = 'block';
                    showAlert('success', '✅ Caméra activée avec succès!');
                    console.log('📹 Stream video actif');
                })
                .catch(err => {
                    console.error('❌ Erreur caméra:', err);
                    
                    // Fallback: essayer sans facingMode
                    navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    })
                        .then(stream => {
                            videoStream = stream;
                            video.srcObject = stream;
                            video.play().catch(err => console.warn('Play warning:', err));
                            video.style.display = 'block';
                            document.getElementById('arreter-camera-btn').style.display = 'block';
                            showAlert('success', '✅ Caméra activée!');
                        })
                        .catch(err2 => {
                            let message = '❌ Erreur caméra: ';
                            if (err.name === 'NotAllowedError') {
                                message += 'Permission refusée. Acceptez l\'accès à la caméra.';
                            } else if (err.name === 'NotFoundError') {
                                message += 'Aucune caméra détectée sur votre appareil.';
                            } else {
                                message += err.name + ': ' + err.message;
                            }
                            showAlert('error', message);
                            console.error('Erreur caméra complète:', err2);
                        });
                });
        }
        
        function arreterCamera() {
            const video = document.getElementById('video');
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
                document.getElementById('arreter-camera-btn').style.display = 'none';
                videoStream = null;
                showAlert('info', '⏹️ Caméra arrêtée');
            }
        }
        
        function capturerPhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (!videoStream) {
                showAlert('error', '❌ Veuillez démarrer la caméra d\'abord');
                return;
            }
            
            showAlert('info', '📸 Compression de la photo...');
            
            // Créer un canvas de taille réduite pour compresser
            const maxWidth = 800;
            const maxHeight = 600;
            
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            // Redimensionner si trop grand
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width = width * ratio;
                height = height * ratio;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, width, height);
            canvas.style.display = 'block';
            
            // Compresser en JPEG basse qualité (0.7 = 70%)
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            
            // Vérifier la taille maximale (5MB = 5242880 bytes)
            const maxSize = 5242880;
            const dataSize = imageData.length;
            
            if (dataSize > maxSize) {
                showAlert('error', `❌ Photo trop grosse: ${(dataSize/1024/1024).toFixed(1)}MB (max 5MB)`);
                return;
            }
            
            donnees.photo = imageData;
            
            // 🔑 Récupérer le site et créer le nom du fichier
            const siteElement = document.getElementById('adresse');
            const communeElement = document.getElementById('commune');
            const regionElement = document.getElementById('region');
            const departementElement = document.getElementById('departement');
            const activitesElement = document.getElementById('activites-group');
            
            let siteName = siteElement ? siteElement.value.trim() : 'site_inconnu';
            let communeName = communeElement ? communeElement.options[communeElement.selectedIndex]?.text : 'commune';
            let regionName = regionElement ? regionElement.options[regionElement.selectedIndex]?.text : 'region';
            let deptName = departementElement ? departementElement.options[departementElement.selectedIndex]?.text : 'dept';
            
            // Récupérer les activités sélectionnées
            let activites = [];
            if (activitesElement) {
                const checkboxes = activitesElement.querySelectorAll('input[type="checkbox"]:checked');
                activites = Array.from(checkboxes).map(cb => cb.labels?.[0]?.textContent?.trim() || '').filter(a => a);
            }
            
            // Nettoyer les noms (supprimer caractères spéciaux)
            siteName = siteName.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 30);
            communeName = communeName.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 20);
            
            // Créer le nom du fichier avec date
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            const filename = `photo_${communeName}_${siteName}_${dateStr}_${timeStr}.jpg`;
            
            // Stocker le filename pour le téléchargement
            window.currentPhotoFilename = filename;
            
            // 📸 Créer un nouvel objet photo pour la galerie (avec vérification des doublons)
            const newPhoto = {
                id: Date.now(), // Utiliser timestamp pour ID unique
                commune: communeName,
                partenaire: "SONAGED",
                site: siteName,
                dept: deptName,
                region: regionName,
                activites: activites.join(", "),
                superficie: document.getElementById('superficie')?.value || "0 m²",
                personnel: document.getElementById('personnel')?.value || "0",
                dispositifs: document.getElementById('dispositif')?.value || "N/A",
                frequence: document.getElementById('frequence')?.value || "F1",
                accessibilite: document.getElementById('accessibilite')?.value || "Facile",
                lat: "0.0000°N",
                lng: "0.0000°O",
                src: imageData, // Photo en base64
                quality: 0.7, // Qualité de compression
                size: dataSize // Taille en bytes
            };
            
            // Vérifier les doublons: si même site/commune, garder la meilleure qualité
            const existingPhotoIndex = galleriePhotos.findIndex(p => p.site === newPhoto.site && p.commune === newPhoto.commune);
            if (existingPhotoIndex !== -1 && galleriePhotos[existingPhotoIndex].quality < newPhoto.quality) {
                // Remplacer par meilleure qualité
                const oldPhoto = galleriePhotos[existingPhotoIndex];
                galleriePhotos[existingPhotoIndex] = newPhoto;
                console.log(`♻️ Photo ${siteName} remplacée par meilleure qualité`);
                showAlert('info', `♻️ Photo de ${communeName} remplacée par meilleure qualité`);
            } else if (existingPhotoIndex === -1) {
                // Nouvelle photo
                galleriePhotos.unshift(newPhoto);
            } else {
                // Qualité plus basse, garder l'existante
                console.log(`⏭️ Photo ${siteName} non remplacée (qualité inférieure)`);
                showAlert('info', `⏭️ Photo non ajoutée (qualité inférieure à l'existante)`);
                return;
            }
            
            // Ajouter l'élément HTML à la galerie
            const galerieScroll = document.querySelector('.galerie-scroll');
            if (galerieScroll) {
                const newItem = document.createElement('div');
                newItem.className = 'galerie-item';
                newItem.dataset.photoId = newPhoto.id; // Ajouter un data attribute pour identifier
                newItem.onclick = () => openGalerieModalByPhotoId(newPhoto.id); // Chercher par ID
                newItem.innerHTML = `
                    <img class="galerie-item-image" src="${imageData}" alt="${siteName}">
                    <div class="galerie-item-info">
                        <div class="galerie-item-detail"><strong>Partenaire:</strong> SONAGED</div>
                        <div class="galerie-item-commune">📍 ${communeName}</div>
                        <div class="galerie-item-detail"><strong>Site:</strong> ${siteName}</div>
                    </div>
                `;
                galerieScroll.insertBefore(newItem, galerieScroll.firstChild);
            }
            
            // Mettre à jour les statistiques
            const statsNumber = document.querySelector('.galerie-stat-item .galerie-stat-number');
            if (statsNumber) {
                statsNumber.textContent = galleriePhotos.length;
            }
            
            // ✅ AFFICHER LA PRÉVIEW (avec vérification complète + support mobile)
            setTimeout(() => {
                const previewImg = document.getElementById('preview-img');
                if (previewImg) {
                    previewImg.src = imageData;
                    previewImg.style.display = 'block';
                    previewImg.style.maxWidth = '100%';
                    previewImg.style.height = 'auto';
                    previewImg.style.borderRadius = '8px';
                    previewImg.style.marginTop = '10px';
                    previewImg.style.minHeight = '200px';
                    previewImg.onload = () => {
                        previewImg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    };
                }
                
                // Update filename display
                const filenameSpan = document.getElementById('photo-filename');
                if (filenameSpan) {
                    filenameSpan.textContent = filename;
                }
                
                // Show the image preview container
                const imagePreview = document.getElementById('image-preview');
                if (imagePreview) {
                    imagePreview.classList.remove('hidden');
                    imagePreview.style.display = 'block';
                    imagePreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
            
            showAlert('success', `✅ Photo capturée et ajoutée à la galerie (${(dataSize/1024).toFixed(0)}KB)`);
            
            // 🗺️ Mettre à jour la carte des collectes avec le nouveau point GPS
            setTimeout(() => {
                ajouterCollecteGPS(communeName, siteName, donnees.latitude, donnees.longitude);
            }, 500);
        }
        
        // 🗺️ Fonction pour ajouter une nouvelle collecte à la carte
        function ajouterCollecteGPS(commune, site, lat, lon) {
            if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                console.warn('⚠️ Coordonnées GPS invalides, carte non mise à jour');
                return;
            }
            
            // Créer un nouvel objet collecte
            const nouvelleCollecte = {
                id: Math.max(...collectesGPS.map(c => c.id), 0) + 1,
                commune: commune,
                partenaire: "SONAGED",
                site: site,
                lat: lat,
                lng: lon,
                photo: ""
            };
            
            // Ajouter à la liste
            collectesGPS.unshift(nouvelleCollecte);
            
            console.log(`✅ Nouvelle collecte GPS ajoutée: ${commune} - ${site}`);
            
            // Si la carte des collectes est visible, la mettre à jour
            const collecteMapContainer = document.getElementById('collecte-map');
            if (collecteMapContainer && collecteMapContainer._leaflet_map) {
                ajouterMarqueurSurCollecteMap(nouvelleCollecte);
            }
        }
        
        // 🗺️ Ajouter marqueur sur la carte des collectes
        function ajouterMarqueurSurCollecteMap(collecte) {
            const collecteMapContainer = document.getElementById('collecte-map');
            if (!collecteMapContainer || !collecteMapContainer._leaflet_map) return;
            
            const collecteMap = collecteMapContainer._leaflet_map;
            
            // Créer une icône personnalisée
            const customIcon = L.divIcon({
                className: 'custom-collecte-marker',
                html: `<div style="
                    background: linear-gradient(135deg, #6db038 0%, #5ba837 100%);
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 18px;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                ">📍</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // Créer le contenu du popup
            const popupContent = `
                <div style="font-size: 12px;">
                    <strong style="color: #6db038; font-size: 13px;">📌 ${collecte.commune}</strong><br>
                    <small style="color: #666;">
                        <strong>Site:</strong> ${collecte.site}<br>
                        <strong>Partenaire:</strong> ${collecte.partenaire}<br>
                        <strong>Coordonnées:</strong> ${collecte.lat.toFixed(4)}, ${collecte.lng.toFixed(4)}<br>
                        <strong>ID:</strong> Collecte #${collecte.id}<br>
                        <em style="color: #6db038;">✨ Récemment ajoutée</em>
                    </small>
                </div>
            `;
            
            // Ajouter le marqueur à la carte
            const marker = L.marker([collecte.lat, collecte.lng], { icon: customIcon })
                .bindPopup(popupContent)
                .bindTooltip(`${collecte.commune}`, { permanent: false, direction: 'top' })
                .addTo(collecteMap);
            
            // Centrer et zoomer sur le nouveau marqueur
            collecteMap.setView([collecte.lat, collecte.lng], 13);
            
            showAlert('success', `🗺️ Marqueur ajouté à la carte: ${collecte.commune}`);
        }
        
        
        // 📥 Fonction pour télécharger l'image (compatible mobile)
        function telechargerPhoto() {
            const imageData = donnees.photo;
            if (!imageData) {
                showAlert('error', '❌ Aucune photo à télécharger');
                return;
            }
            
            const filename = window.currentPhotoFilename || 'photo.jpg';
            
            try {
                // Convertir data URL en Blob pour meilleure compatibilité mobile
                fetch(imageData)
                    .then(res => res.blob())
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        // Libérer la mémoire
                        URL.revokeObjectURL(url);
                        showAlert('success', `✅ Image téléchargée: ${filename}`);
                    })
                    .catch(err => {
                        console.error('Erreur Blob:', err);
                        // Fallback: utiliser la méthode directe
                        const link = document.createElement('a');
                        link.href = imageData;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showAlert('success', `✅ Image téléchargée: ${filename}`);
                    });
            } catch (error) {
                console.error('Erreur téléchargement:', error);
                showAlert('error', '❌ Erreur lors du téléchargement');
            }
        }
        
        function effacerPhoto() {
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            
            canvas.style.display = 'none';
            preview.classList.add('hidden');
            previewImg.src = '';
            donnees.photo = null;
            showAlert('info', '🗑️ Photo supprimée');
        }
        
        // 📸 TOGGLE GALERIE - Afficher/Masquer la galerie
        function toggleGalerie() {
            const galerieSection = document.getElementById('galerie-section');
            const toggleBtn = document.getElementById('toggle-galerie-btn');
            
            if (!galerieSection || !toggleBtn) {
                console.warn('⚠️ Éléments de galerie non trouvés');
                return;
            }
            
            if (galerieSection.style.display === 'none') {
                galerieSection.style.display = 'block';
                toggleBtn.textContent = '📸 Fermer la Galerie';
                toggleBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                toggleBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.3)';
                galerieSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Charger les dernières images du dernier export
                chargerDernierExportEnGalerie();
            } else {
                galerieSection.style.display = 'none';
                toggleBtn.textContent = '📸 Voir la Galerie des Collectes';
                toggleBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                toggleBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
            }
        }
        
        // 📐 CALCULER SUPERFICIE - Méthode GPS (Marche autour du site)
        let gpsPointsForSurface = [];
        let isRecordingGPS = false;
        let gpsMap = null;
        let gpsPolygon = null;
        let gpsMarkers = [];
        let gpsWatchId = null;
        
        function calculerSuperficie() {
            showAlert('info', '📐 Méthode GPS: Vous allez marquer les points en marchant autour du site');
            
            if (!isRecordingGPS) {
                // Démarrer la capture
                startGPSRecording();
            } else {
                // Arrêter et finir
                finishGPSRecording();
            }
        }
        
        function startGPSRecording() {
            gpsPointsForSurface = [];
            gpsMarkers = [];
            isRecordingGPS = true;
            
            if (!map) {
                showAlert('error', '❌ La carte n\'est pas initialisée. Appuyez d\'abord sur "Obtenir Position GPS"');
                isRecordingGPS = false;
                return;
            }
            
            const surficieInput = document.getElementById('superficie');
            const calcBtn = document.querySelector('button[onclick="calculerSuperficie()"]');
            if (calcBtn) {
                calcBtn.textContent = '⏹️ Arrêter et Calculer';
                calcBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }
            
            showAlert('info', '🚶 Enregistrement lancé! Limitez le périmètre du site en appuyant sur les points...');
            
            // Créer une modal pour afficher les points enregistrés
            const modal = document.createElement('div');
            modal.id = 'gps-recording-modal';
            modal.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                font-size: 14px;
            `;
            modal.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: 600; color: #667eea;">📍 Enregistrement GPS</div>
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8e6; border-radius: 6px; border-left: 3px solid #6db038;">
                    <strong>Points capturés:</strong> <span id="gps-point-count">0</span>
                </div>
                <button onclick="addCurrentGPSPoint()" style="width: 100%; background: #6db038; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 8px;">📌 Ajouter Point Actuel</button>
                <button onclick="finishGPSRecording()" style="width: 100%; background: #667eea; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">✅ Terminer & Calculer</button>
            `;
            document.body.appendChild(modal);
            
            // Obtenir la position GPS actuelle
            if (navigator.geolocation) {
                gpsWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const coords = position.coords;
                        // Mettre à jour les coordonnées affichées
                        const coordsDisplay = document.getElementById('coords-display');
                        if (coordsDisplay) {
                            let markButton = '';
                            if (window.innerWidth >= 768) {
                                markButton = '<button onclick="addCurrentGPSPoint()" style="margin-top: 10px; background: #6db038; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">📌 Marquer ce Point</button>';
                            }
                            coordsDisplay.innerHTML = `
                                <strong>📍 Position GPS actuelle:</strong><br>
                                Latitude: <span id="lat">${coords.latitude.toFixed(6)}</span><br>
                                Longitude: <span id="lon">${coords.longitude.toFixed(6)}</span><br>
                                Précision: ${coords.accuracy.toFixed(0)} m<br>
                                ` + markButton + `
                            `;
                        }
                    },
                    (error) => {
                        console.error('Erreur GPS:', error);
                        showAlert('error', `❌ Erreur GPS: ${error.message}`);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                showAlert('error', '❌ GPS non disponible sur ce navigateur');
                isRecordingGPS = false;
            }
        }
        
        function addCurrentGPSPoint() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = position.coords;
                        const point = {
                            lat: coords.latitude,
                            lng: coords.longitude,
                            accuracy: coords.accuracy
                        };
                        
                        gpsPointsForSurface.push(point);
                        
                        // Mettre à jour le compteur
                        const countSpan = document.getElementById('gps-point-count');
                        if (countSpan) {
                            countSpan.textContent = gpsPointsForSurface.length;
                        }
                        
                        // Ajouter un marqueur sur la carte
                        if (map) {
                            const marker = L.marker([coords.latitude, coords.longitude], {
                                icon: L.divIcon({
                                    className: 'gps-point-marker',
                                    html: `<div style="background: #6db038; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; border: 3px white solid; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${gpsPointsForSurface.length}</div>`,
                                    iconSize: [35, 35],
                                    iconAnchor: [17, 17]
                                })
                            }).addTo(map);
                            gpsMarkers.push(marker);
                            
                            // 🔴 Dessiner le polygone progressivement
                            if (gpsPointsForSurface.length >= 2) {
                                // Si on a déjà au moins 2 points, tracer des lignes
                                const latlngs = gpsPointsForSurface.map(p => [p.lat, p.lng]);
                                
                                // Supprimer l'ancien polyline
                                if (gpsPolygon) {
                                    map.removeLayer(gpsPolygon);
                                }
                                
                                // Tracer une polyline (pas encore fermée)
                                gpsPolygon = L.polyline(latlngs, {
                                    color: '#6db038',
                                    weight: 3,
                                    opacity: 0.8,
                                    dashArray: '5, 5'
                                }).addTo(map);
                            }
                        }
                        
                        showAlert('success', `✅ Point ${gpsPointsForSurface.length} enregistré (Précision: ${coords.accuracy.toFixed(0)}m)`);
                    },
                    (error) => {
                        showAlert('error', `❌ Erreur: ${error.message}`);
                    }
                );
            }
        }
        
        function finishGPSRecording() {
            isRecordingGPS = false;
            
            // Arrêter de surveiller le GPS
            if (gpsWatchId !== null) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            
            // Fermer la modal
            const modal = document.getElementById('gps-recording-modal');
            if (modal) {
                modal.remove();
            }
            
            // Réinitialiser le bouton
            const calcBtn = document.querySelector('button[onclick="calculerSuperficie()"]');
            if (calcBtn) {
                calcBtn.textContent = '📐 Calculer';
                calcBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            
            if (gpsPointsForSurface.length < 3) {
                showAlert('error', `❌ Au moins 3 points sont nécessaires (vous en avez ${gpsPointsForSurface.length})`);
                gpsPointsForSurface = [];
                if (map) {
                    gpsMarkers.forEach(m => map.removeLayer(m));
                }
                gpsMarkers = [];
                return;
            }
            
            // Calculer la superficie
            const surfaceM2 = calculatePolygonArea(gpsPointsForSurface);
            
            // Afficher le polygone sur la carte (si disponible)
            if (map) {
                const latlngs = gpsPointsForSurface.map(p => [p.lat, p.lng]);
                if (gpsPolygon) {
                    map.removeLayer(gpsPolygon);
                }
                gpsPolygon = L.polygon(latlngs, {
                    color: '#6db038',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.3,
                    fillColor: '#6db038'
                }).addTo(map);
                
                // Adapter la vue à la map
                const group = new L.featureGroup(gpsMarkers.concat([gpsPolygon]));
                map.fitBounds(group.getBounds());
            }
            
            // Mettre à jour le champ Superficie (en m²)
            const surficieInput = document.getElementById('superficie');
            surficieInput.value = surfaceM2.toFixed(2);
            
            showAlert('success', `✅ Superficie calculée: ${surfaceM2.toFixed(2)} m² (${gpsPointsForSurface.length} points)`);
        }
        
        // Formule correcte pour calculer l'aire d'un polygone en coordonnées GPS (en m²)
        function calculatePolygonArea(points) {
            if (points.length < 3) return 0;
            
            // Utiliser la projection Mercator approximative pour de petites zones
            const EARTH_RADIUS = 6371000; // Rayon terrain en mètres
            
            // Convertir les coordonnées GPS en coordonnées relatives (x, y) en mètres
            // Basées sur une projection équirectangulaire centrée en haut-centre de la zone
            const convertToMeters = (point, refPoint) => {
                const latDiff = (point.lat - refPoint.lat) * Math.PI / 180;
                const lonDiff = (point.lng - refPoint.lng) * Math.PI / 180;
                const avgLat = (point.lat + refPoint.lat) / 2 * Math.PI / 180;
                
                const x = EARTH_RADIUS * lonDiff * Math.cos(avgLat);
                const y = EARTH_RADIUS * latDiff;
                
                return { x, y };
            };
            
            // Point de référence (premier point)
            const refPoint = points[0];
            
            // Convertir tous les points en coordonnées cartésiennes
            const xys = points.map(p => convertToMeters(p, refPoint));
            
            // Appliquer la formule Shoelace
            let area = 0;
            for (let i = 0; i < xys.length; i++) {
                const x1 = xys[i].x;
                const y1 = xys[i].y;
                const x2 = xys[(i + 1) % xys.length].x;
                const y2 = xys[(i + 1) % xys.length].y;
                
                area += x1 * y2 - x2 * y1;
            }
            
            area = Math.abs(area) / 2;
            
            // Retourner en m²
            return area;
        }
        
        // Formulaire
        function sauvegarderDonnees() {
            try {
                console.group('📋 COLLECTE DES DONNÉES - sauvegarderDonnees()');
                
                // 🔍 Vérifier d'abord que les éléments existent
                console.log('1️⃣ Récupération des éléments HTML par ID:');
                
                const partenaire_elem = document.getElementById('partenaire');
                const region_elem = document.getElementById('region');
                const departement_elem = document.getElementById('departement');
                const commune_elem = document.getElementById('commune');
                
                console.log(`   ✓ partenaire: ${partenaire_elem ? '✅ TROUVÉ' : '❌ MANQUANT'}`);
                console.log(`   ✓ region: ${region_elem ? '✅ TROUVÉ' : '❌ MANQUANT'}`);
                console.log(`   ✓ departement: ${departement_elem ? '✅ TROUVÉ' : '❌ MANQUANT'}`);
                console.log(`   ✓ commune: ${commune_elem ? '✅ TROUVÉ' : '❌ MANQUANT'}`);
                
                // Récupérer les valeurs avec détails
                console.log('\n2️⃣ Lecture des valeurs:');
                
                donnees.partenaire = partenaire_elem ? partenaire_elem.value.trim() : '';
                donnees.region = region_elem ? region_elem.value.trim() : '';
                donnees.departement = departement_elem ? departement_elem.value.trim() : '';
                donnees.commune = commune_elem ? commune_elem.value.trim() : '';
                
                // AIDE POUR RÉGION - récupérer aussi le texte affiché
                let regionText = '';
                if (region_elem && region_elem.selectedIndex >= 0) {
                    regionText = region_elem.options[region_elem.selectedIndex].text;
                }
                
                // AIDE POUR DÉPARTEMENT - récupérer aussi le texte affiché
                let departementText = '';
                if (departement_elem && departement_elem.selectedIndex >= 0) {
                    departementText = departement_elem.options[departement_elem.selectedIndex].text;
                }
                
                // AIDE POUR COMMUNE - récupérer aussi le texte affiché
                let communeText = '';
                if (commune_elem && commune_elem.selectedIndex >= 0) {
                    communeText = commune_elem.options[commune_elem.selectedIndex].text;
                }
                
                console.log(`   partenaire = "${donnees.partenaire}"`);
                console.log(`   region = "${donnees.region}" | text="${regionText}"`);
                console.log(`   departement = "${donnees.departement}" | text="${departementText}"`);
                console.log(`   commune = "${donnees.commune}" | text="${communeText}"`);
                
                // Récupérer tous les types d'activité sélectionnés
                const typeActiviteSelect = document.getElementById('typeActivite');
                const selectedTypes = typeActiviteSelect ? Array.from(typeActiviteSelect.selectedOptions).map(option => option.value) : [];
                donnees.typeActivite = selectedTypes.length > 0 ? selectedTypes : [];
                
                donnees.sites_concernes = document.getElementById('adresse') ? document.getElementById('adresse').value : '';
                donnees.superficie = document.getElementById('superficie') ? document.getElementById('superficie').value : '';
                donnees.besoinPersonnel = document.getElementById('besoinPersonnel') ? document.getElementById('besoinPersonnel').value : '';
                
                // Récupérer tous les dispositifs sélectionnés
                const dispositifSelect = document.getElementById('dispositifDeploy');
                const selectedDisposition = dispositifSelect ? Array.from(dispositifSelect.selectedOptions).map(option => option.value) : [];
                donnees.dispositifDeploy = selectedDisposition.length > 0 ? selectedDisposition : [];
                
                donnees.nombreRotation = document.getElementById('nombreRotation') ? document.getElementById('nombreRotation').value : '';
                donnees.infrastructureGestion = document.getElementById('infrastructureGestion') ? document.getElementById('infrastructureGestion').value : '';
                donnees.frequenceCollecte = document.getElementById('frequenceCollecte') ? document.getElementById('frequenceCollecte').value : '';
                donnees.bacs240 = document.getElementById('bacs240') ? document.getElementById('bacs240').value : '';
                donnees.caissePolybene = document.getElementById('caissePolybene') ? document.getElementById('caissePolybene').value : '';
                donnees.bacs660 = document.getElementById('bacs660') ? document.getElementById('bacs660').value : '';
                donnees.accessibilite = document.getElementById('accessibilite') ? document.getElementById('accessibilite').value : '';
                donnees.observation = document.getElementById('observation') ? document.getElementById('observation').value : '';
                
                // Récupérer les coordonnées UTM si elles existent
                const coordXElem = document.getElementById('coordonneeX');
                const coordYElem = document.getElementById('coordonneeY');
                donnees.coordonneeX = coordXElem ? coordXElem.value : '';
                donnees.coordonneeY = coordYElem ? coordYElem.value : '';
                
                console.log('\n3️⃣ OBJET donnees FINAL:', donnees);
                
                // ⚠️ ALERTE SI DONNÉES VIDES
                if (!donnees.region) {
                    console.warn('⚠️ ALERTE: Région est vide! Vérifiez que vous avez sélectionné une région dans le dropdown.');
                }
                if (!donnees.departement) {
                    console.warn('⚠️ ALERTE: Département est vide! Vérifiez que vous avez sélectionné un département dans le dropdown.');
                }
                if (!donnees.commune) {
                    console.warn('⚠️ ALERTE: Commune est vide! Vérifiez que vous avez sélectionné une commune dans le dropdown.');
                }
                
                console.groupEnd();
                
                showAlert('success', '✅ Données collectées localement!');
            } catch (error) {
                console.error('❌ Erreur lors de la récupération des données:', error);
                console.error('Stack:', error.stack);
                showAlert('error', '❌ Erreur: ' + error.message);
            }
        }
        
        function affichageResume() {
            const summary = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            let html = `
                <div class="data-item">
                    <div class="data-label">Partenaire:</div>
                    <div class="data-value">${donnees.partenaire}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Région:</div>
                    <div class="data-value">${donnees.region}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Département:</div>
                    <div class="data-value">${donnees.departement}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Commune:</div>
                    <div class="data-value">${donnees.commune}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Type d'Activité:</div>
                    <div class="data-value">${Array.isArray(donnees.typeActivite) ? donnees.typeActivite.join(', ') : donnees.typeActivite}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Sites Concernés:</div>
                    <div class="data-value">${donnees.sites_concernes}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Superficie:</div>
                    <div class="data-value">${donnees.superficie} ha</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Besoin en Personnel:</div>
                    <div class="data-value">${donnees.besoinPersonnel}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Dispositif Déployé:</div>
                    <div class="data-value">${Array.isArray(donnees.dispositifDeploy) ? donnees.dispositifDeploy.join(', ') : donnees.dispositifDeploy}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Nombre de Rotation:</div>
                    <div class="data-value">${donnees.nombreRotation}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Infrastructure de Gestion:</div>
                    <div class="data-value">${donnees.infrastructureGestion}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Fréquence de Collecte:</div>
                    <div class="data-value">${donnees.frequenceCollecte}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Bacs 240L:</div>
                    <div class="data-value">${donnees.bacs240}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Caisse Polybene:</div>
                    <div class="data-value">${donnees.caissePolybene}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Bacs 660L:</div>
                    <div class="data-value">${donnees.bacs660}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Accessibilité:</div>
                    <div class="data-value">${donnees.accessibilite}</div>
                </div>
            `;
            
            if (donnees.latitude) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Latitude:</div>
                        <div class="data-value">${donnees.latitude.toFixed(6)}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Longitude:</div>
                        <div class="data-value">${donnees.longitude.toFixed(6)}</div>
                    </div>
                `;
            }
            
            if (donnees.coordonneeX || donnees.coordonneeY) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Coordonnées X (UTM):</div>
                        <div class="data-value">${donnees.coordonneeX}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Coordonnées Y (UTM):</div>
                        <div class="data-value">${donnees.coordonneeY}</div>
                    </div>
                `;
            }
            
            if (donnees.observation) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Observations:</div>
                        <div class="data-value">${donnees.observation}</div>
                    </div>
                `;
            }
            
            if (donnees.photo) {
                html += `
                    <div class="data-item">
                        <div class="data-label">Photo Capturée:</div>
                        <div class="data-value">✅ Oui</div>
                    </div>
                `;
            }
            
            summaryContent.innerHTML = html;
            summary.style.display = 'block';
        }
        
        function exporterExcel(avecImage = true) {
            const ExcelJS = window.ExcelJS;
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Collecte de Données');
            
            // Définir les largeurs de colonnes
            worksheet.columns = [
                { width: 40 },
                { width: 50 }
            ];
            
            let rowCount = 1;
            
            // Titre principal
            const titleRow = worksheet.getRow(rowCount);
            titleRow.values = ['DIMENSIONNEMENT SONAGED - COLLECTE DE DONNÉES'];
            titleRow.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 14 };
            titleRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            titleRow.alignment = { horizontal: 'center', vertical: 'center' };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Informations du Site
            const sectionRow1 = worksheet.getRow(rowCount);
            sectionRow1.values = ['INFORMATIONS DU SITE'];
            sectionRow1.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow1.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            // Données du site
            const siteData = [
                ['Région', donnees.region || 'Région de Ziguinchor'],
                ['Département', donnees.departement],
                ['Commune', donnees.commune],
                ['Type d\'Activité', donnees.typeActivite],
                ['Sites Concernés', donnees.sites_concernes],
                ['Superficie (ha)', donnees.superficie],
                ['Besoin en Personnel', donnees.besoinPersonnel],
                ['Dispositif Déployé', Array.isArray(donnees.dispositifDeploy) ? donnees.dispositifDeploy.join(', ') : donnees.dispositifDeploy],
                ['Nombre de Rotation', donnees.nombreRotation],
                ['Infrastructure de Gestion', donnees.infrastructureGestion],
                ['Fréquence de Collecte', donnees.frequenceCollecte],
                ['Bacs 240L', donnees.bacs240],
                ['Caisse Polybene', donnees.caissePolybene],
                ['Bacs 660L', donnees.bacs660],
                ['Accessibilité', donnees.accessibilite],
                ['Observations', donnees.observation]
            ];
            
            siteData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Localisation GPS
            const sectionRow2 = worksheet.getRow(rowCount);
            sectionRow2.values = ['LOCALISATION GPS'];
            sectionRow2.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow2.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const gpsData = [
                ['Latitude', donnees.latitude ? donnees.latitude.toFixed(6) : '--'],
                ['Longitude', donnees.longitude ? donnees.longitude.toFixed(6) : '--'],
                ['Précision (m)', donnees.precision || '--']
            ];
            
            gpsData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Localisation UTM
            const sectionRow3 = worksheet.getRow(rowCount);
            sectionRow3.values = ['LOCALISATION DU SITE (UTM)'];
            sectionRow3.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow3.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF69B4' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const utmData = [
                ['Coordonnées X (Easting)', donnees.coordonneeX],
                ['Coordonnées Y (Northing)', donnees.coordonneeY]
            ];
            
            utmData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            // Section: Photo
            if (donnees.photo) {
                const sectionRow4 = worksheet.getRow(rowCount);
                sectionRow4.values = ['PHOTO CAPTURÉE'];
                sectionRow4.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
                sectionRow4.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF10B981' } };
                worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
                rowCount++;
                
                // Convertir le canvas/data URL en image et l'ajouter
                const imageBase64 = donnees.photo.split('data:image/jpeg;base64,')[1] || donnees.photo;
                const imageId = workbook.addImage({
                    base64: imageBase64,
                    extension: 'jpeg'
                });
                
                // Ajouter l'image à la feuille
                worksheet.addImage(imageId, {
                    tl: { col: 0, row: rowCount - 1 },
                    ext: { width: 400, height: 400 }
                });
                
                rowCount += 15;
            }
            
            // Section: Informations de collecte
            worksheet.getRow(rowCount).height = 5;
            rowCount++;
            
            const sectionRow5 = worksheet.getRow(rowCount);
            sectionRow5.values = ['INFORMATIONS DE COLLECTE'];
            sectionRow5.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 12 };
            sectionRow5.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF667EEA' } };
            worksheet.mergeCells(`A${rowCount}:B${rowCount}`);
            rowCount++;
            
            const collecteData = [
                ['Date de Collecte', new Date(donnees.dateCollecte).toLocaleString('fr-FR')],
                ['Photo Capturée', donnees.photo ? 'Oui' : 'Non']
            ];
            
            collecteData.forEach(data => {
                const row = worksheet.getRow(rowCount);
                row.values = data;
                row.font = { name: 'Calibri', size: 11 };
                row.alignment = { horizontal: 'left', vertical: 'center' };
                worksheet.getCell(`A${rowCount}`).font = { bold: true, color: { argb: 'FF667EEA' } };
                worksheet.getCell(`A${rowCount}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                rowCount++;
            });
            
            // Générer et télécharger le fichier
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `SONAGED_Collecte_${new Date().getTime()}.xlsx`;
                link.click();
                URL.revokeObjectURL(url);
                showAlert('success', '✅ Fichier Excel exporté avec succès!');
            });
        }
        
        function exporterJSON() {
            const dataStr = JSON.stringify(donnees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `collecte_donnees_${new Date().getTime()}.json`;
            link.click();
        }
        
        function imprimerDonnees() {
            window.print();
        }
        
        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 4000);
        }
        
        // Afficher le résumé des données avant sauvegarde
        function afficherResume() {
            // Récupérer tous les champs du formulaire avec vérifications null-safety
            const region = document.getElementById('region')?.value || '';
            const regionLabel = document.getElementById('region')?.options[document.getElementById('region')?.selectedIndex || 0]?.text || '';
            const departement = document.getElementById('departement')?.value || '';
            const departementLabel = document.getElementById('departement')?.options[document.getElementById('departement')?.selectedIndex || 0]?.text || '';
            const commune = document.getElementById('commune')?.value || '';
            const typeActivite = Array.from(document.getElementById('typeActivite')?.selectedOptions || []).map(opt => opt.text).join(', ');
            const partenaire = document.getElementById('partenaire')?.value || '';
            const sites_concernes = document.getElementById('adresse')?.value || '';
            const superficie = document.getElementById('superficie')?.value || '';
            const besoinPersonnel = document.getElementById('besoinPersonnel')?.value || '';
            const dispositifDeploy = Array.from(document.getElementById('dispositifDeploy')?.selectedOptions || []).map(opt => opt.text).join(', ');
            const nombreRotation = document.getElementById('nombreRotation')?.value || '';
            const infrastructureGestion = document.getElementById('infrastructureGestion')?.value || '';
            const frequenceCollecte = document.getElementById('frequenceCollecte')?.value || '';
            const bacs240 = document.getElementById('bacs240')?.value || '';
            const caissePolybene = document.getElementById('caissePolybene')?.value || '';
            const bacs660 = document.getElementById('bacs660')?.value || '';
            const accessibilite = document.getElementById('accessibilite')?.value || '';
            const observation = document.getElementById('observation')?.value || '';
            const lat = document.getElementById('lat')?.textContent || '--';
            const lon = document.getElementById('lon')?.textContent || '--';
            const accuracy = document.getElementById('accuracy')?.textContent || '--';
            const utmEasting = document.getElementById('utm-easting')?.textContent || '--';
            const utmNorthing = document.getElementById('utm-northing')?.textContent || '--';
            const photo = donnees.photo;
            
            if (!region || !departement || !commune) {
                alert('❌ Veuillez sélectionner la région, le département et la commune');
                return;
            }
            
            let resumeHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">📍 LOCALISATION</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Région: <strong>${regionLabel || region}</strong></div>
                        <div>Département: <strong>${departementLabel || departement}</strong></div>
                        <div>Commune: <strong>${commune}</strong></div>
                        <div>Sites Concernés: <strong>${sites_concernes}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">📊 INFORMATIONS PRINCIPALES</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Type d'Activité: <strong>${typeActivite || 'Non spécifié'}</strong></div>
                        <div>Partenaire: <strong>${partenaire}</strong></div>
                        <div>Superficie: <strong>${superficie} ha</strong></div>
                        <div>Accessibilité: <strong>${accessibilite}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">👥 RESSOURCES</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Besoin en Personnel: <strong>${besoinPersonnel} personne(s)</strong></div>
                        <div>Nombre de Rotations: <strong>${nombreRotation}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">🛠️ INFRASTRUCTURE & ÉQUIPEMENTS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Dispositif Déployé: <strong>${dispositifDeploy || 'Non spécifié'}</strong></div>
                        <div>Infrastructure de Gestion: <strong>${infrastructureGestion}</strong></div>
                        <div>Fréquence de Collecte: <strong>${frequenceCollecte}</strong></div>
                        <div>Bacs 240L: <strong>${bacs240}</strong></div>
                        <div>Caisse Polybène: <strong>${caissePolybene}</strong></div>
                        <div>Bacs 660L: <strong>${bacs660}</strong></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">🗺️ COORDONNÉES GPS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>Latitude: <strong>${lat}</strong></div>
                        <div>Longitude: <strong>${lon}</strong></div>
                        <div>Précision: <strong>${accuracy}</strong></div>
                        <div style="font-size: 12px; margin-top: 8px; color: #666;">
                            UTM - Easting: <strong>${utmEasting}</strong> | Northing: <strong>${utmNorthing}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            if (observation) {
                resumeHTML += `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">📝 OBSERVATIONS</strong>
                    <div style="margin-top: 10px; margin-left: 10px; border-left: 3px solid #6db038; padding-left: 12px;">
                        <div>${observation}</div>
                    </div>
                </div>
                `;
            }
            
            if (photo) {
                resumeHTML += `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: #2d5016; font-size: 16px;">📷 PHOTO CAPTURÉE</strong>
                    <div style="margin-top: 10px; text-align: center;">
                        <img src="${photo}" alt="Photo capturée" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 2px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    </div>
                </div>
                `;
            }
            
            resumeHTML += `
                <div style="background: linear-gradient(135deg, #f0f8e6 0%, #e8f5df 100%); padding: 15px; border-radius: 8px; text-align: center; font-size: 12px; color: #2d5016;">
                    <strong>✅ Vérifiez toutes les informations avant de sauvegarder</strong>
                </div>
            `;
            
            document.getElementById('resume-contenu').innerHTML = resumeHTML;
            document.getElementById('resume-section').style.display = 'block';
            
            // Scroller vers le résumé (avec fallback pour mobile)
            setTimeout(() => {
                try {
                    const resumeSection = document.getElementById('resume-section');
                    if (resumeSection) {
                        resumeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } catch (e) {
                    // Fallback pour navigateurs mobiles qui ne supportent pas scrollIntoView
                    window.scrollTo({ top: document.getElementById('resume-section').offsetTop - 100, behavior: 'smooth' });
                }
            }, 100);
        }
        
        // ✅ FONCTION DE VALIDATION POUR UN SEUL CHAMP
        function validerChamp(fieldId) {
            const champ = document.getElementById(fieldId);
            const errorElem = document.getElementById(`error-${fieldId}`);
            
            if (!champ || !errorElem) return true;
            
            const valeur = champ.value ? champ.value.toString().trim() : '';
            const estValide = valeur !== '' && valeur !== '0';
            
            if (!estValide) {
                errorElem.style.display = 'block';
                champ.style.borderColor = '#dc3545';
                champ.style.borderWidth = '2px';
            } else {
                errorElem.style.display = 'none';
                champ.style.borderColor = '';
                champ.style.borderWidth = '';
            }
            
            return estValide;
        }
        
        // ✅ FONCTION DE VALIDATION COMPLÈTE DU FORMULAIRE
        function validerFormulaire() {
            console.log('🔍 Validation du formulaire...');
            
            const champsObligatoires = [
                'region', 'departement', 'commune', 'typeActivite',
                'partenaire', 'adresse', 'superficie', 'besoinPersonnel'
            ];
            
            let tousValides = true;
            const erreursMessages = [];
            
            champsObligatoires.forEach(fieldId => {
                const champ = document.getElementById(fieldId);
                if (!champ) return;
                
                let valeur = '';
                if (champ.type === 'select-multiple') {
                    valeur = Array.from(champ.selectedOptions).length > 0 ? 'ok' : '';
                } else {
                    valeur = champ.value ? champ.value.toString().trim() : '';
                }
                
                const estValide = valeur !== '' && valeur !== '0';
                
                if (!estValide) {
                    tousValides = false;
                    erreursMessages.push(`❌ ${champ.previousElementSibling?.textContent || fieldId}`);
                    validerChamp(fieldId);
                } else {
                    const errorElem = document.getElementById(`error-${fieldId}`);
                    if (errorElem) {
                        errorElem.style.display = 'none';
                        champ.style.borderColor = '';
                    }
                }
            });
            
            // Vérifier GPS
            const lat = parseFloat(document.getElementById('lat')?.textContent || '');
            const lon = parseFloat(document.getElementById('lon')?.textContent || '');
            
            if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                tousValides = false;
                erreursMessages.push('❌ Coordonnées GPS obligatoires (cliquez sur "Obtenir Position GPS")');
            }
            
            // Afficher les erreurs
            if (!tousValides) {
                const message = '⚠️ ERREURS DE VALIDATION:\n\n' + erreursMessages.join('\n');
                console.error(message);
                showAlert('error', message);
            } else {
                console.log('✅ Tous les champs sont valides!');
            }
            
            return tousValides;
        }
        
        // ✅ FONCTION DE RÉINITIALISATION COMPLÈTE DES CHAMPS
        function reinitialiserFormulaire() {
            console.group('🧹 RÉINITIALISATION COMPLÈTE DU FORMULAIRE');
            
            // Réinitialiser le formulaire HTML
            const form = document.getElementById('collecte-form');
            if (form) {
                form.reset();
                console.log('  ✅ Formulaire HTML réinitialisé');
            }
            
            // Masquer le résumé
            const resumeSection = document.getElementById('resume-section');
            if (resumeSection) {
                resumeSection.style.display = 'none';
                console.log('  ✅ Résumé masqué');
            }
            
            // Réinitialiser les coordonnées GPS
            document.getElementById('lat').textContent = '--';
            document.getElementById('lon').textContent = '--';
            document.getElementById('accuracy').textContent = '--';
            document.getElementById('utm-easting').textContent = '--';
            document.getElementById('utm-northing').textContent = '--';
            console.log('  ✅ Coordonnées GPS réinitialisées');
            
            // Masquer les images
            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) {
                imagePreview.classList.add('hidden');
                console.log('  ✅ Aperçu image masqué');
            }
            
            const canvas = document.getElementById('canvas');
            if (canvas) {
                canvas.style.display = 'none';
                console.log('  ✅ Canvas masqué');
            }
            
            // Réinitialiser l'objet global donnees
            donnees = {
                partenaire: '', region: '', departement: '', commune: '',
                typeActivite: [], sites_concernes: '', superficie: '',
                besoinPersonnel: '', dispositifDeploy: [], nombreRotation: '',
                infrastructureGestion: '', frequenceCollecte: '',
                bacs240: '', caissePolybene: '', bacs660: '',
                accessibilite: '', observation: '',
                latitude: null, longitude: null, precision: null,
                coordonneeX: '', coordonneeY: '', photo: null,
                dateCollecte: new Date().toISOString()
            };
            console.log('  ✅ Objet donnees réinitialisé');
            
            // Réinitialiser la map
            if (typeof map !== 'undefined' && map !== null && typeof marker !== 'undefined' && marker !== null) {
                map.removeLayer(marker);
                marker = null;
                console.log('  ✅ Marqueur supprimé de la carte');
            }
            
            console.groupEnd();
            console.log('✅ Formulaire, GPS et images complètement vidés');
        }
        
        // ✅ FONCTION QUI VALIDE PUIS SAUVEGARDE
        function validerEtSauvegarder() {
            if (validerFormulaire()) {
                sauvegarderDonneesBD();
            } else {
                console.log('⛔ Sauvegarde bloquée: formulaire invalide');
            }
        }
        
        // Fonction pour sauvegarder en base de données
        function sauvegarderDonneesBD() {
            console.group('🔴 COLLECTE DIRECTE DEPUIS LE FORMULAIRE HTML');
            
            // 🔴 COLLECTER DIRECTEMENT DES ÉLÉMENTS HTML (pas de dépendance sur l'objet donnees)
            const partenaire = (document.getElementById('partenaire')?.value || '').trim();
            const region = (document.getElementById('region')?.value || '').trim();
            const departement = (document.getElementById('departement')?.value || '').trim();
            const commune = (document.getElementById('commune')?.value || '').trim();
            const sites_concernes = (document.getElementById('adresse')?.value || '').trim();
            const superficie = (document.getElementById('superficie')?.value || '').trim();
            const besoinPersonnel = (document.getElementById('besoinPersonnel')?.value || '').trim();
            const observation = (document.getElementById('observation')?.value || '').trim();
            
            // Collecte des éléments multi-select
            const typeActiviteSelect = document.getElementById('typeActivite');
            const typeActivite = typeActiviteSelect ? Array.from(typeActiviteSelect.selectedOptions).map(opt => opt.value) : [];
            
            const dispositifDeploySelect = document.getElementById('dispositifDeploy');
            const dispositifDeploy = dispositifDeploySelect ? Array.from(dispositifDeploySelect.selectedOptions).map(opt => opt.value) : [];
            
            // Collecte des champs optionnels
            const nombreRotation = (document.getElementById('nombreRotation')?.value || '').trim();
            const infrastructureGestion = (document.getElementById('infrastructureGestion')?.value || '').trim();
            const frequenceCollecte = (document.getElementById('frequenceCollecte')?.value || '').trim();
            const bacs240 = (document.getElementById('bacs240')?.value || '').trim();
            const caissePolybene = (document.getElementById('caissePolybene')?.value || '').trim();
            const bacs660 = (document.getElementById('bacs660')?.value || '').trim();
            const accessibilite = (document.getElementById('accessibilite')?.value || '').trim();
            
            // Collecte des GPS
            const latitude = parseFloat(document.getElementById('lat')?.textContent || donnees.latitude || '');
            const longitude = parseFloat(document.getElementById('lon')?.textContent || donnees.longitude || '');
            const precision = parseFloat(document.getElementById('accuracy')?.textContent || donnees.precision || '');
            const coordonneeX = (document.getElementById('utm-easting')?.textContent || donnees.coordonneeX || '').trim();
            const coordonneeY = (document.getElementById('utm-northing')?.textContent || donnees.coordonneeY || '').trim();
            
            // Photo depuis donnees globales
            const photo = donnees.photo || null;
            
            console.log('✅ COLLECTE DIRECTE - Résultats:');
            console.log('  Partenaire:', partenaire);
            console.log('  Région:', region);
            console.log('  Département:', departement);
            console.log('  Commune:', commune);
            console.log('  Sites Concernés:', sites_concernes);
            console.log('  Superficie:', superficie);
            console.log('  Personnel:', besoinPersonnel);
            console.log('  Latitude:', latitude);
            console.log('  Longitude:', longitude);
            console.log('  Precision:', precision);
            
            console.groupEnd();
            
            // ✅ VALIDATION STRICTE DES CHAMPS OBLIGATOIRES
            console.group('🔴 VALIDATION STRUCTE');
            
            const champs_vides = [];
            
            if (!partenaire) champs_vides.push('Partenaire');
            if (!region) champs_vides.push('Région');
            if (!departement) champs_vides.push('Département');
            if (!commune) champs_vides.push('Commune');
            if (!sites_concernes) champs_vides.push('Sites Concernés');
            if (!superficie) champs_vides.push('Superficie');
            if (!besoinPersonnel) champs_vides.push('Besoin en Personnel');
            
            // Afficher les vérifications
            champs_vides.length === 0 && console.log('✅ Tous les champs obligatoires sont remplis!');
            champs_vides.forEach(champ => console.error(`❌ ${champ} est VIDE`));
            
            console.groupEnd();
            
            // Si des champs obligatoires sont vides
            if (champs_vides.length > 0) {
                const message = `❌ ERREUR: Veuillez remplir les champs obligatoires manquants:\n\n${champs_vides.map(c => '• ' + c).join('\n')}`;
                console.error(message);
                alert(message);
                showAlert('error', message);
                return;
            }
            
            // GPS obligatoire
            if (!latitude || !longitude || isNaN(latitude) || isNaN(longitude)) {
                showAlert('error', '📍 Les coordonnées GPS sont obligatoires. Cliquez sur "📡 Obtenir Position GPS" d\'abord.');
                console.error('❌ GPS invalide - Latitude:', latitude, 'Longitude:', longitude);
                return;
            }
            
            // Afficher le résumé pour vérification
            afficherResume();
            
            // Demander confirmation
            if (!confirm('✅ Êtes-vous sûr(e) de vouloir sauvegarder ces données en base de données ?')) {
                console.log('ℹ️ Sauvegarde annulée par l\'utilisateur');
                return;
            }
            
            console.log('📤 Prêt à envoyer les données au serveur');
            
            // Préparer les données pour l'envoi (DIRECTEMENT depuis les variables locales)
            const dataToSend = {
                partenaire: partenaire,
                region: region,
                departement: departement,
                commune: commune,
                typeActivite: typeActivite.length > 0 ? typeActivite.join(',') : '',
                sites_concernes: sites_concernes,
                superficie: superficie,
                besoinPersonnel: besoinPersonnel,
                dispositifDeploy: dispositifDeploy.length > 0 ? dispositifDeploy.join(',') : '',
                nombreRotation: nombreRotation,
                infrastructureGestion: infrastructureGestion,
                frequenceCollecte: frequenceCollecte,
                bacs240: bacs240,
                caissePolybene: caissePolybene,
                bacs660: bacs660,
                accessibilite: accessibilite,
                observation: observation,
                latitude: latitude,
                longitude: longitude,
                precision: precision,
                coordonneeX: coordonneeX,
                coordonneeY: coordonneeY,
                photo: photo,
                dateCollecte: new Date().toISOString()
            };
            
            console.group('🟢 DONNÉES À ENVOYER AU SERVEUR');
            console.log('Partenaire:', dataToSend.partenaire);
            console.log('Région:', dataToSend.region);
            console.log('Département:', dataToSend.departement);
            console.log('Commune:', dataToSend.commune);
            console.log('Sites Concernés:', dataToSend.sites_concernes);
            console.log('Latitude:', dataToSend.latitude);
            console.log('Longitude:', dataToSend.longitude);
            console.log('Full dataToSend:', JSON.stringify(dataToSend, null, 2));
            console.groupEnd();
            
            showAlert('success', '⏳ Envoi des données au serveur... Veuillez patienter.');
            
            // Vérifier la taille totale avant envoi
            const totalSize = JSON.stringify(dataToSend).length;
            console.log('📦 Taille totale à envoyer:', (totalSize/1024/1024).toFixed(2), 'MB');
            
            if (totalSize > 25 * 1024 * 1024) {
                showAlert('error', `❌ Les données sont trop volumineuses: ${(totalSize/1024/1024).toFixed(1)}MB`);
                return;
            }
            
            console.log('🚀 Envoi des données au serveur...');
            
            // Envoyer au serveur avec l'URL dynamique
            fetch(API_BASE_URL + '/api/collecte', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                console.log('📡 Réponse serveur:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Erreur serveur ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(result => {
                console.log('✅ Réponse du serveur (SUCCESS):', result);
                console.log('🗄️ Les données sont maintenant dans PostgreSQL');
                
                const serverURL = window.API_BASE_URL || 'serveur backend';
                const message = `
✅ DONNÉES SAUVEGARDÉES DANS POSTGRESQL!

🆔 ID Collecte: ${result.data.id || 'N/A'}
📅 Date: ${new Date(result.data.dateCollecte).toLocaleString('fr-FR')}
🗄️ Serveur: ${serverURL}
📊 Status: Prêt pour nouvelle saisie
                `.trim();
                
                showAlert('success', message);
                
                // Sauvegarder aussi localement
                sauvegarderEnLocal(dataToSend);
                
                // 🧹 RÉINITIALISER COMPLÈTEMENT LE FORMULAIRE
                reinitialiserFormulaire();
                
                // Notification finale après 1 seconde
                setTimeout(() => {
                    showAlert('info', '🧹 Formulaire vidé. Prêt pour une nouvelle saisie!');
                }, 1000);
            })
            .catch(error => {
                console.error('❌ ERREUR SAUVEGARDE POSTGRESQL:', error);
                console.error('📍 Stack:', error.stack);
                console.error('📊 Type d\'erreur:', error.name);
                console.error('💾 Données envoyées (size):', (JSON.stringify(dataToSend).length/1024/1024).toFixed(2), 'MB');
                
                // Message plus détaillé basé sur le type d'erreur
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = `
❌ IMPOSSIBLE DE JOINDRE LE SERVEUR POSTGRESQL

Vérifiez que:
1. Le serveur backend est lancé: npm start
2. PostgreSQL est en cours d'exécution
3. L'URL est correcte: http://localhost:3001

Si le problème persiste, consultez les logs du serveur.
                    `.trim();
                } else if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
                    errorMsg = `
❌ ERREUR DE RÉPONSE DU SERVEUR

Le serveur n'a pas retourné du JSON valide.
Vérifiez les logs du serveur (npm start) pour plus de détails.
                    `.trim();
                } else if (error.message.includes('HTTP 500')) {
                    errorMsg = `
❌ ERREUR SERVEUR (500)

Le serveur PostgreSQL a rencontré une erreur.
Consultez les logs du serveur pour les détails complets.
                    `.trim();
                } else if (error.message.includes('HTTP')) {
                    errorMsg = error.message;
                }
                
                showAlert('error', errorMsg);
                
                // Sauvegarder quand même en local en cas d'échec
                console.log('💾 Sauvegarde locale de secours...');
                sauvegarderEnLocal(dataToSend);
                const serverURL = window.API_BASE_URL || 'http://localhost:3001';
                showAlert('info', `💾 Données sauvegardées localement en attente.\n\nElle seront synchronisées avec PostgreSQL dès que le serveur ${serverURL} sera disponible.`);
            });
        }
        
        // Sauvegarder en localStorage en tant que secours
        function sauvegarderEnLocal(donnees) {
            try {
                // Créer une copie sans la photo pour réduire la taille localStorage
                const donneesReduite = { ...donnees };
                if (donneesReduite.photo) {
                    donneesReduite.photo = '(photo supprimée du local storage)';
                }
                
                const collectes = JSON.parse(localStorage.getItem('collectes_donnees') || '[]');
                collectes.push({
                    ...donneesReduite,
                    saveDateLocal: new Date().toISOString(),
                    photoExists: !!donnees.photo
                });
                localStorage.setItem('collectes_donnees', JSON.stringify(collectes));
                console.log('✅ Données sauvegardées en localStorage');
            } catch (e) {
                console.error('❌ Erreur localStorage:', e);
            }
        }
        
        // ============ FONCTIONS DE NAVIGATION LANDING PAGE ============
        
        // Synchroniser les données entre mobile et desktop
        function syncCircuitData(field, value, isMobile = true) {
            if (isMobile) {
                // Depuis mobile vers desktop
                const desktopField = field.replace('-desktop', '') === field ? field + '-desktop' : field;
                const elem = document.getElementById(desktopField);
                if (elem) elem.textContent = value;
            } else {
                // Depuis desktop vers mobile
                const mobileField = field.replace('-desktop', '');
                const elem = document.getElementById(mobileField);
                if (elem) elem.textContent = value;
            }
        }
        function allerAuFormulaire(scroll = true) {
            mostrarMenu('collecte');
            
            // Initialiser les cartes quand le formulaire devient visible
            setTimeout(() => {
                initMap();
                initializeCollecteMap();
            }, 100);
            
            console.log('✅ Navigation vers la collecte');
        }
        
        function scrollToFeatures() {
            const featuresSection = document.getElementById('features-section');
            if (featuresSection) {
                featuresSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // ============= 🗺️ CIRCUIT TRACKER ===============
        let circuitMap = null;
        let circuitTracking = false;
        let circuitPoints = [];
        let circuitPolyline = null;
        let circuitMarkers = [];
        let trackingStartTime = null;
        let trackingWatchId = null;
        let basemapLayers = {};
        let startMarker = null;
        let currentPositionMarker = null;
        let accuracyCircle = null;
        let circuitsHistory = [];
        let selectedCircuitId = null;
        
        // Event listener pour déterminer "Collecte" ou "Balayage"
        document.getElementById('typeActivite')?.addEventListener('change', function() {
            const selectedTypes = Array.from(this.selectedOptions).map(o => o.value);
            if (selectedTypes.includes('Collecte') || selectedTypes.includes('Balayage')) {
                const typeLabel = selectedTypes.includes('Collecte') ? 'Collecte' : 'Balayage';
                if (selectedTypes.includes('Collecte') && selectedTypes.includes('Balayage')) {
                    ouvrirModalCircuit('Collecte/Balayage');
                } else {
                    ouvrirModalCircuit(typeLabel);
                }
            }
        });
        
        function ouvrirModalCircuit(type) {
            document.getElementById('circuit-modal').style.display = 'block';
            document.getElementById('circuit-type-label').textContent = type;
            // Synchroniser le label pour desktop
            const desktopLabel = document.getElementById('circuit-type-label-desktop');
            if (desktopLabel) desktopLabel.textContent = type;
            document.body.style.overflow = 'hidden';
            
            // Force le modal à être vraiment fullscreen sur mobile
            const modal = document.getElementById('circuit-modal');
            if (window.innerWidth <= 768) {
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.top = '0';
                modal.style.left = '0';
            }
            
            // Initialiser la carte avec délai
            setTimeout(() => {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    initCircuitMap('fullscreen');
                } else {
                    initCircuitMap('desktop');
                }
            }, 300);
        }
        
        function fermerModalCircuit() {
            document.getElementById('circuit-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            if (trackingWatchId) navigator.geolocation.clearWatch(trackingWatchId);
            circuitTracking = false;
        }
        
        function initCircuitMap(mode = 'auto') {
            // Nettoyer l'ancienne carte si elle existe
            if (circuitMap) {
                circuitMap.off();
                circuitMap.remove();
                circuitMap = null;
                basemapLayers = {};
            }
            
            const mapContainer = mode === 'fullscreen' ? 'circuit-map-fullscreen' : 'circuit-map';
            circuitMap = L.map(mapContainer, { zoomControl: true }).setView([13.1939, -15.5277], 13);
            
            // Basemap OSM Standard
            basemapLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(circuitMap);
            
            // Basemap Satellite (Esri)
            basemapLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 18
            });
            
            // Basemap Topographique (OpenTopoMap)
            basemapLayers.topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap',
                maxZoom: 17
            });
            
            // Charger les circuits sauvegardés
            chargerCircuits();
            
            // Ajouter les marqueurs actuels
            circuitMarkers = [];
            circuitPoints = [];
            updateCircuitStats();
        }
        
        function changerBasemap(type) {
            if (!circuitMap) return;
            
            // Retirer tous les basemaps
            Object.values(basemapLayers).forEach(layer => circuitMap.removeLayer(layer));
            
            // Ajouter le basemap sélectionné
            basemapLayers[type].addTo(circuitMap);
        }
        
        // Variables globales pour le suivi
        let circuitFollowMode = true; // Mode suivi automatique activé
        let lastUpdateTime = 0;
        let updateThrottle = 500; // Mise à jour toutes les 500ms maximum
        
        function demarrerTracking() {
            circuitTracking = true;
            trackingStartTime = new Date();
            circuitPoints = [];
            circuitPolyline = null;
            circuitMarkers = [];
            startMarker = null;
            currentPositionMarker = null;
            circuitFollowMode = true; // Activer le mode suivi
            
            // Afficher les boutons d'action
            document.getElementById('btn-demarrer-circuit').style.display = 'none';
            document.getElementById('btn-pause-circuit').style.display = 'flex';
            document.getElementById('btn-ajouter-marker').style.display = 'flex';
            document.getElementById('btn-ajouter-marker-desktop').style.display = 'flex'; // Repère sur PC
            document.getElementById('btn-terminer-circuit').style.display = 'flex';
            document.getElementById('circuit-status-header').textContent = '🔴 ENREGISTREMENT EN COURS';
            
            showAlert('success', '✅ Tracage démarré! Naviguez votre terrain... 🗺️');
            
            // Démarrer le tracking GPS avec haute précision
            if (navigator.geolocation) {
                trackingWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        // Throttle les mises à jour
                        const now = Date.now();
                        if (now - lastUpdateTime < updateThrottle) return;
                        lastUpdateTime = now;
                        
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        const altitude = position.coords.altitude;
                        
                        // Ajouter le point uniquement si distance suffisante du dernier point
                        let shouldAddPoint = true;
                        if (circuitPoints.length > 0) {
                            const lastPoint = circuitPoints[circuitPoints.length - 1];
                            const distance = calculateDistance(lat, lon, lastPoint[0], lastPoint[1]);
                            // Ignorer les points trop proches (< 2 mètres)
                            if (distance < 2) shouldAddPoint = false;
                        }
                        
                        if (shouldAddPoint) {
                            circuitPoints.push([lat, lon]);
                        }
                        
                        // Mise à jour des affichages
                        document.getElementById('circuit-lat').textContent = lat.toFixed(6);
                        document.getElementById('circuit-lon').textContent = lon.toFixed(6);
                        document.getElementById('circuit-lat-desktop').textContent = lat.toFixed(6);
                        document.getElementById('circuit-lon-desktop').textContent = lon.toFixed(6);
                        document.getElementById('circuit-points').textContent = circuitPoints.length;
                        document.getElementById('circuit-points-desktop').textContent = circuitPoints.length;
                        
                        // Code couleur de précision GPS
                        const accuracySpan = document.getElementById('circuit-accuracy');
                        const accuracySpanDesktop = document.getElementById('circuit-accuracy-desktop');
                        accuracySpan.className = 'gps-quality';
                        
                        if (accuracy < 10) {
                            accuracySpan.classList.add('good');
                            accuracySpan.textContent = '✓ ' + accuracy.toFixed(1) + ' m';
                            if (accuracySpanDesktop) {
                                accuracySpanDesktop.className = 'gps-quality good';
                                accuracySpanDesktop.textContent = '✓ ' + accuracy.toFixed(1) + ' m';
                            }
                        } else if (accuracy < 20) {
                            accuracySpan.classList.add('medium');
                            accuracySpan.textContent = '⚠ ' + accuracy.toFixed(1) + ' m';
                            if (accuracySpanDesktop) {
                                accuracySpanDesktop.className = 'gps-quality medium';
                                accuracySpanDesktop.textContent = '⚠ ' + accuracy.toFixed(1) + ' m';
                            }
                        } else {
                            accuracySpan.classList.add('poor');
                            accuracySpan.textContent = '✗ ' + accuracy.toFixed(1) + ' m';
                            if (accuracySpanDesktop) {
                                accuracySpanDesktop.className = 'gps-quality poor';
                                accuracySpanDesktop.textContent = '✗ ' + accuracy.toFixed(1) + ' m';
                            }
                        }
                        
                        // 🎯 SI C'EST LE PREMIER POINT - Ajouter marqueur de départ
                        if (circuitPoints.length === 1) {
                            startMarker = L.marker([lat, lon], {
                                icon: L.icon({
                                    iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="%236db038"><circle cx="16" cy="16" r="12" fill="%236db038" stroke="white" stroke-width="2"/><circle cx="16" cy="16" r="6" fill="white"/></svg>',
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 16],
                                    className: 'circuit-start-marker'
                                })
                            }).addTo(circuitMap);
                            startMarker.bindPopup('🟢 <strong>Départ du Circuit</strong><br>Position: ' + lat.toFixed(4) + ', ' + lon.toFixed(4));
                            
                            // ZOOM INITIAL SUR LA POSITION UTILISATEUR
                            circuitMap.setView([lat, lon], 17);
                        }
                        
                        // 📍 METTRE À JOUR MARQUEUR DE POSITION ACTUELLE
                        if (currentPositionMarker) {
                            circuitMap.removeLayer(currentPositionMarker);
                        }
                        if (accuracyCircle) {
                            circuitMap.removeLayer(accuracyCircle);
                        }
                        
                        // 🔵 Marqueur principal avec couleur animée
                        currentPositionMarker = L.circleMarker([lat, lon], {
                            radius: 10,
                            fillColor: '#2196F3',
                            color: '#1976D2',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 0.9,
                            className: 'circuit-current-position'
                        }).addTo(circuitMap);
                        currentPositionMarker.bindPopup(`<b>📍 Position Actuelle</b><br>Lat: ${lat.toFixed(6)}°<br>Lon: ${lon.toFixed(6)}°<br>Précision: ±${accuracy.toFixed(1)}m<br>Altitude: ${altitude ? altitude.toFixed(1) + 'm' : 'N/A'}`);
                        
                        // 🔵 CERCLE DE PRÉCISION (accuracy circle) - optionnel
                        if (accuracy < 50) { // Afficher seulement si < 50m
                            accuracyCircle = L.circle([lat, lon], {
                                radius: accuracy,
                                fillColor: '#2196F3',
                                fillOpacity: 0.08,
                                color: '#2196F3',
                                weight: 2,
                                opacity: 0.4,
                                dashArray: '8, 4'
                            }).addTo(circuitMap);
                        }
                        
                        // Tracer la polyline en temps réel
                        if (!circuitPolyline && circuitPoints.length > 1) {
                            circuitPolyline = L.polyline(circuitPoints, {
                                color: '#2196F3',
                                weight: 4,
                                opacity: 0.85,
                                lineCap: 'round',
                                lineJoin: 'round',
                                smoothFactor: 1.0,
                                className: 'circuit-polyline'
                            }).addTo(circuitMap);
                        } else if (circuitPolyline && circuitPoints.length > 1) {
                            circuitPolyline.setLatLngs(circuitPoints);
                        }
                        
                        // 🎯 MODE SUIVI - Centrer automatiquement sur la position
                        if (circuitFollowMode) {
                            circuitMap.setView([lat, lon], 17, { animate: true });
                        }
                        
                        // Mettre à jour les stats
                        updateCircuitStats();
                    },
                    (error) => {
                        console.error('❌ Erreur GPS:', error);
                        let errorMsg = '❌ Erreur GPS: ';
                        switch(error.code) {
                            case 1: errorMsg += 'Permission refusée'; break;
                            case 2: errorMsg += 'Position indisponible'; break;
                            case 3: errorMsg += 'Délai dépassé'; break;
                            default: errorMsg += error.message;
                        }
                        document.getElementById('circuit-status-header').textContent = errorMsg;
                        showAlert('error', errorMsg);
                    },
                    { 
                        enableHighAccuracy: true, 
                        maximumAge: 0, 
                        timeout: 8000 
                    }
                );
            } else {
                showAlert('error', '❌ Géolocalisation non supportée par le navigateur');
            }
        }
        
        // Fonction auxiliaire pour calculer la distance entre deux coordonnées (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c * 1000; // Retourner en mètres
        }
        
        function pauseTracking() {
            circuitTracking = false;
            circuitFollowMode = false; // Arrêter le suivi automatique
            
            if (trackingWatchId) navigator.geolocation.clearWatch(trackingWatchId);
            
            document.getElementById('btn-pause-circuit').style.display = 'none';
            document.getElementById('btn-demarrer-circuit').style.display = 'flex';
            document.getElementById('btn-ajouter-marker').style.display = 'none'; // Masquer repère en pause
            document.getElementById('btn-ajouter-marker-desktop').style.display = 'none';
            document.getElementById('circuit-status-header').textContent = '⏸️ PAUSE - Appuyez "Démarrer" pour reprendre';
            
            // Garder le marqueur de position actuelle visible mais en pause
            if (currentPositionMarker) {
                // Changer la couleur du marqueur en pause (orange)
                currentPositionMarker.setStyle({
                    fillColor: '#FF9800',
                    color: '#F57C00',
                    radius: 8
                });
                currentPositionMarker.setPopupContent('<b>⏸️ Position Pause</b><br>' + currentPositionMarker.getPopupContent());
            }
            
            // Réduire l'opacité du cercle de précision
            if (accuracyCircle) {
                accuracyCircle.setStyle({
                    opacity: 0.15,
                    fillOpacity: 0.03
                });
            }
            
            showAlert('info', '⏸️ Tracage en pause. Appuyez Démarrer pour reprendre.');
            console.log('⏸️ Tracage en pause - ' + circuitPoints.length + ' points enregistrés');
        }
        
        // Reprendre le suivi depuis la pause
        function reprendreTracking() {
            if (!circuitTracking) {
                demarrerTracking();
                circuitFollowMode = true;
            }
        }
        
        function ajouterMarqueurCircuit() {
            if (circuitPoints.length > 0) {
                const lastPoint = circuitPoints[circuitPoints.length - 1];
                const marker = L.marker([lastPoint[0], lastPoint[1]], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red"><circle cx="12" cy="12" r="8"/></svg>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(circuitMap).bindPopup(`📍 Repère ${circuitMarkers.length + 1}`);
                circuitMarkers.push(marker);
            }
        }
        
        // ============= 💾 GESTION DES CIRCUITS ===============
        function chargerCircuits() {
            try {
                const stored = localStorage.getItem('circuitsHistory');
                circuitsHistory = stored ? JSON.parse(stored) : [];
                afficherListeCircuits();
            } catch (e) {
                console.warn('⚠️ Erreur lors du chargement des circuits:', e);
                circuitsHistory = [];
            }
        }
        
        function sauvegarderCircuit(nom) {
            if (circuitPoints.length < 2) {
                showAlert('error', '❌ Circuit trop court (minimum 2 points)');
                return;
            }
            
            const distance = turf.length({
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: circuitPoints.map(p => [p[1], p[0]])
                }
            });
            
            const circuit = {
                id: Date.now(),
                nom: nom || `Circuit ${new Date().toLocaleString('fr-FR')}`,
                points: circuitPoints,
                markers: circuitMarkers.map(m => m.getLatLng()),
                distance: distance,
                pointsCount: circuitPoints.length,
                duree: document.getElementById('circuit-time').textContent,
                dateCreation: new Date().toLocaleString('fr-FR'),
                buffer: document.getElementById('circuit-buffer')?.checked || false
            };
            
            circuitsHistory.push(circuit);
            localStorage.setItem('circuitsHistory', JSON.stringify(circuitsHistory));
            afficherListeCircuits();
            showAlert('success', `✅ Circuit sauvegardé: ${circuit.nom}`);
        }
        
        function afficherListeCircuits() {
            const lista = document.getElementById('circuits-list');
            const count = document.getElementById('circuits-count');
            
            if (circuitsHistory.length === 0) {
                lista.innerHTML = '<div style="text-align: center; color: #999; padding: 20px 10px; font-size: 12px;">Aucun circuit sauvegardé</div>';
                count.textContent = '0';
                return;
            }
            
            count.textContent = circuitsHistory.length;
            lista.innerHTML = circuitsHistory.map(circuit => `
                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid ${selectedCircuitId === circuit.id ? '#667eea' : '#e5e7eb'}; cursor: pointer; transition: all 0.2s;" onclick="chargerCircuitSurCarte(${circuit.id})">
                    <div style="font-size: 12px; font-weight: 700; color: #2d5016; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${circuit.nom}</div>
                    <div style="font-size: 10px; color: #999; margin-top: 4px;">
                        📏 ${circuit.distance.toFixed(2)} km
                        <br>📍 ${circuit.pointsCount} points
                        <br>⏱️ ${circuit.duree}
                    </div>
                    <div style="display: flex; gap: 4px; margin-top: 8px;">
                        <button onclick="event.stopPropagation(); exporterGPX(${circuit.id})" style="flex: 1; padding: 4px 6px; font-size: 10px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">📍 GPX</button>
                        <button onclick="event.stopPropagation(); modifierCircuit(${circuit.id})" style="flex: 1; padding: 4px 6px; font-size: 10px; background: #ff9800; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">✏️ Éditer</button>
                        <button onclick="event.stopPropagation(); supprimerCircuit(${circuit.id})" style="flex: 1; padding: 4px 6px; font-size: 10px; background: #c92a2a; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">🗑️</button>
                    </div>
                </div>
            `).join('');
        }
        
        function chargerCircuitSurCarte(circuitId) {
            const circuit = circuitsHistory.find(c => c.id === circuitId);
            if (!circuit) return;
            
            selectedCircuitId = circuitId;
            
            // Nettoyer la carte
            if (circuitPolyline) circuitMap.removeLayer(circuitPolyline);
            circuitMarkers.forEach(m => circuitMap.removeLayer(m));
            if (startMarker) circuitMap.removeLayer(startMarker);
            if (currentPositionMarker) circuitMap.removeLayer(currentPositionMarker);
            if (accuracyCircle) circuitMap.removeLayer(accuracyCircle);
            
            circuitMarkers = [];
            circuitPoints = circuit.points;
            
            // Afficher la polyline
            circuitPolyline = L.polyline(circuit.points, {
                color: '#667eea',
                weight: 3,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(circuitMap);
            
            // Afficher les repères
            circuit.markers.forEach((point, idx) => {
                const marker = L.marker([point.lat, point.lng], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red"><circle cx="12" cy="12" r="8"/></svg>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(circuitMap).bindPopup(`📍 Repère ${idx + 1}`);
                circuitMarkers.push(marker);
            });
            
            // Zoom sur le circuit
            const bounds = L.latLngBounds(circuit.points);
            circuitMap.fitBounds(bounds, { padding: [50, 50] });
            
            // Marqueur de départ
            if (circuit.points.length > 0) {
                const start = circuit.points[0];
                startMarker = L.marker([start[0], start[1]], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236db038"><rect width="24" height="24" fill="none"/><circle cx="12" cy="12" r="6" fill="%236db038"/><circle cx="12" cy="12" r="4" fill="white"/></svg>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(circuitMap);
                startMarker.bindPopup('🟢 Départ du circuit');
            }
            
            // Marqueur de fin
            if (circuit.points.length > 1) {
                const end = circuit.points[circuit.points.length - 1];
                const endMarker = L.marker([end[0], end[1]], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c92a2a"><rect width="24" height="24" fill="none"/><circle cx="12" cy="12" r="6" fill="%23c92a2a"/><circle cx="12" cy="12" r="4" fill="white"/></svg>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(circuitMap);
                endMarker.bindPopup('🔴 Fin du circuit');
            }
            
            afficherListeCircuits();
        }
        
        function supprimerCircuit(circuitId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce circuit?')) {
                circuitsHistory = circuitsHistory.filter(c => c.id !== circuitId);
                localStorage.setItem('circuitsHistory', JSON.stringify(circuitsHistory));
                if (selectedCircuitId === circuitId) {
                    selectedCircuitId = null;
                    if (circuitPolyline) circuitMap.removeLayer(circuitPolyline);
                    circuitMarkers.forEach(m => circuitMap.removeLayer(m));
                }
                afficherListeCircuits();
                showAlert('success', '✓ Circuit supprimé');
            }
        }
        
        function modifierCircuit(circuitId) {
            const circuit = circuitsHistory.find(c => c.id === circuitId);
            if (!circuit) return;
            
            const newNom = prompt('Nouveau nom du circuit:', circuit.nom);
            if (newNom && newNom.trim()) {
                circuit.nom = newNom.trim();
                localStorage.setItem('circuitsHistory', JSON.stringify(circuitsHistory));
                afficherListeCircuits();
                showAlert('success', '✓ Circuit renommé');
            }
        }
        
        function exporterGPX(circuitId) {
            const circuit = circuitsHistory.find(c => c.id === circuitId);
            if (!circuit) return;
            
            // Créer un GPX de base
            let gpxContent = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>${circuit.nom}</name>
    <desc>Circuit de collecte - Distance: ${circuit.distance.toFixed(2)} km</desc>
    <time>${new Date().toISOString()}</time>
  </metadata>
  <trk>
    <name>${circuit.nom}</name>
    <trkseg>`;
            
            circuit.points.forEach(point => {
                gpxContent += `
      <trkpt lat="${point[0]}" lon="${point[1]}">
        <time>${new Date().toISOString()}</time>
      </trkpt>`;
            });
            
            gpxContent += `
    </trkseg>
  </trk>
</gpx>`;
            
            const blob = new Blob([gpxContent], { type: 'application/gpx+xml' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${circuit.nom}.gpx`;
            a.click();
            
            showAlert('success', `✓ GPX exporté: ${circuit.nom}.gpx`);
        }
        
        function terminerTracking() {
            pauseTracking();
            
            document.getElementById('btn-demarrer-circuit').style.display = 'flex';
            document.getElementById('btn-pause-circuit').style.display = 'none';
            document.getElementById('btn-ajouter-marker').style.display = 'none';
            document.getElementById('btn-ajouter-marker-desktop').style.display = 'none'; // Masquer repère à la fin
            document.getElementById('btn-terminer-circuit').style.display = 'none';
            document.getElementById('circuit-status-header').textContent = '✓ TERMINÉ';
            
            // 🎯 AJOUTER MARQUEUR DE FIN
            if (circuitPoints.length > 1) {
                const lastPoint = circuitPoints[circuitPoints.length - 1];
                const endMarker = L.marker([lastPoint[0], lastPoint[1]], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23c92a2a"><rect width="24" height="24" fill="none"/><circle cx="12" cy="12" r="6" fill="%23c92a2a"/><circle cx="12" cy="12" r="4" fill="white"/></svg>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(circuitMap);
                endMarker.bindPopup('🔴 Fin du circuit');
            }
            
            // Supprimer le marqueur et le cercle de position actuelle
            if (currentPositionMarker) {
                circuitMap.removeLayer(currentPositionMarker);
            }
            if (accuracyCircle) {
                circuitMap.removeLayer(accuracyCircle);
            }
            
            // Afficher un résumé du circuit
            const distance = (turf.length(circuitPolyline?.toGeoJSON() || { type: 'Feature', geometry: { type: 'LineString', coordinates: [] } }) || 0).toFixed(3);
            const duration = document.getElementById('circuit-time').textContent;
            const points = circuitPoints.length;
            
            // 💾 SAUVEGARDER LE CIRCUIT
            sauvegarderCircuit(document.getElementById('circuit-name').value);
            
            showAlert('success', `✅ Circuit enregistré!\n📏 Distance: ${distance} km\n⏱️ Durée: ${duration}\n📍 Points GPS: ${points}`);
        }
        
        function updateCircuitStats() {
            if (circuitPoints.length > 0) {
                const feature = {
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: circuitPoints.map(p => [p[1], p[0]])
                    }
                };
                const distance = turf.length(feature, { units: 'kilometers' });
                document.getElementById('circuit-distance').textContent = distance.toFixed(2);
                // Synchroniser avec desktop
                const desktopDist = document.getElementById('circuit-distance-desktop');
                if (desktopDist) desktopDist.textContent = distance.toFixed(2);
            }
            
            const now = new Date();
            const elapsed = trackingStartTime ? (now - trackingStartTime) / 1000 : 0;
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = Math.floor(elapsed % 60);
            const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            document.getElementById('circuit-time').textContent = timeStr;
            const desktopTime = document.getElementById('circuit-time-desktop');
            if (desktopTime) desktopTime.textContent = timeStr;
            
            document.getElementById('circuit-points').textContent = circuitPoints.length;
            const desktopPoints = document.getElementById('circuit-points-desktop');
            if (desktopPoints) desktopPoints.textContent = circuitPoints.length;
        }
        
        function exporterCircuitGeoJSON() {
            if (circuitPoints.length < 2) {
                alert('❌ Au moins 2 points GPS requis pour exporter!');
                return;
            }
            
            const circuitName = document.getElementById('circuit-name').value || 'Circuit';
            const hasBuffer = document.getElementById('circuit-buffer').checked;
            
            const geoJSON = {
                type: 'FeatureCollection',
                features: [{
                    type: 'Feature',
                    properties: {
                        name: circuitName,
                        timestamp: new Date().toISOString(),
                        distance_km: (turf.length({ type: 'Feature', geometry: { type: 'LineString', coordinates: circuitPoints.map(p => [p[1], p[0]]) } }, { units: 'kilometers' })).toFixed(2),
                        points_count: circuitPoints.length
                    },
                    geometry: {
                        type: 'LineString',
                        coordinates: circuitPoints.map(p => [p[1], p[0]])
                    }
                }]
            };
            
            if (hasBuffer) {
                const line = turf.lineString(circuitPoints.map(p => [p[1], p[0]]));
                const buffered = turf.buffer(line, 0.2, { units: 'kilometers' });
                geoJSON.features.push({
                    type: 'Feature',
                    properties: { name: `${circuitName} - Buffer 200m` },
                    geometry: buffered.geometry
                });
            }
            
            const blob = new Blob([JSON.stringify(geoJSON, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${circuitName}.geojson`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✅ GeoJSON exporté: ' + a.download);
        }
        
        function exporterCircuitShapefile() {
            if (circuitPoints.length < 2) {
                alert('❌ Au moins 2 points GPS requis pour exporter!');
                return;
            }
            
            const circuitName = document.getElementById('circuit-name').value || 'Circuit';
            const hasBuffer = document.getElementById('circuit-buffer').checked;
            
            const features = [{
                type: 'Feature',
                properties: {
                    ID: 1,
                    NAME: circuitName,
                    DIST_KM: (turf.length({ type: 'Feature', geometry: { type: 'LineString', coordinates: circuitPoints.map(p => [p[1], p[0]]) } }, { units: 'kilometers' })).toFixed(2),
                    NB_POINTS: circuitPoints.length,
                    DATE: new Date().toISOString()
                },
                geometry: {
                    type: 'LineString',
                    coordinates: circuitPoints.map(p => [p[1], p[0]])
                }
            }];
            
            if (hasBuffer) {
                const line = turf.lineString(circuitPoints.map(p => [p[1], p[0]]));
                const buffered = turf.buffer(line, 0.2, { units: 'kilometers' });
                features.push({
                    type: 'Feature',
                    properties: {
                        ID: 2,
                        NAME: `${circuitName}_Buffer`,
                        DIST_KM: '--',
                        NB_POINTS: '--',
                        DATE: new Date().toISOString()
                    },
                    geometry: buffered.geometry
                });
            }
            
            try {
                const fc = { type: 'FeatureCollection', features };
                const shapeWriter = shpwrite || window.shpwrite;
                if (shapeWriter && shapeWriter.download) {
                    shapeWriter.download(fc, { fileName: circuitName });
                    alert('✅ Shapefile exporté: ' + circuitName);
                } else {
                    alert('⚠️ Export Shapefile non disponible. Téléchargez le GeoJSON à la place.');
                }
            } catch (e) {
                console.log('Shapefile export error:', e);
                alert('⚠️ Export GeoJSON recommandé. Utilisez "📄 GeoJSON" pour télécharger.');
            }
        }
        
        // Timer pour mettre à jour les stats
        setInterval(() => {
            if (circuitTracking) updateCircuitStats();
        }, 1000);
        
        // 🧭 NAVIGATION ENTRE LES 3 MENUS
        function mostrarMenu(menu) {
            // Masquer tous les menus
            const accueilSection = document.getElementById('accueil-section');
            const actualiteSection = document.getElementById('actualite-section');
            const collecteSection = document.getElementById('collecte-section');
            
            const btnAccueil = document.getElementById('btn-accueil');
            const btnActualite = document.getElementById('btn-actualite');
            const btnCollecte = document.getElementById('btn-collecte');
            
            // Masquer toutes les sections
            if (accueilSection) accueilSection.style.display = 'none';
            if (actualiteSection) actualiteSection.style.display = 'none';
            if (collecteSection) collecteSection.style.display = 'none';
            
            // Retirer la classe active de tous les boutons
            if (btnAccueil) btnAccueil.classList.remove('active');
            if (btnActualite) btnActualite.classList.remove('active');
            if (btnCollecte) btnCollecte.classList.remove('active');
            
            // Afficher le menu sélectionné
            switch(menu) {
                case 'accueil':
                    if (accueilSection) {
                        accueilSection.style.display = 'flex';
                        accueilSection.style.flexDirection = 'column';
                    }
                    if (btnAccueil) btnAccueil.classList.add('active');
                    break;
                case 'actualite':
                    if (actualiteSection) actualiteSection.style.display = 'block';
                    if (btnActualite) btnActualite.classList.add('active');
                    break;
                case 'collecte':
                    if (collecteSection) collecteSection.style.display = 'block';
                    if (btnCollecte) btnCollecte.classList.add('active');
                    // 🚀 INITIALISER LA CARTE IMMÉDIATEMENT après display:block
                    setTimeout(() => {
                        if (document.getElementById('collecte-map') && !collecteMapInitialized) {
                            initializeCollecteMap();
                            console.log('✅ Carte collecte initialisée après affichage du menu');
                        }
                    }, 50);
                    break;
            }
            
            // Scroller vers le top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function allerAuFormulaire() {
            mostrarMenu('collecte');
        }
        
        function retournerAuFormulaire() {
            mostrarMenu('accueil');
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // NE PAS initialiser les cartes immédiatement
            // Elles seront initialisées de manière "lazy" quand nécessaire
            
            afficherInfoCache();
            document.getElementById('date-update').textContent = new Date().toLocaleDateString('fr-FR');
            mettreAJourSites();
            
            // Initialiser les selects géographiques
            initialiserSelectsGeographiques();
            
            // Vérifier le statut PWA
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                console.log('✅ Exécution en mode PWA');
                showAlert('success', '📱 Application PWA chargée!');
            }
            
            // 📱 FIXER LES ÉVÉNEMENTS TACTILES POUR BOUTONS D'ACTION (compatible mobile)
            setTimeout(function() {
                // Boutons landing page
                const landingButtons = document.querySelectorAll('#landing-section button, #landing-section [onclick*="allerAuFormulaire"], #landing-section [onclick*="scrollToFeatures"]');
                landingButtons.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('touchend', function(e) {
                            e.preventDefault();
                            this.click();
                        }, { passive: false });
                        btn.style.pointerEvents = 'auto';
                        btn.style.touchAction = 'auto';
                    }
                });
                
                // Boutons formulaire - GESTION COMPLÈTE
                setTimeout(() => {
                    const btnResume = document.getElementById('btn-voir-resume');
                    const btnSauvegarder = document.getElementById('btn-sauvegarder');
                    
                    if (btnResume) {
                        // Supprimer onclick et utiliser uniquement des événements
                        btnResume.removeAttribute('onclick');
                        
                        // Click (fonctionne sur bureau ET mobile)
                        btnResume.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('📋 CLICK afficherResume');
                            try {
                                afficherResume();
                            } catch (err) {
                                console.error('Erreur afficherResume:', err);
                                alert('Erreur: ' + err.message);
                            }
                        }, true);
                        
                        btnResume.style.pointerEvents = 'auto';
                        btnResume.style.cursor = 'pointer';
                    }
                    
                    if (btnSauvegarder) {
                        // Supprimer onclick et utiliser uniquement des événements
                        btnSauvegarder.removeAttribute('onclick');
                        
                        // Click (fonctionne sur bureau ET mobile)
                        btnSauvegarder.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('💾 CLICK validerEtSauvegarder');
                            try {
                                validerEtSauvegarder();
                            } catch (err) {
                                console.error('Erreur validerEtSauvegarder:', err);
                                alert('Erreur: ' + err.message);
                            }
                        }, true);
                        
                        btnSauvegarder.style.pointerEvents = 'auto';
                        btnSauvegarder.style.cursor = 'pointer';
                    }
                }, 100);
            }, 0);
        });
    </script>
    
    <!-- MODAL GALERIE POUR IMAGES EN PLEIN ÉCRAN -->
    <div id="galerie-modal" class="galerie-modal">
        <div class="galerie-modal-content">
            <button class="galerie-modal-close" onclick="closeGalerieModal()">&times;</button>
            <button class="galerie-nav-button galerie-nav-prev" onclick="prevGalerieImage()">❮</button>
            <button class="galerie-nav-button galerie-nav-next" onclick="nextGalerieImage()">❯</button>
            <img class="galerie-modal-image" id="galerie-modal-image" src="" alt="">
            <div class="galerie-modal-counter" id="galerie-modal-counter"></div>
            <div style="padding: 0 15px 10px 15px; display: flex; gap: 10px; flex-direction: column;">
                <button onclick="telechargerGaleriePhoto()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;">⬇️ Enregistrer l'Image</button>
                <button id="galerie-delete-btn" onclick="supprimerPhotoGalerie()" style="width: 100%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;">🗑️ Supprimer l'Image</button>
            </div>
            <div class="galerie-modal-info" id="galerie-modal-info"></div>
        </div>
    </div>
    
    <!-- FONCTIONS JAVASCRIPT POUR LA GALERIE PHOTOS -->
    <script>
        // Données complètes des 8 photos collectées
        let galleriePhotos = [
            { 
                id: 12,
                commune: "Oussouye", 
                partenaire: "SENELEC", 
                site: "Bureau commercial Oussouye",
                dept: "Oussouye",
                region: "Ziguinchor",
                activites: "Desherbage, Collecte",
                superficie: "0.00 ha",
                personnel: "15",
                dispositifs: "Benne tasseuse",
                frequence: "F1",
                accessibilite: "Facile",
                lat: "12.4906°N",
                lng: "16.5466°O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_12_1.jpg" 
            },
            { 
                id: 11,
                commune: "Diembéring", 
                partenaire: "SENELEC", 
                site: "District Cap-Skirring",
                dept: "Oussouye",
                region: "Ziguinchor",
                activites: "Desherbage, Collecte",
                superficie: "0.00 ha",
                personnel: "15",
                dispositifs: "Benne tasseuse",
                frequence: "F2",
                accessibilite: "Facile",
                lat: "12.3763°N",
                lng: "16.7300°O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_11_2.jpg" 
            },
            { 
                id: 10,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Bureau commercial de Boutoute",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Collecte",
                superficie: "0.00 ha",
                personnel: "0",
                dispositifs: "Benne tasseuse",
                frequence: "F2",
                accessibilite: "Facile",
                lat: "12.5694°N",
                lng: "16.2776°O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_10_3.jpg" 
            },
            { 
                id: 9,
                commune: "Niaguis", 
                partenaire: "SENELEC", 
                site: "Centrale électrique de Boutoute",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Levé des dechets vert, Desherbage, Mecanisation, Collecte",
                superficie: "0.00 ha",
                personnel: "150",
                dispositifs: "Pelle Chargeur, Camion BTP, Benne tasseuse",
                frequence: "F2",
                accessibilite: "Facile",
                lat: "12.5871°N",
                lng: "16.2667°O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_9_4.jpg" 
            },
            { 
                id: 8,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Chambre de passage",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Collecte",
                superficie: "0.00 ha",
                personnel: "0",
                dispositifs: "Benne tasseuse",
                frequence: "F3",
                accessibilite: "Facile",
                lat: "12.5843°N",
                lng: "16.2716°O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_8_5.jpg" 
            },
            { 
                id: 7,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Agence principale",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Collecte",
                superficie: "0.00 ha",
                personnel: "0",
                dispositifs: "Benne tasseuse",
                frequence: "F3",
                accessibilite: "Facile",
                lat: "12.5841°N",
                lng: "16.2716°O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_7_6.jpg" 
            },
            { 
                id: 6,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Sous station Kankourang",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Desherbage, Collecte",
                superficie: "0.00 ha",
                personnel: "3",
                dispositifs: "Benne tasseuse",
                frequence: "F3",
                accessibilite: "Facile",
                lat: "12.5828°N",
                lng: "16.2672°O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_6_7.jpg" 
            },
            { 
                id: 5,
                commune: "Ziguinchor", 
                partenaire: "SENELEC", 
                site: "Parc à carburant",
                dept: "Ziguinchor",
                region: "Ziguinchor",
                activites: "Levé des dechets vert, Desherbage",
                superficie: "0.01 ha",
                personnel: "30",
                dispositifs: "Pelle Chargeur, Camion BTP",
                frequence: "F1",
                accessibilite: "Facile",
                lat: "12.5868°N",
                lng: "16.2649°O",
                src: "./exports/export-2026-02-17T18-16-04/images/photo_5_8.jpg" 
            }
        ];
        
        let currentGalerieIndex = 0;
        
        // Fonction helper pour trouver et ouvrir une photo par son ID
        function openGalerieModalByPhotoId(photoId) {
            const index = galleriePhotos.findIndex(photo => photo.id === photoId);
            if (index !== -1) {
                openGalerieModal(index);
            }
        }
        
        function openGalerieModal(index) {
            currentGalerieIndex = index;
            const modal = document.getElementById('galerie-modal');
            const photo = galleriePhotos[currentGalerieIndex];
            
            document.getElementById('galerie-modal-image').src = photo.src;
            document.getElementById('galerie-modal-counter').textContent = `${currentGalerieIndex + 1} / ${galleriePhotos.length}`;
            document.getElementById('galerie-modal-info').innerHTML = `
                <div style="padding: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <h3 style="margin: 0; color: #2d5016; font-size: 16px;">📍 ${photo.commune}</h3>
                        <span style="background: #f0f8e6; color: #2d5016; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">🏷️ ID: ${photo.id}</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px; color: #333; line-height: 1.6;">
                        <div>
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">📌 Site</strong>
                            <span>${photo.site}</span>
                        </div>
                        <div>
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">🏢 Partenaire</strong>
                            <span>${photo.partenaire}</span>
                        </div>
                        <div>
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">🗺️ Région/Département</strong>
                            <span>${photo.region} / ${photo.dept}</span>
                        </div>
                        <div>
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">📍 Localisation</strong>
                            <span>${photo.lat}, ${photo.lng}</span>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <strong style="color: #5ba837; display: block; margin-bottom: 4px;">🎯 Activités</strong>
                            <span>${photo.activites}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">📏 Superficie</strong>
                            <span>${photo.superficie}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">👥 Personnel</strong>
                            <span>${photo.personnel} personnes</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">🚗 Dispositifs</strong>
                            <span>${photo.dispositifs}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">📅 Fréquence</strong>
                            <span>${photo.frequence}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea; display: block; margin-bottom: 4px;">🛣️ Accessibilité</strong>
                            <span>${photo.accessibilite}</span>
                        </div>
                    </div>
                </div>
            `;
            modal.style.display = 'block';
        }
        
        function closeGalerieModal() {
            document.getElementById('galerie-modal').style.display = 'none';
        }
        
        // 🗑️ Fonction pour supprimer une photo de la galerie
        function supprimerPhotoGalerie() {
            const photo = galleriePhotos[currentGalerieIndex];
            if (!photo) {
                showAlert('error', '❌ Aucune photo à supprimer');
                return;
            }
            
            // Confirmation avant suppression
            if (!confirm(`⚠️ Êtes-vous sûr de vouloir supprimer cette photo de ${photo.commune}?\n\nCette action est irréversible.`)) {
                return;
            }
            
            try {
                // 1. Supprimer du tableau galleriePhotos
                const indexInArray = galleriePhotos.findIndex(p => p.id === photo.id);
                if (indexInArray !== -1) {
                    galleriePhotos.splice(indexInArray, 1);
                }
                
                // 2. Retirer l'élément HTML du DOM
                const galerieScroll = document.querySelector('.galerie-scroll');
                if (galerieScroll) {
                    const items = galerieScroll.querySelectorAll('[data-photo-id]');
                    items.forEach(item => {
                        if (item.dataset.photoId == photo.id) {
                            item.remove();
                        }
                    });
                }
                
                // 3. Retirer aussi par classe galerie-item si pas encore supprimé
                const galerieItems = document.querySelectorAll('.galerie-item');
                for (let i = 0; i < galerieItems.length; i++) {
                    const text = galerieItems[i].textContent;
                    if (text.includes(photo.commune)) {
                        const itemSrc = galerieItems[i].querySelector('img')?.src;
                        if (itemSrc === photo.src || itemSrc?.includes(photo.site)) {
                            galerieItems[i].remove();
                            break;
                        }
                    }
                }
                
                // 4. Mettre à jour le compteur
                const statsNumber = document.querySelector('.galerie-stat-item .galerie-stat-number');
                if (statsNumber) {
                    statsNumber.textContent = galleriePhotos.length;
                }
                
                // 5. Si des photos restent, afficher la suivante
                if (galleriePhotos.length > 0) {
                    currentGalerieIndex = Math.min(currentGalerieIndex, galleriePhotos.length - 1);
                    openGalerieModal(currentGalerieIndex);
                    showAlert('success', `✅ Photo de ${photo.commune} supprimée! (${galleriePhotos.length} restante)`);
                } else {
                    // Sinon, fermer le modal
                    closeGalerieModal();
                    showAlert('info', `🗑️ Dernière photo supprimée! Galerie vide.`);
                }
            } catch (error) {
                console.error('Erreur suppression:', error);
                showAlert('error', '❌ Erreur lors de la suppression');
            }
        }
        
        // 📥 Fonction pour télécharger une image de la galerie
        function telechargerGaleriePhoto() {
            const photo = galleriePhotos[currentGalerieIndex];
            if (!photo) {
                alert('❌ Aucune photo à télécharger');
                return;
            }
            
            // Créer le nom du fichier avec commune et site
            let comuneName = photo.commune.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 20);
            let siteName = photo.site.replace(/[^a-zA-Z0-9-]/g, '_').substring(0, 30);
            
            // Ajouter la date
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            
            const filename = `photo_${comuneName}_${siteName}_${dateStr}_${timeStr}.jpg`;
            
            // Télécharger l'image
            const link = document.createElement('a');
            link.href = photo.src;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`✅ Image téléchargée: ${filename}`);
        }
        
        function nextGalerieImage() {
            currentGalerieIndex = (currentGalerieIndex + 1) % galleriePhotos.length;
            openGalerieModal(currentGalerieIndex);
        }
        
        function prevGalerieImage() {
            currentGalerieIndex = (currentGalerieIndex - 1 + galleriePhotos.length) % galleriePhotos.length;
            openGalerieModal(currentGalerieIndex);
        }
        
        // Navigation au clavier
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('galerie-modal');
            if (modal && modal.style.display === 'block') {
                if (event.key === 'ArrowRight') nextGalerieImage();
                if (event.key === 'ArrowLeft') prevGalerieImage();
                if (event.key === 'Escape') closeGalerieModal();
            }
        });
        
        // Clic en dehors ferme le modal
        window.onclick = function(event) {
            const modal = document.getElementById('galerie-modal');
            if (event.target === modal) {
                closeGalerieModal();
            }
        }
    </script>
    
    <!-- FONCTIONS JAVASCRIPT POUR LA CARTE DES COLLECTES -->
    <script>
        // Données géographiques des 8 collectes
        let collectesGPS = [
            { id: 12, commune: "Oussouye", partenaire: "SENELEC", site: "Bureau commercial Oussouye", lat: 12.49055100, lng: -16.54658500, photo: "./exports/export-2026-02-17T18-16-04/images/photo_12_1.jpg" },
            { id: 11, commune: "Diembéring", partenaire: "SENELEC", site: "District Cap-Skirring", lat: 12.37629500, lng: -16.72996200, photo: "./exports/export-2026-02-17T18-16-04/images/photo_11_2.jpg" },
            { id: 10, commune: "Ziguinchor", partenaire: "SENELEC", site: "Bureau commercial de Boutoute", lat: 12.56943000, lng: -16.27761800, photo: "./exports/export-2026-02-17T18-16-04/images/photo_10_3.jpg" },
            { id: 9, commune: "Niaguis", partenaire: "SENELEC", site: "Centrale électrique de Boutoute", lat: 12.58711600, lng: -16.26668500, photo: "./exports/export-2026-02-17T18-16-04/images/photo_9_4.jpg" },
            { id: 8, commune: "Ziguinchor", partenaire: "SENELEC", site: "Chambre de passage", lat: 12.58425300, lng: -16.27164800, photo: "./exports/export-2026-02-17T18-16-04/images/photo_8_5.jpg" },
            { id: 7, commune: "Ziguinchor", partenaire: "SENELEC", site: "Agence principale", lat: 12.58413100, lng: -16.27159400, photo: "./exports/export-2026-02-17T18-16-04/images/photo_7_6.jpg" },
            { id: 6, commune: "Ziguinchor", partenaire: "SENELEC", site: "Sous station Kankourang", lat: 12.58277100, lng: -16.26715500, photo: "./exports/export-2026-02-17T18-16-04/images/photo_6_7.jpg" },
            { id: 5, commune: "Ziguinchor", partenaire: "SENELEC", site: "Parc à carburant", lat: 12.58679000, lng: -16.26486000, photo: "./exports/export-2026-02-17T18-16-04/images/photo_5_8.jpg" }
        ];
        
        // Régions du Sénégal avec leurs coordonnées centrales et noms
        const senegalRegions = [
            { name: "Dakar", lat: 14.6928, lng: -17.0467 },
            { name: "Saint-Louis", lat: 16.0255, lng: -16.4861 },
            { name: "Tambacounda", lat: 13.7768, lng: -13.7707 },
            { name: "Kaolack", lat: 13.1609, lng: -15.0277 },
            { name: "Ziguinchor", lat: 13.1549, lng: -15.5828 },
            { name: "Louga", lat: 15.6167, lng: -15.6167 },
            { name: "Kolda", lat: 13.1662, lng: -14.9428 },
            { name: "Diourbel", lat: 14.6667, lng: -16.2500 },
            { name: "Thiès", lat: 14.7833, lng: -16.9333 },
            { name: "Guédiawaye", lat: 14.6833, lng: -17.45 },
            { name: "Méguetane", lat: 14.5333, lng: -15.1333 }
        ];
        
        let collecteMapInitialized = false;
        
        // Initialiser la carte une fois que le DOM est prêt
        function initializeCollecteMap() {
            if (collecteMapInitialized) return; // Éviter re-initialisation
            
            const mapContainer = document.getElementById('collecte-map');
            if (!mapContainer || !mapContainer.offsetHeight) return; // Vérifier que le conteneur est visible
            
            collecteMapInitialized = true;
            
            console.log('🗺️ DÉBUT INITIALISATION CARTE COLLECTE');
            const startTime = performance.now();
            
            // Créer la carte centrée sur Ziguinchor
            const collecteMap = L.map('collecte-map').setView([12.9, -16.0], 9);
            
            // Ajouter la couche de base OpenStreetMap avec optimisation
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
                minZoom: 6,
                errorTileUrl: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="256" height="256"%3E%3Crect fill="%23f0f0f0" width="256" height="256"/%3E%3C/svg%3E'
            }).addTo(collecteMap);
            
            // ⚡ OPTIMISATION : Ajouter les régions avec délai progressif (au lieu de tout à la fois)
            console.log('📍 Ajout des régions Sénégal...');
            senegalRegions.forEach((region, idx) => {
                setTimeout(() => {
                    L.circleMarker([region.lat, region.lng], {
                        radius: 0,
                        fillOpacity: 0,
                        opacity: 0
                    })
                    .bindPopup(`<strong style="color: #667eea;">${region.name}</strong><br><small>Région du Sénégal</small>`)
                    .addTo(collecteMap);
                    
                    // Ajouter l'étiquette du nom de région
                    L.marker([region.lat, region.lng], {
                        icon: L.divIcon({
                            className: 'senegal-region-label',
                            html: `<div style="color: #999; font-size: 10px; font-weight: bold; text-align: center; width: 60px; background: rgba(255,255,255,0.7); padding: 2px; border-radius: 3px; white-space: nowrap;">${region.name}</div>`,
                            iconSize: [60, 20],
                            iconAnchor: [30, 10]
                        })
                    }).addTo(collecteMap);
                }, idx * 10); // Délai de 10ms entre chaque région
            });
            
            // ⚡ OPTIMISATION : Charger les marqueurs des collectes GRADUELLEMENT
            console.log(`🎯 Ajout de ${collectesGPS.length} marqueurs de collecte...`);
            
            // Limiter à 50 marqueurs initialement pour éviter surcharge
            const maxMarkersInitial = 50;
            const markersToLoad = collectesGPS.slice(0, maxMarkersInitial);
            
            // Ajouter les marqueurs avec délai échelonné
            markersToLoad.forEach((collecte, idx) => {
                setTimeout(() => {
                    // Créer une icône personnalisée
                    const customIcon = L.divIcon({
                        className: 'custom-collecte-marker',
                        html: `<div style="
                            background: linear-gradient(135deg, #6db038 0%, #5ba837 100%);
                            width: 30px;
                            height: 30px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 18px;
                            border: 3px solid white;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        ">📍</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });
                    
                    // Créer le contenu du popup avec IMAGE
                    const popupContent = `
                        <div style="font-size: 12px; width: 250px;">
                            <strong style="color: #6db038; font-size: 13px;">📌 ${collecte.commune}</strong><br>
                            <small style="color: #666;">
                                <strong>Site:</strong> ${collecte.site}<br>
                                <strong>Partenaire:</strong> ${collecte.partenaire}<br>
                                <strong>Coordonnées:</strong> ${collecte.lat.toFixed(4)}, ${collecte.lng.toFixed(4)}
                            </small>
                            ${collecte.photo ? `<div style="margin-top: 10px; text-align: center;">
                                <img src="${collecte.photo}" alt="${collecte.commune}" style="max-width: 100%; height: auto; border-radius: 6px; max-height: 150px;">
                            </div>` : ''}
                        </div>
                    `;
                    
                    // Ajouter le marqueur à la carte (sans tooltip pour plus de rapidité)
                    L.marker([collecte.lat, collecte.lng], { icon: customIcon })
                        .bindPopup(popupContent)
                        .addTo(collecteMap);
                }, idx * 5); // Délai de 5ms entre chaque marqueur
            });
            
            // Ajouter une légende
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'info');
                div.style.background = 'white';
                div.style.padding = '10px';
                div.style.borderRadius = '5px';
                div.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';
                div.style.fontSize = '12px';
                div.innerHTML = `
                    <strong style="color: #333; display: block; margin-bottom: 8px;">📊 Statistiques</strong>
                    <div style="color: #666;">
                        <div><strong>📍 Marqueurs:</strong> ${markersToLoad.length}/${collectesGPS.length}</div>
                        <div><strong>🗺️ Région:</strong> Ziguinchor</div>
                        <div><strong>🏢 Partenaire:</strong> SONAGED</div>
                        <div style="margin-top: 8px; color: #999; font-size: 11px;">
                            💡 Cliquez sur les marqueurs<br>pour voir les détails
                        </div>
                    </div>
                `;
                return div;
            };
            legend.addTo(collecteMap);
            
            // 📊 Afficher time de chargement en console
            const endTime = performance.now();
            console.log(`✅ CARTE INITIALISÉE EN ${(endTime - startTime).toFixed(0)}ms`);
            console.log(`✅ ${markersToLoad.length}/${collectesGPS.length} marqueurs en cours de chargement...`);
        }
        
    </script>
    
    

    <!-- Configuration d'environnement (doit être avant api-client.js) -->
    <script src="config.js"></script>
    <!-- Client API pour communication avec PostgreSQL backend -->
    <script src="api-client.js"></script>

    <!-- 🔧 SERVICE WORKER REGISTRATION - Mode Offline -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('✅ Service Worker enregistré:', registration);
                        
                        // Vérifier les mises à jour
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('🔄 Nouvelle version disponible');
                                    showAlert('info', '🔄 Mise à jour disponible. Rechargez la page.');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('❌ Service Worker registration échoué:', error);
                    });
            });
        } else {
            console.log('⚠️ Service Workers non supportés');
        }
    </script>

    <!-- 🔋 BATTERY API & WAKE LOCK - Optimisation Terrain -->
    <script>
        // Battery Status API
        if ('getBattery' in navigator) {
            navigator.getBattery().then((battery) => {
                const updateBatteryStatus = () => {
                    const level = Math.round(battery.level * 100);
                    console.log(`🔋 Batterie: ${level}%`);
                    
                    // Avertir si batterie faible
                    if (level < 20 && !sessionStorage.getItem('battery-warned')) {
                        showAlert('warning', `⚠️ Batterie faible (${level}%). Branchez si possible.`);
                        sessionStorage.setItem('battery-warned', '1');
                    }
                    
                    // Pause automatique si critique
                    if (level < 5 && window.circuitTracking) {
                        pauseTracking();
                        showAlert('error', '❌ Batterie critique. Tracking arrêté.');
                    }
                };
                
                updateBatteryStatus();
                battery.addEventListener('levelchange', updateBatteryStatus);
            });
        }

        // Screen Wake Lock API
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                if ('wake_lock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('✅ Wake Lock actif - l\'écran restera allumé');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('⏹️ Wake Lock libéré');
                    });
                }
            } catch (err) {
                console.log('⚠️ Wake Lock non disponible:', err.name, err.message);
            }
        }

        async function releaseWakeLock() {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
            }
        }

        // Hook sur démarrage du traceur circuit
        const origDemarrerTracking = window.demarrerTracking;
        window.demarrerTracking = function() {
            requestWakeLock();
            return origDemarrerTracking.apply(this, arguments);
        };

        // Hook sur pause du traceur
        const origPauseTracking = window.pauseTracking;
        window.pauseTracking = function() {
            releaseWakeLock();
            return origPauseTracking.apply(this, arguments);
        };

        // ============= 🗺️ INITIALISATION CARTE LEAFLET LANDING PAGE ===============
        let landingMap = null;
        let landingLayersControl = null;
        let geojsonLayers = {};
        let loadedLayersCount = 0;
        const totalLayers = 6;
        
        // 🗺️ STYLES DETAILLES POUR CHAQUE COUCHE
        const layerStyles = {
            'Region_3': { 
                color: 'rgba(35,35,35,1.0)', 
                weight: 1.0, 
                opacity: 1,
                fillOpacity: 1, 
                fillColor: 'rgba(164,113,88,1.0)' 
            },
            'Departement_4': { 
                color: 'rgba(35,35,35,1.0)', 
                weight: 1.0, 
                opacity: 1,
                fillOpacity: 1, 
                fillColor: 'rgba(221,51,206,1.0)' 
            },
            'Arrondissement_5': { 
                color: 'rgba(0,0,0,1.0)', 
                weight: 1.0, 
                opacity: 1,
                fillOpacity: 1, 
                fillColor: 'rgba(141,90,153,1.0)' 
            },
            'CollecteNational_6': { 
                color: 'rgba(196,60,57,1.0)', 
                weight: 1.0, 
                opacity: 1,
                lineCap: 'square', 
                lineJoin: 'bevel',
                fillOpacity: 0
            },
            'BalayageNational_7': { 
                color: 'rgba(152,125,183,1.0)', 
                weight: 1.0, 
                opacity: 1,
                lineCap: 'square', 
                lineJoin: 'bevel',
                fillOpacity: 0
            },
            'MobilierUrbain_8_Bac': { radius: 4.0, color: 'rgba(35,35,35,1.0)', weight: 1, fillColor: 'rgba(213,106,140,1.0)', fillOpacity: 1 },
            'MobilierUrbain_8_Polybenne': { radius: 4.0, color: 'rgba(35,35,35,1.0)', weight: 1, fillColor: 'rgba(140,52,233,1.0)', fillOpacity: 1 },
            'MobilierUrbain_8_PP': { radius: 4.0, color: 'rgba(35,35,35,1.0)', weight: 1, fillColor: 'rgba(72,203,81,1.0)', fillOpacity: 1 },
            'MobilierUrbain_8_PRN': { radius: 4.0, color: 'rgba(35,35,35,1.0)', weight: 1, fillColor: 'rgba(108,177,202,1.0)', fillOpacity: 1 }
        };
        
        // 🎯 BASEMAPS - Couches de fond disponibles
        const baseMaps = {
            'OpenStreetMap': L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 20, minZoom: 1
            }),
            'Google Hybrid': L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                attribution: '© Google',
                maxZoom: 20, minZoom: 1
            }),
            'Dark Matter': L.tileLayer('https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                attribution: '© CartoDB',
                maxZoom: 20, minZoom: 1
            })
        };
        
        // Noms affichables des couches overlay
        const layerDisplayNames = {
            'Region_3': '🟤 Régions',
            'Departement_4': '🟣 Départements',
            'Arrondissement_5': '🟪 Arrondissements',
            'CollecteNational_6': '🔴 Circuits Collecte',
            'BalayageNational_7': '🟣 Circuits Balayage',
            'MobilierUrbain_8': '🟢 Mobilier Urbain'
        };
        
        // 🗺️ INITIALISER LA CARTE GEOSPATIALE
        function initLandingMap() {
            if (landingMap) return;
            
            const mapContainer = document.getElementById('dimensionnement-map');
            if (!mapContainer) {
                console.error('❌ Conteneur dimensionnement-map non trouvé');
                return;
            }
            
            // 🎯 Créer la carte centrée sur le Sénégal (14.5°N, 14.5°O) à zoom 6
            landingMap = L.map('dimensionnement-map', {
                zoomControl: true,
                maxZoom: 20,
                minZoom: 1
            }).setView([14.5, -14.5], 6);
            
            // 🗺️ Ajouter les basemaps disponibles et sélectionner OpenStreetMap par défaut
            baseMaps['OpenStreetMap'].addTo(landingMap);
            
            // ⚙️ Ajouter le contrôle d'attribution
            landingMap.attributionControl.setPrefix('<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> • <a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> • <a href="https://qgis.org">QGIS</a>');
            
            console.log('✅ Carte Leaflet initialisée avec basemaps');
            loadGeoJSONLayers();
        }
        
        // 📥 CHARGER LES COUCHES GeoJSON DEPUIS data/
        function loadGeoJSONLayers() {
            const overlayMaps = {};
            const urls = [
                { name: 'Region_3', url: './data/Region_3.js' },
                { name: 'Departement_4', url: './data/Departement_4.js' },
                { name: 'Arrondissement_5', url: './data/Arrondissement_5.js' },
                { name: 'CollecteNational_6', url: './data/CollecteNational_6.js' },
                { name: 'BalayageNational_7', url: './data/BalayageNational_7.js' },
                { name: 'MobilierUrbain_8', url: './data/MobilierUrbain_8.js' }
            ];
            
            urls.forEach(({ name, url }) => {
                const script = document.createElement('script');
                script.src = url;
                script.async = true;
                
                script.onload = function() {
                    const geoJsonData = window['json_' + name];
                    
                    if (!geoJsonData) {
                        console.warn(`⚠️ GeoJSON ${name} non trouvé`);
                        loadedLayersCount++;
                        return;
                    }
                    
                    let layer;
                    
                    // 📍 MOBILIER URBAIN - Points avec styles colors par type
                    if (name === 'MobilierUrbain_8') {
                        layer = L.geoJSON(geoJsonData, {
                            pointToLayer: (feature, latlng) => {
                                const typeDeMotorMo = feature.properties['Type_de_Mo'] || '';
                                let style;
                                
                                // 🎨 Couleurs spécifiques par type de mobilier
                                switch(typeDeMotorMo) {
                                    case 'Bac de rue':
                                        style = layerStyles['MobilierUrbain_8_Bac'];
                                        break;
                                    case 'Caisse Polybenne':
                                        style = layerStyles['MobilierUrbain_8_Polybenne'];
                                        break;
                                    case 'PP':
                                        style = layerStyles['MobilierUrbain_8_PP'];
                                        break;
                                    case 'PRN':
                                        style = layerStyles['MobilierUrbain_8_PRN'];
                                        break;
                                    default:
                                        style = layerStyles['MobilierUrbain_8_Bac'];
                                }
                                
                                return L.circleMarker(latlng, style);
                            },
                            onEachFeature: function(feature, l) {
                                const props = feature.properties || {};
                                let html = `<table style="font-size: 11px; width: 100%;">`;
                                html += `<tr><td colspan="2"><strong>🟢 Mobilier Urbain</strong></td></tr>`;
                                
                                const keysToShow = ['Type_de_Mo', 'REGION', 'DEPARTEMEN', 'Commune_de', 'Statut_du_', 'Etat_du_Mo'];
                                keysToShow.forEach(key => {
                                    if (props[key] != null) {
                                        html += `<tr><td><strong>${key}:</strong></td><td>${props[key]}</td></tr>`;
                                    }
                                });
                                
                                html += `</table>`;
                                l.bindPopup(html, { maxHeight: 300 });
                            }
                        });
                    }
                    // 📌 CIRCUITS (Collecte et Balayage) - Lignes
                    else if (name.includes('CollecteNational') || name.includes('BalayageNational')) {
                        const style = layerStyles[name];
                        layer = L.geoJSON(geoJsonData, {
                            style: style,
                            onEachFeature: function(feature, l) {
                                const props = feature.properties || {};
                                let html = `<table style="font-size: 11px; width: 100%;">`;
                                html += `<tr><td colspan="2"><strong>${name.includes('Collecte') ? '🔴 Collecte' : '🟣 Balayage'} National</strong></td></tr>`;
                                
                                const keysToShow = ['region', 'dept', 'commune', 'frequence', 'rotation', 'longueur'];
                                keysToShow.forEach(key => {
                                    if (props[key] != null) {
                                        html += `<tr><td><strong>${key}:</strong></td><td>${props[key]}</td></tr>`;
                                    }
                                });
                                
                                html += `</table>`;
                                l.bindPopup(html, { maxHeight: 300 });
                                
                                // Effets au survol pour les lignes
                                l.on('mouseover', () => l.setStyle({ weight: style.weight + 1.5, opacity: 1 }));
                                l.on('mouseout', () => l.setStyle(style));
                            }
                        });
                    }
                    // 🏛️ ADMINISTRATIF (Régions, Départements, Arrondissements) - Polygones
                    else {
                        const style = layerStyles[name];
                        layer = L.geoJSON(geoJsonData, {
                            style: style,
                            onEachFeature: function(feature, l) {
                                const props = feature.properties || {};
                                let html = `<table style="font-size: 11px; width: 100%;">`;
                                html += `<tr><td colspan="2"><strong>${layerDisplayNames[name]}</strong></td></tr>`;
                                
                                for (let key in props) {
                                    if (props[key] != null) {
                                        html += `<tr><td><strong>${key}:</strong></td><td>${props[key]}</td></tr>`;
                                    }
                                }
                                
                                html += `</table>`;
                                l.bindPopup(html, { maxHeight: 400 });
                                
                                // Effets au survol pour les polygones
                                l.on('mouseover', () => {
                                    l.setStyle({ weight: 3, opacity: 1 });
                                    l.bringToFront();
                                });
                                l.on('mouseout', () => l.setStyle(style));
                                
                                // 🏷️ AJOUTER LABELS POUR LES RÉGIONS
                                if (name === 'Region_3' && feature.geometry && props['Région']) {
                                    try {
                                        const centroid = turf.centroid(feature);
                                        const regionName = props['Région'] || props['region'] || 'N/A';
                                        
                                        const labelIcon = L.divIcon({
                                            className: 'region-label',
                                            html: `<div style="
                                                background: rgba(255, 255, 255, 0.95);
                                                border: 2px solid rgba(45, 80, 22, 0.8);
                                                border-radius: 6px;
                                                padding: 4px 12px;
                                                font-size: 13px;
                                                font-weight: 700;
                                                color: #2d5016;
                                                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                                                text-align: center;
                                                white-space: nowrap;
                                                z-index: 1000;
                                            ">${regionName}</div>`,
                                            iconSize: [120, 35],
                                            iconAnchor: [60, 17],
                                            popupAnchor: [0, -10]
                                        });
                                        
                                        L.marker(
                                            [centroid.geometry.coordinates[1], centroid.geometry.coordinates[0]],
                                            { icon: labelIcon }
                                        ).addTo(landingMap);
                                        
                                        console.log(`✅ Label ajouté: ${regionName}`);
                                    } catch (err) {
                                        console.warn(`⚠️ Erreur lors de l'ajout du label pour la région: ${err.message}`);
                                    }
                                }
                            }
                        });
                    }
                    
                    // ✅ Ajouter la couche à la carte et au contrôle
                    layer.addTo(landingMap);
                    geojsonLayers[name] = layer;
                    
                    // 🖼️ Améliorer le label avec image de légende si disponible
                    let displayLabel = layerDisplayNames[name];
                    const legendImagePath = `./legend/${name}.png`;
                    
                    // Créer un label avec légende (HTML)
                    const labelWithLegend = document.createElement('div');
                    labelWithLegend.style.display = 'flex';
                    labelWithLegend.style.alignItems = 'center';
                    labelWithLegend.style.gap = '8px';
                    
                    const legendImg = document.createElement('img');
                    legendImg.src = legendImagePath;
                    legendImg.style.height = '16px';
                    legendImg.style.width = 'auto';
                    legendImg.onerror = () => {
                        legendImg.style.display = 'none';
                    };
                    
                    const labelText = document.createElement('span');
                    labelText.textContent = displayLabel;
                    
                    labelWithLegend.appendChild(legendImg);
                    labelWithLegend.appendChild(labelText);
                    
                    // Ajouter avec le label enrichi
                    overlayMaps[displayLabel] = layer;
                    
                    loadedLayersCount++;
                    
                    // Quand toutes les couches sont chargées
                    if (loadedLayersCount === totalLayers) {
                        // Recréer le contrôle des couches
                        if (landingLayersControl) landingMap.removeControl(landingLayersControl);
                        
                        landingLayersControl = L.control.layers(baseMaps, overlayMaps, {
                            position: 'topright',
                            collapsed: true,
                            expandControlLabel: '☰',
                            collapseControlLabel: '✕'
                        }).addTo(landingMap);
                        
                        console.log(`✅ ${loadedLayersCount} couches GeoJSON chargées avec succès`);
                        console.log(`🖼️ Légendes intégrées depuis ./legend/`);
                    }
                };
                
                script.onerror = () => {
                    console.error(`❌ Erreur: Impossible de charger ${url}`);
                    loadedLayersCount++;
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Initialiser quand le DOM est prêt
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (!landingMap) {
                    initLandingMap();
                }
            }, 300);
        });

        // 📸 CHARGE AUTOMATIQUE DU DERNIER EXPORT DANS LA GALERIE
        async function chargerDernierExportEnGalerie() {
            try {
                let gallerieData = [];
                let gallerieSource = 'export-local';
                
                // 1️⃣ PRIORITÉ: Charger depuis le CSV du dernier export local
                try {
                    const response = await fetch('./get-latest-export.json');
                    if (response.ok) {
                        const lastExport = await response.json();
                        if (lastExport.path) {
                            const csvResponse = await fetch(`${lastExport.path}/collectes_donnees.csv`);
                            if (csvResponse.ok) {
                                const csvText = await csvResponse.text();
                                
                                const lines = csvText.trim().split('\n');
                                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                                const rows = lines.slice(1).map(line => {
                                    const columns = line.split(',').map(c => c.replace(/"/g, '').trim());
                                    const obj = {};
                                    headers.forEach((header, index) => {
                                        obj[header] = columns[index];
                                    });
                                    return obj;
                                });
                                
                                gallerieData = rows
                                    .filter(row => row.commune && row.commune.trim())
                                    .map(row => {
                                        // Extraire le nom du fichier d'image depuis la colonne photo
                                        let imagePath = row.photo || '';
                                        console.log(`📸 Traitement image pour ${row.commune}: "${imagePath}"`);
                                        
                                        // Extraire le nom du fichier (photo_XX_Y.jpg)
                                        let filename = '';
                                        const match = imagePath.match(/photo_\d+_\d+\.jpg/);
                                        if (match) {
                                            filename = match[0];
                                        }
                                        
                                        // Utiliser le chemin complet de l'export
                                        if (filename) {
                                            imagePath = `${lastExport.path}/images/${filename}`;
                                            console.log(`   ✅ Chemin corrigé: ${imagePath}`);
                                        } else {
                                            console.warn(`   ❌ Impossible d'extraire le nom du fichier de: ${row.photo}`);
                                        }
                                        
                                        return {
                                            id: parseInt(row.id) || 0,
                                            commune: row.commune,
                                            partenaire: row.partenaire || 'N/A',
                                            site: row.sites_concernes || 'N/A',
                                            region: row.region || 'N/A',
                                            latitude: parseFloat(row.latitude) || 0,
                                            longitude: parseFloat(row.longitude) || 0,
                                            lat: row.latitude ? `${row.latitude}°N` : 'N/A',
                                            lng: row.longitude ? `${row.longitude}°O` : 'N/A',
                                            src: imagePath,
                                            date: row.date_collecte || ''
                                        };
                                    });
                                
                                if (gallerieData.length > 0) {
                                    gallerieSource = 'export-csv';
                                    console.log(`✅ ${gallerieData.length} images chargées depuis l'export local (${lastExport.path})`);
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.log('⚠️ Erreur chargement export local:', err.message);
                }
                
                // 2️⃣ FALLBACK: Utiliser les données statiques si pas de données du CSV
                if (gallerieData.length === 0) {
                    console.log('ℹ️ Utilisation des données statiques de galerie');
                    gallerieSource = 'static-data';
                    // galleriePhotos déjà initialisée avec les données statiques au début du script
                    gallerieData = galleriePhotos;
                }
                
                // 🔄 Mettre à jour la variable globale galleriePhotos avec les données valides
                if (gallerieData.length > 0) {
                    galleriePhotos = gallerieData;
                    console.log(`✅ Galerie initialisée avec ${gallerieData.length} photos (source: ${gallerieSource})`);
                } else {
                    console.warn('⚠️ Aucune donnée de galerie disponible');
                    return;
                }
                
                // 📊 Mettre à jour les statistiques
                const regions = new Set(gallerieData
                    .filter(r => r.region && r.region !== 'N/A')
                    .map(r => r.region));
                const communes = new Set(gallerieData
                    .filter(c => c.commune && c.commune !== 'N/A')
                    .map(c => c.commune));
                
                const galerieCounts = document.getElementById('galerie-count-collectes');
                const galerieRegions = document.getElementById('galerie-count-regions');
                const galerieImages = document.getElementById('galerie-count-images');
                
                if (galerieCounts) galerieCounts.textContent = gallerieData.length;
                if (galerieRegions) galerieRegions.textContent = regions.size;
                if (galerieImages) galerieImages.textContent = gallerieData.length;
                
                // 🎨 Mettre à jour les items de la galerie
                const galerieScroll = document.querySelector('.galerie-scroll');
                if (!galerieScroll) return;
                
                galerieScroll.innerHTML = '';
                gallerieData.forEach((row, index) => {
                    const item = document.createElement('div');
                    item.className = 'galerie-item';
                    item.onclick = () => openGalerieModal(index);
                    
                    // Vérifier et corriger le chemin de l'image
                    let imagePath = row.src || '';
                    
                    // Debug: Log le chemin d'image
                    if (index === 0) {
                        console.log(`🖼️ Première image - Chemin: ${imagePath}, Commune: ${row.commune}`);
                    }
                    
                    // Créer un fallback SVG pour les images manquantes
                    const fallbackSVG = `data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23e8f5e9%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2245%25%22 font-size=%2216%22 fill=%22%236db038%22 text-anchor=%22middle%22 font-weight=%22bold%22%3E${row.commune}%3C/text%3E%3Ctext x=%2250%25%22 y=%2260%25%22 font-size=%2212%22 fill=%22%23999%22 text-anchor=%22middle%22%3EImage indisponible%3C/text%3E%3C/svg%3E`;
                    
                    item.innerHTML = `
                        <img class="galerie-item-image" src="${imagePath}" alt="${row.commune}" 
                             onerror="this.src='${fallbackSVG}'; console.warn('❌ Image non trouvée: ${imagePath}');">
                        <div class="galerie-item-info">
                            <div class="galerie-item-detail"><strong>Partenaire:</strong> ${row.partenaire || 'N/A'}</div>
                            <div class="galerie-item-commune">📍 ${row.commune || 'N/A'}</div>
                            <div class="galerie-item-detail"><strong>Site:</strong> ${row.site || 'N/A'}</div>
                            ${row.date ? `<div class="galerie-item-date">📅 ${row.date}</div>` : ''}
                        </div>
                    `;
                    galerieScroll.appendChild(item);
                });
                
                // 🗺️ Mettre à jour collectesGPS avec les données de galerie pour la carte
                if (gallerieData.length > 0) {
                    collectesGPS = gallerieData.map(row => ({
                        id: row.id || 0,
                        commune: row.commune || 'N/A',
                        partenaire: row.partenaire || 'N/A',
                        site: row.site || 'N/A',
                        lat: row.latitude || 0,
                        lng: row.longitude || 0,
                        photo: row.src || ''
                    }));
                    
                    console.log(`🗺️ collectesGPS mise à jour avec ${collectesGPS.length} marqueurs`);
                    
                    // Réinitialiser la carte si elle existe et est visible
                    if (collecteMapInitialized && document.getElementById('collecte-map') && document.getElementById('collecte-map').offsetHeight > 0) {
                        collecteMapInitialized = false;
                        initializeCollecteMap();
                    }
                }
                
                console.log(`✅ Galerie mise à jour (${gallerieData.length} images - Source: ${gallerieSource})`);
            } catch (error) {
                console.warn('⚠️ Erreur lors du chargement de la galerie:', error.message);
            }
        }
        
        /**
         * 🔄 Charger les données depuis le DTM.csv (OneDrive)
         */
        async function chargerDonneesDTM() {
            try {
                console.log('📥 Chargement des données DTM.csv...');
                
                // Appel API au serveur DTM
                const response = await fetch('http://localhost:3002/api/dtm-data');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    throw new Error('Aucune donnée DTM reçue');
                }
                
                console.log(`✅ ${result.count} enregistrements DTM chargés`);
                
                // Mettre à jour collectesGPS avec les données DTM
                collectesGPS = result.data.map(item => ({
                    id: item.id,
                    commune: item.commune,
                    site: item.site,
                    partenaire: item.partenaire,
                    lat: item.latitude,
                    lng: item.longitude,
                    photo: item.photo,
                    date: item.date_collecte,
                    type: item.type_activite,
                    observation: item.observation
                }));
                
                console.log(`🗺️ collectesGPS mise à jour avec ${collectesGPS.length} marqueurs DTM`);
                
                // Mettre à jour la galerie avec les données DTM
                galleriePhotos = result.data.map(item => ({
                    commune: item.commune,
                    site: item.site,
                    partenaire: item.partenaire,
                    src: item.photo,
                    date: item.date_collecte
                })).filter(item => item.src && item.src.trim() !== '');
                
                console.log(`📷 Galerie mise à jour avec ${galleriePhotos.length} photos DTM`);
                
                // Rafraîchir l'affichage de la galerie
                if (document.getElementById('galerie-scroll')) {
                    const galerieScroll = document.getElementById('galerie-scroll');
                    galerieScroll.innerHTML = '';
                    
                    galleriePhotos.forEach((photo, idx) => {
                        const item = document.createElement('div');
                        item.className = 'gallery-item';
                        item.innerHTML = `
                            <div class="gallery-item-wrapper">
                                <img src="${photo.src}" alt="Photo de ${photo.commune}" 
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2218%22 fill=%22%23999%22%3EImage non disponible%3C/text%3E%3C/svg%3E'">
                                <div class="gallery-info">
                                    <p class="commune"><strong>📍 ${photo.commune}</strong></p>
                                    <p class="site">${photo.site}</p>
                                    <p class="partenaire">🤝 ${photo.partenaire}</p>
                                    <p class="date">📅 ${new Date(photo.date).toLocaleDateString('fr-FR')}</p>
                                </div>
                            </div>
                        `;
                        galerieScroll.appendChild(item);
                    });
                    
                    console.log('✅ Galerie DTM affichée avec succès');
                }
                
                // Réinitialiser la carte si elle existe
                if (typeof initializeCollecteMap === 'function' && document.getElementById('collecte-map')) {
                    console.log('🗺️ Réinitialisation de la carte avec données DTM...');
                    initializeCollecteMap();
                }
                
                return true;
                
            } catch (error) {
                console.warn('⚠️ Erreur chargement DTM.csv:', error.message);
                console.info('ℹ️ Utilisation des données locales...');
                return false;
            }
        }
        
        // Charger la galerie au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            // Essayer d'abord charger les données DTM
            chargerDonneesDTM().then(success => {
                if (!success) {
                    // Sinon utiliser l'export local
                    chargerDernierExportEnGalerie();
                }
            }).catch(err => {
                console.error('Erreur lors du chargement initial:', err);
                chargerDernierExportEnGalerie();
            });
        });
    </script>

</body>
</html>